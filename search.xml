<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Android Native Reverse(...ing)</title>
      <link href="/2022/04/04/Android%20native%20%E9%80%86%E5%90%91/"/>
      <url>/2022/04/04/Android%20native%20%E9%80%86%E5%90%91/</url>
      
        <content type="html"><![CDATA[<h1>Android native 逆向</h1><h2 id="前置知识">前置知识</h2><p><code>NDK</code></p><p>NDK 即 Native Development Kit，是 Android 中的一个开发工具包，使您能够在 Android 应用中使用 C 和 C++ 代码。</p><p>使用NDK可以快速开发 C、 C++ 的动态库，并自动将 so 和应用一起打包成 APK。即可通过 NDK使 Java 与 Native 代码（如 C、C++）交互。</p><p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/20200924220730991.png" alt="在这里插入图片描述"></p><p><code>JNI</code></p><p>JNI 即 Java Native Interface，是一种编程框架，使得 Java 虚拟机中的 Java 程序可以调用本地应用或库，也可以被其他程序调用。 本地程序一般是用其它语言（C、C++ 或汇编语言等）编写的，并且被编译为基于本机硬件和操作系统的程序</p><p>使用JNI 首先要声明native方法，之后实现native方法，并生成so文件，最终加载so文件，调用native方法。</p><blockquote><p>JNI 是一个编程框架，是一个抽象的东西，NDK 是一个工具包</p></blockquote><p><code>ABI</code></p><p>ABI 即 Application Binary Interface。我们上面说了，每个CPU系统只能使用相对应的二进制文件，不同的 Android 设备使用不同的 CPU，而不同的 CPU 支持不同的指令集。</p><p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20220331174010239.png" alt="image-20220331174010239"></p><p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20220403183650728.png" alt="image-20220403183650728"></p><p><strong>在 Android 手机上安装一个应用时，只有手机CPU架构支持的ABI架构对应的.so文件会被安装。如果支持多个ABI架构，会按照优先级进行安装。x86架构的模拟器也能运行arm的程序是因为其中间对so文件进行了转换，所以在调试或者是用frida hook 时会因此出现不匹配或找不到的问题。</strong></p><h2 id="JNI方法的使用">JNI方法的使用</h2><h3 id="静态注册">静态注册</h3><p>native 层的方法名为：<strong>Java_&lt;包名&gt;*&lt;类名&gt;*&lt;方法名&gt;（__&lt;参数&gt;）</strong></p><p>linux: mkdir -p jni/com/example/task</p><p>注册步骤如下</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.task; <span class="comment">//包名</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>{</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">func</span><span class="params">(<span class="keyword">int</span> a)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">boolean</span> <span class="title">func</span><span class="params">(String a)</span></span>; </span><br><span class="line">    <span class="comment">//只有当 native 方法出现需要重载的时候，native 层的方法名后才需要跟上参数</span></span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"><span class="comment">//java层 native 方法声明 通常在一个类中</span></span><br></pre></td></tr></tbody></table></figure><p>在<code>xxxx/jni/com/example/task</code>目录下编译java文件</p><p>javac 编译<code>test.java</code>文件生成<code>test.class</code></p><p>进入到 <code> xxx/jni</code> 目录下使用命令：  <strong>javah com.example.task.test</strong> 会生成 com_example_task_test.h 文件，内容如下。</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* DO NOT EDIT THIS FILE - it is machine generated */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="comment">/* Header for class com_example_task_test */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _Included_com_example_task_test</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _Included_com_example_task_test</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> {</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Class:     com_example_task_test</span></span><br><span class="line"><span class="comment"> * Method:    init</span></span><br><span class="line"><span class="comment"> * Signature: ()V</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">JNIEXPORT <span class="keyword">void</span> JNICALL <span class="title">Java_com_example_task_test_init</span> </span></span><br><span class="line"><span class="function">  <span class="params">(JNIEnv *, jobject)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Class:     com_example_task_test</span></span><br><span class="line"><span class="comment"> * Method:    func</span></span><br><span class="line"><span class="comment"> * Signature: (I)V</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">JNIEXPORT <span class="keyword">void</span> JNICALL <span class="title">Java_com_example_task_test_func__I</span></span></span><br><span class="line"><span class="function">  <span class="params">(JNIEnv *, jobject, jint)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Class:     com_example_task_test</span></span><br><span class="line"><span class="comment"> * Method:    func</span></span><br><span class="line"><span class="comment"> * Signature: (Ljava/lang/String;)Z</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">JNIEXPORT jboolean JNICALL <span class="title">Java_com_example_task_test_func__Ljava_lang_String_2</span></span></span><br><span class="line"><span class="function">  <span class="params">(JNIEnv *, jobject, jstring)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></span><br><span class="line">}</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></tbody></table></figure><blockquote><p>可以观察 函数是 java_包名_类名_函数名 参数是 <strong>JNIEnv</strong>* 和 <strong>jobject</strong> + 额外参数</p></blockquote><p>将<code>com_example_task_test.h</code> 修改为<code>Myjni.h</code> 或其他 按照自己喜好👨‍💻。</p><p>此时我们只拿到了在java中声明的native函数，还没有给出函数体，故下一步是通过c/c++完善函数并编译出so文件。</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"MyJni.h"</span> <span class="comment">//导入修改后的头文件 编写函数实体</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">JNIEXPORT jboolean JNICALL Java_com_example_task_test_func__Ljava_lang_String_2 <span class="comment">//头文件中声明的native函数</span></span><br><span class="line">  (JNIEnv *, jobject, jstring){</span><br><span class="line">         <span class="keyword">char</span> *cstr=(<span class="keyword">char</span> *)(*env)-&gt;GetStringUTFChars(env,jstr,<span class="literal">NULL</span>); <span class="comment">//获取传入的字符</span></span><br><span class="line">         <span class="built_in">printf</span>(<span class="string">"%s\n"</span>,cstr);</span><br><span class="line">}</span><br><span class="line">....</span><br></pre></td></tr></tbody></table></figure><p>之后通过gcc 编译<code>MyJni.c</code>生成so文件</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -fPIC -shared -o libMyJni.so MyJni.c -I xxxx/include</span><br></pre></td></tr></tbody></table></figure><blockquote><p>-I  xxxx/include 指定头文件搜索目录，xxx为jdk的安装路径，要用到Jni.h文件 ， 并且输出so文件必须以lib开头</p></blockquote><p>如果要想实例运行，<code>test.java</code>中需要调用so文件,如下。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.task; <span class="comment">//包名</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>{</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">boolean</span> <span class="title">func</span><span class="params">(String a)</span></span>; </span><br><span class="line">    <span class="comment">//只有当 native 方法出现需要重载的时候，native 层的方法名后才需要跟上参数</span></span><br><span class="line">    <span class="keyword">static</span>{</span><br><span class="line">            System.loadLibrary(<span class="string">"MyJni"</span>); <span class="comment">//加载so文件</span></span><br><span class="line">    }</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] argv)</span></span>{ <span class="comment">//主函数</span></span><br><span class="line">                System.out.println(<span class="string">"hello"</span>);</span><br><span class="line">                <span class="keyword">new</span> test().func(<span class="string">"jni callback!"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>完成上述步骤后可通过 <strong>java -Djava.library.path=xxx/jni/com/example/task/ com.example.task.test</strong>进行运行测试。</p><p>上述是静态注册的方法，静态注册的函数名都按照<code>java_包名_类名_方法名</code>的格式来命名，长度比较长，并且类名或包名修改后还要重复上述步骤生成新的so文件。</p><h3 id="动态注册">动态注册</h3><p>动态注册需要将native方法构造成JNINativeMethod数组，JNINativeMethod结构体定义如下。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">typedef struct {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* name; <span class="comment">// Java层native方法名称</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* signature; <span class="comment">// 方法签名</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span>*       fnPtr; <span class="comment">// native层方法指针</span></span><br><span class="line">} JNINativeMethod;</span><br></pre></td></tr></tbody></table></figure><p><strong>之后需要重写JNI_OnLoad函数，该函数会在 System.loadLibrary加载完so文件后被调用，在其中完成动态注册。</strong></p><p>一个MyJni.c的结构如下。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">#include&lt;jni.h&gt;</span><br><span class="line">#include&lt;stdio.h&gt;</span><br><span class="line"><span class="keyword">static</span> JNINativeMethod methods[] = {      <span class="comment">//JNINativeMethod数组 每一项的值 包括 name sign 和 函数指针</span></span><br><span class="line">        {<span class="string">"init"</span>, <span class="string">"()V"</span>, (<span class="keyword">void</span> *)c_init1},</span><br><span class="line">        {<span class="string">"init"</span>, <span class="string">"(I)V"</span>, (<span class="keyword">void</span> *)c_init2},</span><br><span class="line">        {<span class="string">"init"</span>, <span class="string">"(Ljava/lang/String;)Z"</span>, (<span class="keyword">void</span> *)c_init3},</span><br><span class="line">        {<span class="string">"update"</span>, <span class="string">"()V"</span>, (<span class="keyword">void</span> *)c_update},</span><br><span class="line">    .....</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line">JNIEXPORT jint JNICALL  <span class="comment">//JNIEXPORT</span></span><br><span class="line">JNI_OnLoad(JavaVM* vm, <span class="keyword">void</span>* reserved) { <span class="comment">//注意参数 JavaVM* vm 和 void* reserved </span></span><br><span class="line">    JNIEnv *env = NULL;</span><br><span class="line">    jint result = -<span class="number">1</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 获取JNI env变量</span></span><br><span class="line">    <span class="keyword">if</span> (vm-&gt;GetEnv((<span class="keyword">void</span>**) &amp;env, JNI_VERSION_1_6) != JNI_OK) {</span><br><span class="line">        <span class="comment">// 失败返回-1</span></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    }</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 获取native方法所在类</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* className = <span class="string">"com/example/ndk/NativeTest"</span>;</span><br><span class="line">    jclass clazz = env-&gt;FindClass(className);</span><br><span class="line">    <span class="keyword">if</span> (clazz == NULL) {</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    }</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 动态注册native方法</span></span><br><span class="line">    <span class="keyword">if</span> (env-&gt;RegisterNatives(clazz, methods, sizeof(methods) / sizeof(methods[<span class="number">0</span>])) &lt; <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    }</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 返回成功</span></span><br><span class="line">    result = JNI_VERSION_1_6;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">extern <span class="string">"C"</span> <span class="function">JNIEXPORT <span class="keyword">void</span> JNICALL</span></span><br><span class="line"><span class="function"><span class="title">c_init1</span><span class="params">(JNIEnv *env, jobject thiz)</span> </span>{</span><br><span class="line">    <span class="comment">//  函数实体</span></span><br><span class="line">}</span><br><span class="line">...........</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>因为<code>JNI_OnLoad</code>是导出函数，所以IDA在exports中可以找到。</p><p>其中，主要用RegisterNatives解析</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">jint <span class="title">RegisterNatives</span><span class="params">(jclass clazz, <span class="keyword">const</span> JNINativeMethod* methods, jint nMethods)</span><span class="comment">//参数依次是 native所在类 函数数组 和 函数个数</span></span></span><br><span class="line"><span class="function"><span class="comment">//注册成功则返回 0,失败则返回一个负值</span></span></span><br></pre></td></tr></tbody></table></figure><p>上述只是对JNI编程结构有一定的了解，如果要深入的话还要系统学习一下Android开发和java等😔。</p><h2 id="libxxx-so文件函数修复">libxxx.so文件函数修复</h2><p>👀易忽略点：so文件是一个elf格式的文件，在so被加载之前，会执行init段的代码,在结束的时候，会执行fini段的代码。所以在init_array中可能会有smc数据解密的代码，往往存在着数据解密。</p><blockquote><p>静态注册的native函数因为命名规范很容易识别，所以难点在动态注册的函数。</p></blockquote><p>jadx中查看native声明，并且之后会调用check函数。</p><p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20220401003254289.png" alt="image-20220401003254289"></p><p>打开lib.so文件，其中native的check函数通过动态注册，因为导出表中无xxxx_check函数。可见JNI_OnLoad函数本身的参数是正确的，但是其中的局部变量类型却不正确😭。</p><p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20220331230040806.png" alt="image-20220331230040806"></p><p>根据上文所述动态注册的步骤(获取JNI的env变量，获取包含native的类，通过RegisterNatives和method数组来动态注册)，调整变量修复函数。</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">jint <span class="title">JNI_OnLoad</span><span class="params">(JavaVM *vm, <span class="keyword">void</span> *reserved)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  jint v3; <span class="comment">// w19</span></span><br><span class="line">  JNIEnv *v5; <span class="comment">// x20</span></span><br><span class="line">  jclass v6; <span class="comment">// x0</span></span><br><span class="line">  JNIEnv *v7[<span class="number">2</span>]; <span class="comment">// [xsp+0h] [xbp-30h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v3 = <span class="number">65542</span>;</span><br><span class="line">  v7[<span class="number">1</span>] = *(JNIEnv **)(_ReadStatusReg(ARM64_SYSREG(<span class="number">3</span>, <span class="number">3</span>, <span class="number">13</span>, <span class="number">0</span>, <span class="number">2</span>)) + <span class="number">40</span>);</span><br><span class="line">  v7[<span class="number">0</span>] = <span class="number">0LL</span>;</span><br><span class="line">  sub_1724();                                   <span class="comment">// 反调试</span></span><br><span class="line">  <span class="keyword">if</span> ( (*vm)-&gt;GetEnv(vm, (<span class="keyword">void</span> **)v7, <span class="number">65542LL</span>) )<span class="comment">// 通过vm获取JNI env变量存到v7</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  v5 = v7[<span class="number">0</span>];</span><br><span class="line">  v6 = (*v7[<span class="number">0</span>])-&gt;FindClass(v7[<span class="number">0</span>], class_name);  <span class="comment">// com/test/hufu22/TestActivity</span></span><br><span class="line">  <span class="keyword">if</span> ( !v6</span><br><span class="line">    || (((__int64 (__fastcall *)(JNIEnv *, jclass, <span class="keyword">char</span> **, __int64))(*v5)-&gt;RegisterNatives)(v5, v6, &amp;method, <span class="number">1LL</span>) &amp; <span class="number">0x80000000</span>) != <span class="number">0</span> )</span><br><span class="line">  {</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;                                  <span class="comment">// 动态注册了一个函数 并且在TestActivity类中的调用</span></span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> v3;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>修改之后，即可直观看出是对一个函数进行了动态注册，跟进method变量，观察其3个值，是经过smc修改的，手动修一下，如下。</p><p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20220331231932296.png" alt="image-20220331231932296"></p><p><strong>动态注册的check函数已经找到，接下来就要逆向分析函数逻辑，不过在此之前，.init_array的内容需要解决，因为本题中发现其中存在解密代码，对一些静态数据进行了修改。</strong></p><p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20220331234953540.png" alt="image-20220331234953540"></p><p>根据jadx中check函数的参数和JNI函数的结构修复check函数。</p><p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20220403203347019.png" alt="image-20220403203347019"></p><blockquote><p>对于Init段存在字符解密的so文件，可以用frida hook dump出so，这样拿到就是字符串解密后的so文件，可惜👦手上没有root机，暂且硬怼。</p></blockquote><p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20220403210636506.png" alt="image-20220403210636506"></p><p>首先对传入字符进行base64解密，解密函数也是通过索引表映射来实现的，打印出索引表，b64表被修改，这和RE2 shellcode中所用函数一致。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a=[...] <span class="comment">#删除末尾重复0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">64</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">chr</span>(a.index(i)),end=<span class="string">''</span>)</span><br><span class="line"><span class="comment">#zTsI01htNUF/VoE4uQnpyA9bCqD53fgiBd6GXcKHLjJv7Pm2rSkMlxwW8OeRZa+Y</span></span><br></pre></td></tr></tbody></table></figure><p>之后进入第一个处理函数，<code>pre_getstr</code>通过交叉引用知是java层调用prenative函数传入的字符串，分析知该函数为AES128的秘钥扩展。</p><p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20220403210433884.png" alt="image-20220403210433884"></p><p>不过这里的sbox经过换表了，接下来是<code>sub_2DE8</code>函数，是AES的加密主体。由控制流程图知，他在进行加密的时候没有用循环，代码复用导致函数比较大，比较难读。</p><p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20220403224816348.png" alt="image-20220403224816348"></p><p>类似这种块主要进行轮秘钥加和行位移，之后<code>sub_2668</code>执行列混淆，用到了一个数组</p><p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20220404000101335.png" alt="image-20220404000101335"></p><p>通过<code>IDAPYTHON</code> dump出数组，根据数组去github上搜一下，找到了类似符号的源码<a href="https://github.com/microsoft/LWE_Library/blob/master/src/aes/aes_c.c">aes_c.c - github</a>,这段逻辑也主要用于列混淆中。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">s1=[<span class="number">0x00</span>,<span class="number">0x02</span>,<span class="number">0x04</span>,<span class="number">0x06</span>,<span class="number">0x08</span>,<span class="number">0x0a</span>,<span class="number">0x0c</span>,<span class="number">0x0e</span>,<span class="number">0x10</span>,<span class="number">0x12</span>,<span class="number">0x14</span>,<span class="number">0x16</span>,<span class="number">0x18</span>,<span class="number">0x1a</span>,<span class="number">0x1c</span>,<span class="number">0x1e</span>,<span class="number">0x20</span>,<span class="number">0x22</span>,<span class="number">0x24</span>,<span class="number">0x26</span>,<span class="number">0x28</span>,<span class="number">0x2a</span>,<span class="number">0x2c</span>,<span class="number">0x2e</span>,<span class="number">0x30</span>,<span class="number">0x32</span>,<span class="number">0x34</span>,<span class="number">0x36</span>,<span class="number">0x38</span>,<span class="number">0x3a</span>,<span class="number">0x3c</span>,<span class="number">0x3e</span>,<span class="number">0x40</span>,<span class="number">0x42</span>,<span class="number">0x44</span>,<span class="number">0x46</span>,<span class="number">0x48</span>,<span class="number">0x4a</span>,<span class="number">0x4c</span>,<span class="number">0x4e</span>,<span class="number">0x50</span>,<span class="number">0x52</span>,<span class="number">0x54</span>,<span class="number">0x56</span>,<span class="number">0x58</span>,<span class="number">0x5a</span>,<span class="number">0x5c</span>,<span class="number">0x5e</span>,<span class="number">0x60</span>,<span class="number">0x62</span>,<span class="number">0x64</span>,<span class="number">0x66</span>,<span class="number">0x68</span>,<span class="number">0x6a</span>,<span class="number">0x6c</span>,<span class="number">0x6e</span>,<span class="number">0x70</span>,<span class="number">0x72</span>,<span class="number">0x74</span>,<span class="number">0x76</span>,<span class="number">0x78</span>,<span class="number">0x7a</span>,<span class="number">0x7c</span>,<span class="number">0x7e</span>,<span class="number">0x80</span>,<span class="number">0x82</span>,<span class="number">0x84</span>,<span class="number">0x86</span>,<span class="number">0x88</span>,<span class="number">0x8a</span>,<span class="number">0x8c</span>,<span class="number">0x8e</span>,<span class="number">0x90</span>,<span class="number">0x92</span>,<span class="number">0x94</span>,<span class="number">0x96</span>,<span class="number">0x98</span>,<span class="number">0x9a</span>,<span class="number">0x9c</span>,<span class="number">0x9e</span>,<span class="number">0xa0</span>,<span class="number">0xa2</span>,<span class="number">0xa4</span>,<span class="number">0xa6</span>,<span class="number">0xa8</span>,<span class="number">0xaa</span>,<span class="number">0xac</span>,<span class="number">0xae</span>,<span class="number">0xb0</span>,<span class="number">0xb2</span>,<span class="number">0xb4</span>,<span class="number">0xb6</span>,<span class="number">0xb8</span>,<span class="number">0xba</span>,<span class="number">0xbc</span>,<span class="number">0xbe</span>,<span class="number">0xc0</span>,<span class="number">0xc2</span>,<span class="number">0xc4</span>,<span class="number">0xc6</span>,<span class="number">0xc8</span>,<span class="number">0xca</span>,<span class="number">0xcc</span>,<span class="number">0xce</span>,<span class="number">0xd0</span>,<span class="number">0xd2</span>,<span class="number">0xd4</span>,<span class="number">0xd6</span>,<span class="number">0xd8</span>,<span class="number">0xda</span>,<span class="number">0xdc</span>,<span class="number">0xde</span>,<span class="number">0xe0</span>,<span class="number">0xe2</span>,<span class="number">0xe4</span>,<span class="number">0xe6</span>,<span class="number">0xe8</span>,<span class="number">0xea</span>,<span class="number">0xec</span>,<span class="number">0xee</span>,<span class="number">0xf0</span>,<span class="number">0xf2</span>,<span class="number">0xf4</span>,<span class="number">0xf6</span>,<span class="number">0xf8</span>,<span class="number">0xfa</span>,<span class="number">0xfc</span>,<span class="number">0xfe</span>,<span class="number">0x1b</span>,<span class="number">0x19</span>,<span class="number">0x1f</span>,<span class="number">0x1d</span>,<span class="number">0x13</span>,<span class="number">0x11</span>,<span class="number">0x17</span>,<span class="number">0x15</span>,<span class="number">0x0b</span>,<span class="number">0x09</span>,<span class="number">0x0f</span>,<span class="number">0x0d</span>,<span class="number">0x03</span>,<span class="number">0x01</span>,<span class="number">0x07</span>,<span class="number">0x05</span>,<span class="number">0x3b</span>,<span class="number">0x39</span>,<span class="number">0x3f</span>,<span class="number">0x3d</span>,<span class="number">0x33</span>,<span class="number">0x31</span>,<span class="number">0x37</span>,<span class="number">0x35</span>,<span class="number">0x2b</span>,<span class="number">0x29</span>,<span class="number">0x2f</span>,<span class="number">0x2d</span>,<span class="number">0x23</span>,<span class="number">0x21</span>,<span class="number">0x27</span>,<span class="number">0x25</span>,<span class="number">0x5b</span>,<span class="number">0x59</span>,<span class="number">0x5f</span>,<span class="number">0x5d</span>,<span class="number">0x53</span>,<span class="number">0x51</span>,<span class="number">0x57</span>,<span class="number">0x55</span>,<span class="number">0x4b</span>,<span class="number">0x49</span>,<span class="number">0x4f</span>,<span class="number">0x4d</span>,<span class="number">0x43</span>,<span class="number">0x41</span>,<span class="number">0x47</span>,<span class="number">0x45</span>,<span class="number">0x7b</span>,<span class="number">0x79</span>,<span class="number">0x7f</span>,<span class="number">0x7d</span>,<span class="number">0x73</span>,<span class="number">0x71</span>,<span class="number">0x77</span>,<span class="number">0x75</span>,<span class="number">0x6b</span>,<span class="number">0x69</span>,<span class="number">0x6f</span>,<span class="number">0x6d</span>,<span class="number">0x63</span>,<span class="number">0x61</span>,<span class="number">0x67</span>,<span class="number">0x65</span>,<span class="number">0x9b</span>,<span class="number">0x99</span>,<span class="number">0x9f</span>,<span class="number">0x9d</span>,<span class="number">0x93</span>,<span class="number">0x91</span>,<span class="number">0x97</span>,<span class="number">0x95</span>,<span class="number">0x8b</span>,<span class="number">0x89</span>,<span class="number">0x8f</span>,<span class="number">0x8d</span>,<span class="number">0x83</span>,<span class="number">0x81</span>,<span class="number">0x87</span>,<span class="number">0x85</span>,<span class="number">0xbb</span>,<span class="number">0xb9</span>,<span class="number">0xbf</span>,<span class="number">0xbd</span>,<span class="number">0xb3</span>,<span class="number">0xb1</span>,<span class="number">0xb7</span>,<span class="number">0xb5</span>,<span class="number">0xab</span>,<span class="number">0xa9</span>,<span class="number">0xaf</span>,<span class="number">0xad</span>,<span class="number">0xa3</span>,<span class="number">0xa1</span>,<span class="number">0xa7</span>,<span class="number">0xa5</span>,<span class="number">0xdb</span>,<span class="number">0xd9</span>,<span class="number">0xdf</span>,<span class="number">0xdd</span>,<span class="number">0xd3</span>,<span class="number">0xd1</span>,<span class="number">0xd7</span>,<span class="number">0xd5</span>,<span class="number">0xcb</span>,<span class="number">0xc9</span>,<span class="number">0xcf</span>,<span class="number">0xcd</span>,<span class="number">0xc3</span>,<span class="number">0xc1</span>,<span class="number">0xc7</span>,<span class="number">0xc5</span>,<span class="number">0xfb</span>,<span class="number">0xf9</span>,<span class="number">0xff</span>,<span class="number">0xfd</span>,<span class="number">0xf3</span>,<span class="number">0xf1</span>,<span class="number">0xf7</span>,<span class="number">0xf5</span>,<span class="number">0xeb</span>,<span class="number">0xe9</span>,<span class="number">0xef</span>,<span class="number">0xed</span>,<span class="number">0xe3</span>,<span class="number">0xe1</span>,<span class="number">0xe7</span>,<span class="number">0xe5</span>]</span><br><span class="line">s2=[<span class="number">0x00</span>,<span class="number">0x03</span>,<span class="number">0x06</span>,<span class="number">0x05</span>,<span class="number">0x0c</span>,<span class="number">0x0f</span>,<span class="number">0x0a</span>,<span class="number">0x09</span>,<span class="number">0x18</span>,<span class="number">0x1b</span>,<span class="number">0x1e</span>,<span class="number">0x1d</span>,<span class="number">0x14</span>,<span class="number">0x17</span>,<span class="number">0x12</span>,<span class="number">0x11</span>,<span class="number">0x30</span>,<span class="number">0x33</span>,<span class="number">0x36</span>,<span class="number">0x35</span>,<span class="number">0x3c</span>,<span class="number">0x3f</span>,<span class="number">0x3a</span>,<span class="number">0x39</span>,<span class="number">0x28</span>,<span class="number">0x2b</span>,<span class="number">0x2e</span>,<span class="number">0x2d</span>,<span class="number">0x24</span>,<span class="number">0x27</span>,<span class="number">0x22</span>,<span class="number">0x21</span>,<span class="number">0x60</span>,<span class="number">0x63</span>,<span class="number">0x66</span>,<span class="number">0x65</span>,<span class="number">0x6c</span>,<span class="number">0x6f</span>,<span class="number">0x6a</span>,<span class="number">0x69</span>,<span class="number">0x78</span>,<span class="number">0x7b</span>,<span class="number">0x7e</span>,<span class="number">0x7d</span>,<span class="number">0x74</span>,<span class="number">0x77</span>,<span class="number">0x72</span>,<span class="number">0x71</span>,<span class="number">0x50</span>,<span class="number">0x53</span>,<span class="number">0x56</span>,<span class="number">0x55</span>,<span class="number">0x5c</span>,<span class="number">0x5f</span>,<span class="number">0x5a</span>,<span class="number">0x59</span>,<span class="number">0x48</span>,<span class="number">0x4b</span>,<span class="number">0x4e</span>,<span class="number">0x4d</span>,<span class="number">0x44</span>,<span class="number">0x47</span>,<span class="number">0x42</span>,<span class="number">0x41</span>,<span class="number">0xc0</span>,<span class="number">0xc3</span>,<span class="number">0xc6</span>,<span class="number">0xc5</span>,<span class="number">0xcc</span>,<span class="number">0xcf</span>,<span class="number">0xca</span>,<span class="number">0xc9</span>,<span class="number">0xd8</span>,<span class="number">0xdb</span>,<span class="number">0xde</span>,<span class="number">0xdd</span>,<span class="number">0xd4</span>,<span class="number">0xd7</span>,<span class="number">0xd2</span>,<span class="number">0xd1</span>,<span class="number">0xf0</span>,<span class="number">0xf3</span>,<span class="number">0xf6</span>,<span class="number">0xf5</span>,<span class="number">0xfc</span>,<span class="number">0xff</span>,<span class="number">0xfa</span>,<span class="number">0xf9</span>,<span class="number">0xe8</span>,<span class="number">0xeb</span>,<span class="number">0xee</span>,<span class="number">0xed</span>,<span class="number">0xe4</span>,<span class="number">0xe7</span>,<span class="number">0xe2</span>,<span class="number">0xe1</span>,<span class="number">0xa0</span>,<span class="number">0xa3</span>,<span class="number">0xa6</span>,<span class="number">0xa5</span>,<span class="number">0xac</span>,<span class="number">0xaf</span>,<span class="number">0xaa</span>,<span class="number">0xa9</span>,<span class="number">0xb8</span>,<span class="number">0xbb</span>,<span class="number">0xbe</span>,<span class="number">0xbd</span>,<span class="number">0xb4</span>,<span class="number">0xb7</span>,<span class="number">0xb2</span>,<span class="number">0xb1</span>,<span class="number">0x90</span>,<span class="number">0x93</span>,<span class="number">0x96</span>,<span class="number">0x95</span>,<span class="number">0x9c</span>,<span class="number">0x9f</span>,<span class="number">0x9a</span>,<span class="number">0x99</span>,<span class="number">0x88</span>,<span class="number">0x8b</span>,<span class="number">0x8e</span>,<span class="number">0x8d</span>,<span class="number">0x84</span>,<span class="number">0x87</span>,<span class="number">0x82</span>,<span class="number">0x81</span>,<span class="number">0x9b</span>,<span class="number">0x98</span>,<span class="number">0x9d</span>,<span class="number">0x9e</span>,<span class="number">0x97</span>,<span class="number">0x94</span>,<span class="number">0x91</span>,<span class="number">0x92</span>,<span class="number">0x83</span>,<span class="number">0x80</span>,<span class="number">0x85</span>,<span class="number">0x86</span>,<span class="number">0x8f</span>,<span class="number">0x8c</span>,<span class="number">0x89</span>,<span class="number">0x8a</span>,<span class="number">0xab</span>,<span class="number">0xa8</span>,<span class="number">0xad</span>,<span class="number">0xae</span>,<span class="number">0xa7</span>,<span class="number">0xa4</span>,<span class="number">0xa1</span>,<span class="number">0xa2</span>,<span class="number">0xb3</span>,<span class="number">0xb0</span>,<span class="number">0xb5</span>,<span class="number">0xb6</span>,<span class="number">0xbf</span>,<span class="number">0xbc</span>,<span class="number">0xb9</span>,<span class="number">0xba</span>,<span class="number">0xfb</span>,<span class="number">0xf8</span>,<span class="number">0xfd</span>,<span class="number">0xfe</span>,<span class="number">0xf7</span>,<span class="number">0xf4</span>,<span class="number">0xf1</span>,<span class="number">0xf2</span>,<span class="number">0xe3</span>,<span class="number">0xe0</span>,<span class="number">0xe5</span>,<span class="number">0xe6</span>,<span class="number">0xef</span>,<span class="number">0xec</span>,<span class="number">0xe9</span>,<span class="number">0xea</span>,<span class="number">0xcb</span>,<span class="number">0xc8</span>,<span class="number">0xcd</span>,<span class="number">0xce</span>,<span class="number">0xc7</span>,<span class="number">0xc4</span>,<span class="number">0xc1</span>,<span class="number">0xc2</span>,<span class="number">0xd3</span>,<span class="number">0xd0</span>,<span class="number">0xd5</span>,<span class="number">0xd6</span>,<span class="number">0xdf</span>,<span class="number">0xdc</span>,<span class="number">0xd9</span>,<span class="number">0xda</span>,<span class="number">0x5b</span>,<span class="number">0x58</span>,<span class="number">0x5d</span>,<span class="number">0x5e</span>,<span class="number">0x57</span>,<span class="number">0x54</span>,<span class="number">0x51</span>,<span class="number">0x52</span>,<span class="number">0x43</span>,<span class="number">0x40</span>,<span class="number">0x45</span>,<span class="number">0x46</span>,<span class="number">0x4f</span>,<span class="number">0x4c</span>,<span class="number">0x49</span>,<span class="number">0x4a</span>,<span class="number">0x6b</span>,<span class="number">0x68</span>,<span class="number">0x6d</span>,<span class="number">0x6e</span>,<span class="number">0x67</span>,<span class="number">0x64</span>,<span class="number">0x61</span>,<span class="number">0x62</span>,<span class="number">0x73</span>,<span class="number">0x70</span>,<span class="number">0x75</span>,<span class="number">0x76</span>,<span class="number">0x7f</span>,<span class="number">0x7c</span>,<span class="number">0x79</span>,<span class="number">0x7a</span>,<span class="number">0x3b</span>,<span class="number">0x38</span>,<span class="number">0x3d</span>,<span class="number">0x3e</span>,<span class="number">0x37</span>,<span class="number">0x34</span>,<span class="number">0x31</span>,<span class="number">0x32</span>,<span class="number">0x23</span>,<span class="number">0x20</span>,<span class="number">0x25</span>,<span class="number">0x26</span>,<span class="number">0x2f</span>,<span class="number">0x2c</span>,<span class="number">0x29</span>,<span class="number">0x2a</span>,<span class="number">0x0b</span>,<span class="number">0x08</span>,<span class="number">0x0d</span>,<span class="number">0x0e</span>,<span class="number">0x07</span>,<span class="number">0x04</span>,<span class="number">0x01</span>,<span class="number">0x02</span>,<span class="number">0x13</span>,<span class="number">0x10</span>,<span class="number">0x15</span>,<span class="number">0x16</span>,<span class="number">0x1f</span>,<span class="number">0x1c</span>,<span class="number">0x19</span>,<span class="number">0x1a</span>]</span><br></pre></td></tr></tbody></table></figure><p>如下图，用到了两个表来列混淆，特征比较明显，一般这种使用数组来实现的，可以在github上找到到蛛丝马迹。</p><p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20220404005222022.png" alt="image-20220404005222022"></p><p>通过交叉引用和第三个参数128可知调用了9次，对应AES中间的9轮，所以上述AES单纯魔改了sbox，其余算法不变。</p><blockquote><p>到此，一个动态注册的函数分析完毕，从修复JNI和注册信息，再到定位函数逆向逻辑，最后逆向还原即可💪。</p></blockquote><p>😴至于后续如何，未完待续。。。。</p><p>参考:</p><p><a href="https://blog.csdn.net/hello_1995/article/details/109393760">NDK 入门指南</a></p><p><a href="https://blog.csdn.net/hello_1995/article/details/109393760">NDK 开发之 JNI 方法静态注册与动态注册</a></p><p><a href="https://blog.csdn.net/yangguo_2011/article/details/17379297">java jni编程详细步骤及注意细节</a></p><p><a href="https://www.programminghunter.com/article/13461090681/">Frida环境搭建-基于python3.7</a></p>]]></content>
      
      
      <categories>
          
          <category> Android </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
            <tag> RE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android逆向环境搭建(持续更新中...)</title>
      <link href="/2022/04/03/Android%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/"/>
      <url>/2022/04/03/Android%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/</url>
      
        <content type="html"><![CDATA[<h1>Android逆向环境搭建</h1><blockquote><p>记录在Android 学习中工具的配置及相关环境的搭建。</p></blockquote><h2 id="Frida的安装">Frida的安装</h2><blockquote><p>过程非常的曲折，好在最终是装上了的，或许你坚持走的路，他始终就是个优雅的错误，梦醒了，还要继续走🚩。</p></blockquote><h3 id="Frida-下载">Frida 下载</h3><p>网上很多教程都是直接<code>pip install frida</code> 和<code>pip install frida-tools</code>即可，可是我在安装时却不是如此。<strong>(记得关掉梯子，否则会出错)</strong></p><blockquote><p>其实后来在装好后 学习用法的时看到很多前辈在安装时候都有强调版本问题，只能怪自己当时有点急躁，漏掉了许多细节😞。</p></blockquote><p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20220401233143141.png" alt="image-20220401233143141"></p><p>这是我安装成功后用python3.10运行时的报错(部分)，其余版本也是如此，对此我测试了python3.7-3.10间的版本。</p><p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20220401233315327.png" alt="image-20220401233315327"></p><p>在使用python3.8和python2.7安装时，发现其缓存中的库都是同一个版本<code>frida-15.1.17</code>这在pypi上标注是针对3.10的,然后错误是在setup.py所以是版本处理不当,不过python3.10也运行出错就有点意外。</p><p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20220401234359678.png" alt="image-20220401234359678"></p><p>他这一步其实是下载了 <code>frida-15.1.17.tar.gz</code> , <a href="http://xn--setup-4n1hg0rx93at61crfxbxjr.py">并运行其中的setup.py</a> ,故可以直接在网上下载一个对应python3.7版本的frida文件 ,<a href="http://xn--setup-r96h474gtsi6t8eyyp.py">手动来运行setup.py</a>。</p><p>python3.7对应win-amd64版本  <a href="https://files.pythonhosted.org/packages/0a/4b/b191420bd34215377f72e04593619d9266d5e3e33f6cf48c8e827dcecb89/frida-12.8.20.tar.gz">frida-12.8.20.tar.gz </a> ,之后在任意目录解压，并在命令行依次运行如下指令。</p><ol><li><p><strong>python3.7 <a href="http://setup.py">setup.py</a> install</strong></p><p>该步过后会在Python37\Lib\site-packages 目录下生成frida-12.8.20-py3.7-win-amd64.egg，在运行的最后一步可能需要等待一段时间。</p><p>之后不要再去pip install frida ，接着去安装 frida-tools，不过直接pip 也会有报错。</p></li><li><p><strong>pip3.7 install  frida-tools==7.2.1</strong></p></li></ol><p>​指定frida-tools的版本为7.2.1，接着等待一段时间，出现success就算成功。</p><p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20220402000244440.png" alt="image-20220402000244440"></p><p>之后安装frida-server 版本要和frida一致 <code>frida --version</code> ，到<a href="https://github.com/frida/frida/releases?page=8">frida-github</a>安装对应版本的server。</p><p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20220403004209807.png" alt="image-20220403004209807"></p><blockquote><p>adb shell getprop ro.product.cpu.abi   查看手机cpu版本下载对应的server架构</p></blockquote><p>下载解压后，将文件重命名为 <code>frida-server</code> ，或者加上对应的架构，<strong>夜神模拟器的话选Android-x86</strong>。</p><h3 id="adb调试环境">adb调试环境</h3><p>首先进入夜神模拟器的bin目录，打开终端。</p><ol><li>nox_adb.exe connect 127.0.0.1:62001 模拟器连到62001这个端口上</li><li>在非夜神bin目录的终端下 运行 adb connect 127.0.0.1:62001</li><li>adb devices 检测是否连接</li></ol><blockquote><p>如果其中出现不匹配的问题，就到Android_SDK目录下把adb.exe复制到夜神模拟器的bin目录，重命名为nox_adb.exe之后再进行上述步骤。</p></blockquote><p>配置好夜神后，将<code>frida-server</code>传到其<code>\data\local\tmp</code>目录下，修改权限并运行。</p><ol><li><strong>adb push ./frida-server /data/local/tmp</strong></li><li><strong>adb shell</strong></li><li><strong>cd data/local/tmp</strong></li><li><strong>chmod 777 frida-server</strong></li><li><strong>./frida-server</strong></li><li><strong>adb tcp:27042 tcp:27042 进行端口转发</strong></li></ol><p>夜神模拟器中打开一个app程序，在主机上通过<code>frida-ps -U</code>查看USB调试进程，发现自己启动的程序包即为成功😃。</p><p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20220403004501603.png" alt="image-20220403004501603"></p><p>使用<code>firda</code>hook包，<strong>frida-trace -i “open” -U com.test.hufu22</strong>。</p><p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20220403104658735.png" alt="image-20220403104658735"></p><blockquote><p>当然基于frida的使用还有待进一步的学习，使用夜神模拟器等也只能是正对程序中带了x86的so文件才能进行IDA调试和Frida hook，要想用于实战必须要配备root机。</p></blockquote><p>最终简介一下:frida是一款基于python + javascript 的hook框架，可运行在android、ios、linux、winosx等各平台，主要使用动态二进制插桩技术。</p><h3 id="Objection安装">Objection安装</h3><p>objection是一个基于Frida开发的命令行工具，它可以很方便的Hook Java函数和类，并输出参数，调用栈。其git地址为<a href="https://github.com/sensepost/objection/releases?page=2">objection-github-release</a>。</p><figure class="highlight cmd"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida --version #打印frida版本  <span class="number">12</span>.<span class="number">11</span>.<span class="number">18</span></span><br></pre></td></tr></tbody></table></figure><blockquote><p>安装对版本也又要求，如果frida安装的是12.11.18 ，那么安装的版本在1.8.4 ~ 1.9.0左右，更多可以根据frida版本的发行时间去objection找靠后一点的版本。</p></blockquote><figure class="highlight cmd"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3.<span class="number">7</span> install objection==<span class="number">1</span>.<span class="number">9</span>.<span class="number">0</span> #直接指定相应版本即可</span><br></pre></td></tr></tbody></table></figure><p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20220403195842070.png" alt="image-20220403195842070"></p><p><a href="https://chowdera.com/2021/09/20210926150657751D.html">frida install and 夜神模拟器</a></p><p><a href="https://www.cxybb.com/article/freeking101/106965168">Android逆向-firda Hook 框架</a></p><p><a href="https://www.codeleading.com/article/77291460162/">Python-HOOK神器-Frida学习</a></p>]]></content>
      
      
      <categories>
          
          <category> Android </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
            <tag> Tools </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RE_Challenge</title>
      <link href="/2022/03/28/RE_Challenge/"/>
      <url>/2022/03/28/RE_Challenge/</url>
      
        <content type="html"><![CDATA[<blockquote><p>主要是以虎符和近期国际赛的题为主，梳理一下学到的方法和技巧。</p></blockquote><h2 id="虎符">虎符</h2><h3 id="fype">fype</h3><p>基于libbpf编写的bpf程序逆向，原理类似hook。主要分为两部分，一部分是bpf代码，一部分是用户代码。本题是<a href="https://github.com/libbpf/libbpf-bootstrap"> libbpf-bootstrap</a>结构下的uprobe模板，用于对程序内函数进行hook(或称跟踪)。</p><p><code>uprobe.bpf.c</code></p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: GPL-2.0 OR BSD-3-Clause</span></span><br><span class="line"><span class="comment">/* Copyright (c) 2020 Facebook */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/bpf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/ptrace.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bpf/bpf_helpers.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bpf/bpf_tracing.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> LICENSE[] SEC(<span class="string">"license"</span>) = <span class="string">"Dual BSD/GPL"</span>;</span><br><span class="line"></span><br><span class="line">SEC(<span class="string">"uprobe/func"</span>)</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">BPF_KPROBE</span><span class="params">(uprobe, <span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">bpf_printk(<span class="string">"UPROBE ENTRY: a = %d, b = %d\n"</span>, a, b);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">SEC(<span class="string">"uretprobe/func"</span>)</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">BPF_KRETPROBE</span><span class="params">(uretprobe, <span class="keyword">int</span> ret)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">bpf_printk(<span class="string">"UPROBE EXIT: return = %d\n"</span>, ret);</span><br><span class="line">    <span class="comment">//类似printf 把格式化字符串放入 /sys/kernel/debug/tracing/trace_pipe 文件中，需要sudo 即root权限下运行</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"><span class="comment">//LICENSE变量定义了BPF代码的许可证。指定许可证是强制性的，由内核强制执行。某些 BPF 功能不可用于非 GPL 兼容代码。</span></span><br><span class="line"><span class="comment">//其中uprobe/func 为进入函数 , uretprobe/func为退出函数。</span></span><br></pre></td></tr></tbody></table></figure><p>BPF程序一般需要4个步骤，即创建并打开<code>open</code>、加载并验证<code>loda</code>、附加<code>attach</code>、退出<code>destroy</code>。</p><p>bpf程序用户代码模板函数</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">libbpf_set_print(libbpf_print_fn);<span class="comment">//设置日志输出函数libbpf_print_fn</span></span><br><span class="line"></span><br><span class="line">bump_memlock_rlimit();<span class="comment">//提高内核内部用户的内存权限，为bpf程序的执行做准备</span></span><br><span class="line"></span><br><span class="line">fype(name)_bpf__open_and_load();<span class="comment">//加载bpf字节码文件到内核中</span></span><br><span class="line"><span class="comment">//又细分为如下两个函数</span></span><br><span class="line"></span><br><span class="line">fpbe_bpf *obj=fpbe_bpf__open();<span class="comment">//创建并打开bpf</span></span><br><span class="line"><span class="comment">//-- fpbe_bpf__create_skeleton(obj)</span></span><br><span class="line"><span class="comment">//bpftool 会根据 bpf 字节码文件（xxx.bpf.o）生成对应的 skeleton 文件——xxx.skel.h。这个文件中包含了关键的函数和结构体。比如，这个文件中包含了 xxx.bpf.o 文件的内容。</span></span><br><span class="line"><span class="comment">//这个函数的内容十分关键</span></span><br><span class="line"></span><br><span class="line">fpbe_bpf__load(obj);<span class="comment">//进行check</span></span><br><span class="line"></span><br><span class="line">bpf_program__attach_uprobe() <span class="comment">//用于绑定 uprobe 和 uretprobe 追踪目标的信息</span></span><br><span class="line"><span class="comment">//如下  最后一个参数是函数偏移 base_addr调试为0x400000即Imagebase</span></span><br><span class="line">obj-&gt;links.uprobe = bpf_program__attach_uprobe(</span><br><span class="line">                              obj-&gt;progs.uprobe,</span><br><span class="line">                              <span class="number">0</span>,</span><br><span class="line">                              <span class="number">0</span>,</span><br><span class="line">                              <span class="string">"/proc/self/exe"</span>,<span class="comment">//跟踪程序</span></span><br><span class="line">                              (<span class="keyword">size_t</span>)uprobed_function - base_addr);<span class="comment">//跟踪函数</span></span><br><span class="line"></span><br><span class="line">fpbe_bpf__destroy(obj);<span class="comment">//退出</span></span><br></pre></td></tr></tbody></table></figure><p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20220325212024715.png" alt="image-20220325212024715"></p><p>了解过bpf程序的框架之后，再分析程序就比较清晰了。将钩子挂在了当前程序的uprobed函数上，该函数内容为hash check，对flag的内容进行检测。</p><p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20220325212213296.png" alt="image-20220325212213296"></p><p>故关键处理在bpf代码，处理后的结果再进行比对，我们只需拿到bpf字节码反汇编逆出逻辑问题就解决了。</p><p>方法一:</p><p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20220326000537317.png" alt="image-20220326000537317"></p><p><strong>可以直接在create_skeleton下找到ebpf字节码文件(elf)，用ipython dump，当然最后看了wp发现binwalk直接分离是一种不错的方法。</strong></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> idautils</span><br><span class="line">adr=<span class="number">0x00000000004F4018</span></span><br><span class="line"><span class="built_in">len</span>=<span class="number">1648</span></span><br><span class="line">f=<span class="built_in">open</span>(<span class="string">r'G:\dump'</span>,<span class="string">'wb'</span>)</span><br><span class="line">s=[]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>):</span><br><span class="line">    s.append(Byte(adr+i))</span><br><span class="line">f.write(<span class="built_in">bytes</span>(s))</span><br><span class="line">f.close()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">'ok'</span>)</span><br></pre></td></tr></tbody></table></figure><p>分离出的是bpf字节码，IDA无法直接反汇编，需要找到相应的解释器。</p><p><a href="https://github.com/saaph/eBPF_processor">saaph/eBPF_processor . disassemble eBPF bytecode</a></p><p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20220326001348915.png" alt="image-20220326001348915"></p><p>配置好后打开dump出的文件，选择EBPF，即可对字节码反汇编，查看汇编代码即可，主要是求解线性方程组，z3即可，通过hash来check flag是否正确</p><p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20220326001641632.png" alt="image-20220326001641632"></p><p><code>exp</code></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> sha256</span><br><span class="line">a=[Int(<span class="string">'a{}'</span>.<span class="built_in">format</span>(i)) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)]</span><br><span class="line">s=Solver()</span><br><span class="line">s.add(a[<span class="number">3</span>]*<span class="number">0x6DC0</span>+a[<span class="number">2</span>]*<span class="number">0xfb88</span>+a[<span class="number">1</span>]*<span class="number">0x71fb</span>+a[<span class="number">0</span>]*<span class="number">0xcc8e</span>==<span class="number">0xBE18A1735995</span>)</span><br><span class="line">s.add(a[<span class="number">3</span>]*<span class="number">0xF1BF</span>+a[<span class="number">2</span>]*<span class="number">0x6AE5</span>+a[<span class="number">1</span>]*<span class="number">0xADD3</span>+a[<span class="number">0</span>]*<span class="number">0x9284</span>==<span class="number">0xA556E5540340</span>)</span><br><span class="line">s.add(a[<span class="number">3</span>]*<span class="number">0xDD85</span>+a[<span class="number">2</span>]*<span class="number">0x8028</span>+a[<span class="number">1</span>]*<span class="number">0x652D</span>+a[<span class="number">0</span>]*<span class="number">0xE712</span>==<span class="number">0xA6F374484DA3</span>)</span><br><span class="line">s.add(a[<span class="number">3</span>]*<span class="number">0x822C</span>+a[<span class="number">2</span>]*<span class="number">0xCA43</span>+a[<span class="number">1</span>]*<span class="number">0x7C8E</span>+a[<span class="number">0</span>]*<span class="number">0xF23A</span>==<span class="number">0xB99C485A7277</span>)</span><br><span class="line">s.check()</span><br><span class="line">ans=s.model()</span><br><span class="line">res=[]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">    res.append(<span class="built_in">int</span>.to_bytes(ans[a[i]].as_long(),<span class="number">4</span>,<span class="string">'little'</span>).decode())</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>,-<span class="number">1</span>,-<span class="number">1</span>):</span><br><span class="line">    <span class="built_in">print</span>(res[i],end=<span class="string">''</span>)</span><br><span class="line"><span class="built_in">print</span>()</span><br><span class="line"><span class="built_in">print</span>(sha256(<span class="string">b'0vR3sAlbs8pD2h53'</span>).hexdigest())</span><br><span class="line"><span class="comment">#0vR3sAlbs8pD2h53</span></span><br></pre></td></tr></tbody></table></figure><p>方法二:</p><p>使用bpftool，bpftool是一个用来检查 BPF 程序和映射的内核工具。</p><p><code>bpftool prog</code> 可以用来检查系统中运行程序的情况</p><p><code>bpf prog dump </code>获取到了程序标识符后，可以执行 bpf prog dump 来获取整个程序的数据,能够看到由编译器生成的字节码。</p><p>当然拿到编译器生成的字节码已经可读了，如果代码量大的话，则需要修改一下格式之后用C重新编译，详见<a href="https://blog.shi1011.cn/ctf/2259">Mas0n</a>师傅的做法。</p><p>参考:</p><p><a href="https://github.com/libbpf/libbpf-bootstrap">git-libbpf-bootstrap source</a></p><p><a href="https://zhuanlan.zhihu.com/p/467647354">ebpf:基于 uprobe 的自定义例程</a></p><h3 id="the-shellcode">the shellcode</h3><p>赛后复现，程序加了<code>Themida / Winlicense v3.0.0.0 - 3.0.4.0</code>强保护壳，硬脱比较困难，并且壳代码有反调试，可以先运行，之后IDA attach来进行调试。</p><p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20220323165537110.png" alt="image-20220323165537110"></p><p>将the shell程序代码段的数据用IDA python批量转为代码，大小0x12f7。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> idaapi</span><br><span class="line">adr=<span class="number">0x00631000</span></span><br><span class="line">size=<span class="number">0x12f7</span></span><br><span class="line">end=adr+size</span><br><span class="line"><span class="keyword">while</span> adr&lt;end:</span><br><span class="line">    idaapi.create_insn(adr)</span><br><span class="line">    insn=idaapi.insn_t()</span><br><span class="line">    <span class="built_in">len</span>=idaapi.decode_insn(insn,adr)</span><br><span class="line">    adr+=<span class="built_in">len</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">'ok'</span>)</span><br><span class="line"><span class="comment"># 自动化转data 为 code</span></span><br></pre></td></tr></tbody></table></figure><p>之后通过运行时的输出字符定位关键处理函数。</p><p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20220321234631973.png" alt=""></p><p>首先对opcode进行base64解密，解密函数通过 密文&lt;-&gt;索引表下标 的方式实现，之后又发现了位运算和魔改xxTea。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64encode</span><br><span class="line">s=<span class="string">b'abc'</span></span><br><span class="line"><span class="built_in">print</span>(b64encode(s))</span><br><span class="line">c=<span class="string">b'YWJj'</span></span><br><span class="line">table=[<span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x40</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x3E</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x3F</span>, <span class="number">0x34</span>, <span class="number">0x35</span>, <span class="number">0x36</span>, <span class="number">0x37</span>, <span class="number">0x38</span>, <span class="number">0x39</span>, <span class="number">0x3A</span>, <span class="number">0x3B</span>, <span class="number">0x3C</span>, <span class="number">0x3D</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x41</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x02</span>, <span class="number">0x03</span>, <span class="number">0x04</span>, <span class="number">0x05</span>, <span class="number">0x06</span>, <span class="number">0x07</span>, <span class="number">0x08</span>, <span class="number">0x09</span>, <span class="number">0x0A</span>, <span class="number">0x0B</span>, <span class="number">0x0C</span>, <span class="number">0x0D</span>, <span class="number">0x0E</span>, <span class="number">0x0F</span>, <span class="number">0x10</span>, <span class="number">0x11</span>, <span class="number">0x12</span>, <span class="number">0x13</span>, <span class="number">0x14</span>, <span class="number">0x15</span>, <span class="number">0x16</span>, <span class="number">0x17</span>, <span class="number">0x18</span>, <span class="number">0x19</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x1A</span>, <span class="number">0x1B</span>, <span class="number">0x1C</span>, <span class="number">0x1D</span>, <span class="number">0x1E</span>, <span class="number">0x1F</span>, <span class="number">0x20</span>, <span class="number">0x21</span>, <span class="number">0x22</span>, <span class="number">0x23</span>, <span class="number">0x24</span>, <span class="number">0x25</span>, <span class="number">0x26</span>, <span class="number">0x27</span>, <span class="number">0x28</span>, <span class="number">0x29</span>, <span class="number">0x2A</span>, <span class="number">0x2B</span>, <span class="number">0x2C</span>, <span class="number">0x2D</span>, <span class="number">0x2E</span>, <span class="number">0x2F</span>, <span class="number">0x30</span>, <span class="number">0x31</span>, <span class="number">0x32</span>, <span class="number">0x33</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>, <span class="number">0x42</span>]</span><br><span class="line"><span class="built_in">sum</span>=<span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> c:</span><br><span class="line">    <span class="built_in">sum</span>=(<span class="built_in">sum</span>&lt;&lt;<span class="number">6</span>)+table[i]</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(<span class="built_in">sum</span>))</span><br><span class="line"><span class="comment">#base64解密</span></span><br></pre></td></tr></tbody></table></figure><p>之后是逐字节循环左移3</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; v2; ++i )</span><br><span class="line">   v4-&gt;m128i_i8[i] = __ROL1__(v4-&gt;m128i_i8[i], <span class="number">3</span>);</span><br></pre></td></tr></tbody></table></figure><p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20220321234846646.png" alt="image-20220321234846646"></p><p>xxTea将明文前一项右移5改为了右移6。</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ut32 unsigned int</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> delta 0x9e3779b9</span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">XXTea_Decrypt</span><span class="params">(ut32* enc, ut32 n, ut32* key)</span> </span>{</span><br><span class="line">ut32 y, z, sum;</span><br><span class="line">ut32 e, rounds;</span><br><span class="line"><span class="keyword">int</span> p;</span><br><span class="line">rounds = <span class="number">6</span> + <span class="number">52</span> / n;</span><br><span class="line">sum = delta * rounds;</span><br><span class="line"></span><br><span class="line"><span class="keyword">do</span> {</span><br><span class="line">e = (sum &gt;&gt; <span class="number">2</span>) &amp; <span class="number">3</span>;</span><br><span class="line"><span class="keyword">for</span> (p = n - <span class="number">1</span>; p &gt; <span class="number">0</span>; p--) {</span><br><span class="line">y = enc[(p + <span class="number">1</span>) % n];</span><br><span class="line">z = enc[(p - <span class="number">1</span>)];</span><br><span class="line">enc[p] -= (((z &gt;&gt; <span class="number">6</span> ^ y &lt;&lt; <span class="number">2</span>) + (y &gt;&gt; <span class="number">3</span> ^ z &lt;&lt; <span class="number">4</span>)) ^ ((sum ^ y) + (key[(p &amp; <span class="number">3</span>) ^ e] ^ z)));</span><br><span class="line">}</span><br><span class="line">y = enc[<span class="number">1</span>];</span><br><span class="line">z = enc[n - <span class="number">1</span>];</span><br><span class="line">enc[<span class="number">0</span>] -= (((z &gt;&gt; <span class="number">6</span> ^ y &lt;&lt; <span class="number">2</span>) + (y &gt;&gt; <span class="number">3</span> ^ z &lt;&lt; <span class="number">4</span>)) ^ ((sum ^ y) + (key[(<span class="number">0</span> &amp; <span class="number">3</span>) ^ e] ^ z)));</span><br><span class="line">sum -= delta;</span><br><span class="line">} <span class="keyword">while</span> (--rounds);</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">ut32 m[<span class="number">66</span>] = { <span class="number">0x4B6B89A1</span>, <span class="number">0x74C15453</span>, <span class="number">0x4092A06E</span>, <span class="number">0x429B0C07</span>, <span class="number">0x40281E84</span>, <span class="number">0x8B5B44C9</span>, <span class="number">0x66FEB37B</span>, <span class="number">0x3C77A603</span>,</span><br><span class="line"><span class="number">0x79C5892D</span>, <span class="number">0x0D7ADA97</span>, <span class="number">0x1D51AA56</span>, <span class="number">0x02D4D703</span>, <span class="number">0x4FA526BA</span>, <span class="number">0x32FAD64A</span>, <span class="number">0x0C0F6091</span>, <span class="number">0x562B7593</span>,</span><br><span class="line"><span class="number">0xDB9ADD67</span>, <span class="number">0x76165563</span>, <span class="number">0xA5F79315</span>, <span class="number">0x3AEB991D</span>, <span class="number">0x1AB721D4</span>, <span class="number">0xAACD9D2C</span>, <span class="number">0x825C2B27</span>, <span class="number">0x76A7761A</span>,</span><br><span class="line"><span class="number">0xB4005F18</span>, <span class="number">0x117F3763</span>, <span class="number">0x512CC540</span>, <span class="number">0xC594A16F</span>, <span class="number">0xD0E24F8C</span>, <span class="number">0x9CA3E2E9</span>, <span class="number">0x0A9CC2D5</span>, <span class="number">0x4629E61D</span>,</span><br><span class="line"><span class="number">0x637129E3</span>, <span class="number">0xCA4E8AD7</span>, <span class="number">0xF5DFAF71</span>, <span class="number">0x474E68AB</span>, <span class="number">0x542FBC3A</span>, <span class="number">0xD6741617</span>, <span class="number">0xAD0DBBE5</span>, <span class="number">0x62F7BBE3</span>,</span><br><span class="line"><span class="number">0xC8D68C07</span>, <span class="number">0x880E950E</span>, <span class="number">0xF80F25BA</span>, <span class="number">0x767A264C</span>, <span class="number">0x9A7CE014</span>, <span class="number">0x5C8BC9EE</span>, <span class="number">0x5D9EF7D4</span>, <span class="number">0xB999ACDE</span>,</span><br><span class="line"><span class="number">0xB2EC8E13</span>, <span class="number">0xEE68232D</span>, <span class="number">0x927C5FCE</span>, <span class="number">0xC9E3A85D</span>, <span class="number">0xAC74B56B</span>, <span class="number">0x42B6E712</span>, <span class="number">0xCD2898DA</span>, <span class="number">0xFCF11C58</span>,</span><br><span class="line"><span class="number">0xF57075EE</span>, <span class="number">0x5076E678</span>, <span class="number">0xD4D66A35</span>, <span class="number">0x95105AB9</span>, <span class="number">0x1BB04403</span>, <span class="number">0xB240B959</span>, <span class="number">0x7B4E261A</span>, <span class="number">0x23D129D8</span>,</span><br><span class="line"><span class="number">0xF5E752CD</span>, <span class="number">0x4EA78F70</span> };</span><br><span class="line">ut32 k[<span class="number">4</span>] = { <span class="number">0x74</span>,<span class="number">0x6f</span>,<span class="number">0x72</span>,<span class="number">0x61</span> };</span><br><span class="line">XXTea_Decrypt(m, <span class="number">66</span>, k);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span> * <span class="number">66</span>; i++) {</span><br><span class="line"><span class="keyword">uint8_t</span> tmp = *((<span class="keyword">uint8_t</span>*)m + i);</span><br><span class="line">*((<span class="keyword">uint8_t</span>*)m + i) = ((tmp &gt;&gt; <span class="number">3</span>) | (tmp &lt;&lt; <span class="number">5</span>)) &amp; <span class="number">0xff</span>;</span><br><span class="line">}</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span> * <span class="number">66</span>; i++) {</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"0x%x,"</span>, *((<span class="keyword">uint8_t</span>*)m + i));</span><br><span class="line">}</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">from base64 <span class="keyword">import</span> b64encode</span><br><span class="line">code=[<span class="number">0x60</span>,<span class="number">0xfc</span>,<span class="number">0x68</span>,<span class="number">0x4c</span>,<span class="number">0x77</span>,<span class="number">0x26</span>,<span class="number">0x7</span>,<span class="number">0x33</span>,<span class="number">0xd2</span>,<span class="number">0x64</span>,<span class="number">0x8b</span>,<span class="number">0x52</span>,<span class="number">0x30</span>,<span class="number">0x8b</span>,<span class="number">0x52</span>,<span class="number">0xc</span>,<span class="number">0x8b</span>,<span class="number">0x52</span>,<span class="number">0x14</span>,<span class="number">0x8b</span>,<span class="number">0x72</span>,<span class="number">0x28</span>,<span class="number">0xf</span>,<span class="number">0xb7</span>,<span class="number">0x4a</span>,<span class="number">0x26</span>,<span class="number">0x33</span>,<span class="number">0xff</span>,<span class="number">0x33</span>,<span class="number">0xc0</span>,<span class="number">0xac</span>,<span class="number">0x3c</span>,<span class="number">0x61</span>,<span class="number">0x7c</span>,<span class="number">0x2</span>,<span class="number">0x2c</span>,<span class="number">0x20</span>,<span class="number">0xc1</span>,<span class="number">0xcf</span>,<span class="number">0xd</span>,<span class="number">0x3</span>,<span class="number">0xf8</span>,<span class="number">0xe2</span>,<span class="number">0xf0</span>,<span class="number">0x52</span>,<span class="number">0x57</span>,<span class="number">0x8b</span>,<span class="number">0x52</span>,<span class="number">0x10</span>,<span class="number">0x8b</span>,<span class="number">0x42</span>,<span class="number">0x3c</span>,<span class="number">0x3</span>,<span class="number">0xc2</span>,<span class="number">0x8b</span>,<span class="number">0x40</span>,<span class="number">0x78</span>,<span class="number">0x85</span>,<span class="number">0xc0</span>,<span class="number">0xf</span>,<span class="number">0x84</span>,<span class="number">0xbe</span>,<span class="number">0x0</span>,<span class="number">0x0</span>,<span class="number">0x0</span>,<span class="number">0x3</span>,<span class="number">0xc2</span>,<span class="number">0x50</span>,<span class="number">0x8b</span>,<span class="number">0x48</span>,<span class="number">0x18</span>,<span class="number">0x8b</span>,<span class="number">0x58</span>,<span class="number">0x20</span>,<span class="number">0x3</span>,<span class="number">0xda</span>,<span class="number">0x83</span>,<span class="number">0xf9</span>,<span class="number">0x0</span>,<span class="number">0xf</span>,<span class="number">0x84</span>,<span class="number">0xa9</span>,<span class="number">0x0</span>,<span class="number">0x0</span>,<span class="number">0x0</span>,<span class="number">0x49</span>,<span class="number">0x8b</span>,<span class="number">0x34</span>,<span class="number">0x8b</span>,<span class="number">0x3</span>,<span class="number">0xf2</span>,<span class="number">0x33</span>,<span class="number">0xff</span>,<span class="number">0x33</span>,<span class="number">0xc0</span>,<span class="number">0xac</span>,<span class="number">0xc1</span>,<span class="number">0xcf</span>,<span class="number">0xd</span>,<span class="number">0x3</span>,<span class="number">0xf8</span>,<span class="number">0x3a</span>,<span class="number">0xc4</span>,<span class="number">0x75</span>,<span class="number">0xf4</span>,<span class="number">0x3</span>,<span class="number">0x7c</span>,<span class="number">0x24</span>,<span class="number">0x4</span>,<span class="number">0x3b</span>,<span class="number">0x7c</span>,<span class="number">0x24</span>,<span class="number">0xc</span>,<span class="number">0x75</span>,<span class="number">0xd9</span>,<span class="number">0x33</span>,<span class="number">0xff</span>,<span class="number">0x33</span>,<span class="number">0xc9</span>,<span class="number">0x83</span>,<span class="number">0xc2</span>,<span class="number">0x50</span>,<span class="number">0xf</span>,<span class="number">0xb6</span>,<span class="number">0x4</span>,<span class="number">0xa</span>,<span class="number">0xc1</span>,<span class="number">0xcf</span>,<span class="number">0xd</span>,<span class="number">0x3</span>,<span class="number">0xf8</span>,<span class="number">0x41</span>,<span class="number">0x83</span>,<span class="number">0xf9</span>,<span class="number">0xe</span>,<span class="number">0x75</span>,<span class="number">0xf1</span>,<span class="number">0xc1</span>,<span class="number">0xcf</span>,<span class="number">0xd</span>,<span class="number">0x57</span>,<span class="number">0x33</span>,<span class="number">0xff</span>,<span class="number">0x33</span>,<span class="number">0xc9</span>,<span class="number">0x8b</span>,<span class="number">0x54</span>,<span class="number">0x24</span>,<span class="number">0x3c</span>,<span class="number">0x52</span>,<span class="number">0xf</span>,<span class="number">0xb6</span>,<span class="number">0x1c</span>,<span class="number">0xe</span>,<span class="number">0xb8</span>,<span class="number">0x67</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0xf7</span>,<span class="number">0xeb</span>,<span class="number">0xd1</span>,<span class="number">0xfa</span>,<span class="number">0x8b</span>,<span class="number">0xc2</span>,<span class="number">0xc1</span>,<span class="number">0xe8</span>,<span class="number">0x1f</span>,<span class="number">0x3</span>,<span class="number">0xc2</span>,<span class="number">0x8d</span>,<span class="number">0x4</span>,<span class="number">0x80</span>,<span class="number">0x2b</span>,<span class="number">0xd8</span>,<span class="number">0x5a</span>,<span class="number">0xf</span>,<span class="number">0xb6</span>,<span class="number">0x4</span>,<span class="number">0xa</span>,<span class="number">0x2b</span>,<span class="number">0xc3</span>,<span class="number">0xc1</span>,<span class="number">0xcf</span>,<span class="number">0xd</span>,<span class="number">0x3</span>,<span class="number">0xf8</span>,<span class="number">0x41</span>,<span class="number">0x83</span>,<span class="number">0xf9</span>,<span class="number">0xe</span>,<span class="number">0x75</span>,<span class="number">0xd4</span>,<span class="number">0xc1</span>,<span class="number">0xcf</span>,<span class="number">0xd</span>,<span class="number">0x3b</span>,<span class="number">0x3c</span>,<span class="number">0x24</span>,<span class="number">0x74</span>,<span class="number">0x16</span>,<span class="number">0x68</span>,<span class="number">0x25</span>,<span class="number">0x73</span>,<span class="number">0x0</span>,<span class="number">0x0</span>,<span class="number">0x8b</span>,<span class="number">0xc4</span>,<span class="number">0x68</span>,<span class="number">0x6e</span>,<span class="number">0x6f</span>,<span class="number">0x0</span>,<span class="number">0x0</span>,<span class="number">0x54</span>,<span class="number">0x50</span>,<span class="number">0x8b</span>,<span class="number">0x5c</span>,<span class="number">0x24</span>,<span class="number">0x48</span>,<span class="number">0xff</span>,<span class="number">0xd3</span>,<span class="number">0xeb</span>,<span class="number">0x14</span>,<span class="number">0x68</span>,<span class="number">0x25</span>,<span class="number">0x73</span>,<span class="number">0x0</span>,<span class="number">0x0</span>,<span class="number">0x8b</span>,<span class="number">0xc4</span>,<span class="number">0x68</span>,<span class="number">0x79</span>,<span class="number">0x65</span>,<span class="number">0x73</span>,<span class="number">0x0</span>,<span class="number">0x54</span>,<span class="number">0x50</span>,<span class="number">0x8b</span>,<span class="number">0x5c</span>,<span class="number">0x24</span>,<span class="number">0x48</span>,<span class="number">0xff</span>,<span class="number">0xd3</span>,<span class="number">0x58</span>,<span class="number">0x58</span>,<span class="number">0x58</span>,<span class="number">0x58</span>,<span class="number">0x58</span>,<span class="number">0x58</span>,<span class="number">0x58</span>,<span class="number">0x58</span>,<span class="number">0x58</span>,<span class="number">0x61</span>,<span class="number">0xc3</span>,<span class="number">0x58</span>,<span class="number">0x5f</span>,<span class="number">0x5a</span>,<span class="number">0x8b</span>,<span class="number">0x12</span>,<span class="number">0xe9</span>,<span class="number">0xb</span>,<span class="number">0xff</span>,<span class="number">0xff</span>,<span class="number">0xff</span>]</span><br><span class="line">print(b64encode(bytes(code)))</span><br><span class="line"><span class="string">""</span><span class="string">"shellcode</span></span><br><span class="line"><span class="string">YPxoTHcmBzPSZItSMItSDItSFItyKA+3SiYz/zPArDxhfAIsIMHPDQP44vBSV4tSEItCPAPCi0B4hcAPhL4AAAADwlCLSBiLWCAD2oP5AA+EqQAAAEmLNIsD8jP/M8Cswc8NA/g6xHX0A3wkBDt8JAx12TP/M8mDwlAPtgQKwc8NA/hBg/kOdfHBzw1XM/8zyYtUJDxSD7YcDrhnZmZm9+vR+ovCwegfA8KNBIAr2FoPtgQKK8PBzw0D+EGD+Q511MHPDTs8JHQWaCVzAACLxGhubwAAVFCLXCRI/9PrFGglcwAAi8RoeWVzAFRQi1wkSP/TWFhYWFhYWFhYYcNYX1qLEukL////    </span></span><br><span class="line"><span class="string">"</span><span class="string">""</span></span><br></pre></td></tr></tbody></table></figure><p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20220322001247766.png" alt="image-20220322001247766"></p><p>shellcode check成功，之后就是执行shellcode来解密flag。</p><p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20220323171640667.png" alt="image-20220323171640667"></p><p>用函数指针来调用解密的shellcode，以便进一步调试。</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*func)</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span>(_cdecl*)(<span class="keyword">unsigned</span> <span class="keyword">int</span>), <span class="keyword">char</span>*, <span class="keyword">unsigned</span> <span class="keyword">int</span>, <span class="keyword">unsigned</span> <span class="keyword">int</span>, <span class="keyword">unsigned</span> <span class="keyword">int</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> a[<span class="number">264</span>] = { <span class="number">0x60</span>,<span class="number">0xfc</span>,<span class="number">0x68</span>,<span class="number">0x4c</span>,<span class="number">0x77</span>,<span class="number">0x26</span>,<span class="number">0x7</span>,<span class="number">0x33</span>,<span class="number">0xd2</span>,<span class="number">0x64</span>,<span class="number">0x8b</span>,<span class="number">0x52</span>,<span class="number">0x30</span>,<span class="number">0x8b</span>,<span class="number">0x52</span>,<span class="number">0xc</span>,<span class="number">0x8b</span>,<span class="number">0x52</span>,<span class="number">0x14</span>,<span class="number">0x8b</span>,<span class="number">0x72</span>,<span class="number">0x28</span>,<span class="number">0xf</span>,<span class="number">0xb7</span>,<span class="number">0x4a</span>,<span class="number">0x26</span>,<span class="number">0x33</span>,<span class="number">0xff</span>,<span class="number">0x33</span>,<span class="number">0xc0</span>,<span class="number">0xac</span>,<span class="number">0x3c</span>,<span class="number">0x61</span>,<span class="number">0x7c</span>,<span class="number">0x2</span>,<span class="number">0x2c</span>,<span class="number">0x20</span>,<span class="number">0xc1</span>,<span class="number">0xcf</span>,<span class="number">0xd</span>,<span class="number">0x3</span>,<span class="number">0xf8</span>,<span class="number">0xe2</span>,<span class="number">0xf0</span>,<span class="number">0x52</span>,<span class="number">0x57</span>,<span class="number">0x8b</span>,<span class="number">0x52</span>,<span class="number">0x10</span>,<span class="number">0x8b</span>,<span class="number">0x42</span>,<span class="number">0x3c</span>,<span class="number">0x3</span>,<span class="number">0xc2</span>,<span class="number">0x8b</span>,<span class="number">0x40</span>,<span class="number">0x78</span>,<span class="number">0x85</span>,<span class="number">0xc0</span>,<span class="number">0xf</span>,<span class="number">0x84</span>,<span class="number">0xbe</span>,<span class="number">0x0</span>,<span class="number">0x0</span>,<span class="number">0x0</span>,<span class="number">0x3</span>,<span class="number">0xc2</span>,<span class="number">0x50</span>,<span class="number">0x8b</span>,<span class="number">0x48</span>,<span class="number">0x18</span>,<span class="number">0x8b</span>,<span class="number">0x58</span>,<span class="number">0x20</span>,<span class="number">0x3</span>,<span class="number">0xda</span>,<span class="number">0x83</span>,<span class="number">0xf9</span>,<span class="number">0x0</span>,<span class="number">0xf</span>,<span class="number">0x84</span>,<span class="number">0xa9</span>,<span class="number">0x0</span>,<span class="number">0x0</span>,<span class="number">0x0</span>,<span class="number">0x49</span>,<span class="number">0x8b</span>,<span class="number">0x34</span>,<span class="number">0x8b</span>,<span class="number">0x3</span>,<span class="number">0xf2</span>,<span class="number">0x33</span>,<span class="number">0xff</span>,<span class="number">0x33</span>,<span class="number">0xc0</span>,<span class="number">0xac</span>,<span class="number">0xc1</span>,<span class="number">0xcf</span>,<span class="number">0xd</span>,<span class="number">0x3</span>,<span class="number">0xf8</span>,<span class="number">0x3a</span>,<span class="number">0xc4</span>,<span class="number">0x75</span>,<span class="number">0xf4</span>,<span class="number">0x3</span>,<span class="number">0x7c</span>,<span class="number">0x24</span>,<span class="number">0x4</span>,<span class="number">0x3b</span>,<span class="number">0x7c</span>,<span class="number">0x24</span>,<span class="number">0xc</span>,<span class="number">0x75</span>,<span class="number">0xd9</span>,<span class="number">0x33</span>,<span class="number">0xff</span>,<span class="number">0x33</span>,<span class="number">0xc9</span>,<span class="number">0x83</span>,<span class="number">0xc2</span>,<span class="number">0x50</span>,<span class="number">0xf</span>,<span class="number">0xb6</span>,<span class="number">0x4</span>,<span class="number">0xa</span>,<span class="number">0xc1</span>,<span class="number">0xcf</span>,<span class="number">0xd</span>,<span class="number">0x3</span>,<span class="number">0xf8</span>,<span class="number">0x41</span>,<span class="number">0x83</span>,<span class="number">0xf9</span>,<span class="number">0xe</span>,<span class="number">0x75</span>,<span class="number">0xf1</span>,<span class="number">0xc1</span>,<span class="number">0xcf</span>,<span class="number">0xd</span>,<span class="number">0x57</span>,<span class="number">0x33</span>,<span class="number">0xff</span>,<span class="number">0x33</span>,<span class="number">0xc9</span>,<span class="number">0x8b</span>,<span class="number">0x54</span>,<span class="number">0x24</span>,<span class="number">0x3c</span>,<span class="number">0x52</span>,<span class="number">0xf</span>,<span class="number">0xb6</span>,<span class="number">0x1c</span>,<span class="number">0xe</span>,<span class="number">0xb8</span>,<span class="number">0x67</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0x66</span>,<span class="number">0xf7</span>,<span class="number">0xeb</span>,<span class="number">0xd1</span>,<span class="number">0xfa</span>,<span class="number">0x8b</span>,<span class="number">0xc2</span>,<span class="number">0xc1</span>,<span class="number">0xe8</span>,<span class="number">0x1f</span>,<span class="number">0x3</span>,<span class="number">0xc2</span>,<span class="number">0x8d</span>,<span class="number">0x4</span>,<span class="number">0x80</span>,<span class="number">0x2b</span>,<span class="number">0xd8</span>,<span class="number">0x5a</span>,<span class="number">0xf</span>,<span class="number">0xb6</span>,<span class="number">0x4</span>,<span class="number">0xa</span>,<span class="number">0x2b</span>,<span class="number">0xc3</span>,<span class="number">0xc1</span>,<span class="number">0xcf</span>,<span class="number">0xd</span>,<span class="number">0x3</span>,<span class="number">0xf8</span>,<span class="number">0x41</span>,<span class="number">0x83</span>,<span class="number">0xf9</span>,<span class="number">0xe</span>,<span class="number">0x75</span>,<span class="number">0xd4</span>,<span class="number">0xc1</span>,<span class="number">0xcf</span>,<span class="number">0xd</span>,<span class="number">0x3b</span>,<span class="number">0x3c</span>,<span class="number">0x24</span>,<span class="number">0x74</span>,<span class="number">0x16</span>,<span class="number">0x68</span>,<span class="number">0x25</span>,<span class="number">0x73</span>,<span class="number">0x0</span>,<span class="number">0x0</span>,<span class="number">0x8b</span>,<span class="number">0xc4</span>,<span class="number">0x68</span>,<span class="number">0x6e</span>,<span class="number">0x6f</span>,<span class="number">0x0</span>,<span class="number">0x0</span>,<span class="number">0x54</span>,<span class="number">0x50</span>,<span class="number">0x8b</span>,<span class="number">0x5c</span>,<span class="number">0x24</span>,<span class="number">0x48</span>,<span class="number">0xff</span>,<span class="number">0xd3</span>,<span class="number">0xeb</span>,<span class="number">0x14</span>,<span class="number">0x68</span>,<span class="number">0x25</span>,<span class="number">0x73</span>,<span class="number">0x0</span>,<span class="number">0x0</span>,<span class="number">0x8b</span>,<span class="number">0xc4</span>,<span class="number">0x68</span>,<span class="number">0x79</span>,<span class="number">0x65</span>,<span class="number">0x73</span>,<span class="number">0x0</span>,<span class="number">0x54</span>,<span class="number">0x50</span>,<span class="number">0x8b</span>,<span class="number">0x5c</span>,<span class="number">0x24</span>,<span class="number">0x48</span>,<span class="number">0xff</span>,<span class="number">0xd3</span>,<span class="number">0x58</span>,<span class="number">0x58</span>,<span class="number">0x58</span>,<span class="number">0x58</span>,<span class="number">0x58</span>,<span class="number">0x58</span>,<span class="number">0x58</span>,<span class="number">0x58</span>,<span class="number">0x58</span>,<span class="number">0x61</span>,<span class="number">0xc3</span>,<span class="number">0x58</span>,<span class="number">0x5f</span>,<span class="number">0x5a</span>,<span class="number">0x8b</span>,<span class="number">0x12</span>,<span class="number">0xe9</span>,<span class="number">0xb</span>,<span class="number">0xff</span>,<span class="number">0xff</span>,<span class="number">0xff</span> };</span><br><span class="line"><span class="keyword">void</span>* data = VirtualAlloc(<span class="number">0</span>, <span class="number">264</span>, <span class="number">0x00001000</span>, <span class="number">0x40</span>);</span><br><span class="line"><span class="built_in">memcpy</span>(data, a, <span class="number">264</span> * <span class="keyword">sizeof</span>(<span class="keyword">unsigned</span> <span class="keyword">char</span>));</span><br><span class="line">func test = (func)data;</span><br><span class="line"><span class="keyword">char</span> str[<span class="number">15</span>] = <span class="string">"aaaaaaaaaaaaaa"</span>;</span><br><span class="line">test((<span class="keyword">unsigned</span> <span class="keyword">int</span>(_cdecl*)(<span class="keyword">unsigned</span> <span class="keyword">int</span>))<span class="built_in">printf</span>,str,<span class="number">0</span>,<span class="number">264</span>,<span class="number">4096</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>编译成<code>32位</code>可执行文件，调试定位到flag的check点。</p><p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20220323221616553.png" alt="image-20220323221616553"></p><p>察check_num和v23的变化，发现基本结构一致，故只要让v22[i]=flag[i]-v17[i]%5，那么v23最终结果一定和check num相同，所有数据均可通过调试获得。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> m</span><br><span class="line">v17=<span class="string">'LoadLibraryExA'</span></span><br><span class="line">v22=[<span class="number">0x69</span>, <span class="number">0x73</span>, <span class="number">0x20</span>, <span class="number">0x70</span>, <span class="number">0x72</span>, <span class="number">0x6F</span>, <span class="number">0x67</span>, <span class="number">0x72</span>, <span class="number">0x61</span>, <span class="number">0x6D</span>, <span class="number">0x20</span>, <span class="number">0x63</span>, <span class="number">0x61</span>, <span class="number">0x6E</span>]</span><br><span class="line">flag=<span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">14</span>):</span><br><span class="line">       flag+=<span class="built_in">chr</span>(v22[i]+<span class="built_in">ord</span>(v17[i])%<span class="number">5</span>)</span><br></pre></td></tr></tbody></table></figure><p>当然github上也能找到针对<a href="https://github.com/ergrelet/unlicense">WinLicense/Themida 2.x 和 3.x脱壳</a>的工具，不过attach这种方法更趋向于通解，即可能适用于多种壳型。</p><h2 id="foreign-challenges">foreign challenges</h2><blockquote><p>浅浅记录一下近期国际比赛上的一些题目，容易踩坑或者考点比较新颖。</p></blockquote><h3 id="OFPPT-CTF-unicode">OFPPT-CTF . unicode</h3><p><code>unicode2utf-8</code></p><p>题目给了一个<code>flag.jpg.utf8</code>的文件，将图片存为了utf-8编码的格式。<a href="https://www.utf8-chartable.de/unicode-utf8-table.pl?utf8=dec">unicode-utf-8对照表</a></p><p>只需要将utf-8读入转为unicode编码，python3的chr和ord函数默认是以unicode编码来处理字符的，所以只需以utf-8编码格式读取数据，再用ord遍历就拿到了对应的unicode值。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line">f=codecs.<span class="built_in">open</span>(<span class="string">r'flag.jpg.utf8'</span>,<span class="string">'r'</span>,encoding=<span class="string">'utf-8'</span>).read()</span><br><span class="line"><span class="comment"># print(f)</span></span><br><span class="line">s=[]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> f:</span><br><span class="line">    s.append(<span class="built_in">ord</span>(i))</span><br><span class="line">f=<span class="built_in">open</span>(<span class="string">r'flag.jpg'</span>,<span class="string">'wb'</span>).write(<span class="built_in">bytes</span>(s))</span><br></pre></td></tr></tbody></table></figure><blockquote><p>codecs是python用于处理文本编码的包，支持多种编码。…其实这题挺坑的…</p></blockquote><h3 id="xxx-game">xxx_game</h3><p><code>python打包的elf files</code></p><blockquote><p>python打包的elf文件，之前多是打包exe，并且pyinstaller打包的exe图标很容易识别。还有一种是py2exe打包，较前者出现频率较少，并且打包exe文件查看strings窗口会有PY2EXE的字符。</p></blockquote><p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20220327210353884.png" alt="image-20220327210353884"></p><p>根据strings窗口下很多py命名的函数，所以认为是经过了pyc文件经过打包生成的exe，直接用pyinstxtractor解包会出错，正确步骤如下。</p><p>参考<a href="https://github.com/extremecoders-re/pyinstxtractor/wiki/Extracting-Linux-ELF-binaries">Extracting Linux ELF binaries</a>第一种简单的方法。</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#Using objcopy dump the section named pydata to a file.</span><br><span class="line">objcopy --dump-section pydata=pydata.dump testfile.elf</span><br><span class="line"></span><br><span class="line">#Now you can run pyinstxtractor on the dumped file.</span><br><span class="line">python2 pyinstxtractor.py pydata.dump</span><br></pre></td></tr></tbody></table></figure><p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20220327211244130.png" alt="image-20220327211244130"></p><p>之后顺序同打包exe的解法一致。</p><h3 id="picoCTF-game2">picoCTF_game2</h3><p><code>hide and exec code</code></p><blockquote><p>通过对称加密算法来解码code并执行，当然可以通过给出高版本的pyc文件来让这个问题更有趣。</p></blockquote><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> cryptography.fernet <span class="keyword">import</span> Fernet</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b'gAAAAABiMD1Dt87s50caSunQlHoZqPOwtGNaQXexN-gjKwZeuLEN_-v6UcFJHVXOT4B6DcD1SB7cnd6yTcHg9e9LZCAeJY2cJ0r0sfyGPRiH60F-WbkyUjlAdDywI8RPdTpDYLuBmpZ_Kun-kHyTzMjeKR6R26Z4JITUS8n7Dj9X--9eNLajH6UuYD4GkjRACpsidl_8z33DlB86u_xDCMMm7HFK2oJTs8HG1fBex6enQsu0frUAJbx56DxhRvWawAysDMtLE50vaohrzkVV7Yaz4ClilwgfjQ=='</span></span><br><span class="line"></span><br><span class="line">key_str = <span class="string">'correctstaplecorrectstaplecorrec'</span></span><br><span class="line">key_base64 = base64.b64encode(key_str.encode())</span><br><span class="line">f = Fernet(key_base64)</span><br><span class="line">plain = f.decrypt(payload)</span><br><span class="line"><span class="built_in">print</span>(plain)</span><br><span class="line"></span><br><span class="line"><span class="comment"># exec(plain.decode())</span></span><br><span class="line"><span class="comment">#b"\npw = input('What\\'s the password? ')\n\nif pw == 'batteryhorse':\n  print('picoCTF{175_chr157m45_8aef58d2}')\nelse:\n  print('That password is incorrect.')\n\n"</span></span><br></pre></td></tr></tbody></table></figure><h3 id="Gandalf-Baba">Gandalf Baba</h3><p><code>apk-webview-js</code></p><p><code>webview</code>封装的apk程序,主要通过调用js来进行交互，需要进行get传参，并且请求头满足要求才能getflag。</p><p><strong>js代码在assets文件下，内容如下。</strong></p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">User=MyInterface.GetUser();</span><br><span class="line">Serial=MyInterface.GetSerial();</span><br><span class="line">Model=MyInterface.GetModel();</span><br><span class="line">Product=MyInterface.GetProduct();</span><br><span class="line">Auth=MyInterface.GetAuth();</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myFunction</span>(<span class="params"></span>) </span>{</span><br><span class="line">  <span class="keyword">var</span> x = <span class="built_in">document</span>.getElementById(<span class="string">"myTable"</span>).rows[<span class="number">1</span>].cells;</span><br><span class="line">  x[<span class="number">0</span>].innerHTML =User ;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">var</span> y = <span class="built_in">document</span>.getElementById(<span class="string">"myTable"</span>).rows[<span class="number">1</span>].cells;</span><br><span class="line">  x[<span class="number">1</span>].innerHTML =Serial;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">var</span> z = <span class="built_in">document</span>.getElementById(<span class="string">"myTable"</span>).rows[<span class="number">1</span>].cells;</span><br><span class="line">  x[<span class="number">2</span>].innerHTML =Model ;</span><br><span class="line">   <span class="keyword">var</span> a = <span class="built_in">document</span>.getElementById(<span class="string">"myTable"</span>).rows[<span class="number">1</span>].cells;</span><br><span class="line">  x[<span class="number">3</span>].innerHTML =Product ;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">var</span> b = <span class="built_in">document</span>.getElementById(<span class="string">"myTable"</span>).rows[<span class="number">1</span>].cells;</span><br><span class="line">  x[<span class="number">4</span>].innerHTML =Auth ;</span><br><span class="line">}</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></tbody></table></figure><p>其中并没有调用关键的flag函数，故可以添加该函数并重新打包签名，当然也可以直接逆向关键函数的逻辑，这里我采用后者。</p><p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20220327213347459.png" alt="image-20220327213347459"></p><p>对题目给出的网站get传入参数，满足其请求头的内容要求即可绕过Gandalf Baba成功拿到flag。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">a=<span class="string">'RheO5PB6mfL5N3YBH45e5XuCEaWpvWUFESqTYnZk'</span></span><br><span class="line">c=[<span class="number">38</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">60</span>, <span class="number">93</span>, <span class="number">49</span>, <span class="number">50</span>, <span class="number">95</span>, <span class="number">25</span>, <span class="number">22</span>, <span class="number">45</span>, <span class="number">71</span>, <span class="number">47</span>, <span class="number">94</span>, <span class="number">60</span>, <span class="number">54</span>, <span class="number">45</span>, <span class="number">70</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(c)):</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">chr</span>(c[i]^<span class="built_in">ord</span>(a[i])),end=<span class="string">''</span>)</span><br><span class="line"><span class="built_in">print</span>()</span><br><span class="line">c=[<span class="number">80</span>, <span class="number">104</span>, <span class="number">97</span>, <span class="number">67</span>, <span class="number">36</span>, <span class="number">64</span>, <span class="number">66</span>, <span class="number">52</span>, <span class="number">97</span>, <span class="number">100</span>, <span class="number">64</span>, <span class="number">33</span>, <span class="number">70</span>, <span class="number">33</span>, <span class="number">72</span>, <span class="number">64</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">bytes</span>(c))</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests <span class="keyword">as</span> req</span><br><span class="line">headers = {<span class="string">'user-agent'</span>: <span class="string">'PhaC$@B4ad@!F!H@'</span>,</span><br><span class="line">           <span class="string">'Accept-Language'</span>:<span class="string">"From JavaScript Interface"</span></span><br><span class="line">           }</span><br><span class="line"></span><br><span class="line">resp = req.get(<span class="string">"https://teambounters.com/shapa.php?theshapitparameter=givemeflag"</span>,headers=headers)</span><br><span class="line"><span class="built_in">print</span>(resp.text)</span><br><span class="line"><span class="comment">#参考: https://geek-docs.com/python/python-tutorial/python-requests.html</span></span><br></pre></td></tr></tbody></table></figure><blockquote><p>虎符的Contra 2048也采用的webview封装，对js和消息处理目前还不是太了解，之后会给出复现。</p></blockquote><h3 id="Tutctf-unitea">Tutctf-unitea</h3><p><code>python unicorn模拟二进制代码 </code></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">import</span> unicorn</span><br><span class="line">    <span class="keyword">except</span> ModuleNotFoundError:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"unicorn Error: pip install unicorn"</span>)</span><br><span class="line">        exit()</span><br><span class="line">    <span class="keyword">import</span> unicorn.x86_const</span><br><span class="line">    <span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">    flag = <span class="built_in">input</span>(<span class="string">"input your password: "</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">len</span>(flag) == <span class="number">32</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"wrong"</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    CODE_ADDR = <span class="number">0x41000</span></span><br><span class="line">    CODE_LEN = <span class="number">0x10000</span></span><br><span class="line">    DATA_ADDR = <span class="number">0x51000</span></span><br><span class="line">    DATA_LEN = <span class="number">0x10000</span></span><br><span class="line">    STACK_ADDR = DATA_ADDR + <span class="number">0x9000</span></span><br><span class="line">    data = <span class="built_in">bytearray</span>([<span class="built_in">ord</span>(c) ^ <span class="number">0xAB</span> <span class="keyword">for</span> c <span class="keyword">in</span> flag])</span><br><span class="line">    keys = base64.b64decode(<span class="string">b"Z0UjAe/Nq4mYutz+EDJUdg=="</span>)</span><br><span class="line">    code = base64.b64decode(</span><br><span class="line">        <span class="string">b"SDPASD2vAAAAfw2QkJCQgDQHfEj/wOvrPSs9Kj0pPSgpKyovNfWxNPWrwXx8fHyXKvWsvZx4fYw68UB+OE2EPfWrPb2TeT19ozhNhH29Pf2UtfodOvW0vZx4OH2kOvFAfThNhD31sz29k3k5fas4TYR9vj3/vX09/4VjAsg99XI99WhY/7l+/4F7A1M0H7kx8Qj5fD33cjHxGPl4PfdoWPdL9yN4OPcjdDj3K3A9xXx8fHw9xHx8fHyXwCciIyE9ID0hPSI9Iw=="</span></span><br><span class="line">    )</span><br><span class="line">    machine = unicorn.Uc(unicorn.UC_ARCH_X86, unicorn.UC_MODE_64)</span><br><span class="line">    machine.mem_map(CODE_ADDR, CODE_LEN)</span><br><span class="line">    machine.mem_write(CODE_ADDR, code)</span><br><span class="line">    machine.mem_map(DATA_ADDR, DATA_LEN)</span><br><span class="line">    machine.mem_write(DATA_ADDR, <span class="built_in">bytes</span>(data))</span><br><span class="line">    machine.mem_write(DATA_ADDR + <span class="number">0x1000</span>, keys)</span><br><span class="line">    machine.reg_write(unicorn.x86_const.UC_X86_REG_RBP, STACK_ADDR)</span><br><span class="line">    machine.reg_write(unicorn.x86_const.UC_X86_REG_RSP, STACK_ADDR)</span><br><span class="line">    machine.reg_write(unicorn.x86_const.UC_X86_REG_RCX, DATA_ADDR)</span><br><span class="line">    machine.reg_write(unicorn.x86_const.UC_X86_REG_RDX, DATA_ADDR + <span class="number">0x1000</span>)</span><br><span class="line">    machine.reg_write(unicorn.x86_const.UC_X86_REG_RDI, CODE_ADDR + <span class="number">0x18</span>) <span class="comment"># smc开始处</span></span><br><span class="line">    machine.emu_start(CODE_ADDR, CODE_ADDR + <span class="built_in">len</span>(code))</span><br><span class="line">    </span><br><span class="line">    data = <span class="built_in">bytearray</span>(machine.mem_read(DATA_ADDR, <span class="number">32</span>))</span><br><span class="line">    <span class="keyword">if</span> base64.b64encode(data) == <span class="string">b"M0EVk4axKRsXVUSramrA4wfg5xarslKPxZgP3WVYDOY="</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"success"</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"wrong, try harder"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></tbody></table></figure><p>观察程序流程，首先输入32位的flag之后与0xab异或，并且通过<code> Unicorn Engine</code>执行base64解密出的shellcode，并分配了内存空间设置了寄存器的值。</p><p>其实可以将通过函数指针来调用，不过既然是python来模拟的，那么我们就用<code>Capstone</code>来对代码进行反汇编，因为shellcode的函数参数类型等不好确定</p><blockquote><p>Capstone是一款反编译器，支持x86、arm、mips等架构，通过调用一些api函数可以进行汇编和反汇编。</p></blockquote><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> capstone <span class="keyword">import</span> Cs, CS_ARCH_X86, CS_MODE_64, CsError</span><br><span class="line"></span><br><span class="line">code = base64.b64decode( <span class="string">b"SDPASD2vAAAAfw2QkJCQgDQHfEj/wOvrPSs9Kj0pPSgpKyovNfWxNPWrwXx8fHyXKvWsvZx4fYw68UB+OE2EPfWrPb2TeT19ozhNhH29Pf2UtfodOvW0vZx4OH2kOvFAfThNhD31sz29k3k5fas4TYR9vj3/vX09/4VjAsg99XI99WhY/7l+/4F7A1M0H7kx8Qj5fD33cjHxGPl4PfdoWPdL9yN4OPcjdDj3K3A9xXx8fHw9xHx8fHyXwCciIyE9ID0hPSI9Iw=="</span></span><br><span class="line">)</span><br><span class="line">md = Cs(CS_ARCH_X86, CS_MODE_64)</span><br><span class="line"><span class="keyword">for</span> instruction <span class="keyword">in</span> md.disasm(<span class="built_in">bytes</span>(code), <span class="number">0</span>):<span class="comment">#第一个参数是要反汇编的机器码 第二个参数是起始地址</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"0x%x:\t%s\t%s"</span> % (instruction.address, instruction.mnemonic, instruction.op_str))</span><br><span class="line">    </span><br></pre></td></tr></tbody></table></figure><p>disasm函数翻译到错误代码停止或完整反汇编code结束,显然之后的代码出现了问题。</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">;machine.reg_write(unicorn.x86_const.UC_X86_REG_RDI, CODE_ADDR + 0x18)</span><br><span class="line">0x0:xorrax, rax</span><br><span class="line">0x3:cmprax, 0xaf</span><br><span class="line">0x9:jg0x18</span><br><span class="line">0xb:nop</span><br><span class="line">0xc:nop</span><br><span class="line">0xd:nop</span><br><span class="line">0xe:nop</span><br><span class="line">0xf:xorbyte ptr [rdi + rax], 0x7c  </span><br><span class="line">0x13:incrax</span><br><span class="line">0x16:jmp3</span><br><span class="line">0x18:cmpeax, 0x3d2a3d2b</span><br><span class="line">0x1d:subdword ptr [rip + 0x2a2b2928], edi</span><br></pre></td></tr></tbody></table></figure><p>可知RDI指向代码0x18处，而上述代码块对0x18开始的0xaf字节异或了0x7c，故此段位自修改代码，需要先对0x18后的code异或0x7c再进行反汇编，得到如下指令。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="number">0x0</span>:xorrax, rax</span><br><span class="line"><span class="number">0x3</span>:cmprax, <span class="number">0xaf</span></span><br><span class="line"><span class="number">0x9</span>:jg<span class="number">0x18</span></span><br><span class="line"><span class="number">0xb</span>:nop</span><br><span class="line"><span class="number">0xc</span>:nop</span><br><span class="line"><span class="number">0xd</span>:nop</span><br><span class="line"><span class="number">0xe</span>:nop</span><br><span class="line"><span class="number">0xf</span>:xorbyte ptr [rdi + rax], <span class="number">0x7c</span></span><br><span class="line"><span class="number">0x13</span>:incrax</span><br><span class="line"><span class="number">0x16</span>:jmp<span class="number">3</span></span><br><span class="line"><span class="number">0x18</span>:cmpeax, <span class="number">0x3d2a3d2b</span></span><br><span class="line"><span class="number">0x1d</span>:subdword ptr [rip + <span class="number">0x2a2b2928</span>], edi</span><br><span class="line"><span class="number">0x0</span>:pushr15</span><br><span class="line"><span class="number">0x2</span>:pushr14</span><br><span class="line"><span class="number">0x4</span>:pushr13</span><br><span class="line"><span class="number">0x6</span>:pushr12</span><br><span class="line"><span class="number">0x8</span>:pushrbp</span><br><span class="line"><span class="number">0x9</span>:pushrdi</span><br><span class="line"><span class="number">0xa</span>:pushrsi</span><br><span class="line"><span class="number">0xb</span>:pushrbx</span><br><span class="line"><span class="number">0xc</span>:movr13, rcx</span><br><span class="line"><span class="number">0xf</span>:movrdi, rdx</span><br><span class="line"><span class="number">0x12</span>:movebp, <span class="number">0</span></span><br><span class="line"><span class="number">0x17</span>:jmp<span class="number">0x6f</span></span><br><span class="line"><span class="number">0x19</span>:moveax, edx</span><br><span class="line"><span class="number">0x1b</span>:shleax, <span class="number">4</span></span><br><span class="line"><span class="number">0x1e</span>:addeax, esi</span><br><span class="line"><span class="number">0x20</span>:lear15d, [rdx + r8]</span><br><span class="line"><span class="number">0x24</span>:xoreax, r15d</span><br><span class="line"><span class="number">0x27</span>:movr15d, edx</span><br><span class="line"><span class="number">0x2a</span>:shrr15d, <span class="number">5</span></span><br><span class="line"><span class="number">0x2e</span>:addr15d, ebx</span><br><span class="line"><span class="number">0x31</span>:xoreax, r15d</span><br><span class="line"><span class="number">0x34</span>:addecx, eax</span><br><span class="line"><span class="number">0x36</span>:subr8d, <span class="number">0x466186c9</span></span><br><span class="line"><span class="number">0x3d</span>:moveax, ecx</span><br><span class="line"><span class="number">0x3f</span>:shleax, <span class="number">4</span></span><br><span class="line"><span class="number">0x42</span>:addeax, r11d</span><br><span class="line"><span class="number">0x45</span>:lear15d, [rcx + r8]</span><br><span class="line"><span class="number">0x49</span>:xoreax, r15d</span><br><span class="line"><span class="number">0x4c</span>:movr15d, ecx</span><br><span class="line"><span class="number">0x4f</span>:shrr15d, <span class="number">5</span></span><br><span class="line"><span class="number">0x53</span>:addr15d, r10d</span><br><span class="line"><span class="number">0x56</span>:xoreax, r15d</span><br><span class="line"><span class="number">0x59</span>:addedx, eax</span><br><span class="line"><span class="number">0x5b</span>:addr9d, <span class="number">1</span></span><br><span class="line"><span class="number">0x5f</span>:cmpr9d, <span class="number">0x1f</span></span><br><span class="line"><span class="number">0x63</span>:jle<span class="number">0x19</span></span><br><span class="line"><span class="number">0x65</span>:movdword ptr [r14], ecx</span><br><span class="line"><span class="number">0x68</span>:movdword ptr [r12], edx</span><br><span class="line"><span class="number">0x6c</span>:addebp, <span class="number">2</span></span><br><span class="line"><span class="number">0x6f</span>:cmpebp, <span class="number">7</span></span><br><span class="line"><span class="number">0x72</span>:jg<span class="number">0xa3</span></span><br><span class="line"><span class="number">0x74</span>:movsxdrax, ebp</span><br><span class="line"><span class="number">0x77</span>:lear14, [r13 + rax*<span class="number">4</span>]</span><br><span class="line"><span class="number">0x7c</span>:movecx, dword ptr [r14]</span><br><span class="line"><span class="number">0x7f</span>:lear12, [r13 + rax*<span class="number">4</span> + <span class="number">4</span>]</span><br><span class="line"><span class="number">0x84</span>:movedx, dword ptr [r12]</span><br><span class="line"><span class="number">0x88</span>:movesi, dword ptr [rdi]</span><br><span class="line"><span class="number">0x8a</span>:movebx, dword ptr [rdi + <span class="number">4</span>]</span><br><span class="line"><span class="number">0x8d</span>:movr11d, dword ptr [rdi + <span class="number">8</span>]</span><br><span class="line"><span class="number">0x91</span>:movr10d, dword ptr [rdi + <span class="number">0xc</span>]</span><br><span class="line"><span class="number">0x95</span>:movr9d, <span class="number">0</span></span><br><span class="line"><span class="number">0x9b</span>:movr8d, <span class="number">0</span></span><br><span class="line"><span class="number">0xa1</span>:jmp<span class="number">0x5f</span></span><br><span class="line"><span class="number">0xa3</span>:poprbx</span><br><span class="line"><span class="number">0xa4</span>:poprsi</span><br><span class="line"><span class="number">0xa5</span>:poprdi</span><br><span class="line"><span class="number">0xa6</span>:poprbp</span><br><span class="line"><span class="number">0xa7</span>:popr12</span><br><span class="line"><span class="number">0xa9</span>:popr13</span><br><span class="line"><span class="number">0xab</span>:popr14</span><br><span class="line"><span class="number">0xad</span>:popr15</span><br></pre></td></tr></tbody></table></figure><p>通过右移5和左移4外加题目名称可以确定是Tea系列，魔改了delta并且sum+=delta放到了v0的修改之后，参考unicorn中对寄存器的赋值，写出解密脚本。</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ut32 unsigned int</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> delta 0xb99e7937</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Tea_Decrypt</span><span class="params">(ut32* enc, ut32* k)</span> </span>{</span><br><span class="line">ut32 sum = delta * <span class="number">0x20</span>;</span><br><span class="line">ut32 v0 = enc[<span class="number">0</span>];</span><br><span class="line">ut32 v1 = enc[<span class="number">1</span>];</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x20</span>; i++) {</span><br><span class="line">v1 -= ((v0 &lt;&lt; <span class="number">4</span>) + k[<span class="number">2</span>]) ^ (v0 + sum) ^ ((v0 &gt;&gt; <span class="number">5</span>) + k[<span class="number">3</span>]);</span><br><span class="line">sum -= delta;</span><br><span class="line">v0 -= ((v1 &lt;&lt; <span class="number">4</span>) + k[<span class="number">0</span>]) ^ (v1 + sum) ^ ((v1 &gt;&gt; <span class="number">5</span>) + k[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line">enc[<span class="number">0</span>] = v0;</span><br><span class="line">enc[<span class="number">1</span>] = v1;</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line"><span class="keyword">uint8_t</span> m[<span class="number">32</span>] = { <span class="number">51</span>, <span class="number">65</span>, <span class="number">21</span>, <span class="number">147</span>, <span class="number">134</span>, <span class="number">177</span>, <span class="number">41</span>, <span class="number">27</span>, <span class="number">23</span>, <span class="number">85</span>, <span class="number">68</span>, <span class="number">171</span>, <span class="number">106</span>, <span class="number">106</span>, <span class="number">192</span>, <span class="number">227</span>, <span class="number">7</span>, <span class="number">224</span>, <span class="number">231</span>, <span class="number">22</span>, <span class="number">171</span>, <span class="number">178</span>, <span class="number">82</span>, <span class="number">143</span>, <span class="number">197</span>, <span class="number">152</span>, <span class="number">15</span>, <span class="number">221</span>, <span class="number">101</span>, <span class="number">88</span>, <span class="number">12</span>, <span class="number">230</span> };</span><br><span class="line"><span class="keyword">uint8_t</span> k[<span class="number">16</span>] = { <span class="number">103</span>, <span class="number">69</span>, <span class="number">35</span>, <span class="number">1</span>, <span class="number">239</span>, <span class="number">205</span>, <span class="number">171</span>, <span class="number">137</span>, <span class="number">152</span>, <span class="number">186</span>, <span class="number">220</span>, <span class="number">254</span>, <span class="number">16</span>, <span class="number">50</span>, <span class="number">84</span>, <span class="number">118</span> };</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">32</span>; i += <span class="number">8</span>)</span><br><span class="line">Tea_Decrypt((ut32*)(m + i), (ut32*)(k));</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">32</span>; i++)</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%c"</span>, m[i] ^ <span class="number">0xab</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="amazing-code">amazing_code</h3><p><code>Evm Opcodes</code></p><p>打开附件，Evm Opcode，一般出现在智能合约的逆向，目前是有工具可以做到反编译的所以无需硬读。<a href="https://github.com/wolflo/evm-opcodes">github- Evm Opcode对照 HEX</a></p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">PUSH1<span class="number">0x80</span></span><br><span class="line">PUSH1<span class="number">0x40</span></span><br><span class="line">MSTORE</span><br><span class="line">PUSH1<span class="number">0x20</span></span><br><span class="line">PUSH1<span class="number">0xf8</span></span><br><span class="line">SHL</span><br><span class="line">PUSH1<span class="number">0x00</span></span><br><span class="line">DUP1</span><br><span class="line">PUSH2<span class="number">0x0100</span></span><br><span class="line">EXP</span><br><span class="line">...</span><br></pre></td></tr></tbody></table></figure><p>先将opcode转为16进制数据。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pyevmasm <span class="keyword">import</span> assemble_hex</span><br><span class="line"></span><br><span class="line">op=[<span class="string">'PUSH1'</span>, <span class="string">'MSTORE'</span>, <span class="string">'SHL'</span>, <span class="string">'DUP1'</span>, <span class="string">'PUSH2'</span>, <span class="string">'EXP'</span>, <span class="string">'DUP2'</span>, <span class="string">'SLOAD'</span>, <span class="string">'MUL'</span>, <span class="string">'NOT'</span>, <span class="string">'AND'</span>, <span class="string">'SWAP1'</span>, <span class="string">'DUP4'</span>, <span class="string">'SHR'</span>, <span class="string">'OR'</span>, <span class="string">'SSTORE'</span>, <span class="string">'POP'</span>, <span class="string">'DIV'</span>, <span class="string">'XOR'</span>, <span class="string">'CALLVALUE'</span>, <span class="string">'ISZERO'</span>, <span class="string">'JUMPI'</span>, <span class="string">'REVERT'</span>, <span class="string">'JUMPDEST'</span>, <span class="string">'CODECOPY'</span>, <span class="string">'RETURN'</span>, <span class="string">'INVALID'</span>, <span class="string">'CALLDATASIZE'</span>, <span class="string">'LT'</span>, <span class="string">'CALLDATALOAD'</span>, <span class="string">'PUSH4'</span>, <span class="string">'GT'</span>, <span class="string">'EQ'</span>, <span class="string">'JUMP'</span>, <span class="string">'MLOAD'</span>, <span class="string">'SWAP2'</span>, <span class="string">'SUB'</span>, <span class="string">'PUSH32'</span>, <span class="string">'DUP3'</span>, <span class="string">'ADD'</span>, <span class="string">'DUP5'</span>, <span class="string">'SWAP3'</span>, <span class="string">'LOG2'</span>, <span class="string">'PUSH5'</span>, <span class="string">'SLT'</span>, <span class="string">'SHA3'</span>, <span class="string">'PUSH19'</span>, <span class="string">'CALLER'</span>, <span class="string">'SDIV'</span>, <span class="string">'LOG4'</span>, <span class="string">'PUSH17'</span>]</span><br><span class="line">tb=[<span class="number">0x60</span>+i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>)]</span><br><span class="line">k=[]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> op:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        k.append(<span class="built_in">int</span>(assemble_hex(i),<span class="number">16</span>))</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        k.append(tb[<span class="built_in">int</span>(i[<span class="number">4</span>:])-<span class="number">1</span>])</span><br><span class="line">table=<span class="built_in">dict</span>(<span class="built_in">zip</span>(op,k))</span><br><span class="line"><span class="built_in">print</span>(table) <span class="comment">#根据用到的op生成字典</span></span><br><span class="line"></span><br><span class="line">table={<span class="string">'PUSH1'</span>: <span class="number">96</span>, <span class="string">'MSTORE'</span>: <span class="number">82</span>, <span class="string">'SHL'</span>: <span class="number">27</span>, <span class="string">'DUP1'</span>: <span class="number">128</span>, <span class="string">'PUSH2'</span>: <span class="number">97</span>, <span class="string">'EXP'</span>: <span class="number">10</span>, <span class="string">'DUP2'</span>: <span class="number">129</span>, <span class="string">'SLOAD'</span>: <span class="number">84</span>, <span class="string">'MUL'</span>: <span class="number">2</span>, <span class="string">'NOT'</span>: <span class="number">25</span>, <span class="string">'AND'</span>: <span class="number">22</span>, <span class="string">'SWAP1'</span>: <span class="number">144</span>, <span class="string">'DUP4'</span>: <span class="number">131</span>, <span class="string">'SHR'</span>: <span class="number">28</span>, <span class="string">'OR'</span>: <span class="number">23</span>, <span class="string">'SSTORE'</span>: <span class="number">85</span>, <span class="string">'POP'</span>: <span class="number">80</span>, <span class="string">'DIV'</span>: <span class="number">4</span>, <span class="string">'XOR'</span>: <span class="number">24</span>, <span class="string">'CALLVALUE'</span>: <span class="number">52</span>, <span class="string">'ISZERO'</span>: <span class="number">21</span>, <span class="string">'JUMPI'</span>: <span class="number">87</span>, <span class="string">'REVERT'</span>: <span class="number">253</span>, <span class="string">'JUMPDEST'</span>: <span class="number">91</span>, <span class="string">'CODECOPY'</span>: <span class="number">57</span>, <span class="string">'RETURN'</span>: <span class="number">243</span>, <span class="string">'INVALID'</span>: <span class="number">254</span>, <span class="string">'CALLDATASIZE'</span>: <span class="number">54</span>, <span class="string">'LT'</span>: <span class="number">16</span>, <span class="string">'CALLDATALOAD'</span>: <span class="number">53</span>, <span class="string">'PUSH4'</span>: <span class="number">99</span>, <span class="string">'GT'</span>: <span class="number">17</span>, <span class="string">'EQ'</span>: <span class="number">20</span>, <span class="string">'JUMP'</span>: <span class="number">86</span>, <span class="string">'MLOAD'</span>: <span class="number">81</span>, <span class="string">'SWAP2'</span>: <span class="number">145</span>, <span class="string">'SUB'</span>: <span class="number">3</span>, <span class="string">'PUSH32'</span>: <span class="number">127</span>, <span class="string">'DUP3'</span>: <span class="number">130</span>, <span class="string">'ADD'</span>: <span class="number">1</span>, <span class="string">'DUP5'</span>: <span class="number">132</span>, <span class="string">'SWAP3'</span>: <span class="number">146</span>, <span class="string">'LOG2'</span>: <span class="number">162</span>, <span class="string">'PUSH5'</span>: <span class="number">100</span>, <span class="string">'SLT'</span>: <span class="number">18</span>, <span class="string">'SHA3'</span>: <span class="number">32</span>, <span class="string">'PUSH19'</span>: <span class="number">114</span>, <span class="string">'CALLER'</span>: <span class="number">51</span>, <span class="string">'SDIV'</span>: <span class="number">5</span>, <span class="string">'LOG4'</span>: <span class="number">164</span>, <span class="string">'PUSH17'</span>: <span class="number">112</span>}</span><br><span class="line">f=<span class="built_in">open</span>(<span class="string">r'amazing_code'</span>,<span class="string">'r'</span>)</span><br><span class="line">byt=<span class="string">''</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    buf=f.readline()</span><br><span class="line">    <span class="keyword">if</span> buf:</span><br><span class="line">        stu=buf.replace(<span class="string">'\n'</span>,<span class="string">''</span>).split(<span class="string">''</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            byt+=<span class="built_in">hex</span>(table[stu[<span class="number">0</span>]])[<span class="number">2</span>:].zfill(<span class="number">2</span>)+stu[<span class="number">1</span>].replace(<span class="string">'0x'</span>,<span class="string">''</span>)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"><span class="built_in">print</span>(byt)</span><br></pre></td></tr></tbody></table></figure><p>得到的16进制数据可以通过<a href="https://ethervm.io/decompile">Online Solidity Decompiler</a>在线反编译，结果可能有些偏差比较难读，关键部分还是要参考字节码文件。</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line">contract Contract {</span><br><span class="line">    function main() {</span><br><span class="line">        memory[0x40:0x60] = 0x80;</span><br><span class="line">        storage[0x00] = (storage[0x00] &amp; ~0xff) | ((0x20 &lt;&lt; 0xf8) &gt;&gt; 0xf8);</span><br><span class="line">        storage[0x00] = (storage[0x00] &amp; ~(0xff * 0x0100 ** 0x01)) | ((0x53 &lt;&lt; 0xf8) &gt;&gt; 0xf8) * 0x0100 ** 0x01;</span><br><span class="line">        storage[0x00] = (storage[0x00] &amp; ~(0xff * 0x0100 ** 0x02)) | ((0x6f &lt;&lt; 0xf8) &gt;&gt; 0xf8) * 0x0100 ** 0x02;</span><br><span class="line">        storage[0x00] = (storage[0x00] &amp; ~(0xff * 0x0100 ** 0x03)) | ((0x6c &lt;&lt; 0xf8) &gt;&gt; 0xf8) * 0x0100 ** 0x03;</span><br><span class="line">        storage[0x00] = (storage[0x00] &amp; ~(0xff * 0x0100 ** 0x04)) | ((0x69 &lt;&lt; 0xf8) &gt;&gt; 0xf8) * 0x0100 ** 0x04;</span><br><span class="line">        storage[0x00] = (storage[0x00] &amp; ~(0xff * 0x0100 ** 0x05)) | ((0x64 &lt;&lt; 0xf8) &gt;&gt; 0xf8) * 0x0100 ** 0x05;</span><br><span class="line">        storage[0x00] = (storage[0x00] &amp; ~(0xff * 0x0100 ** 0x06)) | ((0x60 &lt;&lt; 0xf8) &gt;&gt; 0xf8) * 0x0100 ** 0x06;</span><br><span class="line">        storage[0x00] = (storage[0x00] &amp; ~(0xff * 0x0100 ** 0x07)) | ((0x74 &lt;&lt; 0xf8) &gt;&gt; 0xf8) * 0x0100 ** 0x07;</span><br><span class="line">        storage[0x00] = (storage[0x00] &amp; ~(0xff * 0x0100 ** 0x08)) | ((0x79 &lt;&lt; 0xf8) &gt;&gt; 0xf8) * 0x0100 ** 0x08;</span><br><span class="line">        storage[0x00] = (storage[0x00] &amp; ~(0xff * 0x0100 ** 0x09)) | ((0x5f &lt;&lt; 0xf8) &gt;&gt; 0xf8) * 0x0100 ** 0x09;</span><br><span class="line">        storage[0x00] = (storage[0x00] &amp; ~(0xff * 0x0100 ** 0x0a)) | ((0x42 &lt;&lt; 0xf8) &gt;&gt; 0xf8) * 0x0100 ** 0x0a;</span><br><span class="line">        storage[0x00] = (storage[0x00] &amp; ~(0xff * 0x0100 ** 0x0b)) | ((0x69 &lt;&lt; 0xf8) &gt;&gt; 0xf8) * 0x0100 ** 0x0b;</span><br><span class="line">        storage[0x00] = (storage[0x00] &amp; ~(0xff * 0x0100 ** 0x0c)) | ((0x74 &lt;&lt; 0xf8) &gt;&gt; 0xf8) * 0x0100 ** 0x0c;</span><br><span class="line">        storage[0x00] = (storage[0x00] &amp; ~(0xff * 0x0100 ** 0x0d)) | ((0x77 &lt;&lt; 0xf8) &gt;&gt; 0xf8) * 0x0100 ** 0x0d;</span><br><span class="line">        storage[0x00] = (storage[0x00] &amp; ~(0xff * 0x0100 ** 0x0e)) | ((0x69 &lt;&lt; 0xf8) &gt;&gt; 0xf8) * 0x0100 ** 0x0e;</span><br><span class="line">        storage[0x00] = (storage[0x00] &amp; ~(0xff * 0x0100 ** 0x0f)) | ((0x73 &lt;&lt; 0xf8) &gt;&gt; 0xf8) * 0x0100 ** 0x0f;</span><br><span class="line">        storage[0x00] = (storage[0x00] &amp; ~(0xff * 0x0100 ** 0x10)) | ((0x65 &lt;&lt; 0xf8) &gt;&gt; 0xf8) * 0x0100 ** 0x10;</span><br><span class="line">        storage[0x00] = (storage[0x00] &amp; ~(0xff * 0x0100 ** 0x11)) | ((0x5f &lt;&lt; 0xf8) &gt;&gt; 0xf8) * 0x0100 ** 0x11;</span><br><span class="line">        storage[0x00] = (storage[0x00] &amp; ~(0xff * 0x0100 ** 0x12)) | ((0x4f &lt;&lt; 0xf8) &gt;&gt; 0xf8) * 0x0100 ** 0x12;</span><br><span class="line">        storage[0x00] = (storage[0x00] &amp; ~(0xff * 0x0100 ** 0x13)) | ((0x70 &lt;&lt; 0xf8) &gt;&gt; 0xf8) * 0x0100 ** 0x13;</span><br><span class="line">        storage[0x00] = (storage[0x00] &amp; ~(0xff * 0x0100 ** 0x14)) | ((0x65 &lt;&lt; 0xf8) &gt;&gt; 0xf8) * 0x0100 ** 0x14;</span><br><span class="line">        storage[0x00] = (storage[0x00] &amp; ~(0xff * 0x0100 ** 0x15)) | ((0x72 &lt;&lt; 0xf8) &gt;&gt; 0xf8) * 0x0100 ** 0x15;</span><br><span class="line">        storage[0x00] = (storage[0x00] &amp; ~(0xff * 0x0100 ** 0x16)) | ((0x61 &lt;&lt; 0xf8) &gt;&gt; 0xf8) * 0x0100 ** 0x16;</span><br><span class="line">        storage[0x00] = (storage[0x00] &amp; ~(0xff * 0x0100 ** 0x17)) | ((0x74 &lt;&lt; 0xf8) &gt;&gt; 0xf8) * 0x0100 ** 0x17;</span><br><span class="line">        storage[0x00] = (storage[0x00] &amp; ~(0xff * 0x0100 ** 0x18)) | ((0x69 &lt;&lt; 0xf8) &gt;&gt; 0xf8) * 0x0100 ** 0x18;</span><br><span class="line">        storage[0x00] = (storage[0x00] &amp; ~(0xff * 0x0100 ** 0x19)) | ((0x6f &lt;&lt; 0xf8) &gt;&gt; 0xf8) * 0x0100 ** 0x19;</span><br><span class="line">        storage[0x00] = (storage[0x00] &amp; ~(0xff * 0x0100 ** 0x1a)) | ((0x6e &lt;&lt; 0xf8) &gt;&gt; 0xf8) * 0x0100 ** 0x1a;</span><br><span class="line">        storage[0x00] = (storage[0x00] &amp; ~(0xff * 0x0100 ** 0x1b)) | 0x00;</span><br><span class="line">        storage[0x00] = (storage[0x00] &amp; ~(0xff * 0x0100 ** 0x1c)) | 0x00;</span><br><span class="line">        storage[0x00] = (storage[0x00] &amp; ~(0xff * 0x0100 ** 0x1d)) | 0x00;</span><br><span class="line">        storage[0x00] = (storage[0x00] &amp; ~(0xff * 0x0100 ** 0x1e)) | 0x00;</span><br><span class="line">        storage[0x00] = (storage[0x00] &amp; ~(0xff * 0x0100 ** 0x1f)) | 0x00;</span><br><span class="line">        storage[0x01] = (storage[0x01] &amp; ~0xff) | ((0x62 &lt;&lt; 0xf8) &gt;&gt; 0xf8);</span><br><span class="line">        storage[0x01] = (storage[0x01] &amp; ~(0xff * 0x0100 ** 0x01)) | ((0x10 &lt;&lt; 0xf8) &gt;&gt; 0xf8) * 0x0100 ** 0x01;</span><br><span class="line">        storage[0x01] = (storage[0x01] &amp; ~(0xff * 0x0100 ** 0x02)) | ((0x3b &lt;&lt; 0xf8) &gt;&gt; 0xf8) * 0x0100 ** 0x02;</span><br><span class="line">        storage[0x01] = (storage[0x01] &amp; ~(0xff * 0x0100 ** 0x03)) | ((0x2a &lt;&lt; 0xf8) &gt;&gt; 0xf8) * 0x0100 ** 0x03;</span><br><span class="line">        storage[0x01] = (storage[0x01] &amp; ~(0xff * 0x0100 ** 0x04)) | ((0x12 &lt;&lt; 0xf8) &gt;&gt; 0xf8) * 0x0100 ** 0x04;</span><br><span class="line">        storage[0x01] = (storage[0x01] &amp; ~(0xff * 0x0100 ** 0x05)) | ((0x26 &lt;&lt; 0xf8) &gt;&gt; 0xf8) * 0x0100 ** 0x05;</span><br><span class="line">        storage[0x01] = (storage[0x01] &amp; ~(0xff * 0x0100 ** 0x06)) | ((0x09 &lt;&lt; 0xf8) &gt;&gt; 0xf8) * 0x0100 ** 0x06;</span><br><span class="line">        storage[0x01] = (storage[0x01] &amp; ~(0xff * 0x0100 ** 0x07)) | 0x00;</span><br><span class="line">        storage[0x01] = (storage[0x01] &amp; ~(0xff * 0x0100 ** 0x08)) | ((0x26 &lt;&lt; 0xf8) &gt;&gt; 0xf8) * 0x0100 ** 0x08;</span><br><span class="line">        storage[0x01] = (storage[0x01] &amp; ~(0xff * 0x0100 ** 0x09)) | ((0x10 &lt;&lt; 0xf8) &gt;&gt; 0xf8) * 0x0100 ** 0x09;</span><br><span class="line">        storage[0x01] = (storage[0x01] &amp; ~(0xff * 0x0100 ** 0x0a)) | ((0x32 &lt;&lt; 0xf8) &gt;&gt; 0xf8) * 0x0100 ** 0x0a;</span><br><span class="line">        storage[0x01] = (storage[0x01] &amp; ~(0xff * 0x0100 ** 0x0b)) | ((0x0c &lt;&lt; 0xf8) &gt;&gt; 0xf8) * 0x0100 ** 0x0b;</span><br><span class="line">        storage[0x01] = (storage[0x01] &amp; ~(0xff * 0x0100 ** 0x0c)) | ((0x06 &lt;&lt; 0xf8) &gt;&gt; 0xf8) * 0x0100 ** 0x0c;</span><br><span class="line">        storage[0x01] = (storage[0x01] &amp; ~(0xff * 0x0100 ** 0x0d)) | ((0x16 &lt;&lt; 0xf8) &gt;&gt; 0xf8) * 0x0100 ** 0x0d;</span><br><span class="line">        storage[0x01] = (storage[0x01] &amp; ~(0xff * 0x0100 ** 0x0e)) | ((0x1d &lt;&lt; 0xf8) &gt;&gt; 0xf8) * 0x0100 ** 0x0e;</span><br><span class="line">        storage[0x01] = (storage[0x01] &amp; ~(0xff * 0x0100 ** 0x0f)) | ((0x1a &lt;&lt; 0xf8) &gt;&gt; 0xf8) * 0x0100 ** 0x0f;</span><br><span class="line">        storage[0x01] = (storage[0x01] &amp; ~(0xff * 0x0100 ** 0x10)) | ((0x0a &lt;&lt; 0xf8) &gt;&gt; 0xf8) * 0x0100 ** 0x10;</span><br><span class="line">        storage[0x01] = (storage[0x01] &amp; ~(0xff * 0x0100 ** 0x11)) | ((0x31 &lt;&lt; 0xf8) &gt;&gt; 0xf8) * 0x0100 ** 0x11;</span><br><span class="line">        storage[0x01] = (storage[0x01] &amp; ~(0xff * 0x0100 ** 0x12)) | ((0x3c &lt;&lt; 0xf8) &gt;&gt; 0xf8) * 0x0100 ** 0x12;</span><br><span class="line">        storage[0x01] = (storage[0x01] &amp; ~(0xff * 0x0100 ** 0x13)) | ((0x2f &lt;&lt; 0xf8) &gt;&gt; 0xf8) * 0x0100 ** 0x13;</span><br><span class="line">        storage[0x01] = (storage[0x01] &amp; ~(0xff * 0x0100 ** 0x14)) | ((0x2c &lt;&lt; 0xf8) &gt;&gt; 0xf8) * 0x0100 ** 0x14;</span><br><span class="line">        storage[0x01] = (storage[0x01] &amp; ~(0xff * 0x0100 ** 0x15)) | ((0x1c &lt;&lt; 0xf8) &gt;&gt; 0xf8) * 0x0100 ** 0x15;</span><br><span class="line">        storage[0x01] = (storage[0x01] &amp; ~(0xff * 0x0100 ** 0x16)) | ((0x3e &lt;&lt; 0xf8) &gt;&gt; 0xf8) * 0x0100 ** 0x16;</span><br><span class="line">        storage[0x01] = (storage[0x01] &amp; ~(0xff * 0x0100 ** 0x17)) | ((0x27 &lt;&lt; 0xf8) &gt;&gt; 0xf8) * 0x0100 ** 0x17;</span><br><span class="line">        storage[0x01] = (storage[0x01] &amp; ~(0xff * 0x0100 ** 0x18)) | ((0x06 &lt;&lt; 0xf8) &gt;&gt; 0xf8) * 0x0100 ** 0x18;</span><br><span class="line">        storage[0x01] = (storage[0x01] &amp; ~(0xff * 0x0100 ** 0x19)) | ((0x03 &lt;&lt; 0xf8) &gt;&gt; 0xf8) * 0x0100 ** 0x19;</span><br><span class="line">        storage[0x01] = (storage[0x01] &amp; ~(0xff * 0x0100 ** 0x1a)) | ((0x07 &lt;&lt; 0xf8) &gt;&gt; 0xf8) * 0x0100 ** 0x1a;</span><br><span class="line">        storage[0x01] = (storage[0x01] &amp; ~(0xff * 0x0100 ** 0x1b)) | ((0x64 &lt;&lt; 0xf8) &gt;&gt; 0xf8) * 0x0100 ** 0x1b;</span><br><span class="line">        storage[0x01] = (storage[0x01] &amp; ~(0xff * 0x0100 ** 0x1c)) | ((0x69 &lt;&lt; 0xf8) &gt;&gt; 0xf8) * 0x0100 ** 0x1c;</span><br><span class="line">        storage[0x01] = (storage[0x01] &amp; ~(0xff * 0x0100 ** 0x1d)) | ((0x74 &lt;&lt; 0xf8) &gt;&gt; 0xf8) * 0x0100 ** 0x1d;</span><br><span class="line">        storage[0x01] = (storage[0x01] &amp; ~(0xff * 0x0100 ** 0x1e)) | ((0x79 &lt;&lt; 0xf8) &gt;&gt; 0xf8) * 0x0100 ** 0x1e;</span><br><span class="line">        storage[0x01] = (storage[0x01] &amp; ~(0xff * 0x0100 ** 0x1f)) | ((0x7d &lt;&lt; 0xf8) &gt;&gt; 0xf8) * 0x0100 ** 0x1f;</span><br><span class="line">        storage[0x02] = (((storage[0x00] &lt;&lt; 0xf8) ~ (storage[0x01] &lt;&lt; 0xf8)) &gt;&gt; 0xf8) | (storage[0x02] &amp; ~0xff);</span><br><span class="line">        storage[0x02] = (((storage[0x00] / 0x0100 ** 0x01 &lt;&lt; 0xf8) ~ (storage[0x01] / 0x0100 ** 0x01 &lt;&lt; 0xf8)) &gt;&gt; 0xf8) * 0x0100 ** 0x01 | (storage[0x02] &amp; ~(0xff * 0x0100 ** 0x01));</span><br><span class="line">        storage[0x02] = (((storage[0x00] / 0x0100 ** 0x02 &lt;&lt; 0xf8) ~ (storage[0x01] / 0x0100 ** 0x02 &lt;&lt; 0xf8)) &gt;&gt; 0xf8) * 0x0100 ** 0x02 | (storage[0x02] &amp; ~(0xff * 0x0100 ** 0x02));</span><br><span class="line">        storage[0x02] = (((storage[0x00] / 0x0100 ** 0x03 &lt;&lt; 0xf8) ~ (storage[0x01] / 0x0100 ** 0x03 &lt;&lt; 0xf8)) &gt;&gt; 0xf8) * 0x0100 ** 0x03 | (storage[0x02] &amp; ~(0xff * 0x0100 ** 0x03));</span><br><span class="line">        storage[0x02] = (((storage[0x00] / 0x0100 ** 0x04 &lt;&lt; 0xf8) ~ (storage[0x01] / 0x0100 ** 0x04 &lt;&lt; 0xf8)) &gt;&gt; 0xf8) * 0x0100 ** 0x04 | (storage[0x02] &amp; ~(0xff * 0x0100 ** 0x04));</span><br><span class="line">        storage[0x02] = (((storage[0x00] / 0x0100 ** 0x05 &lt;&lt; 0xf8) ~ (storage[0x01] / 0x0100 ** 0x05 &lt;&lt; 0xf8)) &gt;&gt; 0xf8) * 0x0100 ** 0x05 | (storage[0x02] &amp; ~(0xff * 0x0100 ** 0x05));</span><br><span class="line">        storage[0x02] = (((storage[0x00] / 0x0100 ** 0x06 &lt;&lt; 0xf8) ~ (storage[0x01] / 0x0100 ** 0x06 &lt;&lt; 0xf8)) &gt;&gt; 0xf8) * 0x0100 ** 0x06 | (storage[0x02] &amp; ~(0xff * 0x0100 ** 0x06));</span><br><span class="line">        storage[0x02] = (((storage[0x00] / 0x0100 ** 0x07 &lt;&lt; 0xf8) ~ (storage[0x01] / 0x0100 ** 0x07 &lt;&lt; 0xf8)) &gt;&gt; 0xf8) * 0x0100 ** 0x07 | (storage[0x02] &amp; ~(0xff * 0x0100 ** 0x07));</span><br><span class="line">        storage[0x02] = (((storage[0x00] / 0x0100 ** 0x08 &lt;&lt; 0xf8) ~ (storage[0x01] / 0x0100 ** 0x08 &lt;&lt; 0xf8)) &gt;&gt; 0xf8) * 0x0100 ** 0x08 | (storage[0x02] &amp; ~(0xff * 0x0100 ** 0x08));</span><br><span class="line">        storage[0x02] = (((storage[0x00] / 0x0100 ** 0x09 &lt;&lt; 0xf8) ~ (storage[0x01] / 0x0100 ** 0x09 &lt;&lt; 0xf8)) &gt;&gt; 0xf8) * 0x0100 ** 0x09 | (storage[0x02] &amp; ~(0xff * 0x0100 ** 0x09));</span><br><span class="line">        storage[0x02] = (((storage[0x00] / 0x0100 ** 0x0a &lt;&lt; 0xf8) ~ (storage[0x01] / 0x0100 ** 0x0a &lt;&lt; 0xf8)) &gt;&gt; 0xf8) * 0x0100 ** 0x0a | (storage[0x02] &amp; ~(0xff * 0x0100 ** 0x0a));</span><br><span class="line">        storage[0x02] = (((storage[0x00] / 0x0100 ** 0x0b &lt;&lt; 0xf8) ~ (storage[0x01] / 0x0100 ** 0x0b &lt;&lt; 0xf8)) &gt;&gt; 0xf8) * 0x0100 ** 0x0b | (storage[0x02] &amp; ~(0xff * 0x0100 ** 0x0b));</span><br><span class="line">        storage[0x02] = (((storage[0x00] / 0x0100 ** 0x0c &lt;&lt; 0xf8) ~ (storage[0x01] / 0x0100 ** 0x0c &lt;&lt; 0xf8)) &gt;&gt; 0xf8) * 0x0100 ** 0x0c | (storage[0x02] &amp; ~(0xff * 0x0100 ** 0x0c));</span><br><span class="line">        storage[0x02] = (((storage[0x00] / 0x0100 ** 0x0d &lt;&lt; 0xf8) ~ (storage[0x01] / 0x0100 ** 0x0d &lt;&lt; 0xf8)) &gt;&gt; 0xf8) * 0x0100 ** 0x0d | (storage[0x02] &amp; ~(0xff * 0x0100 ** 0x0d));</span><br><span class="line">        storage[0x02] = (((storage[0x00] / 0x0100 ** 0x0e &lt;&lt; 0xf8) ~ (storage[0x01] / 0x0100 ** 0x0e &lt;&lt; 0xf8)) &gt;&gt; 0xf8) * 0x0100 ** 0x0e | (storage[0x02] &amp; ~(0xff * 0x0100 ** 0x0e));</span><br><span class="line">        storage[0x02] = (((storage[0x00] / 0x0100 ** 0x0f &lt;&lt; 0xf8) ~ (storage[0x01] / 0x0100 ** 0x0f &lt;&lt; 0xf8)) &gt;&gt; 0xf8) * 0x0100 ** 0x0f | (storage[0x02] &amp; ~(0xff * 0x0100 ** 0x0f));</span><br><span class="line">        storage[0x02] = (((storage[0x00] / 0x0100 ** 0x10 &lt;&lt; 0xf8) ~ (storage[0x01] / 0x0100 ** 0x10 &lt;&lt; 0xf8)) &gt;&gt; 0xf8) * 0x0100 ** 0x10 | (storage[0x02] &amp; ~(0xff * 0x0100 ** 0x10));</span><br><span class="line">        storage[0x02] = (((storage[0x00] / 0x0100 ** 0x11 &lt;&lt; 0xf8) ~ (storage[0x01] / 0x0100 ** 0x11 &lt;&lt; 0xf8)) &gt;&gt; 0xf8) * 0x0100 ** 0x11 | (storage[0x02] &amp; ~(0xff * 0x0100 ** 0x11));</span><br><span class="line">        storage[0x02] = (((storage[0x00] / 0x0100 ** 0x12 &lt;&lt; 0xf8) ~ (storage[0x01] / 0x0100 ** 0x12 &lt;&lt; 0xf8)) &gt;&gt; 0xf8) * 0x0100 ** 0x12 | (storage[0x02] &amp; ~(0xff * 0x0100 ** 0x12));</span><br><span class="line">        storage[0x02] = (((storage[0x00] / 0x0100 ** 0x13 &lt;&lt; 0xf8) ~ (storage[0x01] / 0x0100 ** 0x13 &lt;&lt; 0xf8)) &gt;&gt; 0xf8) * 0x0100 ** 0x13 | (storage[0x02] &amp; ~(0xff * 0x0100 ** 0x13));</span><br><span class="line">        storage[0x02] = (((storage[0x00] / 0x0100 ** 0x14 &lt;&lt; 0xf8) ~ (storage[0x01] / 0x0100 ** 0x14 &lt;&lt; 0xf8)) &gt;&gt; 0xf8) * 0x0100 ** 0x14 | (storage[0x02] &amp; ~(0xff * 0x0100 ** 0x14));</span><br><span class="line">        storage[0x02] = (((storage[0x00] / 0x0100 ** 0x15 &lt;&lt; 0xf8) ~ (storage[0x01] / 0x0100 ** 0x15 &lt;&lt; 0xf8)) &gt;&gt; 0xf8) * 0x0100 ** 0x15 | (storage[0x02] &amp; ~(0xff * 0x0100 ** 0x15));</span><br><span class="line">        storage[0x02] = (((storage[0x00] / 0x0100 ** 0x16 &lt;&lt; 0xf8) ~ (storage[0x01] / 0x0100 ** 0x16 &lt;&lt; 0xf8)) &gt;&gt; 0xf8) * 0x0100 ** 0x16 | (storage[0x02] &amp; ~(0xff * 0x0100 ** 0x16));</span><br><span class="line">        storage[0x02] = (((storage[0x00] / 0x0100 ** 0x17 &lt;&lt; 0xf8) ~ (storage[0x01] / 0x0100 ** 0x17 &lt;&lt; 0xf8)) &gt;&gt; 0xf8) * 0x0100 ** 0x17 | (storage[0x02] &amp; ~(0xff * 0x0100 ** 0x17));</span><br><span class="line">        storage[0x02] = (((storage[0x00] / 0x0100 ** 0x18 &lt;&lt; 0xf8) ~ (storage[0x01] / 0x0100 ** 0x18 &lt;&lt; 0xf8)) &gt;&gt; 0xf8) * 0x0100 ** 0x18 | (storage[0x02] &amp; ~(0xff * 0x0100 ** 0x18));</span><br><span class="line">        storage[0x02] = (((storage[0x00] / 0x0100 ** 0x19 &lt;&lt; 0xf8) ~ (storage[0x01] / 0x0100 ** 0x19 &lt;&lt; 0xf8)) &gt;&gt; 0xf8) * 0x0100 ** 0x19 | (storage[0x02] &amp; ~(0xff * 0x0100 ** 0x19));</span><br><span class="line">        storage[0x02] = (((storage[0x00] / 0x0100 ** 0x1a &lt;&lt; 0xf8) ~ (storage[0x01] / 0x0100 ** 0x1a &lt;&lt; 0xf8)) &gt;&gt; 0xf8) * 0x0100 ** 0x1a | (storage[0x02] &amp; ~(0xff * 0x0100 ** 0x1a));</span><br><span class="line">        storage[0x02] = (((storage[0x00] / 0x0100 ** 0x1b &lt;&lt; 0xf8) ~ (storage[0x01] / 0x0100 ** 0x1b &lt;&lt; 0xf8)) &gt;&gt; 0xf8) * 0x0100 ** 0x1b | (storage[0x02] &amp; ~(0xff * 0x0100 ** 0x1b));</span><br><span class="line">        storage[0x02] = (((storage[0x00] / 0x0100 ** 0x1c &lt;&lt; 0xf8) ~ (storage[0x01] / 0x0100 ** 0x1c &lt;&lt; 0xf8)) &gt;&gt; 0xf8) * 0x0100 ** 0x1c | (storage[0x02] &amp; ~(0xff * 0x0100 ** 0x1c));</span><br><span class="line">        storage[0x02] = (((storage[0x00] / 0x0100 ** 0x1d &lt;&lt; 0xf8) ~ (storage[0x01] / 0x0100 ** 0x1d &lt;&lt; 0xf8)) &gt;&gt; 0xf8) * 0x0100 ** 0x1d | (storage[0x02] &amp; ~(0xff * 0x0100 ** 0x1d));</span><br><span class="line">        storage[0x02] = (((storage[0x00] / 0x0100 ** 0x1e &lt;&lt; 0xf8) ~ (storage[0x01] / 0x0100 ** 0x1e &lt;&lt; 0xf8)) &gt;&gt; 0xf8) * 0x0100 ** 0x1e | (storage[0x02] &amp; ~(0xff * 0x0100 ** 0x1e));</span><br><span class="line">        storage[0x02] = (((storage[0x00] / 0x0100 ** 0x1f &lt;&lt; 0xf8) ~ (storage[0x01] / 0x0100 ** 0x1f &lt;&lt; 0xf8)) &gt;&gt; 0xf8) * 0x0100 ** 0x1f | (storage[0x02] &amp; ~(0xff * 0x0100 ** 0x1f));</span><br><span class="line">        var var0 = msg.value;</span><br><span class="line">    </span><br><span class="line">        if (var0) { revert(memory[0x00:0x00]); }</span><br><span class="line">    </span><br><span class="line">        memory[0x00:0x089f] = code[0x0f39:0x17d8];</span><br><span class="line">        return memory[0x00:0x089f];</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><code>analyse this code</code></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">storage=[<span class="number">0</span>]</span><br><span class="line">storage[<span class="number">0x00</span>] = (storage[<span class="number">0x00</span>] &amp; ~<span class="number">0xff</span>) | ((<span class="number">0x20</span> &lt;&lt; <span class="number">0xf8</span>) &gt;&gt; <span class="number">0xf8</span>);</span><br><span class="line">storage[<span class="number">0x00</span>] = (storage[<span class="number">0x00</span>] &amp; ~(<span class="number">0xff</span> * <span class="number">0x0100</span> ** <span class="number">0x01</span>)) | ((<span class="number">0x53</span> &lt;&lt; <span class="number">0xf8</span>) &gt;&gt; <span class="number">0xf8</span>) * <span class="number">0x0100</span> ** <span class="number">0x01</span>;</span><br><span class="line">storage[<span class="number">0x00</span>] = (storage[<span class="number">0x00</span>] &amp; ~(<span class="number">0xff</span> * <span class="number">0x0100</span> ** <span class="number">0x02</span>)) | ((<span class="number">0x6f</span> &lt;&lt; <span class="number">0xf8</span>) &gt;&gt; <span class="number">0xf8</span>) * <span class="number">0x0100</span> ** <span class="number">0x02</span>;</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(storage[<span class="number">0</span>]))</span><br><span class="line"><span class="comment">#0x6f5320</span></span><br><span class="line"><span class="comment">#此类代码是在赋值按照小端序 最后s[0]和s[1]都变成了32字节大小的变量</span></span><br><span class="line"><span class="comment">#之后对s[0]和s[1]结果进行异或操作，存在s[2]中</span></span><br><span class="line">storage[<span class="number">0x02</span>] = (((storage[<span class="number">0x00</span>] &lt;&lt; <span class="number">0xf8</span>) ~ (storage[<span class="number">0x01</span>] &lt;&lt; <span class="number">0xf8</span>)) &gt;&gt; <span class="number">0xf8</span>) | (storage[<span class="number">0x02</span>] &amp; ~<span class="number">0xff</span>);</span><br><span class="line"><span class="comment">#其中~表示xor</span></span><br></pre></td></tr></tbody></table></figure><p>可以返回字节码查看 ~ 到底对应着什么操作 XOR 和 NOT的hex十分接近，可能反编译器内部出了点问题。</p><p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20220327232655873.png" alt="image-20220327232655873"></p><p><code>exp</code></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a=[<span class="number">0x20</span>,<span class="number">0x53</span>,<span class="number">0x6f</span>,<span class="number">0x6c</span>,<span class="number">0x69</span>,<span class="number">0x64</span>,<span class="number">0x60</span>,<span class="number">0x74</span>,<span class="number">0x79</span>,<span class="number">0x5f</span>,<span class="number">0x42</span>,<span class="number">0x69</span>,<span class="number">0x74</span>,<span class="number">0x77</span>,<span class="number">0x69</span>,<span class="number">0x73</span>,<span class="number">0x65</span>,<span class="number">0x5f</span>,<span class="number">0x4f</span>,<span class="number">0x70</span>,<span class="number">0x65</span>,<span class="number">0x72</span>,<span class="number">0x61</span>,<span class="number">0x74</span>,<span class="number">0x69</span>,<span class="number">0x6f</span>,<span class="number">0x6e</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>]</span><br><span class="line">b=[<span class="number">0x62</span>,<span class="number">0x10</span>,<span class="number">0x3b</span>,<span class="number">0x2a</span>,<span class="number">0x12</span>,<span class="number">0x26</span>,<span class="number">0x09</span>,<span class="number">0x00</span>,<span class="number">0x26</span>,<span class="number">0x10</span>,<span class="number">0x32</span>,<span class="number">0x0c</span>,<span class="number">0x06</span>,<span class="number">0x16</span>,<span class="number">0x1d</span>,<span class="number">0x1a</span>,<span class="number">0x0a</span>,<span class="number">0x31</span>,<span class="number">0x3c</span>,<span class="number">0x2f</span>,<span class="number">0x2c</span>,<span class="number">0x1c</span>,<span class="number">0x3e</span>,<span class="number">0x27</span>,<span class="number">0x06</span>,<span class="number">0x03</span>,<span class="number">0x07</span>,<span class="number">0x64</span>,<span class="number">0x69</span>,<span class="number">0x74</span>,<span class="number">0x79</span>,<span class="number">0x7d</span>]</span><br><span class="line"><span class="keyword">for</span> i,j <span class="keyword">in</span> <span class="built_in">zip</span>(a,b):</span><br><span class="line">       <span class="built_in">print</span>(<span class="built_in">chr</span>(i^j),end=<span class="string">''</span>)</span><br><span class="line"><span class="comment">#BCTF{Bit_Operations_In_Solidity}</span></span><br></pre></td></tr></tbody></table></figure><h2 id="The-End">The End</h2><p>还有一些题记不太清了，先暂时整理这些。最近还遇到许多遍历和搜索的算法题，如走图和dfs等，能还原正向算法，解不出就很难受并且无从下手，手撸党表示没机会。</p><p>摸的<code>Rust</code>和<code>IOT</code>之后也会整理一下，Rust就是硬调，IOT要熟悉信号用到的协议和一些分析工具等。</p><blockquote><p>博客由于大创(其实去是峡谷想当yewang)等原因好久没更了，最近许多硬核赛题还没有复现，真是长路漫漫，学无止境(越摆越烂)啊！</p></blockquote><p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/20220113025224690.gif" alt="20220113025224690"></p>]]></content>
      
      
      <categories>
          
          <category> CTF Memory </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>VNCTF2022</title>
      <link href="/2022/02/12/VNCTF2022/"/>
      <url>/2022/02/12/VNCTF2022/</url>
      
        <content type="html"><![CDATA[<blockquote><p>中间有很多失误，没细心看算法直接猜了，还被符号数狠狠坑了一笔。</p></blockquote><h2 id="WEB">WEB</h2><h3 id="GameV4-0">GameV4.0</h3><blockquote><p>签到题，F12在datajs中发现flag的base64字符串</p></blockquote><p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20220212231433347.png" alt="image-20220212231433347"></p><p>base64+URL解码即可</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">VNCTF{Welcome_to_VNCTF2022}</span><br></pre></td></tr></tbody></table></figure><h2 id="Crypto">Crypto</h2><h3 id="ezmath">ezmath</h3><p>解决如下方程，提示知道第一个是15即n=4,可得如下等式<br>$$<br>2^n -1 mod 15==0 \quad ==&gt; \quad 2^n mod 15==1<br>$$</p><blockquote><p>n从4开始，左右两侧取多少次方都可以 故第k个 n就是4*k  k=1,2,3,4…</p></blockquote><p>exp如下，记得当时手动输入数据测试不行，用pwntool就可以了。</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">from hashlib <span class="keyword">import</span> sha256</span></span><br><span class="line"><span class="function">from pwn <span class="keyword">import</span> *</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">def <span class="title">check</span><span class="params">(s,enc)</span>:</span></span><br><span class="line"><span class="function">    table </span>= <span class="string">'0123456789abcdefghijklmnopqrstuvwxyz'</span> + <span class="string">'abcdefghijklmnopqrstuvwxyz'</span>.upper()</span><br><span class="line">    ans=<span class="string">''</span></span><br><span class="line"><span class="string">    for i in table:</span></span><br><span class="line"><span class="string">        for j in table:</span></span><br><span class="line"><span class="string">            for k in table:</span></span><br><span class="line"><span class="string">                for l in table:</span></span><br><span class="line"><span class="string">                    a = i + j + k + l + s</span></span><br><span class="line"><span class="string">                    if sha256(a.encode()).hexdigest() == enc:</span></span><br><span class="line"><span class="string">                        ans+=a[:4]</span></span><br><span class="line"><span class="string">                        print(ans)</span></span><br><span class="line"><span class="string">                        return (ans)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">r=remote('</span>node4.buuoj.cn<span class="number">'</span>,<span class="number">28687</span>)</span><br><span class="line">p=r.recvuntil(<span class="string">':'</span>).decode()[<span class="number">3</span>:].replace(<span class="string">' == '</span>,<span class="string">'#'</span>)</span><br><span class="line">s=p[p.index(<span class="string">'+'</span>)+<span class="number">1</span>:p.index(<span class="string">')'</span>)]</span><br><span class="line">enc=p[p.index(<span class="string">'#'</span>)+<span class="number">1</span>:p.index(<span class="string">'\n'</span>)]</span><br><span class="line">tmp=check(s,enc)</span><br><span class="line">r.sendline(tmp)</span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">777</span>):</span><br><span class="line">    a=r.recvline().decode().split(<span class="string">' '</span>)</span><br><span class="line">    num=<span class="keyword">int</span>(a[<span class="number">4</span>][:a[<span class="number">4</span>].index(<span class="string">'t'</span>)])</span><br><span class="line">    r.sendline(str(<span class="keyword">int</span>(num)*<span class="number">4</span>))</span><br><span class="line">    r.recvline()</span><br><span class="line">r.interactive()</span><br><span class="line"><span class="meta">#flag{7e625b4e-fdec-47aa-8808-c59157d0bb1d}</span></span><br></pre></td></tr></tbody></table></figure><h2 id="RE">RE</h2><blockquote><p>有点小遗憾，败在了C的符号数处理上 最后一题单单SM4秘钥扩就写了好久，赛后python写直接出了，百感交寄G_G</p></blockquote><h3 id="BabyMaze">BabyMaze</h3><blockquote><p>python3.8 不可直接uncompyle反编译  用py38的dis或decompy++都可以反汇编</p></blockquote><p>这里用decompy++  执行 .\pycdas BabyMaze.pyc &gt; code.txt</p><p><strong>部分代码如下</strong></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line">BabyMaze.pyc (Python <span class="number">3.8</span>)</span><br><span class="line">[Code]</span><br><span class="line">    File Name: .\BabyMaze.py</span><br><span class="line">    Object Name: &lt;module&gt;</span><br><span class="line">    Arg Count: <span class="number">0</span></span><br><span class="line">    Pos Only Arg Count: <span class="number">0</span></span><br><span class="line">    KW Only Arg Count: <span class="number">0</span></span><br><span class="line">    Locals: <span class="number">0</span></span><br><span class="line">    Stack Size: <span class="number">61</span></span><br><span class="line">    Flags: <span class="number">0x00000040</span> (CO_NOFREE)</span><br><span class="line">    [Names]</span><br><span class="line">        <span class="string">'_map'</span></span><br><span class="line">        <span class="string">'maze'</span></span><br><span class="line">        <span class="string">'main'</span></span><br><span class="line">        <span class="string">'__name__'</span></span><br><span class="line">    [Var Names]</span><br><span class="line">    [Free Vars]</span><br><span class="line">    [Cell Vars]</span><br><span class="line">    [Constants]</span><br><span class="line">        <span class="number">1</span></span><br><span class="line">        <span class="number">5</span></span><br><span class="line">        <span class="number">0</span></span><br><span class="line">        <span class="number">7</span></span><br><span class="line">        [Code]</span><br><span class="line">            File Name: .\BabyMaze.py</span><br><span class="line">            Object Name: maze</span><br><span class="line">            Arg Count: <span class="number">0</span></span><br><span class="line">            Pos Only Arg Count: <span class="number">0</span></span><br><span class="line">            KW Only Arg Count: <span class="number">0</span></span><br><span class="line">            Locals: <span class="number">4</span></span><br><span class="line">            Stack Size: <span class="number">3</span></span><br><span class="line">            Flags: <span class="number">0x00000043</span> (CO_OPTIMIZED | CO_NEWLOCALS | CO_NOFREE)</span><br><span class="line">            [Names]</span><br><span class="line">                <span class="string">'input'</span></span><br><span class="line">                <span class="string">'range'</span></span><br><span class="line">                <span class="string">'len'</span></span><br><span class="line">                <span class="string">'_map'</span></span><br><span class="line">            [Var Names]</span><br><span class="line">                <span class="string">'x'</span></span><br><span class="line">                <span class="string">'y'</span></span><br><span class="line">                <span class="string">'step'</span></span><br><span class="line">                <span class="string">'i'</span></span><br><span class="line">            [Free Vars]</span><br><span class="line">            [Cell Vars]</span><br><span class="line">            [Constants]</span><br><span class="line">                <span class="literal">None</span></span><br><span class="line">                <span class="number">1</span></span><br><span class="line">                <span class="string">'w'</span></span><br><span class="line">                <span class="string">'s'</span></span><br><span class="line">                <span class="string">'a'</span></span><br><span class="line">                <span class="string">'d'</span></span><br><span class="line">                <span class="literal">False</span></span><br><span class="line">                <span class="number">29</span></span><br><span class="line">                <span class="literal">True</span></span><br><span class="line">            [Disassembly]</span><br><span class="line">                <span class="number">0</span>       LOAD_CONST              <span class="number">1</span>: <span class="number">1</span></span><br><span class="line">                <span class="number">2</span>       STORE_FAST              <span class="number">0</span>: x</span><br><span class="line">                <span class="number">4</span>       LOAD_CONST              <span class="number">1</span>: <span class="number">1</span></span><br><span class="line">                <span class="number">6</span>       STORE_FAST              <span class="number">1</span>: y</span><br><span class="line">                <span class="number">8</span>       LOAD_GLOBAL             <span class="number">0</span>: <span class="built_in">input</span></span><br><span class="line">                <span class="number">10</span>      CALL_FUNCTION           <span class="number">0</span></span><br><span class="line">                <span class="number">12</span>      STORE_FAST              <span class="number">2</span>: step</span><br><span class="line">                <span class="number">14</span>      LOAD_GLOBAL             <span class="number">1</span>: <span class="built_in">range</span></span><br><span class="line">                <span class="number">16</span>      LOAD_GLOBAL             <span class="number">2</span>: <span class="built_in">len</span></span><br><span class="line">                <span class="number">18</span>      LOAD_FAST               <span class="number">2</span>: step</span><br><span class="line">                <span class="number">20</span>      CALL_FUNCTION           <span class="number">1</span></span><br><span class="line">                <span class="number">22</span>      CALL_FUNCTION           <span class="number">1</span></span><br><span class="line">                <span class="number">24</span>      GET_ITER                </span><br><span class="line">                <span class="number">26</span>      FOR_ITER                <span class="number">142</span> (to <span class="number">170</span>)</span><br><span class="line">                <span class="number">28</span>      STORE_FAST              <span class="number">3</span>: i</span><br><span class="line">                <span class="number">30</span>      LOAD_FAST               <span class="number">2</span>: step</span><br><span class="line">                <span class="number">32</span>      LOAD_FAST               <span class="number">3</span>: i</span><br><span class="line">                <span class="number">34</span>      BINARY_SUBSCR           </span><br><span class="line">                <span class="number">36</span>      LOAD_CONST              <span class="number">2</span>: <span class="string">'w'</span></span><br><span class="line">                <span class="number">38</span>      COMPARE_OP              <span class="number">2</span> (==)</span><br><span class="line">                <span class="number">40</span>      POP_JUMP_IF_FALSE       <span class="number">52</span></span><br><span class="line">                <span class="number">42</span>      LOAD_FAST               <span class="number">0</span>: x</span><br><span class="line">                <span class="number">44</span>      LOAD_CONST              <span class="number">1</span>: <span class="number">1</span></span><br><span class="line">                <span class="number">46</span>      INPLACE_SUBTRACT        </span><br><span class="line">                <span class="number">48</span>      STORE_FAST              <span class="number">0</span>: x</span><br><span class="line">                <span class="number">50</span>      JUMP_FORWARD            <span class="number">72</span> (to <span class="number">124</span>)</span><br><span class="line">                <span class="number">52</span>      LOAD_FAST               <span class="number">2</span>: step</span><br><span class="line">                <span class="number">54</span>      LOAD_FAST               <span class="number">3</span>: i</span><br><span class="line">                <span class="number">56</span>      BINARY_SUBSCR           </span><br><span class="line">                <span class="number">58</span>      LOAD_CONST              <span class="number">3</span>: <span class="string">'s'</span></span><br><span class="line">                <span class="number">60</span>      COMPARE_OP              <span class="number">2</span> (==)</span><br><span class="line">                <span class="number">62</span>      POP_JUMP_IF_FALSE       <span class="number">74</span></span><br><span class="line">                <span class="number">64</span>      LOAD_FAST               <span class="number">0</span>: x</span><br><span class="line">                <span class="number">66</span>      LOAD_CONST              <span class="number">1</span>: <span class="number">1</span></span><br><span class="line">                <span class="number">68</span>      INPLACE_ADD             </span><br><span class="line">                <span class="number">70</span>      STORE_FAST              <span class="number">0</span>: x</span><br><span class="line">                <span class="number">72</span>      JUMP_FORWARD            <span class="number">50</span> (to <span class="number">124</span>)</span><br><span class="line">                <span class="number">74</span>      LOAD_FAST               <span class="number">2</span>: step</span><br><span class="line">                <span class="number">76</span>      LOAD_FAST               <span class="number">3</span>: i</span><br><span class="line">                <span class="number">78</span>      BINARY_SUBSCR           </span><br><span class="line">                <span class="number">80</span>      LOAD_CONST              <span class="number">4</span>: <span class="string">'a'</span></span><br><span class="line">                <span class="number">82</span>      COMPARE_OP              <span class="number">2</span> (==)</span><br><span class="line">                <span class="number">84</span>      POP_JUMP_IF_FALSE       <span class="number">96</span></span><br><span class="line">                <span class="number">86</span>      LOAD_FAST               <span class="number">1</span>: y</span><br><span class="line">                <span class="number">88</span>      LOAD_CONST              <span class="number">1</span>: <span class="number">1</span></span><br><span class="line">                <span class="number">90</span>      INPLACE_SUBTRACT        </span><br><span class="line">                <span class="number">92</span>      STORE_FAST              <span class="number">1</span>: y</span><br><span class="line">                <span class="number">94</span>      JUMP_FORWARD            <span class="number">28</span> (to <span class="number">124</span>)</span><br><span class="line">                <span class="number">96</span>      LOAD_FAST               <span class="number">2</span>: step</span><br><span class="line">                <span class="number">98</span>      LOAD_FAST               <span class="number">3</span>: i</span><br><span class="line">                <span class="number">100</span>     BINARY_SUBSCR           </span><br><span class="line">                <span class="number">102</span>     LOAD_CONST              <span class="number">5</span>: <span class="string">'d'</span></span><br><span class="line">                <span class="number">104</span>     COMPARE_OP              <span class="number">2</span> (==)</span><br><span class="line">                <span class="number">106</span>     POP_JUMP_IF_FALSE       <span class="number">118</span></span><br><span class="line">                <span class="number">108</span>     LOAD_FAST               <span class="number">1</span>: y</span><br><span class="line">                <span class="number">110</span>     LOAD_CONST              <span class="number">1</span>: <span class="number">1</span></span><br><span class="line">                <span class="number">112</span>     INPLACE_ADD             </span><br><span class="line">                <span class="number">114</span>     STORE_FAST              <span class="number">1</span>: y</span><br><span class="line">                <span class="number">116</span>     JUMP_FORWARD            <span class="number">6</span> (to <span class="number">124</span>)</span><br><span class="line">                <span class="number">118</span>     POP_TOP                 </span><br><span class="line">                <span class="number">120</span>     LOAD_CONST              <span class="number">6</span>: <span class="literal">False</span></span><br><span class="line">                <span class="number">122</span>     RETURN_VALUE            </span><br><span class="line">                <span class="number">124</span>     LOAD_GLOBAL             <span class="number">3</span>: _<span class="built_in">map</span></span><br><span class="line">                <span class="number">126</span>     LOAD_FAST               <span class="number">0</span>: x</span><br><span class="line">                <span class="number">128</span>     BINARY_SUBSCR           </span><br><span class="line">                <span class="number">130</span>     LOAD_FAST               <span class="number">1</span>: y</span><br><span class="line">                <span class="number">132</span>     BINARY_SUBSCR           </span><br><span class="line">                <span class="number">134</span>     LOAD_CONST              <span class="number">1</span>: <span class="number">1</span></span><br><span class="line">                <span class="number">136</span>     COMPARE_OP              <span class="number">2</span> (==)</span><br><span class="line">                <span class="number">138</span>     POP_JUMP_IF_FALSE       <span class="number">146</span></span><br><span class="line">                <span class="number">140</span>     POP_TOP                 </span><br><span class="line">                <span class="number">142</span>     LOAD_CONST              <span class="number">6</span>: <span class="literal">False</span></span><br><span class="line">                <span class="number">144</span>     RETURN_VALUE            </span><br><span class="line">                <span class="number">146</span>     LOAD_FAST               <span class="number">0</span>: x</span><br><span class="line">                <span class="number">148</span>     LOAD_CONST              <span class="number">7</span>: <span class="number">29</span></span><br><span class="line">                <span class="number">150</span>     COMPARE_OP              <span class="number">2</span> (==)</span><br><span class="line">                <span class="number">152</span>     POP_JUMP_IF_FALSE       <span class="number">26</span></span><br><span class="line">                <span class="number">154</span>     LOAD_FAST               <span class="number">1</span>: y</span><br><span class="line">                <span class="number">156</span>     LOAD_CONST              <span class="number">7</span>: <span class="number">29</span></span><br><span class="line">                <span class="number">158</span>     COMPARE_OP              <span class="number">2</span> (==)</span><br><span class="line">                <span class="number">160</span>     POP_JUMP_IF_FALSE       <span class="number">26</span></span><br><span class="line">                <span class="number">162</span>     POP_TOP                 </span><br><span class="line">                <span class="number">164</span>     LOAD_CONST              <span class="number">8</span>: <span class="literal">True</span></span><br><span class="line">                <span class="number">166</span>     RETURN_VALUE            </span><br><span class="line">                <span class="number">168</span>     JUMP_ABSOLUTE           <span class="number">26</span></span><br><span class="line">                <span class="number">170</span>     LOAD_CONST              <span class="number">0</span>: <span class="literal">None</span></span><br><span class="line">                <span class="number">172</span>     RETURN_VALUE            </span><br></pre></td></tr></tbody></table></figure><p><strong>其余主要是map数组，参考py字节码官网写出伪码</strong></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">x=<span class="number">1</span></span><br><span class="line">y=<span class="number">1</span></span><br><span class="line">step=<span class="built_in">input</span>()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(step)):</span><br><span class="line">    <span class="keyword">if</span> step[i]==<span class="string">'w'</span>:</span><br><span class="line">        x-=<span class="number">1</span></span><br><span class="line">    <span class="keyword">elif</span> step[i]==<span class="string">'s'</span>:</span><br><span class="line">        x+=<span class="number">1</span></span><br><span class="line">    <span class="keyword">elif</span> step[i]==<span class="string">'a'</span>:</span><br><span class="line">        y-=<span class="number">1</span></span><br><span class="line">    <span class="keyword">elif</span> step[i]==<span class="string">'d'</span>:</span><br><span class="line">        y+=<span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">'noo'</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">map</span>[<span class="number">31</span>*x+y]==<span class="number">1</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">'noo'</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">if</span> x==<span class="number">29</span> <span class="keyword">and</span> y==<span class="number">29</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">'yes'</span>)</span><br></pre></td></tr></tbody></table></figure><p><code>solve maze problem</code></p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">uint8_t</span> <span class="built_in">map</span>[<span class="number">961</span>] = { <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>};</span><br><span class="line"><span class="keyword">uint8_t</span> ans[<span class="number">256</span>] = { <span class="number">0</span> };</span><br><span class="line"><span class="keyword">uint8_t</span> visit[<span class="number">961</span>] = { <span class="number">0</span> };</span><br><span class="line"><span class="keyword">uint8_t</span> next[<span class="number">4</span>] = { <span class="number">119</span>,<span class="number">115</span>,<span class="number">97</span>,<span class="number">100</span> };</span><br><span class="line"><span class="keyword">uint32_t</span> step = <span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">maze</span><span class="params">(<span class="keyword">uint32_t</span> x, <span class="keyword">uint32_t</span> y)</span> </span>{</span><br><span class="line">visit[<span class="number">31</span> * x + y] = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">uint32_t</span> tx, ty;</span><br><span class="line"><span class="keyword">if</span> (x == <span class="number">29</span> &amp;&amp; y == <span class="number">29</span>) {</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"yes\n"</span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; step; i++)</span><br><span class="line">{</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%c"</span>, ans[i]);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">}</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) {</span><br><span class="line"><span class="keyword">switch</span> (next[i])</span><br><span class="line">{</span><br><span class="line"><span class="keyword">case</span> <span class="number">119</span>:</span><br><span class="line">tx = x - <span class="number">1</span>;</span><br><span class="line">ty = y;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="number">115</span>:</span><br><span class="line">tx = x + <span class="number">1</span>;</span><br><span class="line">ty = y;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="number">97</span>:</span><br><span class="line">ty = y - <span class="number">1</span>;</span><br><span class="line">tx = x;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="number">100</span>:</span><br><span class="line">ty = y + <span class="number">1</span>;</span><br><span class="line">tx = x;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ((tx &gt;= <span class="number">0</span> &amp;&amp; tx &lt; <span class="number">31</span>) &amp;&amp; (ty &gt;= <span class="number">0</span> &amp;&amp; ty &lt; <span class="number">31</span>) &amp;&amp; <span class="built_in">map</span>[<span class="number">31</span> * tx + ty] != <span class="number">1</span> &amp;&amp; visit[<span class="number">31</span> * tx + ty] == <span class="number">0</span>) {</span><br><span class="line">ans[step] = next[i];</span><br><span class="line">step += <span class="number">1</span>;</span><br><span class="line">maze(tx, ty);</span><br><span class="line">step -= <span class="number">1</span>;</span><br><span class="line">}</span><br><span class="line">}</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">maze(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"><span class="comment">//print('VNCTF{'+md5('ssssddssaassddddwwwwddwwddddddwwddddddssddwwddddddddssssaawwaassaassaassddssaassaawwwwwwaaaaaaaassaassddddwwddssddssssaassddssssaaaaaawwddwwaawwwwaassssssssssssddddssddssddddddddwwaaaaaawwwwddssddwwwwwwwwddssddssssssssddddss'.encode()).hexdigest()+'}')</span></span><br><span class="line"><span class="comment">//VNCTF{801f190737434100e7d2790bd5b0732e}</span></span><br></pre></td></tr></tbody></table></figure><h3 id="cm狗">cm狗</h3><blockquote><p>go的虚拟机 索性是模拟的汇编大致相同，硬静态分析还是可以出的</p></blockquote><p><code>VM_Init</code> 将一些函数地址存在某偏移处，V1结构体有点大，没去定义。</p><p><code>VM_run</code></p><p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20220212233121694.png" alt="image-20220212233121694"></p><p><strong>根据VM_Run可知指令长度是3Byte，并且0xFF4偏移处是eip，0x1000偏移是opcode，接下来是对20个fun的分析</strong></p><blockquote><p>为了减少工作量可以提前对opcode的地址码进行遍历，只解释用到的指令即可</p></blockquote><p>部分函数</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">__int64 __usercall main___ptr_MzVm__init_func2@&lt;rax&gt;(__int64 a1)</span><br><span class="line">{<span class="comment">//高32位为Rnum 低32位为Lnum</span></span><br><span class="line">  __int64 v1; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v2; <span class="comment">// rdx</span></span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  __int64 v4; <span class="comment">// [rsp+0h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  v2 = *(_QWORD *)(v1 + <span class="number">8</span>);                     <span class="comment">// mov r[Lnum],Rnum</span></span><br><span class="line">  result = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)a1;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)a1 &gt;= <span class="number">0x15</span>uLL )</span><br><span class="line">    runtime_panicIndex(v4);</span><br><span class="line">  *(_DWORD *)(v2 + <span class="number">4LL</span> * (<span class="keyword">unsigned</span> <span class="keyword">int</span>)a1) = HIDWORD(a1);<span class="comment">// 0x14个寄存器 Lnum,Rnum</span></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> __int64 __usercall main___ptr_MzVm__init_func6@&lt;rax&gt;(<span class="keyword">unsigned</span> <span class="keyword">int</span> a1)</span><br><span class="line">{</span><br><span class="line">  __int64 v1; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v2; <span class="comment">// rdx</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 result; <span class="comment">// rax</span></span><br><span class="line">  __int64 v4; <span class="comment">// [rsp+0h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  v2 = *(_QWORD *)(v1 + <span class="number">8</span>);</span><br><span class="line">  result = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(*(_DWORD *)(v2 + <span class="number">0xFF8</span>) - <span class="number">1</span>);</span><br><span class="line">  *(_DWORD *)(v2 + <span class="number">0xFF8</span>) = result;</span><br><span class="line">  <span class="keyword">if</span> ( a1 &gt;= <span class="number">0x15</span>uLL )</span><br><span class="line">    runtime_panicIndex(v4);</span><br><span class="line">  <span class="keyword">if</span> ( result &gt;= <span class="number">0x3E8</span> )</span><br><span class="line">    runtime_panicIndex(v4);</span><br><span class="line">  *(_DWORD *)(v2 + <span class="number">4</span> * result + <span class="number">84</span>) = *(_DWORD *)(v2 + <span class="number">4LL</span> * a1);<span class="comment">// push r[Lnum]</span></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">__int64 __usercall main___ptr_MzVm__init_func13@&lt;rax&gt;(<span class="keyword">unsigned</span> <span class="keyword">int</span> a1)</span><br><span class="line">{</span><br><span class="line">  __int64 v1; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v2; <span class="comment">// rdx</span></span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  __int64 v4; <span class="comment">// [rsp+0h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  v2 = *(_QWORD *)(v1 + <span class="number">8</span>);</span><br><span class="line">  <span class="keyword">if</span> ( a1 &gt;= <span class="number">0x15</span>uLL )</span><br><span class="line">    runtime_panicIndex(v4);</span><br><span class="line">  result = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(<span class="number">3</span> * *(_DWORD *)(v2 + <span class="number">4LL</span> * a1));<span class="comment">// jmp r[Lnum]</span></span><br><span class="line">  *(_DWORD *)(v2 + <span class="number">0xFF4</span>) = result;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><blockquote><p>记住几个重要的偏移，剩下的猜结合调试很快就能了解函数功能</p></blockquote><p><code>parser</code></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">op=[opcode...]</span><br><span class="line">f=[]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="built_in">len</span>(op),<span class="number">3</span>):</span><br><span class="line">   <span class="keyword">if</span> op[i]+<span class="number">1</span> <span class="keyword">not</span> <span class="keyword">in</span> f:</span><br><span class="line">       f.append(op[i]+<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">bytes</span>.fromhex(<span class="string">'61336366'</span>))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="built_in">len</span>(op),<span class="number">3</span>):</span><br><span class="line"></span><br><span class="line">    adr=op[i]+<span class="number">1</span></span><br><span class="line">    Lnum=op[i+<span class="number">1</span>]</span><br><span class="line">    Rnum=op[i+<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> adr==<span class="number">1</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"%s: "</span>%<span class="built_in">hex</span>(i)+<span class="string">f"nop"</span>)</span><br><span class="line">    <span class="keyword">elif</span> adr==<span class="number">2</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"%s: "</span>%<span class="built_in">hex</span>(i)+<span class="string">f"mov r[<span class="subst">{Lnum}</span>],<span class="subst">{<span class="built_in">hex</span>(Rnum)}</span>"</span>)</span><br><span class="line">    <span class="keyword">elif</span> adr==<span class="number">3</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"%s: "</span>%<span class="built_in">hex</span>(i)+<span class="string">f"mov r[<span class="subst">{Lnum}</span>],r[<span class="subst">{Rnum}</span>]"</span>)</span><br><span class="line">    <span class="keyword">elif</span> adr==<span class="number">6</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"%s: "</span>%<span class="built_in">hex</span>(i)+<span class="string">f"push r[<span class="subst">{Lnum}</span>]"</span>)</span><br><span class="line">    <span class="keyword">elif</span> adr==<span class="number">7</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"%s: "</span>%<span class="built_in">hex</span>(i)+<span class="string">f"pop r[<span class="subst">{Lnum}</span>]"</span>)</span><br><span class="line">    <span class="keyword">elif</span> adr==<span class="number">8</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"%s: "</span>%<span class="built_in">hex</span>(i)+<span class="string">f"add r[<span class="subst">{Lnum}</span>],r[<span class="subst">{Rnum}</span>]"</span>)</span><br><span class="line">    <span class="keyword">elif</span> adr==<span class="number">9</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"%s: "</span>%<span class="built_in">hex</span>(i)+<span class="string">f"sub r[<span class="subst">{Lnum}</span>],r[<span class="subst">{Rnum}</span>]"</span>)</span><br><span class="line">    <span class="keyword">elif</span> adr==<span class="number">10</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"%s: "</span>%<span class="built_in">hex</span>(i)+<span class="string">f"div r[<span class="subst">{Lnum}</span>],r[<span class="subst">{Rnum}</span>]"</span>)</span><br><span class="line">    <span class="keyword">elif</span> adr==<span class="number">11</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"%s: "</span>%<span class="built_in">hex</span>(i)+<span class="string">f"mul r[<span class="subst">{Lnum}</span>],r[<span class="subst">{Rnum}</span>]"</span>)</span><br><span class="line">    <span class="keyword">elif</span> adr==<span class="number">12</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"%s: "</span>%<span class="built_in">hex</span>(i)+<span class="string">f"xor r[<span class="subst">{Lnum}</span>],r[<span class="subst">{Rnum}</span>]"</span>)</span><br><span class="line">    <span class="keyword">elif</span> adr==<span class="number">13</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"%s: "</span>%<span class="built_in">hex</span>(i)+<span class="string">f"jmp r[<span class="subst">{Lnum}</span>]"</span>)</span><br><span class="line">    <span class="keyword">elif</span> adr==<span class="number">15</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"%s: "</span>%<span class="built_in">hex</span>(i)+<span class="string">f"cmp r[<span class="subst">{Lnum}</span>],r[<span class="subst">{Rnum}</span>] -- jnz r[19]"</span>)</span><br><span class="line">    <span class="keyword">elif</span> adr==<span class="number">0x62</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"%s: "</span>%<span class="built_in">hex</span>(i)+<span class="string">f"getchar(r[<span class="subst">{Lnum}</span>])"</span>)</span><br><span class="line">    <span class="keyword">elif</span> adr==<span class="number">0x63</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"%s: "</span>%<span class="built_in">hex</span>(i)+<span class="string">f'putchar(r[<span class="subst">{Lnum}</span>)]'</span>)</span><br><span class="line">    <span class="keyword">elif</span> adr==<span class="number">0x64</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"%s: "</span>%<span class="built_in">hex</span>(i)+<span class="string">f"exit()"</span>)</span><br></pre></td></tr></tbody></table></figure><p><code>伪码</code></p><blockquote><p>截取片段，前面的putchar 输出 VNCTF…啥的</p></blockquote><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">0xcc: mov r[19],0x49</span><br><span class="line">0xcf: mov r[3],0x0</span><br><span class="line">0xd2: mov r[1],0x2b     #长度0x2b</span><br><span class="line">0xd5: mov r[2],0x1</span><br><span class="line">0xd8: getchar(r[0])</span><br><span class="line">0xdb: push r[0]         #输入进栈</span><br><span class="line">0xde: sub r[1],r[2]</span><br><span class="line">0xe1: cmp r[1],r[3] -- jnz r[19]</span><br></pre></td></tr></tbody></table></figure><p><code>arry2int</code></p><p>4个Byte转为 int</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0xe4</span>: mov r[<span class="number">0</span>],<span class="number">0x0</span></span><br><span class="line"><span class="number">0xe7</span>: push r[<span class="number">0</span>]</span><br><span class="line"><span class="number">0xea</span>: nop</span><br><span class="line"><span class="number">0xed</span>: nop</span><br><span class="line"><span class="number">0xf0</span>: pop r[<span class="number">0</span>]</span><br><span class="line"><span class="number">0xf3</span>: mov r[<span class="number">5</span>],<span class="number">0x100</span></span><br><span class="line"><span class="number">0xf6</span>: mul r[<span class="number">0</span>],r[<span class="number">5</span>]</span><br><span class="line"><span class="number">0xf9</span>: mov r[<span class="number">6</span>],r[<span class="number">0</span>]</span><br><span class="line"><span class="number">0xfc</span>: pop r[<span class="number">0</span>]</span><br><span class="line"><span class="number">0xff</span>: add r[<span class="number">6</span>],r[<span class="number">0</span>]</span><br><span class="line"><span class="number">0x102</span>: mov r[<span class="number">0</span>],r[<span class="number">6</span>]</span><br><span class="line"><span class="number">0x105</span>: mul r[<span class="number">0</span>],r[<span class="number">5</span>]</span><br><span class="line"><span class="number">0x108</span>: mov r[<span class="number">6</span>],r[<span class="number">0</span>]</span><br><span class="line"><span class="number">0x10b</span>: pop r[<span class="number">0</span>]</span><br><span class="line"><span class="number">0x10e</span>: add r[<span class="number">6</span>],r[<span class="number">0</span>]</span><br><span class="line"><span class="number">0x111</span>: mov r[<span class="number">0</span>],r[<span class="number">6</span>]</span><br><span class="line"><span class="number">0x114</span>: mul r[<span class="number">0</span>],r[<span class="number">5</span>]</span><br><span class="line"><span class="number">0x117</span>: mov r[<span class="number">6</span>],r[<span class="number">0</span>]</span><br><span class="line"><span class="number">0x11a</span>: pop r[<span class="number">0</span>]</span><br><span class="line"><span class="number">0x11d</span>: add r[<span class="number">6</span>],r[<span class="number">0</span>]</span><br><span class="line"><span class="number">0x120</span>: nop</span><br></pre></td></tr></tbody></table></figure><p><code>Tea</code></p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">0x3f9: mov r[3],0x9e3779b9 ;delta</span><br><span class="line">0x3fc: mov r[4],0x95c4c    ;key</span><br><span class="line">0x3ff: mov r[5],0x871d</span><br><span class="line">0x402: mov r[6],0x1a7b7</span><br><span class="line">0x405: mov r[7],0x12c7c7</span><br><span class="line">0x408: mov r[8],0x0</span><br><span class="line">0x40b: mov r[17],0x10</span><br><span class="line">0x40e: mov r[18],0x20</span><br><span class="line">0x411: mov r[19],0x160</span><br><span class="line">0x414: mov r[10],0x0</span><br><span class="line">0x417: mov r[11],0x20</span><br><span class="line">0x41a: mov r[12],0x1</span><br><span class="line">0x41d: add r[8],r[3]</span><br><span class="line">0x420: mov r[0],r[2]</span><br><span class="line">0x423: mul r[0],r[17]</span><br><span class="line">0x426: add r[0],r[4]</span><br><span class="line">0x429: mov r[14],r[0]</span><br><span class="line">0x42c: mov r[0],r[2]</span><br><span class="line">0x42f: add r[0],r[8]</span><br><span class="line">0x432: mov r[15],r[0]</span><br><span class="line">0x435: mov r[0],r[2]</span><br><span class="line">0x438: div r[0],r[18]</span><br><span class="line">0x43b: add r[0],r[5]</span><br><span class="line">0x43e: mov r[16],r[0]</span><br><span class="line">0x441: mov r[0],r[14]</span><br><span class="line">0x444: xor r[0],r[15]</span><br><span class="line">0x447: xor r[0],r[16]</span><br><span class="line">0x44a: add r[1],r[0]</span><br><span class="line">0x44d: mov r[0],r[1]</span><br><span class="line">0x450: mul r[0],r[17]</span><br><span class="line">0x453: add r[0],r[6]</span><br><span class="line">0x456: mov r[14],r[0]</span><br><span class="line">0x459: mov r[0],r[1]</span><br><span class="line">0x45c: add r[0],r[8]</span><br><span class="line">0x45f: mov r[15],r[0]</span><br><span class="line">0x462: mov r[0],r[1]</span><br><span class="line">0x465: div r[0],r[18]</span><br><span class="line">0x468: add r[0],r[7]</span><br><span class="line">0x46b: mov r[16],r[0]</span><br><span class="line">0x46e: mov r[0],r[14]</span><br><span class="line">0x471: xor r[0],r[15]</span><br><span class="line">0x474: xor r[0],r[16]</span><br><span class="line">0x477: add r[2],r[0]</span><br><span class="line">0x47a: sub r[11],r[12]</span><br><span class="line">0x47d: cmp r[11],r[10] -- jnz r[19]</span><br><span class="line">0x480: jmp r[20]</span><br><span class="line">0x483: nop</span><br></pre></td></tr></tbody></table></figure><p>感谢作者Tea不魔改之恩</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x348</span>: mov r[<span class="number">20</span>],<span class="number">0x11c</span></span><br><span class="line"><span class="number">0x34b</span>: mov r[<span class="number">0</span>],<span class="number">0x154</span></span><br><span class="line"><span class="number">0x34e</span>: jmp r[<span class="number">0</span>]</span><br><span class="line"><span class="number">0x351</span>: mov r[<span class="number">0</span>],<span class="number">0xe8d1d5df</span></span><br><span class="line"><span class="number">0x354</span>: mov r[<span class="number">19</span>],<span class="number">0x183</span></span><br><span class="line"><span class="number">0x357</span>: mov r[<span class="number">20</span>],<span class="number">0x153</span></span><br><span class="line"><span class="number">0x35a</span>: cmp r[<span class="number">1</span>],r[<span class="number">0</span>] -- jnz r[<span class="number">19</span>]</span><br><span class="line"><span class="number">0x35d</span>: mov r[<span class="number">0</span>],<span class="number">0xf5e3c114</span></span><br><span class="line"><span class="number">0x360</span>: cmp r[<span class="number">2</span>],r[<span class="number">0</span>] -- jnz r[<span class="number">19</span>]</span><br><span class="line"><span class="number">0x363</span>: pop r[<span class="number">1</span>]</span><br><span class="line"><span class="number">0x366</span>: pop r[<span class="number">2</span>]</span><br><span class="line"><span class="number">0x369</span>: mov r[<span class="number">20</span>],<span class="number">0x127</span></span><br><span class="line"><span class="number">0x36c</span>: mov r[<span class="number">0</span>],<span class="number">0x154</span></span><br><span class="line"><span class="number">0x36f</span>: jmp r[<span class="number">0</span>]</span><br><span class="line"><span class="number">0x372</span>: mov r[<span class="number">0</span>],<span class="number">0x228ec216</span></span><br><span class="line"><span class="number">0x375</span>: mov r[<span class="number">19</span>],<span class="number">0x183</span></span><br><span class="line"><span class="number">0x378</span>: mov r[<span class="number">20</span>],<span class="number">0x153</span></span><br><span class="line"><span class="number">0x37b</span>: cmp r[<span class="number">1</span>],r[<span class="number">0</span>] -- jnz r[<span class="number">19</span>]</span><br><span class="line"><span class="number">0x37e</span>: mov r[<span class="number">0</span>],<span class="number">0x89d45a61</span></span><br><span class="line"><span class="number">0x381</span>: cmp r[<span class="number">2</span>],r[<span class="number">0</span>] -- jnz r[<span class="number">19</span>]</span><br><span class="line"><span class="number">0x384</span>: pop r[<span class="number">1</span>]</span><br><span class="line"><span class="number">0x387</span>: pop r[<span class="number">2</span>]</span><br><span class="line"><span class="number">0x38a</span>: mov r[<span class="number">20</span>],<span class="number">0x132</span></span><br><span class="line"><span class="number">0x38d</span>: mov r[<span class="number">0</span>],<span class="number">0x154</span></span><br><span class="line"><span class="number">0x390</span>: jmp r[<span class="number">0</span>]</span><br><span class="line"><span class="number">0x393</span>: mov r[<span class="number">0</span>],<span class="number">0x655b8f69</span></span><br><span class="line"><span class="number">0x396</span>: mov r[<span class="number">19</span>],<span class="number">0x183</span></span><br><span class="line"><span class="number">0x399</span>: mov r[<span class="number">20</span>],<span class="number">0x153</span></span><br><span class="line"><span class="number">0x39c</span>: cmp r[<span class="number">1</span>],r[<span class="number">0</span>] -- jnz r[<span class="number">19</span>]</span><br><span class="line"><span class="number">0x39f</span>: mov r[<span class="number">0</span>],<span class="number">0x2484a07a</span></span><br><span class="line"><span class="number">0x3a2</span>: cmp r[<span class="number">2</span>],r[<span class="number">0</span>] -- jnz r[<span class="number">19</span>]</span><br><span class="line"><span class="number">0x3a5</span>: pop r[<span class="number">1</span>]</span><br><span class="line"><span class="number">0x3a8</span>: pop r[<span class="number">2</span>]</span><br><span class="line"><span class="number">0x3ab</span>: mov r[<span class="number">20</span>],<span class="number">0x13d</span></span><br><span class="line"><span class="number">0x3ae</span>: mov r[<span class="number">0</span>],<span class="number">0x154</span></span><br><span class="line"><span class="number">0x3b1</span>: jmp r[<span class="number">0</span>]</span><br><span class="line"><span class="number">0x3b4</span>: mov r[<span class="number">0</span>],<span class="number">0xd9e5e7f8</span></span><br><span class="line"><span class="number">0x3b7</span>: mov r[<span class="number">19</span>],<span class="number">0x183</span></span><br><span class="line"><span class="number">0x3ba</span>: mov r[<span class="number">20</span>],<span class="number">0x153</span></span><br><span class="line"><span class="number">0x3bd</span>: cmp r[<span class="number">1</span>],r[<span class="number">0</span>] -- jnz r[<span class="number">19</span>]</span><br><span class="line"><span class="number">0x3c0</span>: mov r[<span class="number">0</span>],<span class="number">0x3a441532</span></span><br><span class="line"><span class="number">0x3c3</span>: cmp r[<span class="number">2</span>],r[<span class="number">0</span>] -- jnz r[<span class="number">19</span>]</span><br><span class="line"><span class="number">0x3c6</span>: pop r[<span class="number">1</span>]</span><br><span class="line"><span class="number">0x3c9</span>: pop r[<span class="number">2</span>]</span><br><span class="line"><span class="number">0x3cc</span>: mov r[<span class="number">20</span>],<span class="number">0x148</span></span><br><span class="line"><span class="number">0x3cf</span>: mov r[<span class="number">0</span>],<span class="number">0x154</span></span><br><span class="line"><span class="number">0x3d2</span>: jmp r[<span class="number">0</span>]</span><br><span class="line"><span class="number">0x3d5</span>: mov r[<span class="number">0</span>],<span class="number">0x91ab7e88</span></span><br><span class="line"><span class="number">0x3d8</span>: mov r[<span class="number">19</span>],<span class="number">0x183</span></span><br><span class="line"><span class="number">0x3db</span>: mov r[<span class="number">20</span>],<span class="number">0x153</span></span><br><span class="line"><span class="number">0x3de</span>: cmp r[<span class="number">1</span>],r[<span class="number">0</span>] -- jnz r[<span class="number">19</span>]</span><br><span class="line"><span class="number">0x3e1</span>: mov r[<span class="number">0</span>],<span class="number">0x69fc64bc</span></span><br><span class="line"><span class="number">0x3e4</span>: cmp r[<span class="number">2</span>],r[<span class="number">0</span>] -- jnz r[<span class="number">19</span>]</span><br><span class="line"><span class="number">0x3e7</span>: pop r[<span class="number">1</span>]</span><br><span class="line"><span class="number">0x3ea</span>: mov r[<span class="number">0</span>],<span class="number">0x7d3765</span></span><br><span class="line"><span class="number">0x3ed</span>: cmp r[<span class="number">1</span>],r[<span class="number">0</span>] -- jnz r[<span class="number">19</span>]</span><br><span class="line"><span class="number">0x3f0</span>: mov r[<span class="number">0</span>],<span class="number">0x189</span></span><br><span class="line"><span class="number">0x3f3</span>: jmp r[<span class="number">0</span>]</span><br><span class="line"><span class="number">0x3f6</span>: <span class="built_in">exit</span>()</span><br></pre></td></tr></tbody></table></figure><p>长度44，转为int是11个，前10个两两一组Tea，最后一个不处理，解密即可。</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ut32 unsigned int</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> delta 0x9E3779B9</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Tea_Decrypt</span><span class="params">(ut32* enc, ut32* k)</span> </span>{</span><br><span class="line">ut32 sum = delta * <span class="number">0x20</span>;</span><br><span class="line">ut32 v0 = enc[<span class="number">0</span>];</span><br><span class="line">ut32 v1 = enc[<span class="number">1</span>];</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x20</span>; i++) {</span><br><span class="line">v1 -= ((v0 &lt;&lt; <span class="number">4</span>) + k[<span class="number">2</span>]) ^ (v0 + sum) ^ ((v0 &gt;&gt; <span class="number">5</span>) + k[<span class="number">3</span>]);</span><br><span class="line">v0 -= ((v1 &lt;&lt; <span class="number">4</span>) + k[<span class="number">0</span>]) ^ (v1 + sum) ^ ((v1 &gt;&gt; <span class="number">5</span>) + k[<span class="number">1</span>]);</span><br><span class="line">sum -= delta;</span><br><span class="line">}</span><br><span class="line">enc[<span class="number">0</span>] = v0;</span><br><span class="line">enc[<span class="number">1</span>] = v1;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">ut32 m[<span class="number">2</span>] = { <span class="number">0xe8d1d5df</span>,<span class="number">0xf5e3c114</span> }; <span class="comment">//依次密文</span></span><br><span class="line">ut32 k[<span class="number">4</span>] = { <span class="number">0x95c4c</span>,<span class="number">0x871d</span>,<span class="number">0x1a7b7</span>,<span class="number">0x12c7c7</span>};</span><br><span class="line">Tea_Decrypt(m, k);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%x %x"</span>, m[<span class="number">0</span>], m[<span class="number">1</span>]);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"><span class="comment">//常规Tea解密</span></span><br><span class="line"><span class="comment">//VNCTF{ecd63ae5-8945-4ac4-b5a5-34fc3ade81e7}</span></span><br></pre></td></tr></tbody></table></figure><h3 id="cm1">cm1</h3><blockquote><p>Android题主要逻辑在隐藏的一个dex文件中</p></blockquote><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20220212234819160.png" alt="image-20220212234819160" style="zoom:80%;"><p>主要是copyfile这个函数</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">copyFiles</span><span class="params">(android.content.Context r6, java.lang.String r7, java.io.File r8)</span> </span>{</span><br><span class="line"></span><br><span class="line">        java.lang.String r0 = <span class="string">"vn2022"</span></span><br><span class="line">        <span class="keyword">byte</span>[] r0 = r0.getBytes()</span><br><span class="line">        r1 = <span class="number">0</span></span><br><span class="line">        android.content.Context r6 = r6.getApplicationContext()     <span class="comment">// Catch: IOException -&gt; 0x005a, all -&gt; 0x0056</span></span><br><span class="line">        android.content.res.AssetManager r6 = r6.getAssets()     <span class="comment">// Catch: IOException -&gt; 0x005a, all -&gt; 0x0056</span></span><br><span class="line">        java.io.InputStream r6 = r6.open(r7)     <span class="comment">// Catch: IOException -&gt; 0x005a, all -&gt; 0x0056</span></span><br><span class="line">        java.io.FileOutputStream r7 = <span class="keyword">new</span> java.io.FileOutputStream     <span class="comment">// Catch: IOException -&gt; 0x0052, all -&gt; 0x004f</span></span><br><span class="line">        java.lang.String r8 = r8.getAbsolutePath()     <span class="comment">// Catch: IOException -&gt; 0x0052, all -&gt; 0x004f</span></span><br><span class="line">        r7.&lt;init&gt;(r8)     <span class="comment">// Catch: IOException -&gt; 0x0052, all -&gt; 0x004f</span></span><br><span class="line">        r8 = <span class="number">1024</span>(<span class="number">0x400</span>, <span class="keyword">float</span>:<span class="number">1.435E-42</span>)</span><br><span class="line">        <span class="keyword">byte</span>[] r8 = <span class="keyword">new</span> <span class="keyword">byte</span>[r8]     <span class="comment">// Catch: IOException -&gt; 0x004d, all -&gt; 0x004b</span></span><br><span class="line">    L_0x0020:</span><br><span class="line">        <span class="keyword">int</span> r1 = r6.read(r8)     <span class="comment">// Catch: IOException -&gt; 0x004d, all -&gt; 0x004b</span></span><br><span class="line">        r2 = -<span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> (r1 == r2) goto L_0x003f</span><br><span class="line">        r2 = <span class="number">0</span></span><br><span class="line">        r3 = <span class="number">0</span></span><br><span class="line">    L_0x0029:</span><br><span class="line">        <span class="keyword">if</span> (r3 &gt;= r1) goto L_0x003b</span><br><span class="line">        <span class="keyword">byte</span> r4 = r8[r3]     <span class="comment">// Catch: IOException -&gt; 0x004d, all -&gt; 0x004b</span></span><br><span class="line">        <span class="keyword">int</span> r5 = r0.length     <span class="comment">// Catch: IOException -&gt; 0x004d, all -&gt; 0x004b</span></span><br><span class="line">        <span class="keyword">int</span> r5 = r3 % r5</span><br><span class="line">        <span class="keyword">byte</span> r5 = r0[r5]     <span class="comment">// Catch: IOException -&gt; 0x004d, all -&gt; 0x004b</span></span><br><span class="line">        r4 = r4 ^ r5</span><br><span class="line">        r4 = r4 &amp; <span class="number">255</span>(<span class="number">0xff</span>, <span class="keyword">float</span>:<span class="number">3.57E-43</span>)</span><br><span class="line">        <span class="keyword">byte</span> r4 = (<span class="keyword">byte</span>) r4     <span class="comment">// Catch: IOException -&gt; 0x004d, all -&gt; 0x004b</span></span><br><span class="line">        r8[r3] = r4     <span class="comment">// Catch: IOException -&gt; 0x004d, all -&gt; 0x004b</span></span><br><span class="line">        <span class="keyword">int</span> r3 = r3 + <span class="number">1</span></span><br><span class="line">        goto L_0x0029</span><br><span class="line">    L_0x003b:</span><br><span class="line">        r7.write(r8, r2, r1)     <span class="comment">// Catch: IOException -&gt; 0x004d, all -&gt; 0x004b</span></span><br><span class="line">        goto L_0x0020</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><blockquote><p>有点小坑，这里是1024byte读取一次，每次重新开始与vn2022异或，不是直接异或 (坑死了,粗心)</p></blockquote><p><code>re dex</code></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">key=<span class="string">b'vn2022'</span></span><br><span class="line">f1=<span class="built_in">open</span>(<span class="string">r'ooo'</span>,<span class="string">'rb+'</span>)</span><br><span class="line">f2=<span class="built_in">open</span>(<span class="string">r'111'</span>,<span class="string">'wb+'</span>)</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    t=[]</span><br><span class="line">    s=f1.read(<span class="number">1024</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(s)==<span class="number">0</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(s)):</span><br><span class="line">       t.append(s[i]^key[i%<span class="built_in">len</span>(key)])</span><br><span class="line">    f2.write(<span class="built_in">bytes</span>(t))</span><br></pre></td></tr></tbody></table></figure><p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20220212235258147.png" alt="image-20220212235258147"></p><blockquote><p>主体是XXtea，其余就是一些 arry2int 小端序变化 ，请出祖传的XXTea脚本即可，delta没魔改(-法转为+法补码是一样的)</p></blockquote><p>获取key和enc,其实就是小端序转int</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line">a=<span class="string">b'H4pPY_VNCTF!!OvO'</span></span><br><span class="line">r=[<span class="number">0</span>]*<span class="number">4</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">    i2 = i &gt;&gt; <span class="number">2</span></span><br><span class="line">    r[i2] = r[i2] | ((a[i] &amp; <span class="number">255</span>) &lt;&lt; ((i &amp; <span class="number">3</span>) &lt;&lt; <span class="number">3</span>))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> r:</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(i),end=<span class="string">','</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>()</span><br><span class="line">enc=[<span class="number">0</span>]*<span class="number">11</span></span><br><span class="line">c=[<span class="number">0x44</span> ,<span class="number">0x27</span> ,<span class="number">0xffffffa4</span> ,<span class="number">0x6c</span> ,<span class="number">0xffffffae</span> ,<span class="number">0xffffffee</span> ,<span class="number">0x48</span> ,<span class="number">0xffffffc9</span> ,<span class="number">0x4a</span> ,<span class="number">0xffffffc8</span> ,<span class="number">0x26</span> ,<span class="number">0x0b</span> ,<span class="number">0x3c</span> ,<span class="number">0x54</span> ,<span class="number">0x61</span> ,<span class="number">0xffffffd8</span> ,<span class="number">0x57</span> ,<span class="number">0x47</span> ,<span class="number">0x63</span> ,<span class="number">0xffffffae</span> ,<span class="number">0x78</span> ,<span class="number">0x68</span> ,<span class="number">0x2f</span> ,<span class="number">0xffffffb9</span> ,<span class="number">0xffffffc6</span> ,<span class="number">0xffffffc7</span> ,<span class="number">0x00</span> ,<span class="number">0x21</span> ,<span class="number">0x2a</span> ,<span class="number">0x26</span> ,<span class="number">0xffffffd4</span> ,<span class="number">0xffffffd9</span> ,<span class="number">0xffffffc4</span> ,<span class="number">0x71</span> ,<span class="number">0xfffffffe</span> ,<span class="number">0x5c</span> ,<span class="number">0xffffffb5</span> ,<span class="number">0x76</span> ,<span class="number">0xffffffb3</span> ,<span class="number">0x32</span> ,<span class="number">0xffffff87</span> ,<span class="number">0x2b</span> ,<span class="number">0x20</span> ,<span class="number">0xffffff96</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(c)):</span><br><span class="line">    i2 = i &gt;&gt; <span class="number">2</span></span><br><span class="line">    enc[i2] = enc[i2] | ((c[i] &amp; <span class="number">255</span>) &lt;&lt; ((i &amp; <span class="number">3</span>) &lt;&lt; <span class="number">3</span>))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> enc:</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(i),end=<span class="string">','</span>)</span><br><span class="line"><span class="built_in">print</span>()</span><br><span class="line">key=[<span class="number">0x50703448</span>,<span class="number">0x4e565f59</span>,<span class="number">0x21465443</span>,<span class="number">0x4f764f21</span>]</span><br><span class="line">enc=[<span class="number">0x6ca42744</span>,<span class="number">0xc948eeae</span>,<span class="number">0xb26c84a</span>,<span class="number">0xd861543c</span>,<span class="number">0xae634757</span>,<span class="number">0xb92f6878</span>,<span class="number">0x2100c7c6</span>,<span class="number">0xd9d4262a</span>,<span class="number">0x5cfe71c4</span>,<span class="number">0x32b376b5</span>,<span class="number">0x96202b87</span>]</span><br></pre></td></tr></tbody></table></figure><p><code>XXtea</code></p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DELTA 0x9e3779b9</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MX (((z&gt;&gt;5^y<span class="meta-string">&lt;&lt;2) + (y&gt;</span>&gt;3^z&lt;&lt;4)) ^ ((sum^y) + (key[(p&amp;3)^e] ^ z)))</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">btea</span><span class="params">(<span class="keyword">uint32_t</span>* v, <span class="keyword">int</span> n, <span class="keyword">uint32_t</span> <span class="keyword">const</span> key[<span class="number">4</span>])</span> </span>{</span><br><span class="line">    <span class="keyword">uint32_t</span> y, z, sum;</span><br><span class="line">    <span class="keyword">unsigned</span> p, rounds, e;</span><br><span class="line">    <span class="keyword">if</span> (n &gt; <span class="number">1</span>) {          <span class="comment">/* Coding Part */</span></span><br><span class="line">        rounds = <span class="number">6</span> + <span class="number">52</span> / n; <span class="comment">//加密轮数</span></span><br><span class="line">        sum = <span class="number">0</span>;</span><br><span class="line">        z = v[n - <span class="number">1</span>];</span><br><span class="line">        <span class="keyword">do</span> {</span><br><span class="line">            sum += DELTA;</span><br><span class="line">            e = (sum &gt;&gt; <span class="number">2</span>) &amp; <span class="number">3</span>;</span><br><span class="line">            <span class="keyword">for</span> (p = <span class="number">0</span>; p &lt; n - <span class="number">1</span>; p++) {</span><br><span class="line">                y = v[p + <span class="number">1</span>];</span><br><span class="line">                z = v[p] += MX;</span><br><span class="line">            }</span><br><span class="line">            y = v[<span class="number">0</span>];</span><br><span class="line">            z = v[n - <span class="number">1</span>] += MX;</span><br><span class="line">        } <span class="keyword">while</span> (--rounds);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (n &lt; <span class="number">-1</span>) {  <span class="comment">/* Decoding Part */</span></span><br><span class="line">        n = -n;</span><br><span class="line">        rounds = <span class="number">6</span> + <span class="number">52</span> / n;</span><br><span class="line">        sum = rounds * DELTA;</span><br><span class="line">        y = v[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">do</span> {</span><br><span class="line">            e = (sum &gt;&gt; <span class="number">2</span>) &amp; <span class="number">3</span>;</span><br><span class="line">            <span class="keyword">for</span> (p = n - <span class="number">1</span>; p &gt; <span class="number">0</span>; p--) {</span><br><span class="line">                z = v[p - <span class="number">1</span>];</span><br><span class="line">                y = v[p] -= MX;</span><br><span class="line">            }</span><br><span class="line">            z = v[n - <span class="number">1</span>];</span><br><span class="line">            y = v[<span class="number">0</span>] -= MX;</span><br><span class="line">            sum -= DELTA;</span><br><span class="line">        } <span class="keyword">while</span> (--rounds);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> m[<span class="number">11</span>] = { <span class="number">0x6ca42744</span>,<span class="number">0xc948eeae</span>,<span class="number">0xb26c84a</span>,<span class="number">0xd861543c</span>,<span class="number">0xae634757</span>,<span class="number">0xb92f6878</span>,<span class="number">0x2100c7c6</span>,<span class="number">0xd9d4262a</span>,<span class="number">0x5cfe71c4</span>,<span class="number">0x32b376b5</span>,<span class="number">0x96202b87</span> };</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> k[<span class="number">4</span>] = { <span class="number">0x50703448</span>,<span class="number">0x4e565f59</span>,<span class="number">0x21465443</span>,<span class="number">0x4f764f21</span> };</span><br><span class="line">    btea(m, <span class="number">-11</span>, k);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">11</span>; i++) {</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"0x%x ,"</span>,m[i]);</span><br><span class="line">}</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">//VNCTF{93ee7688-f216-42cb-a5c2-191ff4e412ba} </span></span><br></pre></td></tr></tbody></table></figure><h3 id="时空飞行">时空飞行</h3><blockquote><p>太遗憾了，被C++的符号搞懵逼了</p></blockquote><p>首先是求日期,处理函数类似SM4的秘钥扩展，不过L函数魔改了</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">SM4_keyInit</span><span class="params">(_DWORD *a1, <span class="keyword">unsigned</span> <span class="keyword">int</span> *a2)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// esi</span></span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// ebx</span></span><br><span class="line">  <span class="keyword">int</span> v4[<span class="number">36</span>]; <span class="comment">// [rsp+20h] [rbp-B0h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v5; <span class="comment">// [rsp+B0h] [rbp-20h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v6; <span class="comment">// [rsp+B4h] [rbp-1Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v7; <span class="comment">// [rsp+B8h] [rbp-18h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v8; <span class="comment">// [rsp+BCh] [rbp-14h]</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [rsp+CCh] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  v5 = _byteswap_ulong(*a2);</span><br><span class="line">  v6 = _byteswap_ulong(a2[<span class="number">1</span>]);</span><br><span class="line">  v7 = _byteswap_ulong(a2[<span class="number">2</span>]);</span><br><span class="line">  v8 = _byteswap_ulong(a2[<span class="number">3</span>]);</span><br><span class="line">  v4[<span class="number">0</span>] = v5 ^ <span class="number">0xA3B1BAC6</span>;</span><br><span class="line">  v4[<span class="number">1</span>] = v6 ^ <span class="number">0x56AA3350</span>;</span><br><span class="line">  v4[<span class="number">2</span>] = v7 ^ <span class="number">0x677D9197</span>;</span><br><span class="line">  v4[<span class="number">3</span>] = v8 ^ <span class="number">0xB27022DC</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">31</span>; ++i )</span><br><span class="line">  {</span><br><span class="line">    v2 = i + <span class="number">4</span>;</span><br><span class="line">    v3 = v4[i];</span><br><span class="line">    v4[v2] = sub_401A3B(v4[i + <span class="number">3</span>] ^ v4[i + <span class="number">2</span>] ^ (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v4[i + <span class="number">1</span>] ^ CK[i]) ^ v3;</span><br><span class="line">    a1[i] = v4[i + <span class="number">4</span>];</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_401A3B</span><span class="params">(<span class="keyword">int</span> a1)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  <span class="keyword">return</span> a1 ^ (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(__ROL4__(a1, <span class="number">13</span>) ^ __ROR4__(a1, <span class="number">9</span>));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>给出了Rkey的后4位，直接逆序往前推即可，主要加密是异或，具有对称性。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">L</span>(<span class="params">a</span>):</span></span><br><span class="line">    x=((a&lt;&lt;<span class="number">13</span>)|(a&gt;&gt;(<span class="number">32</span>-<span class="number">13</span>)))&amp;<span class="number">0xffffffff</span></span><br><span class="line">    y=((a&gt;&gt;<span class="number">9</span>)|(a&lt;&lt;(<span class="number">32</span>-<span class="number">9</span>)))&amp;<span class="number">0xffffffff</span></span><br><span class="line">    <span class="keyword">return</span> x^y^a</span><br><span class="line">FK=[<span class="number">0xa3b1bac6</span>, <span class="number">0x56aa3350</span>, <span class="number">0x677d9197</span>, <span class="number">0xb27022dc</span>]</span><br><span class="line">CK=[<span class="number">0x00070E15</span>, <span class="number">0x1C232A31</span>, <span class="number">0x383F464D</span>, <span class="number">0x545B6269</span>, <span class="number">0x70777E85</span>, <span class="number">0x8C939AA1</span>, <span class="number">0xA8AFB6BD</span>, <span class="number">0xC4CBD2D9</span>,</span><br><span class="line">    <span class="number">0xE0E7EEF5</span>, <span class="number">0xFC030A11</span>, <span class="number">0x181F262D</span>, <span class="number">0x343B4249</span>, <span class="number">0x50575E65</span>, <span class="number">0x6C737A81</span>, <span class="number">0x888F969D</span>, <span class="number">0xA4ABB2B9</span>,</span><br><span class="line">    <span class="number">0xC0C7CED5</span>, <span class="number">0xDCE3EAF1</span>, <span class="number">0xF8FF060D</span>, <span class="number">0x141B2229</span>, <span class="number">0x30373E45</span>, <span class="number">0x4C535A61</span>, <span class="number">0x686F767D</span>, <span class="number">0x848B9299</span>,</span><br><span class="line">    <span class="number">0xA0A7AEB5</span>, <span class="number">0xBCC3CAD1</span>, <span class="number">0xD8DFE6ED</span>, <span class="number">0xF4FB0209</span>, <span class="number">0x10171E25</span>, <span class="number">0x2C333A41</span>, <span class="number">0x484F565D</span>, <span class="number">0x646B7279</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change</span>(<span class="params">k</span>):</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        k[i]^=FK[i]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">        tmp=L(k[i+<span class="number">1</span>]^k[i+<span class="number">2</span>]^k[i+<span class="number">3</span>]^CK[i])</span><br><span class="line">        k.append(tmp^k[i])</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>,<span class="number">36</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">hex</span>(k[i]),end=<span class="string">','</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">reverse</span>():</span></span><br><span class="line">    k=[<span class="number">0</span>]*<span class="number">36</span></span><br><span class="line">    k[<span class="number">32</span>] = <span class="number">0xFD07C452</span></span><br><span class="line">    k[<span class="number">33</span>] = <span class="number">0xEC90A488</span></span><br><span class="line">    k[<span class="number">34</span>] = <span class="number">0x68D33CD1</span></span><br><span class="line">    k[<span class="number">35</span>] = <span class="number">0x96F64587</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">31</span>,-<span class="number">1</span>,-<span class="number">1</span>):</span><br><span class="line">        tmp=L(k[i+<span class="number">1</span>]^k[i+<span class="number">2</span>]^k[i+<span class="number">3</span>]^CK[i])</span><br><span class="line">        k[i]=tmp^k[i+<span class="number">4</span>]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        k[i] ^= FK[i]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">int</span>.to_bytes(k[i],<span class="number">4</span>,<span class="string">'big'</span>).decode(),end=<span class="string">''</span>)</span><br><span class="line"></span><br><span class="line">reverse()</span><br><span class="line"><span class="comment">#20211205</span></span><br></pre></td></tr></tbody></table></figure><p>之后又进行输入，第一次处理函数类似AES秘钥扩展</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">5</span>; ++i )</span><br><span class="line">    a1[i] = sub_401E21((<span class="keyword">char</span> *)(<span class="number">4</span> * i + a2));   <span class="comment">// 大端序</span></span><br><span class="line">  v5 = <span class="number">6</span>;</span><br><span class="line">  v3 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> ( v5 &lt;= <span class="number">65</span> )</span><br><span class="line">  {</span><br><span class="line">    <span class="keyword">if</span> ( v5 % <span class="number">6</span> )</span><br><span class="line">    {</span><br><span class="line">      a1[v5] = a1[v5 - <span class="number">6</span>] ^ a1[v5 - <span class="number">1</span>];</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    {</span><br><span class="line">      v2 = a1[v5 - <span class="number">6</span>];</span><br><span class="line">      a1[v5] = v2 ^ sub_401FFB(a1[v5 - <span class="number">1</span>], v3++);</span><br><span class="line">    }</span><br><span class="line">    ++v5;</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_401FFB</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> a1, <span class="keyword">int</span> a2)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  <span class="keyword">char</span> v3[<span class="number">28</span>]; <span class="comment">// [rsp+20h] [rbp-20h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v4; <span class="comment">// [rsp+3Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  int_to_array(a1, v3);                         <span class="comment">// 大端</span></span><br><span class="line">  shift_left1(v3, <span class="number">1</span>i64);<span class="comment">//左移一</span></span><br><span class="line">  v4 = array_to_int(v3);<span class="comment">// 大端</span></span><br><span class="line">  <span class="keyword">return</span> v4 ^ round_key[a2];<span class="comment">//异或轮秘钥</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>之后转为小端序进行一个不可逆的异或处理。</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">5</span>; ++i )                    <span class="comment">// 扩展为66 v5是24个字节</span></span><br><span class="line">{</span><br><span class="line">  v4[<span class="number">4</span> * i] = (<span class="keyword">unsigned</span> __int8)ext_key[i + <span class="number">60</span>];</span><br><span class="line">  v4[<span class="number">4</span> * i + <span class="number">1</span>] = (<span class="keyword">unsigned</span> __int8)BYTE1(ext_key[i + <span class="number">60</span>]);</span><br><span class="line">  v4[<span class="number">4</span> * i + <span class="number">2</span>] = (<span class="keyword">unsigned</span> __int8)BYTE2(ext_key[i + <span class="number">60</span>]);</span><br><span class="line">  v4[<span class="number">4</span> * i + <span class="number">3</span>] = HIBYTE(ext_key[i + <span class="number">60</span>]);</span><br><span class="line">}                                             <span class="comment">// v4是最后一轮key</span></span><br><span class="line"><span class="keyword">for</span> ( i = <span class="number">1</span>; i &lt;= <span class="number">23</span>; ++i )</span><br><span class="line">  v4[i - <span class="number">1</span>] ^= (v4[i - <span class="number">1</span>] % <span class="number">0x12</span>u + v4[i] + <span class="number">5</span>) ^ <span class="number">0x41</span>;</span><br></pre></td></tr></tbody></table></figure><p><strong>之前遇到过类似不可逆的处理，可以用dfs爆破所有结果。</strong></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> struct, copy</span><br><span class="line"><span class="comment">#key1='20211205'</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">arr2int</span>(<span class="params">k</span>):</span>      <span class="comment">#小端</span></span><br><span class="line">    m=[<span class="number">0</span>]*(<span class="built_in">len</span>(k)//<span class="number">4</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(k)):</span><br><span class="line">        m[i//<span class="number">4</span>]|=k[i]&lt;&lt;((i&amp;<span class="number">3</span>)*<span class="number">8</span>)</span><br><span class="line">    <span class="keyword">return</span> m</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">F</span>(<span class="params">a,<span class="built_in">round</span></span>):</span></span><br><span class="line">    s=<span class="built_in">hex</span>(a)[<span class="number">2</span>:].zfill(<span class="number">8</span>)</span><br><span class="line">    k=[]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">8</span>,<span class="number">2</span>): <span class="comment">#大端序</span></span><br><span class="line">       k.append(<span class="built_in">int</span>(s[i:i+<span class="number">2</span>],<span class="number">16</span>))</span><br><span class="line">    m=[<span class="number">0</span>]*<span class="number">4</span></span><br><span class="line">    m[<span class="number">0</span>]=k[<span class="number">1</span>]</span><br><span class="line">    m[<span class="number">1</span>]=k[<span class="number">2</span>]</span><br><span class="line">    m[<span class="number">2</span>]=k[<span class="number">3</span>]</span><br><span class="line">    m[<span class="number">3</span>]=k[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    ans=<span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        ans|=m[i]&lt;&lt;((<span class="number">3</span>-i)*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ans^rk[<span class="built_in">round</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dfs_get_cipher2</span>(<span class="params">k</span>):</span>                                 <span class="comment"># 递归枚举所可能的密文</span></span><br><span class="line">    <span class="keyword">if</span> k == <span class="number">0</span>:</span><br><span class="line">        cipher_list.append(copy.deepcopy(c))</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x100</span>):</span><br><span class="line">        <span class="keyword">if</span> final[k-<span class="number">1</span>] ==  j^(j%<span class="number">0x12</span>+c[k] + <span class="number">5</span>)^<span class="number">0x41</span> :</span><br><span class="line">            c[k-<span class="number">1</span>] = j</span><br><span class="line">            dfs_get_cipher2(k-<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">final = <span class="string">b'%\x15\xdf\xa2\xc0\x93\xad\x14F\xc5\x0f.\x9a\xeb0\xf8 \xe9\xcb\x88\xc6\xbe\x8d\xe3'</span></span><br><span class="line">c = [-<span class="number">1</span>] * <span class="number">24</span></span><br><span class="line">c[<span class="number">23</span>] = final[<span class="number">23</span>]</span><br><span class="line">cipher_list = []</span><br><span class="line">dfs_get_cipher2(<span class="number">23</span>)</span><br><span class="line">k=cipher_list[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">rk=[<span class="number">0x01000000</span>, <span class="number">0x02000000</span>, <span class="number">0x04000000</span>, <span class="number">0x08000000</span>, <span class="number">0x10000000</span>, <span class="number">0x20000000</span>, <span class="number">0x40000000</span>, <span class="number">0x80000000</span>, <span class="number">0x1B000000</span>, <span class="number">0x36000000</span>]</span><br><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> cipher_list:    </span><br><span class="line">    m=arr2int(k)</span><br><span class="line">    ff=[<span class="number">0</span>]*<span class="number">60</span></span><br><span class="line">    ff.extend(m)</span><br><span class="line"></span><br><span class="line">    v3=<span class="number">9</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">59</span>,-<span class="number">1</span>,-<span class="number">1</span>):</span><br><span class="line">        <span class="keyword">if</span> i%<span class="number">6</span>!=<span class="number">0</span>:</span><br><span class="line">            ff[i]=ff[i+<span class="number">6</span>]^ff[i+<span class="number">5</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            ff[i]=ff[i+<span class="number">6</span>]^F(ff[i+<span class="number">5</span>],v3)</span><br><span class="line">            v3-=<span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">       <span class="keyword">try</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">int</span>.to_bytes(ff[i],<span class="number">4</span>,<span class="string">'big'</span>).decode(),end=<span class="string">''</span>)</span><br><span class="line">       <span class="keyword">except</span>:</span><br><span class="line">           <span class="keyword">break</span></span><br><span class="line">    <span class="built_in">print</span>()</span><br><span class="line"><span class="comment">#VNCTF{TimeFlightMachine}  爆破筛选结果</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#VNCTF{TimeFl20211205ightMachine}</span></span><br></pre></td></tr></tbody></table></figure><blockquote><p>加密都是异或，第一步AES秘钥扩展也比较容易</p></blockquote><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20220213000738274.png" alt="image-20220213000738274" style="zoom:80%;"><p>不虚此行，别等叶枯萎。</p><blockquote><p>长路漫漫，再回首，依旧是昔日零解少年，当与君共勉，继续寻找新的答案。</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> CTF-WP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Wp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RE-VM技术入门</title>
      <link href="/2022/01/29/RE-VM%E6%8A%80%E6%9C%AF%E5%85%A5%E9%97%A8/"/>
      <url>/2022/01/29/RE-VM%E6%8A%80%E6%9C%AF%E5%85%A5%E9%97%A8/</url>
      
        <content type="html"><![CDATA[<h2 id="VM技术的原理">VM技术的原理</h2><p><strong>虚拟机保护是通过开发者自定的一套opcode，由虚拟机的dispatcher解释执行，从而起到代码混淆、增加逆向难度的技术。</strong></p><p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/2055422-20200604223943869-170147777.png" alt="img"></p><p><strong>VM_start:是对虚拟机的初始化。</strong></p><p><strong>VM_dispatcher: 调度器，解释op_code,并选择相应的函数执行,一般为switch语句，根据地址码判断。</strong></p><p><strong>VM_code:程序可执行代码形成的操作码。</strong></p><blockquote><p>通过对HWS-2022的babyVM来初涉VM保护的逆向分析。</p></blockquote><h2 id="BabyVM">BabyVM</h2><p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20220128224102355.png" alt="image-20220128224102355"></p><p>首先花指令，通过jz 和 jnz 连用实现jmp的功能，本题多次运用该花指令。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> idautils</span><br><span class="line">adr=<span class="number">0x00412CC0</span></span><br><span class="line">end=<span class="number">0x00413991</span> </span><br><span class="line">tmp=get_bytes(adr,end-adr)</span><br><span class="line">tmp=tmp.replace(<span class="string">b'\x74\x03\x75\x01\xE8'</span>,<span class="string">b'\x90'</span>*<span class="number">5</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(tmp)):</span><br><span class="line">    PatchByte(adr+i,tmp[i])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">'ok'</span>)    </span><br></pre></td></tr></tbody></table></figure><h3 id="VM-Dispatcher">VM_Dispatcher</h3><p>修复好后可以直接看到VM_Dispatcher函数内容，根据opcode中的地址码以switch和case语句来执行。</p><p>通过分析代码来确定变量的特殊用途，并且定义相应结构体。</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __cdecl <span class="title">VM_Dispatch</span><span class="params">(_DWORD *a1)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  __int64 *v1; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v2; <span class="comment">// kr00_8</span></span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// ecx</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v6; <span class="comment">// esi</span></span><br><span class="line">  <span class="keyword">int</span> v7; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v8; <span class="comment">// ecx</span></span><br><span class="line">  <span class="keyword">int</span> v9; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v10; <span class="comment">// ecx</span></span><br><span class="line">  <span class="keyword">int</span> v11; <span class="comment">// esi</span></span><br><span class="line">  <span class="keyword">int</span> v12; <span class="comment">// ecx</span></span><br><span class="line">  <span class="keyword">int</span> v13; <span class="comment">// esi</span></span><br><span class="line">  <span class="keyword">int</span> v14; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v15; <span class="comment">// edx</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v16; <span class="comment">// ecx</span></span><br><span class="line">  <span class="keyword">int</span> v17; <span class="comment">// edx</span></span><br><span class="line">  __int64 v18; <span class="comment">// kr08_8</span></span><br><span class="line">  <span class="keyword">int</span> v19; <span class="comment">// eax</span></span><br><span class="line">  __int64 v20; <span class="comment">// rdi</span></span><br><span class="line">  __int64 v21; <span class="comment">// rdi</span></span><br><span class="line">  <span class="keyword">int</span> v22; <span class="comment">// eax</span></span><br><span class="line">  __int64 v23; <span class="comment">// kr10_8</span></span><br><span class="line">  <span class="keyword">int</span> v24; <span class="comment">// eax</span></span><br><span class="line">  __int64 v25; <span class="comment">// rdi</span></span><br><span class="line">  __int64 v26; <span class="comment">// rdi</span></span><br><span class="line">  <span class="keyword">int</span> v27; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v28; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v29; <span class="comment">// eax</span></span><br><span class="line">  __int64 v30; <span class="comment">// rax</span></span><br><span class="line">  __int64 v31; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">int</span> v32; <span class="comment">// esi</span></span><br><span class="line">  __int64 v33; <span class="comment">// rax</span></span><br><span class="line">  __int64 v34; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">int</span> v35; <span class="comment">// esi</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v36; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v37; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">int</span> v38; <span class="comment">// esi</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v39; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v40; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">int</span> v41; <span class="comment">// esi</span></span><br><span class="line">  <span class="keyword">int</span> v42; <span class="comment">// edi</span></span><br><span class="line">  <span class="keyword">int</span> v43; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v44; <span class="comment">// esi</span></span><br><span class="line">  <span class="keyword">int</span> v45; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v46; <span class="comment">// edi</span></span><br><span class="line">  <span class="keyword">int</span> v47; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v48; <span class="comment">// esi</span></span><br><span class="line">  <span class="keyword">int</span> v49; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v50; <span class="comment">// edi</span></span><br><span class="line">  <span class="keyword">int</span> v51; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v52; <span class="comment">// esi</span></span><br><span class="line">  <span class="keyword">int</span> v53; <span class="comment">// eax</span></span><br><span class="line">  __int64 v54; <span class="comment">// kr18_8</span></span><br><span class="line">  <span class="keyword">int</span> v55; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v56; <span class="comment">// eax</span></span><br><span class="line">  __int64 v57; <span class="comment">// [esp-10h] [ebp-134h]</span></span><br><span class="line">  __int64 v58; <span class="comment">// [esp-10h] [ebp-134h]</span></span><br><span class="line">  __int64 v59; <span class="comment">// [esp-8h] [ebp-12Ch]</span></span><br><span class="line">  <span class="keyword">int</span> v60; <span class="comment">// [esp+10h] [ebp-114h]</span></span><br><span class="line">  __int64 Inst_op; <span class="comment">// [esp+108h] [ebp-1Ch]</span></span><br><span class="line">  __int64 Lnum; <span class="comment">// [esp+110h] [ebp-14h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 Rnum; <span class="comment">// [esp+118h] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  LODWORD(Reg.RIP) = <span class="number">0</span>;</span><br><span class="line">  HIDWORD(Reg.RIP) = <span class="number">0</span>;</span><br><span class="line">LABEL_2:</span><br><span class="line">  <span class="keyword">while</span> ( a1[<span class="number">6</span> * LODWORD(Reg.RIP)] != <span class="number">0x19</span> )    <span class="comment">// REG15 是EIP</span></span><br><span class="line">  {</span><br><span class="line">    v1 = (__int64 *)&amp;a1[<span class="number">6</span> * LODWORD(Reg.RIP)];  <span class="comment">// 4x6=24字节 指令长度 低16字节分为两个操作数</span></span><br><span class="line">    Inst_op = *v1;</span><br><span class="line">    Lnum = v1[<span class="number">1</span>];</span><br><span class="line">    Rnum = v1[<span class="number">2</span>];</span><br><span class="line">    v2 = __PAIR64__(HIDWORD(Reg.RIP), LODWORD(Reg.RIP)++) + <span class="number">1</span>;<span class="comment">// 修改PC 即EIP</span></span><br><span class="line">    HIDWORD(Reg.RIP) = HIDWORD(v2);</span><br><span class="line">    <span class="keyword">switch</span> ( (<span class="keyword">int</span>)Inst_op )</span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">        *(_QWORD *)(Mem + <span class="number">8</span> * LODWORD(Reg.R[Lnum])) = Rnum;<span class="comment">// mov Mem[Reg[Lnum]],Rnum</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        v5 = Lnum;</span><br><span class="line">        LODWORD(Reg.R[v5]) = Rnum;</span><br><span class="line">        HIDWORD(Reg.R[v5]) = HIDWORD(Rnum);     <span class="comment">// mov Reg[Lnum],Rnum</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        v9 = Lnum;                              <span class="comment">// mov Reg[Lnum],Reg[Rnum]</span></span><br><span class="line">        LODWORD(Reg.R[v9]) = Reg.R[Rnum];</span><br><span class="line">        HIDWORD(Reg.R[v9]) = HIDWORD(Reg.R[Rnum]);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">        v6 = <span class="number">8</span> * LODWORD(Reg.R[Rnum]);          <span class="comment">// mov Reg[Lnum],Mem[Reg[Rnum]]</span></span><br><span class="line">        v7 = Lnum;</span><br><span class="line">        v8 = Mem;</span><br><span class="line">        LODWORD(Reg.R[v7]) = *(_DWORD *)(Mem + v6);</span><br><span class="line">        HIDWORD(Reg.R[v7]) = *(_DWORD *)(v8 + v6 + <span class="number">4</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">        v3 = <span class="number">8</span> * LODWORD(Reg.R[Lnum]);</span><br><span class="line">        v4 = Mem;</span><br><span class="line">        *(_DWORD *)(Mem + v3) = Reg.R[Rnum];</span><br><span class="line">        *(_DWORD *)(v4 + v3 + <span class="number">4</span>) = HIDWORD(Reg.R[Rnum]);<span class="comment">// mov Mem[Reg[Lnum]],Reg[Rnum]</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">        v10 = Reg.R[<span class="number">4</span>];                         <span class="comment">// Reg[4]初始化时为0x100 类似ESP</span></span><br><span class="line">        v60 = __CFADD__(v10, <span class="number">1</span>) + HIDWORD(Reg.R[<span class="number">4</span>]);<span class="comment">// push Reg[Lnum]</span></span><br><span class="line">        LODWORD(Reg.R[<span class="number">4</span>]) = v10 + <span class="number">1</span>;</span><br><span class="line">        HIDWORD(Reg.R[<span class="number">4</span>]) = v60;</span><br><span class="line">        v11 = <span class="number">8</span> * (v10 + <span class="number">1</span>);</span><br><span class="line">        v12 = Buffer;</span><br><span class="line">        *(_DWORD *)(Buffer + v11) = Reg.R[Lnum];</span><br><span class="line">        *(_DWORD *)(v12 + v11 + <span class="number">4</span>) = HIDWORD(Reg.R[Lnum]);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">        v13 = <span class="number">8</span> * LODWORD(Reg.R[<span class="number">4</span>]);</span><br><span class="line">        v14 = Lnum;</span><br><span class="line">        v15 = Buffer;</span><br><span class="line">        LODWORD(Reg.R[v14]) = *(_DWORD *)(Buffer + v13);<span class="comment">// pop Reg[Lnum]</span></span><br><span class="line">        HIDWORD(Reg.R[v14]) = *(_DWORD *)(v15 + v13 + <span class="number">4</span>);</span><br><span class="line">        v16 = Reg.R[<span class="number">4</span>];</span><br><span class="line">        v17 = (__PAIR64__(HIDWORD(Reg.R[<span class="number">4</span>]), v16) - <span class="number">1</span>) &gt;&gt; <span class="number">32</span>;</span><br><span class="line">        LODWORD(Reg.R[<span class="number">4</span>]) = v16 - <span class="number">1</span>;</span><br><span class="line">        HIDWORD(Reg.R[<span class="number">4</span>]) = v17;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">        v18 = Rnum + __PAIR64__(HIDWORD(Reg.R[Lnum]), Reg.R[Lnum]);<span class="comment">// add Reg[Lnum],Rnum</span></span><br><span class="line">        v19 = Lnum;</span><br><span class="line">        LODWORD(Reg.R[v19]) = Rnum + LODWORD(Reg.R[Lnum]);</span><br><span class="line">        HIDWORD(Reg.R[v19]) = HIDWORD(v18);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">8</span>:                                   <span class="comment">// add Reg[Lnum],Reg[Rnum]</span></span><br><span class="line">        LODWORD(v20) = Reg.R[Lnum];</span><br><span class="line">        HIDWORD(v20) = HIDWORD(Reg.R[Lnum]);</span><br><span class="line">        v21 = __PAIR64__(HIDWORD(Reg.R[Rnum]), Reg.R[Rnum]) + v20;</span><br><span class="line">        v22 = Lnum;</span><br><span class="line">        LODWORD(Reg.R[v22]) = v21;</span><br><span class="line">        HIDWORD(Reg.R[v22]) = HIDWORD(v21);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">9</span>:</span><br><span class="line">        v23 = __PAIR64__(HIDWORD(Reg.R[Lnum]), Reg.R[Lnum]) - Rnum;<span class="comment">// sub Reg[Lnum],Rnum</span></span><br><span class="line">        v24 = Lnum;</span><br><span class="line">        LODWORD(Reg.R[v24]) = LODWORD(Reg.R[Lnum]) - Rnum;</span><br><span class="line">        HIDWORD(Reg.R[v24]) = HIDWORD(v23);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0xA</span>:</span><br><span class="line">        LODWORD(v25) = Reg.R[Lnum];</span><br><span class="line">        HIDWORD(v25) = HIDWORD(Reg.R[Lnum]);</span><br><span class="line">        v26 = v25 - __PAIR64__(HIDWORD(Reg.R[Rnum]), Reg.R[Rnum]);<span class="comment">// sub Reg[Lnum],Reg[Rnum]</span></span><br><span class="line">        v27 = Lnum;</span><br><span class="line">        LODWORD(Reg.R[v27]) = v26;</span><br><span class="line">        HIDWORD(Reg.R[v27]) = HIDWORD(v26);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0xB</span>:</span><br><span class="line">        HIDWORD(v57) = HIDWORD(Reg.R[Lnum]);    <span class="comment">// mul Reg[Lnum],Rnum</span></span><br><span class="line">        LODWORD(v57) = Reg.R[Lnum];</span><br><span class="line">        v28 = Lnum;</span><br><span class="line">        LODWORD(Reg.R[v28]) = v57 * Rnum;</span><br><span class="line">        HIDWORD(Reg.R[v28]) = (v57 * Rnum) &gt;&gt; <span class="number">32</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0xC</span>:</span><br><span class="line">        HIDWORD(v59) = HIDWORD(Reg.R[Rnum]);</span><br><span class="line">        LODWORD(v59) = Reg.R[Rnum];</span><br><span class="line">        HIDWORD(v58) = HIDWORD(Reg.R[Lnum]);</span><br><span class="line">        LODWORD(v58) = Reg.R[Lnum];</span><br><span class="line">        v29 = Lnum;</span><br><span class="line">        LODWORD(Reg.R[v29]) = v58 * v59;</span><br><span class="line">        HIDWORD(Reg.R[v29]) = (<span class="keyword">unsigned</span> __int64)(v58 * v59) &gt;&gt; <span class="number">32</span>;<span class="comment">// mul Reg[Lnum],Reg[Rnum]</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0xD</span>:</span><br><span class="line">        LODWORD(v30) = Reg.R[Lnum];</span><br><span class="line">        HIDWORD(v30) = HIDWORD(Reg.R[Lnum]);</span><br><span class="line">        v31 = v30 &lt;&lt; Rnum;</span><br><span class="line">        v32 = v31;</span><br><span class="line">        LODWORD(v31) = <span class="number">8</span> * Lnum;</span><br><span class="line">        *(_DWORD *)((<span class="keyword">char</span> *)Reg.R + v31) = v32;</span><br><span class="line">        *(_DWORD *)((<span class="keyword">char</span> *)Reg.R + v31 + <span class="number">4</span>) = HIDWORD(v31);<span class="comment">// shl Reg[Lnum],Rnum</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0xE</span>:</span><br><span class="line">        LODWORD(v33) = Reg.R[Lnum];</span><br><span class="line">        HIDWORD(v33) = HIDWORD(Reg.R[Lnum]);</span><br><span class="line">        v34 = v33 &lt;&lt; LODWORD(Reg.R[Rnum]);</span><br><span class="line">        v35 = v34;</span><br><span class="line">        LODWORD(v34) = <span class="number">8</span> * Lnum;</span><br><span class="line">        *(_DWORD *)((<span class="keyword">char</span> *)Reg.R + v34) = v35;</span><br><span class="line">        *(_DWORD *)((<span class="keyword">char</span> *)Reg.R + v34 + <span class="number">4</span>) = HIDWORD(v34);<span class="comment">// shl Reg[Lnum],Reg[Rnum]</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0xF</span>:</span><br><span class="line">        LODWORD(v36) = Reg.R[Lnum];             <span class="comment">// shr Reg[Lnum],Rnum</span></span><br><span class="line">        HIDWORD(v36) = HIDWORD(Reg.R[Lnum]);</span><br><span class="line">        v37 = v36 &gt;&gt; Rnum;</span><br><span class="line">        v38 = v37;</span><br><span class="line">        LODWORD(v37) = <span class="number">8</span> * Lnum;</span><br><span class="line">        *(_DWORD *)((<span class="keyword">char</span> *)Reg.R + v37) = v38;</span><br><span class="line">        *(_DWORD *)((<span class="keyword">char</span> *)Reg.R + v37 + <span class="number">4</span>) = HIDWORD(v37);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0x10</span>:                                <span class="comment">// shr Reg[Lnum],Reg[Rnum]</span></span><br><span class="line">        LODWORD(v39) = Reg.R[Lnum];</span><br><span class="line">        HIDWORD(v39) = HIDWORD(Reg.R[Lnum]);</span><br><span class="line">        v40 = v39 &gt;&gt; LODWORD(Reg.R[Rnum]);</span><br><span class="line">        v41 = v40;</span><br><span class="line">        LODWORD(v40) = <span class="number">8</span> * Lnum;</span><br><span class="line">        *(_DWORD *)((<span class="keyword">char</span> *)Reg.R + v40) = v41;</span><br><span class="line">        *(_DWORD *)((<span class="keyword">char</span> *)Reg.R + v40 + <span class="number">4</span>) = HIDWORD(v40);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0x11</span>:</span><br><span class="line">        v42 = HIDWORD(Rnum) ^ HIDWORD(Reg.R[Lnum]);</span><br><span class="line">        v43 = Lnum;</span><br><span class="line">        LODWORD(Reg.R[v43]) = Rnum ^ LODWORD(Reg.R[Lnum]);<span class="comment">// xor Reg[Lnum],Rnum</span></span><br><span class="line">        HIDWORD(Reg.R[v43]) = v42;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0x12</span>:</span><br><span class="line">        v44 = HIDWORD(Reg.R[Rnum]) ^ HIDWORD(Reg.R[Lnum]);<span class="comment">// xor Reg[Lnum],Reg[Rnum]</span></span><br><span class="line">        v45 = Lnum;</span><br><span class="line">        LODWORD(Reg.R[v45]) = LODWORD(Reg.R[Rnum]) ^ LODWORD(Reg.R[Lnum]);</span><br><span class="line">        HIDWORD(Reg.R[v45]) = v44;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0x13</span>:</span><br><span class="line">        v46 = HIDWORD(Rnum) | HIDWORD(Reg.R[Lnum]);<span class="comment">// or Reg[Lnum],Rnum</span></span><br><span class="line">        v47 = Lnum;</span><br><span class="line">        LODWORD(Reg.R[v47]) = Rnum | LODWORD(Reg.R[Lnum]);</span><br><span class="line">        HIDWORD(Reg.R[v47]) = v46;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0x14</span>:</span><br><span class="line">        v48 = HIDWORD(Reg.R[Rnum]) | HIDWORD(Reg.R[Lnum]);<span class="comment">// or Reg[Lnum],Reg[Rnum]</span></span><br><span class="line">        v49 = Lnum;</span><br><span class="line">        LODWORD(Reg.R[v49]) = LODWORD(Reg.R[Rnum]) | LODWORD(Reg.R[Lnum]);</span><br><span class="line">        HIDWORD(Reg.R[v49]) = v48;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0x15</span>:</span><br><span class="line">        v50 = HIDWORD(Rnum) &amp; HIDWORD(Reg.R[Lnum]);<span class="comment">// and Reg[Lnum],Rnum</span></span><br><span class="line">        v51 = Lnum;</span><br><span class="line">        LODWORD(Reg.R[v51]) = Rnum &amp; LODWORD(Reg.R[Lnum]);</span><br><span class="line">        HIDWORD(Reg.R[v51]) = v50;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0x16</span>:</span><br><span class="line">        v52 = HIDWORD(Reg.R[Rnum]) &amp; HIDWORD(Reg.R[Lnum]);<span class="comment">// and Reg[Lnum],Reg[Rnum]</span></span><br><span class="line">        v53 = Lnum;</span><br><span class="line">        LODWORD(Reg.R[v53]) = Reg.R[Rnum] &amp; LODWORD(Reg.R[Lnum]);</span><br><span class="line">        HIDWORD(Reg.R[v53]) = v52;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0x17</span>:</span><br><span class="line">        v54 = getchar();                        <span class="comment">// Reg[Lnum]=getchar()</span></span><br><span class="line">        v55 = Lnum;</span><br><span class="line">        LODWORD(Reg.R[v55]) = v54;</span><br><span class="line">        HIDWORD(Reg.R[v55]) = HIDWORD(v54);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0x18</span>:</span><br><span class="line">        <span class="built_in">putchar</span>(Reg.R[Lnum]);                   <span class="comment">// putchar(Reg[Lnum])</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0x1A</span>:</span><br><span class="line">        LOBYTE(cmp_bool) = __PAIR64__(HIDWORD(Reg.R[Lnum]), Reg.R[Lnum]) == Rnum;<span class="comment">// cmp Reg[Lnum],Rnum</span></span><br><span class="line">        BYTE1(cmp_bool) = __PAIR64__(HIDWORD(Reg.R[Lnum]), Reg.R[Lnum]) &lt; Rnum;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0x1B</span>:</span><br><span class="line">        LOBYTE(cmp_bool) = LODWORD(Reg.R[Lnum]) == LODWORD(Reg.R[Rnum]) &amp;&amp; HIDWORD(Reg.R[Lnum]) == HIDWORD(Reg.R[Rnum]);<span class="comment">// cmp Reg[Lnum],Reg[Rnum]</span></span><br><span class="line">        v56 = HIDWORD(Reg.R[Lnum]);</span><br><span class="line">        BYTE1(cmp_bool) = v56 &lt;= HIDWORD(Reg.R[Rnum])</span><br><span class="line">                       &amp;&amp; (v56 &lt; HIDWORD(Reg.R[Rnum]) || LODWORD(Reg.R[Lnum]) &lt; LODWORD(Reg.R[Rnum]));</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0x1C</span>:</span><br><span class="line">        <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int8)cmp_bool == <span class="number">1</span> )   <span class="comment">// je Lnum</span></span><br><span class="line">        {</span><br><span class="line">          LODWORD(Reg.RIP) = Lnum;</span><br><span class="line">          HIDWORD(Reg.RIP) = HIDWORD(Lnum);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0x1D</span>:</span><br><span class="line">        LODWORD(Reg.RIP) = Lnum;                <span class="comment">// jmp Lnum</span></span><br><span class="line">        HIDWORD(Reg.RIP) = HIDWORD(Lnum);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0x1E</span>:</span><br><span class="line">        <span class="keyword">if</span> ( BYTE1(cmp_bool) == <span class="number">1</span> )             <span class="comment">// jb Lnum</span></span><br><span class="line">        {</span><br><span class="line">          LODWORD(Reg.RIP) = Lnum;</span><br><span class="line">          HIDWORD(Reg.RIP) = HIDWORD(Lnum);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0x1F</span>:</span><br><span class="line">        <span class="keyword">if</span> ( !(_BYTE)cmp_bool )                 <span class="comment">// jne Lnum</span></span><br><span class="line">        {</span><br><span class="line">          LODWORD(Reg.RIP) = Lnum;</span><br><span class="line">          HIDWORD(Reg.RIP) = HIDWORD(Lnum);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">goto</span> LABEL_2;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="IDA定义结构体">IDA定义结构体</h3><p>观察各case块用到的变量和动作，因为opcode也是解释为x86的指令执行，故要熟悉常用的汇编指令。</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">v1 = (__int64 *)&amp;a1[<span class="number">6</span> * LODWORD(Reg.RIP)]; </span><br><span class="line">Inst_op = *v1;</span><br><span class="line">Lnum = v1[<span class="number">1</span>];</span><br><span class="line">Rnum = v1[<span class="number">2</span>];</span><br><span class="line">v2 = __PAIR64__(HIDWORD(Reg.RIP), LODWORD(Reg.RIP)++) + <span class="number">1</span>;</span><br></pre></td></tr></tbody></table></figure><p>结合指令格式，地址码和操作数，在switch开始前的初始动作便能确定指令长度为24Byte并且了解数组的哪个值为IP。</p><blockquote><p>结合分析结果定义如下结构体</p></blockquote><p>VM中的寄存器，未定义前IDA识别为了大小为32的int数组。</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">VM_REG</span>{</span></span><br><span class="line">_QWORD REG[<span class="number">15</span>];<span class="comment">//也可以修改的更详细，比如有控制堆栈的寄存器</span></span><br><span class="line">_QWORD RIP;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>opcode指令格式,指令长度为24字节。</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Inst</span>{</span></span><br><span class="line">_QWORD adr;</span><br><span class="line">    _QWORD Lnum;</span><br><span class="line">    _QWORD Rnum;</span><br><span class="line">}    </span><br></pre></td></tr></tbody></table></figure><h4 id="way-1">way-1</h4><p><strong>IDA 具体操作，shift+F9 进入struct窗口，按Insert插入结构体，在自己定义结构体的end处按d就能增加元素，通过Y键可以修改数据的类型，例如数组，_DWORD,_QWORD等,最后将想定义为结构体的一片空间的首地址改为自己定义的结构体类型即可。</strong></p><p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20220128232054510.png" alt="image-20220128232054510"></p><h4 id="way-2">way-2</h4><p><strong>另:导入自己定义好的结构体，shift + F1 ，之后insert，把写好的c语言的结构体复制进去即可。</strong></p><p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20220130212048340.png" alt="image-20220130212048340"></p><h3 id="VM-Start">VM_Start</h3><p>根据对VM_Dispatcher的交叉引用发现有四组调用，并且在追溯中发现VM初始化的函数。</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sub_412BB0</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  __CheckForDebuggerJustMyCode(&amp;unk_421002);</span><br><span class="line">  Buffer = (<span class="keyword">int</span>)<span class="built_in">malloc</span>(<span class="number">0x8000</span>u);</span><br><span class="line">  Mem = <span class="built_in">malloc</span>(<span class="number">0x800000</span>u);</span><br><span class="line">  j_memset(&amp;Reg, <span class="number">0</span>, <span class="keyword">sizeof</span>(Reg));</span><br><span class="line">  j_memset(&amp;cmp_bool, <span class="number">0</span>, <span class="keyword">sizeof</span>(cmp_bool));</span><br><span class="line">  LODWORD(Reg.R[<span class="number">4</span>]) = <span class="number">256</span>;</span><br><span class="line">  HIDWORD(Reg.R[<span class="number">4</span>]) = <span class="number">0</span>;</span><br><span class="line">  j_VM_Dispatch((<span class="keyword">int</span>)&amp;code_3);</span><br><span class="line">  j_VM_Dispatch((<span class="keyword">int</span>)&amp;code_4);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>开辟了缓冲区和内存空间，返回了空间的指针，并且对特殊寄存器赋值，比如Reg.R[4]，之后在操控动态空间中用到，类似esp。</p><h3 id="VM-Parser">VM_Parser</h3><p>该题目的opcode比较多，并且有4个分支调用Dispatch，opcode被拆分成四组依次执行，在对每条虚拟机解释指令分析后便可编写parser还原为x86的混编代码，进而分析出伪代码。</p><p>IDAPYTHON dump出opcode，简易脚本如下</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> idautils</span><br><span class="line">adr=<span class="number">0x0041E000</span></span><br><span class="line">end=<span class="number">0x0041E378</span></span><br><span class="line">op=[]</span><br><span class="line"><span class="keyword">while</span>(<span class="literal">True</span>):</span><br><span class="line">    op.append([Qword(adr),Qword(adr+<span class="number">8</span>),Qword(adr+<span class="number">16</span>)])</span><br><span class="line">    <span class="keyword">if</span>(adr==end):</span><br><span class="line">        <span class="built_in">print</span>(op)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">'yes'</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    adr+=<span class="number">24</span> </span><br></pre></td></tr></tbody></table></figure><p>根据VM_Dispatch写还原parser</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">code_1=[[<span class="number">18</span>, <span class="number">0</span>, <span class="number">0</span>], [<span class="number">18</span>, <span class="number">1</span>, <span class="number">1</span>], [<span class="number">18</span>, <span class="number">2</span>, <span class="number">2</span>], [<span class="number">18</span>, <span class="number">3</span>, <span class="number">3</span>], [<span class="number">18</span>, <span class="number">6</span>, <span class="number">6</span>], [<span class="number">18</span>, <span class="number">7</span>, <span class="number">7</span>], [<span class="number">1</span>, <span class="number">0</span>, <span class="number">105</span>], [<span class="number">1</span>, <span class="number">1</span>, <span class="number">110</span>], [<span class="number">1</span>, <span class="number">2</span>, <span class="number">112</span>], [<span class="number">1</span>, <span class="number">3</span>, <span class="number">117</span>], [<span class="number">1</span>, <span class="number">6</span>, <span class="number">116</span>], [<span class="number">1</span>, <span class="number">7</span>, <span class="number">32</span>], [<span class="number">24</span>, <span class="number">0</span>, <span class="number">18446744073709551615</span>], [<span class="number">24</span>, <span class="number">1</span>, <span class="number">18446744073709551615</span>], [<span class="number">24</span>, <span class="number">2</span>, <span class="number">18446744073709551615</span>], [<span class="number">24</span>, <span class="number">3</span>, <span class="number">18446744073709551615</span>], [<span class="number">24</span>, <span class="number">6</span>, <span class="number">18446744073709551615</span>], [<span class="number">24</span>, <span class="number">7</span>, <span class="number">18446744073709551615</span>], [<span class="number">1</span>, <span class="number">0</span>, <span class="number">102</span>], [<span class="number">1</span>, <span class="number">1</span>, <span class="number">108</span>], [<span class="number">1</span>, <span class="number">2</span>, <span class="number">97</span>], [<span class="number">1</span>, <span class="number">3</span>, <span class="number">103</span>], [<span class="number">1</span>, <span class="number">6</span>, <span class="number">58</span>], [<span class="number">1</span>, <span class="number">7</span>, <span class="number">32</span>], [<span class="number">24</span>, <span class="number">0</span>, <span class="number">18446744073709551615</span>], [<span class="number">24</span>, <span class="number">1</span>, <span class="number">18446744073709551615</span>], [<span class="number">24</span>, <span class="number">2</span>, <span class="number">18446744073709551615</span>], [<span class="number">24</span>, <span class="number">3</span>, <span class="number">18446744073709551615</span>], [<span class="number">24</span>, <span class="number">6</span>, <span class="number">18446744073709551615</span>], [<span class="number">24</span>, <span class="number">7</span>, <span class="number">18446744073709551615</span>], [<span class="number">18</span>, <span class="number">1</span>, <span class="number">1</span>], [<span class="number">23</span>, <span class="number">0</span>, <span class="number">18446744073709551615</span>], [<span class="number">5</span>, <span class="number">0</span>, <span class="number">18446744073709551615</span>], [<span class="number">7</span>, <span class="number">1</span>, <span class="number">1</span>], [<span class="number">26</span>, <span class="number">1</span>, <span class="number">38</span>], [<span class="number">30</span>, <span class="number">31</span>, <span class="number">18446744073709551615</span>], [<span class="number">25</span>, <span class="number">18446744073709551615</span>, <span class="number">18446744073709551615</span>], [<span class="number">18</span>, <span class="number">2</span>, <span class="number">2</span>]]</span><br><span class="line"><span class="comment">#输入并check长度</span></span><br><span class="line">code_2=[[<span class="number">6</span>, <span class="number">0</span>, <span class="number">18446744073709551615</span>], [<span class="number">26</span>, <span class="number">0</span>, <span class="number">125</span>], [<span class="number">28</span>, <span class="number">18</span>, <span class="number">18446744073709551615</span>], [<span class="number">1</span>, <span class="number">0</span>, <span class="number">119</span>], [<span class="number">1</span>, <span class="number">1</span>, <span class="number">114</span>], [<span class="number">1</span>, <span class="number">2</span>, <span class="number">111</span>], [<span class="number">1</span>, <span class="number">3</span>, <span class="number">110</span>], [<span class="number">1</span>, <span class="number">6</span>, <span class="number">103</span>], [<span class="number">1</span>, <span class="number">7</span>, <span class="number">33</span>], [<span class="number">24</span>, <span class="number">0</span>, <span class="number">18446744073709551615</span>], [<span class="number">24</span>, <span class="number">1</span>, <span class="number">18446744073709551615</span>], [<span class="number">24</span>, <span class="number">2</span>, <span class="number">18446744073709551615</span>], [<span class="number">24</span>, <span class="number">3</span>, <span class="number">18446744073709551615</span>], [<span class="number">24</span>, <span class="number">6</span>, <span class="number">18446744073709551615</span>], [<span class="number">24</span>, <span class="number">7</span>, <span class="number">18446744073709551615</span>], [<span class="number">1</span>, <span class="number">0</span>, <span class="number">10</span>], [<span class="number">24</span>, <span class="number">0</span>, <span class="number">18446744073709551615</span>], [<span class="number">25</span>, <span class="number">18446744073709551615</span>, <span class="number">18446744073709551615</span>], [<span class="number">1</span>, <span class="number">8</span>, <span class="number">256</span>], [<span class="number">26</span>, <span class="number">8</span>, <span class="number">225</span>], [<span class="number">30</span>, <span class="number">25</span>, <span class="number">18446744073709551615</span>], [<span class="number">6</span>, <span class="number">0</span>, <span class="number">18446744073709551615</span>], [<span class="number">4</span>, <span class="number">8</span>, <span class="number">0</span>], [<span class="number">9</span>, <span class="number">8</span>, <span class="number">1</span>], [<span class="number">29</span>, <span class="number">19</span>, <span class="number">18446744073709551615</span>], [<span class="number">6</span>, <span class="number">0</span>, <span class="number">18446744073709551615</span>], [<span class="number">26</span>, <span class="number">0</span>, <span class="number">123</span>], [<span class="number">31</span>, <span class="number">3</span>, <span class="number">18446744073709551615</span>], [<span class="number">6</span>, <span class="number">0</span>, <span class="number">18446744073709551615</span>], [<span class="number">26</span>, <span class="number">0</span>, <span class="number">103</span>], [<span class="number">31</span>, <span class="number">3</span>, <span class="number">18446744073709551615</span>], [<span class="number">6</span>, <span class="number">0</span>, <span class="number">18446744073709551615</span>], [<span class="number">26</span>, <span class="number">0</span>, <span class="number">97</span>], [<span class="number">31</span>, <span class="number">3</span>, <span class="number">18446744073709551615</span>], [<span class="number">6</span>, <span class="number">0</span>, <span class="number">18446744073709551615</span>], [<span class="number">26</span>, <span class="number">0</span>, <span class="number">108</span>], [<span class="number">31</span>, <span class="number">3</span>, <span class="number">18446744073709551615</span>], [<span class="number">6</span>, <span class="number">0</span>, <span class="number">18446744073709551615</span>], [<span class="number">26</span>, <span class="number">0</span>, <span class="number">102</span>], [<span class="number">31</span>, <span class="number">3</span>, <span class="number">18446744073709551615</span>], [<span class="number">18</span>, <span class="number">9</span>, <span class="number">9</span>], [<span class="number">1</span>, <span class="number">10</span>, <span class="number">225</span>], [<span class="number">3</span>, <span class="number">7</span>, <span class="number">9</span>], [<span class="number">3</span>, <span class="number">6</span>, <span class="number">10</span>], [<span class="number">17</span>, <span class="number">6</span>, <span class="number">66</span>], [<span class="number">13</span>, <span class="number">6</span>, <span class="number">2</span>], [<span class="number">27</span>, <span class="number">6</span>, <span class="number">7</span>], [<span class="number">31</span>, <span class="number">3</span>, <span class="number">18446744073709551615</span>], [<span class="number">7</span>, <span class="number">9</span>, <span class="number">1</span>], [<span class="number">7</span>, <span class="number">10</span>, <span class="number">1</span>], [<span class="number">26</span>, <span class="number">9</span>, <span class="number">32</span>], [<span class="number">30</span>, <span class="number">42</span>, <span class="number">18446744073709551615</span>], [<span class="number">1</span>, <span class="number">0</span>, <span class="number">99</span>], [<span class="number">1</span>, <span class="number">1</span>, <span class="number">111</span>], [<span class="number">1</span>, <span class="number">2</span>, <span class="number">114</span>], [<span class="number">1</span>, <span class="number">3</span>, <span class="number">114</span>], [<span class="number">1</span>, <span class="number">6</span>, <span class="number">101</span>], [<span class="number">1</span>, <span class="number">7</span>, <span class="number">99</span>], [<span class="number">24</span>, <span class="number">0</span>, <span class="number">18446744073709551615</span>], [<span class="number">24</span>, <span class="number">1</span>, <span class="number">18446744073709551615</span>], [<span class="number">24</span>, <span class="number">2</span>, <span class="number">18446744073709551615</span>], [<span class="number">24</span>, <span class="number">3</span>, <span class="number">18446744073709551615</span>], [<span class="number">24</span>, <span class="number">6</span>, <span class="number">18446744073709551615</span>], [<span class="number">24</span>, <span class="number">7</span>, <span class="number">18446744073709551615</span>], [<span class="number">1</span>, <span class="number">0</span>, <span class="number">116</span>], [<span class="number">1</span>, <span class="number">1</span>, <span class="number">108</span>], [<span class="number">1</span>, <span class="number">2</span>, <span class="number">121</span>], [<span class="number">1</span>, <span class="number">3</span>, <span class="number">33</span>], [<span class="number">1</span>, <span class="number">6</span>, <span class="number">10</span>], [<span class="number">24</span>, <span class="number">0</span>, <span class="number">18446744073709551615</span>], [<span class="number">24</span>, <span class="number">1</span>, <span class="number">18446744073709551615</span>], [<span class="number">24</span>, <span class="number">2</span>, <span class="number">18446744073709551615</span>], [<span class="number">24</span>, <span class="number">3</span>, <span class="number">18446744073709551615</span>], [<span class="number">24</span>, <span class="number">6</span>, <span class="number">18446744073709551615</span>], [<span class="number">25</span>, <span class="number">18446744073709551615</span>, <span class="number">18446744073709551615</span>]]</span><br><span class="line"><span class="comment">#对输入字符串进行处理</span></span><br><span class="line">code_3=[[<span class="number">18</span>, <span class="number">2</span>, <span class="number">2</span>], [<span class="number">0</span>, <span class="number">2</span>, <span class="number">255</span>], [<span class="number">7</span>, <span class="number">2</span>, <span class="number">1</span>], [<span class="number">0</span>, <span class="number">2</span>, <span class="number">547</span>], [<span class="number">7</span>, <span class="number">2</span>, <span class="number">1</span>], [<span class="number">0</span>, <span class="number">2</span>, <span class="number">571</span>], [<span class="number">7</span>, <span class="number">2</span>, <span class="number">1</span>], [<span class="number">0</span>, <span class="number">2</span>, <span class="number">567</span>], [<span class="number">7</span>, <span class="number">2</span>, <span class="number">1</span>], [<span class="number">0</span>, <span class="number">2</span>, <span class="number">567</span>], [<span class="number">7</span>, <span class="number">2</span>, <span class="number">1</span>], [<span class="number">0</span>, <span class="number">2</span>, <span class="number">587</span>], [<span class="number">7</span>, <span class="number">2</span>, <span class="number">1</span>], [<span class="number">0</span>, <span class="number">2</span>, <span class="number">555</span>], [<span class="number">7</span>, <span class="number">2</span>, <span class="number">1</span>], [<span class="number">0</span>, <span class="number">2</span>, <span class="number">251</span>], [<span class="number">7</span>, <span class="number">2</span>, <span class="number">1</span>], [<span class="number">0</span>, <span class="number">2</span>, <span class="number">555</span>], [<span class="number">7</span>, <span class="number">2</span>, <span class="number">1</span>], [<span class="number">0</span>, <span class="number">2</span>, <span class="number">547</span>], [<span class="number">7</span>, <span class="number">2</span>, <span class="number">1</span>], [<span class="number">0</span>, <span class="number">2</span>, <span class="number">591</span>], [<span class="number">7</span>, <span class="number">2</span>, <span class="number">1</span>], [<span class="number">0</span>, <span class="number">2</span>, <span class="number">239</span>], [<span class="number">7</span>, <span class="number">2</span>, <span class="number">1</span>], [<span class="number">0</span>, <span class="number">2</span>, <span class="number">567</span>], [<span class="number">7</span>, <span class="number">2</span>, <span class="number">1</span>], [<span class="number">0</span>, <span class="number">2</span>, <span class="number">239</span>], [<span class="number">7</span>, <span class="number">2</span>, <span class="number">1</span>], [<span class="number">0</span>, <span class="number">2</span>, <span class="number">591</span>], [<span class="number">7</span>, <span class="number">2</span>, <span class="number">1</span>], [<span class="number">0</span>, <span class="number">2</span>, <span class="number">591</span>], [<span class="number">7</span>, <span class="number">2</span>, <span class="number">1</span>], [<span class="number">0</span>, <span class="number">2</span>, <span class="number">547</span>], [<span class="number">7</span>, <span class="number">2</span>, <span class="number">1</span>], [<span class="number">0</span>, <span class="number">2</span>, <span class="number">547</span>], [<span class="number">7</span>, <span class="number">2</span>, <span class="number">1</span>], [<span class="number">0</span>, <span class="number">2</span>, <span class="number">571</span>], [<span class="number">7</span>, <span class="number">2</span>, <span class="number">1</span>], [<span class="number">0</span>, <span class="number">2</span>, <span class="number">567</span>], [<span class="number">7</span>, <span class="number">2</span>, <span class="number">1</span>], [<span class="number">0</span>, <span class="number">2</span>, <span class="number">255</span>], [<span class="number">7</span>, <span class="number">2</span>, <span class="number">1</span>], [<span class="number">0</span>, <span class="number">2</span>, <span class="number">563</span>], [<span class="number">7</span>, <span class="number">2</span>, <span class="number">1</span>], [<span class="number">0</span>, <span class="number">2</span>, <span class="number">563</span>], [<span class="number">7</span>, <span class="number">2</span>, <span class="number">1</span>], [<span class="number">0</span>, <span class="number">2</span>, <span class="number">563</span>], [<span class="number">7</span>, <span class="number">2</span>, <span class="number">1</span>], [<span class="number">0</span>, <span class="number">2</span>, <span class="number">567</span>], [<span class="number">7</span>, <span class="number">2</span>, <span class="number">1</span>], [<span class="number">0</span>, <span class="number">2</span>, <span class="number">587</span>], [<span class="number">7</span>, <span class="number">2</span>, <span class="number">1</span>], [<span class="number">0</span>, <span class="number">2</span>, <span class="number">563</span>], [<span class="number">7</span>, <span class="number">2</span>, <span class="number">1</span>], [<span class="number">0</span>, <span class="number">2</span>, <span class="number">591</span>], [<span class="number">7</span>, <span class="number">2</span>, <span class="number">1</span>], [<span class="number">0</span>, <span class="number">2</span>, <span class="number">555</span>], [<span class="number">7</span>, <span class="number">2</span>, <span class="number">1</span>], [<span class="number">0</span>, <span class="number">2</span>, <span class="number">555</span>], [<span class="number">7</span>, <span class="number">2</span>, <span class="number">1</span>], [<span class="number">0</span>, <span class="number">2</span>, <span class="number">587</span>], [<span class="number">7</span>, <span class="number">2</span>, <span class="number">1</span>], [<span class="number">0</span>, <span class="number">2</span>, <span class="number">239</span>], [<span class="number">7</span>, <span class="number">2</span>, <span class="number">1</span>], [<span class="number">25</span>, <span class="number">18446744073709551615</span>, <span class="number">18446744073709551615</span>]]</span><br><span class="line"><span class="comment">#比对的密文</span></span><br><span class="line">code_4=[[<span class="number">18</span>, <span class="number">2</span>, <span class="number">2</span>], [<span class="number">3</span>, <span class="number">0</span>, <span class="number">2</span>], [<span class="number">9</span>, <span class="number">0</span>, <span class="number">99</span>], [<span class="number">4</span>, <span class="number">2</span>, <span class="number">0</span>], [<span class="number">7</span>, <span class="number">2</span>, <span class="number">1</span>], [<span class="number">26</span>, <span class="number">2</span>, <span class="number">32</span>], [<span class="number">30</span>, <span class="number">1</span>, <span class="number">18446744073709551615</span>], [<span class="number">25</span>, <span class="number">18446744073709551615</span>, <span class="number">18446744073709551615</span>]]</span><br><span class="line"><span class="comment">#对密文处理</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">VM_Parser</span>(<span class="params">op</span>):</span></span><br><span class="line">    VM_Inst={</span><br><span class="line">        <span class="number">0</span>:<span class="string">"mov Mem[Reg[{Lnum}]] , {Rnum}"</span>,</span><br><span class="line">        <span class="number">1</span>:<span class="string">"mov Reg[{Lnum}] , {Rnum}"</span> ,</span><br><span class="line">        <span class="number">2</span>:<span class="string">"mov Reg[{Lnum}] , Reg[{Rnum}]"</span> ,</span><br><span class="line">        <span class="number">3</span>:<span class="string">"mov Reg[{Lnum}] , Mem[Reg[{Rnum}]]"</span>,</span><br><span class="line">        <span class="number">4</span>:<span class="string">"mov Mem[Reg[{Lnum}]] , Reg[{Rnum}]"</span>,</span><br><span class="line">        <span class="number">5</span>:<span class="string">"push Reg[{Lnum}]"</span>,</span><br><span class="line">        <span class="number">6</span>:<span class="string">"pop  Reg[{Lnum}]"</span>,</span><br><span class="line">        <span class="number">7</span>:<span class="string">"add Reg[{Lnum}] , {Rnum}"</span>,</span><br><span class="line">        <span class="number">8</span>:<span class="string">"add Reg[{Lnum}] , Reg[{Rnum}]"</span>,</span><br><span class="line">        <span class="number">9</span>:<span class="string">"sub Reg[{Lnum}] , {Rnum}"</span>,</span><br><span class="line">        <span class="number">0xA</span>:<span class="string">"sub Reg[{Lnum}] , Reg[{Rnum}]"</span>,</span><br><span class="line">        <span class="number">0xB</span>:<span class="string">"mul Reg[{Lnum}] , {Rnum}"</span>,</span><br><span class="line">        <span class="number">0xC</span>:<span class="string">"mul Reg[{Lnum}] , Reg[{Rnum}]"</span>,</span><br><span class="line">        <span class="number">0xD</span>:<span class="string">"shl Reg[{Lnum}] , {Rnum}"</span>,</span><br><span class="line">        <span class="number">0xE</span>:<span class="string">"shl Reg[{Lnum}] , Reg[{Rnum}]"</span>,</span><br><span class="line">        <span class="number">0xF</span>:<span class="string">"shr Reg[{Lnum}] , {Rnum}"</span>,</span><br><span class="line">        <span class="number">0x11</span>:<span class="string">"xor Reg[{Lnum}] , {Rnum}"</span>,</span><br><span class="line">        <span class="number">0x12</span>:<span class="string">"xor Reg[{Lnum}] , Reg[{Rnum}]"</span>,</span><br><span class="line">        <span class="number">0x13</span>:<span class="string">"or  Reg[{Lnum}] , {Rnum}"</span>,</span><br><span class="line">        <span class="number">0x14</span>:<span class="string">"or  Reg[{Lnum}] , Reg[{Rnum}]"</span>,</span><br><span class="line">        <span class="number">0x15</span>:<span class="string">"and Reg[{Lnum}] , {Rnum}"</span>,</span><br><span class="line">        <span class="number">0x16</span>:<span class="string">"and Reg[{Lnum}] , Reg[{Rnum}]"</span>,</span><br><span class="line">        <span class="number">0x17</span>:<span class="string">"Reg[{Lnum}] = getchar()"</span>,</span><br><span class="line">        <span class="number">0x18</span>:<span class="string">"putchar() = Reg[{Lnum}]"</span>,</span><br><span class="line">        <span class="number">0x19</span>:<span class="string">"exit()"</span>,</span><br><span class="line">        <span class="number">0x1A</span>:<span class="string">"cmp Reg[{Lnum}] , {Rnum}"</span>,</span><br><span class="line">        <span class="number">0x1B</span>:<span class="string">"cmp Reg[{Lnum}] , Reg[{Rnum}]"</span>,</span><br><span class="line">        <span class="number">0x1C</span>:<span class="string">"je  {Lnum}"</span>,</span><br><span class="line">        <span class="number">0x1D</span>:<span class="string">"jmp {Lnum}"</span>,</span><br><span class="line">        <span class="number">0x1E</span>: <span class="string">"jb  {Lnum}"</span>,</span><br><span class="line">        <span class="number">0x1F</span>:<span class="string">"jne {Lnum}"</span></span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">    tmp = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(op)):</span><br><span class="line">         Inst=op[i]</span><br><span class="line">         adr=Inst[<span class="number">0</span>]</span><br><span class="line">         Lnum=Inst[<span class="number">1</span>]</span><br><span class="line">         Rnum=Inst[<span class="number">2</span>]</span><br><span class="line">         <span class="comment">#if(adr==0): #dump比对密文</span></span><br><span class="line">         <span class="comment">#   tmp.append(Rnum)</span></span><br><span class="line">         <span class="built_in">print</span>(<span class="string">'%s: '</span>%<span class="built_in">hex</span>(i)+VM_Inst[adr].<span class="built_in">format</span>(Lnum=<span class="built_in">hex</span>(Lnum),Rnum=<span class="built_in">hex</span>(Rnum)).replace(<span class="string">'[0x'</span>,<span class="string">'['</span>))</span><br><span class="line">    <span class="comment">#print(tmp)</span></span><br><span class="line">VM_Parser(code_1)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">'------code_end------'</span>)</span><br><span class="line">VM_Parser(code_2)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">'------code_end------'</span>)</span><br><span class="line">VM_Parser(code_3)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">'------code_end------'</span>)</span><br><span class="line">VM_Parser(code_4)</span><br></pre></td></tr></tbody></table></figure><h3 id="分析算法">分析算法</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x0</span>: <span class="keyword">xor</span> Reg[<span class="number">0</span>] , Reg[<span class="number">0</span>]</span><br><span class="line"><span class="number">0x1</span>: <span class="keyword">xor</span> Reg[<span class="number">1</span>] , Reg[<span class="number">1</span>]</span><br><span class="line"><span class="number">0x2</span>: <span class="keyword">xor</span> Reg[<span class="number">2</span>] , Reg[<span class="number">2</span>]</span><br><span class="line"><span class="number">0x3</span>: <span class="keyword">xor</span> Reg[<span class="number">3</span>] , Reg[<span class="number">3</span>]</span><br><span class="line"><span class="number">0x4</span>: <span class="keyword">xor</span> Reg[<span class="number">6</span>] , Reg[<span class="number">6</span>]</span><br><span class="line"><span class="number">0x5</span>: <span class="keyword">xor</span> Reg[<span class="number">7</span>] , Reg[<span class="number">7</span>]</span><br><span class="line"><span class="number">0x6</span>: mov Reg[<span class="number">0</span>] , <span class="number">0x69</span></span><br><span class="line"><span class="number">0x7</span>: mov Reg[<span class="number">1</span>] , <span class="number">0x6e</span></span><br><span class="line"><span class="number">0x8</span>: mov Reg[<span class="number">2</span>] , <span class="number">0x70</span></span><br><span class="line"><span class="number">0x9</span>: mov Reg[<span class="number">3</span>] , <span class="number">0x75</span></span><br><span class="line"><span class="number">0xa</span>: mov Reg[<span class="number">6</span>] , <span class="number">0x74</span></span><br><span class="line"><span class="number">0xb</span>: mov Reg[<span class="number">7</span>] , <span class="number">0x20</span></span><br><span class="line"><span class="number">0xc</span>: <span class="built_in">putchar</span>() = Reg[<span class="number">0</span>]</span><br><span class="line"><span class="number">0xd</span>: <span class="built_in">putchar</span>() = Reg[<span class="number">1</span>]</span><br><span class="line"><span class="number">0xe</span>: <span class="built_in">putchar</span>() = Reg[<span class="number">2</span>]</span><br><span class="line"><span class="number">0xf</span>: <span class="built_in">putchar</span>() = Reg[<span class="number">3</span>]</span><br><span class="line"><span class="number">0x10</span>: <span class="built_in">putchar</span>() = Reg[<span class="number">6</span>]</span><br><span class="line"><span class="number">0x11</span>: <span class="built_in">putchar</span>() = Reg[<span class="number">7</span>]</span><br><span class="line"><span class="number">0x12</span>: mov Reg[<span class="number">0</span>] , <span class="number">0x66</span></span><br><span class="line"><span class="number">0x13</span>: mov Reg[<span class="number">1</span>] , <span class="number">0x6c</span></span><br><span class="line"><span class="number">0x14</span>: mov Reg[<span class="number">2</span>] , <span class="number">0x61</span></span><br><span class="line"><span class="number">0x15</span>: mov Reg[<span class="number">3</span>] , <span class="number">0x67</span></span><br><span class="line"><span class="number">0x16</span>: mov Reg[<span class="number">6</span>] , <span class="number">0x3a</span></span><br><span class="line"><span class="number">0x17</span>: mov Reg[<span class="number">7</span>] , <span class="number">0x20</span></span><br><span class="line"><span class="number">0x18</span>: <span class="built_in">putchar</span>() = Reg[<span class="number">0</span>]</span><br><span class="line"><span class="number">0x19</span>: <span class="built_in">putchar</span>() = Reg[<span class="number">1</span>]</span><br><span class="line"><span class="number">0x1a</span>: <span class="built_in">putchar</span>() = Reg[<span class="number">2</span>]</span><br><span class="line"><span class="number">0x1b</span>: <span class="built_in">putchar</span>() = Reg[<span class="number">3</span>]</span><br><span class="line"><span class="number">0x1c</span>: <span class="built_in">putchar</span>() = Reg[<span class="number">6</span>]</span><br><span class="line"><span class="number">0x1d</span>: <span class="built_in">putchar</span>() = Reg[<span class="number">7</span>]</span><br><span class="line"><span class="number">0x1e</span>: <span class="keyword">xor</span> Reg[<span class="number">1</span>] , Reg[<span class="number">1</span>]</span><br><span class="line"><span class="number">0x1f</span>: Reg[<span class="number">0</span>] = getchar()</span><br><span class="line"><span class="number">0x20</span>: push Reg[<span class="number">0</span>]           <span class="comment">//flag入栈</span></span><br><span class="line"><span class="number">0x21</span>: add Reg[<span class="number">1</span>] , <span class="number">0x1</span></span><br><span class="line"><span class="number">0x22</span>: cmp Reg[<span class="number">1</span>] , <span class="number">0x26</span>     <span class="comment">//check长度</span></span><br><span class="line"><span class="number">0x23</span>: jb  <span class="number">0x1f</span></span><br><span class="line"><span class="number">0x24</span>: <span class="built_in">exit</span>()</span><br><span class="line"><span class="number">0x25</span>: <span class="keyword">xor</span> Reg[<span class="number">2</span>] , Reg[<span class="number">2</span>]</span><br><span class="line">------code_end------</span><br><span class="line"><span class="number">0x0</span>: pop  Reg[<span class="number">0</span>]             <span class="comment">//检测flag尾部是否为}</span></span><br><span class="line"><span class="number">0x1</span>: cmp Reg[<span class="number">0</span>] , <span class="number">0x7d</span> </span><br><span class="line"><span class="number">0x2</span>: je  <span class="number">0x12</span></span><br><span class="line"><span class="number">0x3</span>: mov Reg[<span class="number">0</span>] , <span class="number">0x77</span> </span><br><span class="line"><span class="number">0x4</span>: mov Reg[<span class="number">1</span>] , <span class="number">0x72</span></span><br><span class="line"><span class="number">0x5</span>: mov Reg[<span class="number">2</span>] , <span class="number">0x6f</span></span><br><span class="line"><span class="number">0x6</span>: mov Reg[<span class="number">3</span>] , <span class="number">0x6e</span></span><br><span class="line"><span class="number">0x7</span>: mov Reg[<span class="number">6</span>] , <span class="number">0x67</span></span><br><span class="line"><span class="number">0x8</span>: mov Reg[<span class="number">7</span>] , <span class="number">0x21</span></span><br><span class="line"><span class="number">0x9</span>: <span class="built_in">putchar</span>() = Reg[<span class="number">0</span>]</span><br><span class="line"><span class="number">0xa</span>: <span class="built_in">putchar</span>() = Reg[<span class="number">1</span>]</span><br><span class="line"><span class="number">0xb</span>: <span class="built_in">putchar</span>() = Reg[<span class="number">2</span>]</span><br><span class="line"><span class="number">0xc</span>: <span class="built_in">putchar</span>() = Reg[<span class="number">3</span>]</span><br><span class="line"><span class="number">0xd</span>: <span class="built_in">putchar</span>() = Reg[<span class="number">6</span>]</span><br><span class="line"><span class="number">0xe</span>: <span class="built_in">putchar</span>() = Reg[<span class="number">7</span>]</span><br><span class="line"><span class="number">0xf</span>: mov Reg[<span class="number">0</span>] , <span class="number">0xa</span></span><br><span class="line"><span class="number">0x10</span>: <span class="built_in">putchar</span>() = Reg[<span class="number">0</span>]</span><br><span class="line"><span class="number">0x11</span>: <span class="built_in">exit</span>()</span><br><span class="line"><span class="number">0x12</span>: mov Reg[<span class="number">8</span>] , <span class="number">0x100</span></span><br><span class="line"><span class="number">0x13</span>: cmp Reg[<span class="number">8</span>] , <span class="number">0xe1</span></span><br><span class="line"><span class="number">0x14</span>: jb  <span class="number">0x19</span></span><br><span class="line"><span class="number">0x15</span>: pop  Reg[<span class="number">0</span>]</span><br><span class="line"><span class="number">0x16</span>: mov Mem[Reg[<span class="number">8</span>]] , Reg[<span class="number">0</span>]</span><br><span class="line"><span class="number">0x17</span>: sub Reg[<span class="number">8</span>] , <span class="number">0x1</span></span><br><span class="line"><span class="number">0x18</span>: jmp <span class="number">0x13</span></span><br><span class="line"><span class="number">0x19</span>: pop  Reg[<span class="number">0</span>]</span><br><span class="line"><span class="number">0x1a</span>: cmp Reg[<span class="number">0</span>] , <span class="number">0x7b</span></span><br><span class="line"><span class="number">0x1b</span>: jne <span class="number">0x3</span></span><br><span class="line"><span class="number">0x1c</span>: pop  Reg[<span class="number">0</span>]</span><br><span class="line"><span class="number">0x1d</span>: cmp Reg[<span class="number">0</span>] , <span class="number">0x67</span></span><br><span class="line"><span class="number">0x1e</span>: jne <span class="number">0x3</span></span><br><span class="line"><span class="number">0x1f</span>: pop  Reg[<span class="number">0</span>]</span><br><span class="line"><span class="number">0x20</span>: cmp Reg[<span class="number">0</span>] , <span class="number">0x61</span></span><br><span class="line"><span class="number">0x21</span>: jne <span class="number">0x3</span></span><br><span class="line"><span class="number">0x22</span>: pop  Reg[<span class="number">0</span>]</span><br><span class="line"><span class="number">0x23</span>: cmp Reg[<span class="number">0</span>] , <span class="number">0x6c</span></span><br><span class="line"><span class="number">0x24</span>: jne <span class="number">0x3</span></span><br><span class="line"><span class="number">0x25</span>: pop  Reg[<span class="number">0</span>]</span><br><span class="line"><span class="number">0x26</span>: cmp Reg[<span class="number">0</span>] , <span class="number">0x66</span>   <span class="comment">//检测flag头</span></span><br><span class="line"><span class="number">0x27</span>: jne <span class="number">0x3</span></span><br><span class="line"><span class="number">0x28</span>: <span class="keyword">xor</span> Reg[<span class="number">9</span>] , Reg[<span class="number">9</span>]</span><br><span class="line"><span class="number">0x29</span>: mov Reg[a] , <span class="number">0xe1</span></span><br><span class="line"><span class="number">0x2a</span>: mov Reg[<span class="number">7</span>] , Mem[Reg[<span class="number">9</span>]]</span><br><span class="line"><span class="number">0x2b</span>: mov Reg[<span class="number">6</span>] , Mem[Reg[a]]</span><br><span class="line"><span class="number">0x2c</span>: <span class="keyword">xor</span> Reg[<span class="number">6</span>] , <span class="number">0x42</span>            <span class="comment">//a[i]^=0x42 之后 a[i]&lt;&lt;=2</span></span><br><span class="line"><span class="number">0x2d</span>: shl Reg[<span class="number">6</span>] , <span class="number">0x2</span></span><br><span class="line"><span class="number">0x2e</span>: cmp Reg[<span class="number">6</span>] , Reg[<span class="number">7</span>]</span><br><span class="line"><span class="number">0x2f</span>: jne <span class="number">0x3</span></span><br><span class="line"><span class="number">0x30</span>: add Reg[<span class="number">9</span>] , <span class="number">0x1</span></span><br><span class="line"><span class="number">0x31</span>: add Reg[a] , <span class="number">0x1</span></span><br><span class="line"><span class="number">0x32</span>: cmp Reg[<span class="number">9</span>] , <span class="number">0x20</span>   <span class="comment">//flag的内容进行变换</span></span><br><span class="line"><span class="number">0x33</span>: jb  <span class="number">0x2a</span></span><br><span class="line"><span class="number">0x34</span>: mov Reg[<span class="number">0</span>] , <span class="number">0x63</span></span><br><span class="line"><span class="number">0x35</span>: mov Reg[<span class="number">1</span>] , <span class="number">0x6f</span></span><br><span class="line"><span class="number">0x36</span>: mov Reg[<span class="number">2</span>] , <span class="number">0x72</span></span><br><span class="line"><span class="number">0x37</span>: mov Reg[<span class="number">3</span>] , <span class="number">0x72</span></span><br><span class="line"><span class="number">0x38</span>: mov Reg[<span class="number">6</span>] , <span class="number">0x65</span></span><br><span class="line"><span class="number">0x39</span>: mov Reg[<span class="number">7</span>] , <span class="number">0x63</span></span><br><span class="line"><span class="number">0x3a</span>: <span class="built_in">putchar</span>() = Reg[<span class="number">0</span>]</span><br><span class="line"><span class="number">0x3b</span>: <span class="built_in">putchar</span>() = Reg[<span class="number">1</span>]</span><br><span class="line"><span class="number">0x3c</span>: <span class="built_in">putchar</span>() = Reg[<span class="number">2</span>]</span><br><span class="line"><span class="number">0x3d</span>: <span class="built_in">putchar</span>() = Reg[<span class="number">3</span>]</span><br><span class="line"><span class="number">0x3e</span>: <span class="built_in">putchar</span>() = Reg[<span class="number">6</span>]</span><br><span class="line"><span class="number">0x3f</span>: <span class="built_in">putchar</span>() = Reg[<span class="number">7</span>]</span><br><span class="line"><span class="number">0x40</span>: mov Reg[<span class="number">0</span>] , <span class="number">0x74</span></span><br><span class="line"><span class="number">0x41</span>: mov Reg[<span class="number">1</span>] , <span class="number">0x6c</span></span><br><span class="line"><span class="number">0x42</span>: mov Reg[<span class="number">2</span>] , <span class="number">0x79</span></span><br><span class="line"><span class="number">0x43</span>: mov Reg[<span class="number">3</span>] , <span class="number">0x21</span></span><br><span class="line"><span class="number">0x44</span>: mov Reg[<span class="number">6</span>] , <span class="number">0xa</span></span><br><span class="line"><span class="number">0x45</span>: <span class="built_in">putchar</span>() = Reg[<span class="number">0</span>]</span><br><span class="line"><span class="number">0x46</span>: <span class="built_in">putchar</span>() = Reg[<span class="number">1</span>]</span><br><span class="line"><span class="number">0x47</span>: <span class="built_in">putchar</span>() = Reg[<span class="number">2</span>]</span><br><span class="line"><span class="number">0x48</span>: <span class="built_in">putchar</span>() = Reg[<span class="number">3</span>]</span><br><span class="line"><span class="number">0x49</span>: <span class="built_in">putchar</span>() = Reg[<span class="number">6</span>]</span><br><span class="line"><span class="number">0x4a</span>: <span class="built_in">exit</span>()</span><br><span class="line">------code_end------</span><br><span class="line"><span class="number">0x0</span>: <span class="keyword">xor</span> Reg[<span class="number">2</span>] , Reg[<span class="number">2</span>]          <span class="comment">//比对密文存入内存</span></span><br><span class="line"><span class="number">0x1</span>: mov Mem[Reg[<span class="number">2</span>]] , <span class="number">0xff</span></span><br><span class="line"><span class="number">0x2</span>: add Reg[<span class="number">2</span>] , <span class="number">0x1</span></span><br><span class="line"><span class="number">0x3</span>: mov Mem[Reg[<span class="number">2</span>]] , <span class="number">0x223</span></span><br><span class="line"><span class="number">0x4</span>: add Reg[<span class="number">2</span>] , <span class="number">0x1</span></span><br><span class="line"><span class="number">0x5</span>: mov Mem[Reg[<span class="number">2</span>]] , <span class="number">0x23b</span></span><br><span class="line"><span class="number">0x6</span>: add Reg[<span class="number">2</span>] , <span class="number">0x1</span></span><br><span class="line"><span class="number">0x7</span>: mov Mem[Reg[<span class="number">2</span>]] , <span class="number">0x237</span></span><br><span class="line"><span class="number">0x8</span>: add Reg[<span class="number">2</span>] , <span class="number">0x1</span></span><br><span class="line"><span class="number">0x9</span>: mov Mem[Reg[<span class="number">2</span>]] , <span class="number">0x237</span></span><br><span class="line"><span class="number">0xa</span>: add Reg[<span class="number">2</span>] , <span class="number">0x1</span></span><br><span class="line"><span class="number">0xb</span>: mov Mem[Reg[<span class="number">2</span>]] , <span class="number">0x24b</span></span><br><span class="line"><span class="number">0xc</span>: add Reg[<span class="number">2</span>] , <span class="number">0x1</span></span><br><span class="line"><span class="number">0xd</span>: mov Mem[Reg[<span class="number">2</span>]] , <span class="number">0x22b</span></span><br><span class="line"><span class="number">0xe</span>: add Reg[<span class="number">2</span>] , <span class="number">0x1</span></span><br><span class="line"><span class="number">0xf</span>: mov Mem[Reg[<span class="number">2</span>]] , <span class="number">0xfb</span></span><br><span class="line"><span class="number">0x10</span>: add Reg[<span class="number">2</span>] , <span class="number">0x1</span></span><br><span class="line"><span class="number">0x11</span>: mov Mem[Reg[<span class="number">2</span>]] , <span class="number">0x22b</span></span><br><span class="line"><span class="number">0x12</span>: add Reg[<span class="number">2</span>] , <span class="number">0x1</span></span><br><span class="line"><span class="number">0x13</span>: mov Mem[Reg[<span class="number">2</span>]] , <span class="number">0x223</span></span><br><span class="line"><span class="number">0x14</span>: add Reg[<span class="number">2</span>] , <span class="number">0x1</span></span><br><span class="line"><span class="number">0x15</span>: mov Mem[Reg[<span class="number">2</span>]] , <span class="number">0x24f</span></span><br><span class="line"><span class="number">0x16</span>: add Reg[<span class="number">2</span>] , <span class="number">0x1</span></span><br><span class="line"><span class="number">0x17</span>: mov Mem[Reg[<span class="number">2</span>]] , <span class="number">0xef</span></span><br><span class="line"><span class="number">0x18</span>: add Reg[<span class="number">2</span>] , <span class="number">0x1</span></span><br><span class="line"><span class="number">0x19</span>: mov Mem[Reg[<span class="number">2</span>]] , <span class="number">0x237</span></span><br><span class="line"><span class="number">0x1a</span>: add Reg[<span class="number">2</span>] , <span class="number">0x1</span></span><br><span class="line"><span class="number">0x1b</span>: mov Mem[Reg[<span class="number">2</span>]] , <span class="number">0xef</span></span><br><span class="line"><span class="number">0x1c</span>: add Reg[<span class="number">2</span>] , <span class="number">0x1</span></span><br><span class="line"><span class="number">0x1d</span>: mov Mem[Reg[<span class="number">2</span>]] , <span class="number">0x24f</span></span><br><span class="line"><span class="number">0x1e</span>: add Reg[<span class="number">2</span>] , <span class="number">0x1</span></span><br><span class="line"><span class="number">0x1f</span>: mov Mem[Reg[<span class="number">2</span>]] , <span class="number">0x24f</span></span><br><span class="line"><span class="number">0x20</span>: add Reg[<span class="number">2</span>] , <span class="number">0x1</span></span><br><span class="line"><span class="number">0x21</span>: mov Mem[Reg[<span class="number">2</span>]] , <span class="number">0x223</span></span><br><span class="line"><span class="number">0x22</span>: add Reg[<span class="number">2</span>] , <span class="number">0x1</span></span><br><span class="line"><span class="number">0x23</span>: mov Mem[Reg[<span class="number">2</span>]] , <span class="number">0x223</span></span><br><span class="line"><span class="number">0x24</span>: add Reg[<span class="number">2</span>] , <span class="number">0x1</span></span><br><span class="line"><span class="number">0x25</span>: mov Mem[Reg[<span class="number">2</span>]] , <span class="number">0x23b</span></span><br><span class="line"><span class="number">0x26</span>: add Reg[<span class="number">2</span>] , <span class="number">0x1</span></span><br><span class="line"><span class="number">0x27</span>: mov Mem[Reg[<span class="number">2</span>]] , <span class="number">0x237</span></span><br><span class="line"><span class="number">0x28</span>: add Reg[<span class="number">2</span>] , <span class="number">0x1</span></span><br><span class="line"><span class="number">0x29</span>: mov Mem[Reg[<span class="number">2</span>]] , <span class="number">0xff</span></span><br><span class="line"><span class="number">0x2a</span>: add Reg[<span class="number">2</span>] , <span class="number">0x1</span></span><br><span class="line"><span class="number">0x2b</span>: mov Mem[Reg[<span class="number">2</span>]] , <span class="number">0x233</span></span><br><span class="line"><span class="number">0x2c</span>: add Reg[<span class="number">2</span>] , <span class="number">0x1</span></span><br><span class="line"><span class="number">0x2d</span>: mov Mem[Reg[<span class="number">2</span>]] , <span class="number">0x233</span></span><br><span class="line"><span class="number">0x2e</span>: add Reg[<span class="number">2</span>] , <span class="number">0x1</span></span><br><span class="line"><span class="number">0x2f</span>: mov Mem[Reg[<span class="number">2</span>]] , <span class="number">0x233</span></span><br><span class="line"><span class="number">0x30</span>: add Reg[<span class="number">2</span>] , <span class="number">0x1</span></span><br><span class="line"><span class="number">0x31</span>: mov Mem[Reg[<span class="number">2</span>]] , <span class="number">0x237</span></span><br><span class="line"><span class="number">0x32</span>: add Reg[<span class="number">2</span>] , <span class="number">0x1</span></span><br><span class="line"><span class="number">0x33</span>: mov Mem[Reg[<span class="number">2</span>]] , <span class="number">0x24b</span></span><br><span class="line"><span class="number">0x34</span>: add Reg[<span class="number">2</span>] , <span class="number">0x1</span></span><br><span class="line"><span class="number">0x35</span>: mov Mem[Reg[<span class="number">2</span>]] , <span class="number">0x233</span></span><br><span class="line"><span class="number">0x36</span>: add Reg[<span class="number">2</span>] , <span class="number">0x1</span></span><br><span class="line"><span class="number">0x37</span>: mov Mem[Reg[<span class="number">2</span>]] , <span class="number">0x24f</span></span><br><span class="line"><span class="number">0x38</span>: add Reg[<span class="number">2</span>] , <span class="number">0x1</span></span><br><span class="line"><span class="number">0x39</span>: mov Mem[Reg[<span class="number">2</span>]] , <span class="number">0x22b</span></span><br><span class="line"><span class="number">0x3a</span>: add Reg[<span class="number">2</span>] , <span class="number">0x1</span></span><br><span class="line"><span class="number">0x3b</span>: mov Mem[Reg[<span class="number">2</span>]] , <span class="number">0x22b</span></span><br><span class="line"><span class="number">0x3c</span>: add Reg[<span class="number">2</span>] , <span class="number">0x1</span></span><br><span class="line"><span class="number">0x3d</span>: mov Mem[Reg[<span class="number">2</span>]] , <span class="number">0x24b</span></span><br><span class="line"><span class="number">0x3e</span>: add Reg[<span class="number">2</span>] , <span class="number">0x1</span></span><br><span class="line"><span class="number">0x3f</span>: mov Mem[Reg[<span class="number">2</span>]] , <span class="number">0xef</span></span><br><span class="line"><span class="number">0x40</span>: add Reg[<span class="number">2</span>] , <span class="number">0x1</span></span><br><span class="line"><span class="number">0x41</span>: <span class="built_in">exit</span>()</span><br><span class="line">------code_end------</span><br><span class="line"><span class="number">0x0</span>: <span class="keyword">xor</span> Reg[<span class="number">2</span>] , Reg[<span class="number">2</span>]        <span class="comment">//将密文a[i]-=0x63</span></span><br><span class="line"><span class="number">0x1</span>: mov Reg[<span class="number">0</span>] , Mem[Reg[<span class="number">2</span>]]</span><br><span class="line"><span class="number">0x2</span>: sub Reg[<span class="number">0</span>] , <span class="number">0x63</span></span><br><span class="line"><span class="number">0x3</span>: mov Mem[Reg[<span class="number">2</span>]] , Reg[<span class="number">0</span>]</span><br><span class="line"><span class="number">0x4</span>: add Reg[<span class="number">2</span>] , <span class="number">0x1</span></span><br><span class="line"><span class="number">0x5</span>: cmp Reg[<span class="number">2</span>] , <span class="number">0x20</span></span><br><span class="line"><span class="number">0x6</span>: jb  <span class="number">0x1</span></span><br><span class="line"><span class="number">0x7</span>: <span class="built_in">exit</span>()</span><br></pre></td></tr></tbody></table></figure><p>实际执行时先存入密文并且处理，再输入flag经过处理后比对，逻辑如上，简单逆向算法即可。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">enc=[<span class="number">255</span>, <span class="number">547</span>, <span class="number">571</span>, <span class="number">567</span>, <span class="number">567</span>, <span class="number">587</span>, <span class="number">555</span>, <span class="number">251</span>, <span class="number">555</span>, <span class="number">547</span>, <span class="number">591</span>, <span class="number">239</span>, <span class="number">567</span>, <span class="number">239</span>, <span class="number">591</span>, <span class="number">591</span>, <span class="number">547</span>, <span class="number">547</span>, <span class="number">571</span>, <span class="number">567</span>, <span class="number">255</span>, <span class="number">563</span>, <span class="number">563</span>, <span class="number">563</span>, <span class="number">567</span>, <span class="number">587</span>, <span class="number">563</span>, <span class="number">591</span>, <span class="number">555</span>, <span class="number">555</span>, <span class="number">587</span>, <span class="number">239</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(enc)):</span><br><span class="line">    tmp=enc[i]-<span class="number">0x63</span></span><br><span class="line">    tmp&gt;&gt;=<span class="number">2</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">chr</span>(tmp^<span class="number">0x42</span>),end=<span class="string">''</span>)</span><br><span class="line"><span class="comment">#flag{e247780d029a7a992247e6667869008a}</span></span><br></pre></td></tr></tbody></table></figure><h2 id="总结">总结</h2><p>​<strong>在进行VM逆向分析时，首先要了解VM保护的运行流程，关键点在于Dispatcher中的指令解读和程序流程的分析，这其中的工作量一般是比较大的，并且比较吃汇编，同时要注意VM中指令格式，寄存器的结构体定义，这样可以优化伪码，加速分析。</strong></p><p>​   <strong>Parser的编写就是用python将op译码为x86的汇编，再进行算法分析，这个过程应该需要刷题来练的，不过该题的parser比较简单。</strong></p><blockquote><p><strong>IDA的宏定义 和 IDAPYTHON的使用还要进一步加深，分析VM耐心十分重要，虚拟化层度高时动调和静态结合效率会更高。</strong></p></blockquote><p>参考:</p><p><a href="https://www.cnblogs.com/0xHack/p/9399321.html">IDAPYTHON常用命令</a></p><p><a href="https://blog.shi1011.cn/ctf/2077">https://blog.shi1011.cn/ctf/2077</a></p><p><a href="https://www.cnblogs.com/nigacat/p/13039289.html">https://www.cnblogs.com/nigacat/p/13039289.html</a></p>]]></content>
      
      
      <categories>
          
          <category> RE </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2022HWS冬令营-Wp</title>
      <link href="/2022/01/26/2022HWS%E5%86%AC%E4%BB%A4%E8%90%A5-Wp/"/>
      <url>/2022/01/26/2022HWS%E5%86%AC%E4%BB%A4%E8%90%A5-Wp/</url>
      
        <content type="html"><![CDATA[<blockquote><p>题目质量蛮不错的，学到了很多东西，RE是2道VM的题，一道花指令+ollvm混淆，也有两道Android题在Misc和Crypto中，最刺激的是距比赛结束还有两分钟时解出了RE3。</p></blockquote><h1>一、Misc</h1><h2 id="badPDF">badPDF</h2><p>拿到文件拖入010editor中，发现是4c 00开头，是win下快捷方式的标志，并且本身后缀为.link文件。</p><p>通过搜索找到一篇文章https://www.sohu.com/a/387683719_476857</p><p>得知是2020年一个病毒的弱化样本，利用LNK快捷方式伪装nCov-19疫情的恶意攻击。</p><p>大致流程是运行时会在AppData/Local/Temp目录下加载js、exe文件等用于下一次攻击。该附件的执行流程与所述病毒样本类似，关键点在于拿到WsmPty.xsl文件，查看js可知他写在了\AppData\Local\Temp\cscript.exe目录下，运行fakepdf，在xsl加载到目录下时用notepad打开，内容如下。</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version='1.0'?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">stylesheet</span></span></span><br><span class="line"><span class="tag"><span class="attr">xmlns</span>=<span class="string">"http://www.w3.org/1999/XSL/Transform"</span> <span class="attr">xmlns:ms</span>=<span class="string">"urn:schemas-microsoft-com:xslt"</span></span></span><br><span class="line"><span class="tag"><span class="attr">xmlns:user</span>=<span class="string">"placeholder"</span></span></span><br><span class="line"><span class="tag"><span class="attr">version</span>=<span class="string">"1.0"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">output</span> <span class="attr">method</span>=<span class="string">"text"</span>/&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">ms:script</span> <span class="attr">implements-prefix</span>=<span class="string">"user"</span> <span class="attr">language</span>=<span class="string">"VBScript"</span>&gt;</span></span><br><span class="line"> &lt;![CDATA[</span><br><span class="line"> rBOH7OLTCVxzkH=HrtvBsRh3gNUbe("676d60667a64333665326564333665326564333665326536653265643336656564333665327c"):execute(rBOH7OLTCVxzkH):function HrtvBsRh3gNUbe(bhhz6HalbOkrki):for rBOH7OLTCVxzkH=1 to len(bhhz6HalbOkrki)step 2:HrtvBsRh3gNUbe=HrtvBsRh3gNUbe&amp;chr(asc(chr("&amp;h"&amp;mid(bhhz6HalbOkrki,rBOH7OLTCVxzkH,2)))xor 1):next:end function:</span><br><span class="line"> ]]&gt; <span class="tag">&lt;/<span class="name">ms:script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">stylesheet</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>可见按照VBS脚本正常执行就能拿到flag串，加密很容易hex_to_str后与1异或即可。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a=<span class="built_in">bytes</span>.fromhex(<span class="string">'676d60667a64333665326564333665326564333665326536653265643336656564333665327c'</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(a)):</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">chr</span>(a[i]^<span class="number">1</span>),end=<span class="string">''</span>)</span><br><span class="line"><span class="comment">#flag{e27d3de27d3de27d3d7d3de27dde27d3}</span></span><br></pre></td></tr></tbody></table></figure><h2 id="gogogo">gogogo</h2><p>考点是拼图、取证和Aztec</p><p>首先是puzzle，一共有256个分辨率为160x100，如果用gaps的话需要是正方形，所以先用convert强行转分辨率为160x160。</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find ./ -name '*.png'  -exec convert -resize 160x160! {} {} \; </span><br></pre></td></tr></tbody></table></figure><p>之后montage指令将图片拼接</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">montage *png -tile 16x16 -geometry +0+0 out.png</span><br></pre></td></tr></tbody></table></figure><p>之后直接gaps自动化拼即可 size参数选160</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gaps --image=out.png --generations=20 --population=256 --size=160</span><br></pre></td></tr></tbody></table></figure><p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20220123203055938.png" alt="image-20220123203055938"></p><p>拿到passwd: 3e8f092d4d7b80ce338d6e238efb01</p><p>之后还有2.raw文件，因为我们有个passwd所以猜测有zip文件，直接filescan找zip</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">volatility -f 2.raw imageinfo #WinXPSP2x86</span><br><span class="line">volatility -f 2.raw --profile=WinXPSP2x86 filescan | grep "zip"</span><br><span class="line">volatility -f 2.raw --profile=WinXPSP2x86  dumpfiles -Q [csgo.zip偏移] -D .</span><br></pre></td></tr></tbody></table></figure><p>能导出一个csgo.zip，并且能用puzzle得到的passwd解压，拿到二张图片(foremost分离csgo.png得到)</p><p>一个是阿兹特克的图片，一个是没有定位符的图片码，百度能确定是Aztec，那个枪名的谐音是提示，啊这。</p><p>网上生成一个标准的Aztec码，修复定位符即可，御用PDF修复，不会PS :)。</p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20220123204323061.png" alt="image-20220123204323061" style="zoom:80%;"><h1>二、Crypto</h1><h2 id="babyrsa">babyrsa</h2><p>签到题，n能在线分解，正常rsa解密即可。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line">n=<span class="number">13123058934861171416713230498081453101147538789122070079961388806126697916963123413431108069961369055630747412550900239402710827847917960870358653962948282381351741121884528399369764530446509936240262290248305226552117100584726616255292963971141510518678552679033220315246377746270515853987903184512948801397452104554589803725619076066339968999308910127885089547678968793196148780382182445270838659078189316664538631875879022325427220682805580410213245364855569367702919157881367085677283124732874621569379901272662162025780608669577546548333274766058755786449491277002349918598971841605936268030140638579388226573929</span></span><br><span class="line">e=<span class="number">2199344405076718723439776106818391416986774637417452818162477025957976213477191723664184407417234793814926418366905751689789699138123658292718951547073938244835923378103264574262319868072792187129755570696127796856136279813658923777933069924139862221947627969330450735758091555899551587605175567882253565613163972396640663959048311077691045791516671857020379334217141651855658795614761069687029140601439597978203375244243343052687488606544856116827681065414187957956049947143017305483200122033343857370223678236469887421261592930549136708160041001438350227594265714800753072939126464647703962260358930477570798420877</span></span><br><span class="line">c=<span class="number">1492164290534197296766878830710549288168716657792979479408332026408553210558539364503279432780006256047888761718878241924947937039103166564146378209168719163067531460700424309878383312837345239570897122826051628153030129647363574035072755426112229160684859510640271933580581310029921376842631120847546030843821787623965614564745724229763999106839802052036834811357341644073138100679508864747009014415530176077648226083725813290110828240582884113726976794751006967153951269748482024859714451264220728184903144004573228365893961477199925864862018084224563883101101842275596219857205470076943493098825250412323522013524</span></span><br><span class="line">p=<span class="number">98197216341757567488149177586991336976901080454854408243068885480633972200382596026756300968618883148721598031574296054706280190113587145906781375704611841087782526897314537785060868780928063942914187241017272444601926795083433477673935377466676026146695321415853502288291409333200661670651818749836420808033</span></span><br><span class="line">q=<span class="number">133639826298015917901017908376475546339925646165363264658181838203059432536492968144231040597990919971381628901127402671873954769629458944972912180415794436700950304720548263026421362847590283353425105178540468631051824814390421486132775876582962969734956410033443729557703719598998956317920674659744121941513</span></span><br><span class="line">d=gmpy2.invert(e,(p-<span class="number">1</span>)*(q-<span class="number">1</span>))</span><br><span class="line"><span class="built_in">print</span>(long_to_bytes(<span class="built_in">pow</span>(c,d,n)))</span><br><span class="line"><span class="comment">#hwctf{01d_Curs3_c4Me_Again}</span></span><br></pre></td></tr></tbody></table></figure><h2 id="crypto-Elgamal">crypto_Elgamal</h2><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">assert</span> ( A * s0 + B ) % q == s1</span><br><span class="line"><span class="keyword">assert</span> ( A * s1 + B ) % q == s2</span><br><span class="line"><span class="keyword">assert</span> ( A * s2 + B ) % q == s3</span><br><span class="line"><span class="keyword">assert</span> ( A * s3 + B ) % q == s4</span><br></pre></td></tr></tbody></table></figure><p>第一段是LCG，未知参数是A、B、q</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">s0 = <span class="number">543263588863771657634119</span></span><br><span class="line">s1 = <span class="number">628899245716105951093835</span></span><br><span class="line">s2 = <span class="number">78708024695487418261582</span></span><br><span class="line">s3 = <span class="number">598971435111109998816796</span></span><br><span class="line">s4 = <span class="number">789474285039501272453373</span></span><br><span class="line">s=[s0,s1,s2,s3,s4]</span><br><span class="line">t=[]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(s)-<span class="number">1</span>):</span><br><span class="line">    t.append(s[i+<span class="number">1</span>]-s[i])</span><br><span class="line"><span class="built_in">print</span>(t)</span><br><span class="line"></span><br><span class="line">nn=[]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">3</span>):</span><br><span class="line">    nn.append(<span class="built_in">abs</span>(t[i+<span class="number">1</span>]*t[i-<span class="number">1</span>]-t[i]*t[i]))</span><br><span class="line"><span class="built_in">print</span>(nn)</span><br><span class="line">q=gmpy2.gcd(nn[<span class="number">0</span>],nn[<span class="number">1</span>])</span><br><span class="line"><span class="comment">#791763770658839585424113</span></span><br></pre></td></tr></tbody></table></figure><p>现在我们拿到(g, h, A, B, p, q),之后是ElGamal解密，可知他在生成r时也是线性同余，并且参数我们已知。</p><p>参考:2018 Code Blue lagalem</p><p><a href="https://ctf-wiki.org/crypto/asymmetric/discrete-log/elgamal/#2018-code-blue-lagalem">https://ctf-wiki.org/crypto/asymmetric/discrete-log/elgamal/#2018-code-blue-lagalem</a></p><p>即</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">tmp = gmpy2.powmod(c2, A, p) * gmpy2.powmod(h, B, p) * gmpy2.invert(c2_, p)</span><br><span class="line">tmp = tmp % p</span><br><span class="line">gg, x, y = gmpy2.gcdext(A - <span class="number">1</span>, p - <span class="number">1</span>)</span><br><span class="line"><span class="built_in">print</span>(gg)</span><br><span class="line">m = gmpy2.powmod(tmp, x, p)</span><br><span class="line"><span class="built_in">print</span>(long_to_bytes(m))</span><br></pre></td></tr></tbody></table></figure><p>如果是直接解出的q这里的gg则是7438，即我们求出的m 是 pow(m,7438,p)而7438是p-1的因数，所以rsa也不可解，可知在推导中如果我们取q`=k*q，那么A和B的值会变大，但是LCG的结果不会改变，而我们推导中用到了A和B的值来求t和gg，当我们改变q时，gg的值也在改变，故当gg足够小，为1时，则pow(tmp,x,p) = flag。</p><p>综上exp为:</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">s0 = <span class="number">543263588863771657634119</span></span><br><span class="line">s1 = <span class="number">628899245716105951093835</span></span><br><span class="line">s2 = <span class="number">78708024695487418261582</span></span><br><span class="line">s3 = <span class="number">598971435111109998816796</span></span><br><span class="line">s4 = <span class="number">789474285039501272453373</span></span><br><span class="line"></span><br><span class="line">s=[s0,s1,s2,s3,s4]</span><br><span class="line">t=[]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(s)-<span class="number">1</span>):</span><br><span class="line">    t.append(s[i+<span class="number">1</span>]-s[i])</span><br><span class="line"><span class="built_in">print</span>(t)</span><br><span class="line"></span><br><span class="line">nn=[]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">3</span>):</span><br><span class="line">    nn.append(<span class="built_in">abs</span>(t[i+<span class="number">1</span>]*t[i-<span class="number">1</span>]-t[i]*t[i]))</span><br><span class="line"><span class="built_in">print</span>(nn)</span><br><span class="line"><span class="comment">#[258157280800981693845036338952604472521614296785, 375487011827303788911792498742822292475328703777]</span></span><br><span class="line"><span class="comment">#q=gmpy2.gcd(nn[0],nn[1])</span></span><br><span class="line">q=<span class="number">375487011827303788911792498742822292475328703777</span>*<span class="number">3</span> <span class="comment">#从nn的元素中取再数乘即可，但要保证求A时逆元存在。</span></span><br><span class="line"></span><br><span class="line">A=gmpy2.invert(s1-s0,q)*(s2-s1) %q</span><br><span class="line">B=(s1-A*s[<span class="number">0</span>])%q</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p = <span class="number">65211247300401312530078141569304950676358489059623557848188896752173856845051471066071652073612337629832155846984721797768267868868902023383604553319793550396610085424563231688918357710337401138108050205457200940158475922063279384491022916790549837379548978141370347556053597178221402425212594060342213485311</span></span><br><span class="line">g = <span class="number">27642593390439430783453736408814717946185190497201679721975757020767271070510268596627490205095779429964809833535285315202625851326460572368018875381603399143376574281200028337681552876140857556460885848491160812604549770668188783258592940823128376128198726254875984002214053523752696104568469730021811399216</span></span><br><span class="line">h = <span class="number">54585833166051670245656045196940486576634589000609010947618047461787934106392112227019662788387352615714332234871251868259282522817042504587428441746855906297390193418159792477477443129333707197013251839952389651332058368911829464978546505729530760951698134101053626585254469108630886768357270544236516534904</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">c1 = <span class="number">60724920570148295800083597588524297283595971970237964464679084640302395172192639331196385150232229004030419122038089044697951208850497923486467859070476427472465291810423905736825272208842988090394035980454248119048131354993356125895595138979611664707727518852984351599604226889848831071126576874892808080133</span></span><br><span class="line">c2 = <span class="number">48616294792900599931167965577794374684760165574922600262773518630884983374432147726140430372696876107933565006549344582099592376234783044818320678499613925823621554608542446585829308488452057340023780821973913517239972817669309837103043456714481646128392677624092659929248296869048674230341175765084122344264</span></span><br><span class="line">c1_ = <span class="number">42875731538109170678735196002365281622531058597803022779529275736483962610547258618168523955709341579773947887175626960699426438456382655370090748369934296474999389316334717699127421889816721511602392591677377678759026657582648354688447456509292302633971842316239774410380221303269351351929586256938787054867</span></span><br><span class="line">c2_ = <span class="number">64829024929257668640929285124747107162970460545535885047576569803424908055130477684809317765011143527867645692710091307694839524199204611328374569742391489915929451079830143261799375621377093290249652912850024319433129432676683899459510155157108727860920017105870104383111111395351496171846620163716404148070</span></span><br><span class="line"></span><br><span class="line">tmp = gmpy2.powmod(c2, A, p) * gmpy2.powmod(h, B, p) * gmpy2.invert(c2_, p)</span><br><span class="line">tmp = tmp % p</span><br><span class="line">gg, x, y = gmpy2.gcdext(A - <span class="number">1</span>, p - <span class="number">1</span>)</span><br><span class="line"><span class="built_in">print</span>(gg)</span><br><span class="line">m = gmpy2.powmod(tmp, x, p)</span><br><span class="line"><span class="built_in">print</span>(long_to_bytes(m))</span><br><span class="line"></span><br><span class="line"><span class="comment">#19e9f185e6a680324cedd6e6d9382743</span></span><br></pre></td></tr></tbody></table></figure><h1>三、REVERSE</h1><h2 id="EasyVM">EasyVM</h2><p>修复花指令，patch call的第一个字节，之后观察控制流，尝试后在except异常处理块发现关键函数sub_4012F0</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sub_4012F0</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  _DWORD *v0; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> (__thiscall ***v1)(_DWORD, <span class="keyword">void</span> *, <span class="keyword">void</span> *, _DWORD, _BYTE *); <span class="comment">// ebx</span></span><br><span class="line">  _BYTE *v2; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">char</span> flag[<span class="number">256</span>]; <span class="comment">// [esp+8h] [ebp-100h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v0 = (_DWORD *)sub_401889(<span class="number">0x24</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( v0 )</span><br><span class="line">  {</span><br><span class="line">    *v0 = &amp;off_40A0D0;</span><br><span class="line">    v0[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">    v0[<span class="number">2</span>] = <span class="number">0</span>;</span><br><span class="line">    v0[<span class="number">3</span>] = <span class="number">0</span>;</span><br><span class="line">    v0[<span class="number">4</span>] = <span class="number">0</span>;</span><br><span class="line">    v0[<span class="number">5</span>] = <span class="number">0</span>;</span><br><span class="line">    v0[<span class="number">6</span>] = <span class="number">0</span>;</span><br><span class="line">    v0[<span class="number">7</span>] = <span class="number">0</span>;</span><br><span class="line">    v0[<span class="number">8</span>] = <span class="number">0</span>;</span><br><span class="line">    v1 = (<span class="keyword">int</span> (__thiscall ***)(_DWORD, <span class="keyword">void</span> *, <span class="keyword">void</span> *, _DWORD, _BYTE *))v0;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  {</span><br><span class="line">    v1 = <span class="number">0</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="built_in">scanf</span>(<span class="string">"%s"</span>, flag);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strlen</span>(flag) == <span class="number">42</span> )</span><br><span class="line">  {</span><br><span class="line">    v2 = sub_4011E0(flag);</span><br><span class="line">    <span class="keyword">if</span> ( (**v1)(v1, &amp;unk_40B030, &amp;unk_40B050, <span class="number">0</span>, v2) )</span><br><span class="line">      sub_4016F9((<span class="keyword">int</span>)aCongratulation);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      sub_4016F9((<span class="keyword">int</span>)aUnfortunatelyI);</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  {</span><br><span class="line">    sub_4016F9((<span class="keyword">int</span>)aVerificationFa);</span><br><span class="line">  }</span><br><span class="line">  system(Command);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>可知flag长度为42位，加密流程是sub_4011E0 和 v1指向的函数。</p><p>sub_4011E0是个魔改的base64，修改了表的值通过异或。</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  v6 += <span class="number">4</span>;</span><br><span class="line">  v8 = *((<span class="keyword">unsigned</span> __int8 *)v7 - <span class="number">1</span>);</span><br><span class="line">  v7 += <span class="number">3</span>;</span><br><span class="line">  v4[v6 - <span class="number">4</span>] = aAbcdefghijklmn[v8 &gt;&gt; <span class="number">2</span>] ^ <span class="number">0xA</span>;</span><br><span class="line">  v4[v6 - <span class="number">3</span>] = aAbcdefghijklmn[(*((<span class="keyword">unsigned</span> __int8 *)v7 - <span class="number">3</span>) &gt;&gt; <span class="number">4</span>) | (<span class="number">16</span> * (*(v7 - <span class="number">4</span>) &amp; <span class="number">3</span>))] ^ <span class="number">0xB</span>;/</span><br><span class="line">  v4[v6 - <span class="number">2</span>] = aAbcdefghijklmn[(*((<span class="keyword">unsigned</span> __int8 *)v7 - <span class="number">2</span>) &gt;&gt; <span class="number">6</span>) | (<span class="number">4</span> * (*(v7 - <span class="number">3</span>) &amp; <span class="number">0xF</span>))] ^ <span class="number">0xC</span>;</span><br><span class="line">  v4[v6 - <span class="number">1</span>] = aAbcdefghijklmn[*(v7 - <span class="number">2</span>) &amp; <span class="number">0x3F</span>] ^ <span class="number">0xD</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>v1指向的函数是虚拟机处理函数，传入的参数依次为opcode，密文和经过base64处理后的密文。</p><p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20220123205320141.png" alt="image-20220123205320141"></p><p>结合动态调试可知是按字节处理第三个参数，当前直接与前一个处理后的字节异或后在异或0xee在和密文比较(第一个字节异或0异或0xee)</p><p>综上编写exp</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">enc=[<span class="number">0</span>,<span class="number">0xBE</span>, <span class="number">0x36</span>, <span class="number">0xAC</span>, <span class="number">0x27</span>, <span class="number">0x99</span>, <span class="number">0x4F</span>, <span class="number">0xDE</span>, <span class="number">0x44</span>, <span class="number">0xEE</span>, <span class="number">0x5F</span>, <span class="number">0xDA</span>, <span class="number">0x0B</span>, <span class="number">0xB5</span>, <span class="number">0x17</span>, <span class="number">0xB8</span>, <span class="number">0x68</span>, <span class="number">0xC2</span>, <span class="number">0x4E</span>, <span class="number">0x9C</span>, <span class="number">0x4A</span>, <span class="number">0xE1</span>, <span class="number">0x43</span>, <span class="number">0xF0</span>, <span class="number">0x22</span>, <span class="number">0x8A</span>, <span class="number">0x3B</span>, <span class="number">0x88</span>, <span class="number">0x5B</span>, <span class="number">0xE5</span>, <span class="number">0x54</span>, <span class="number">0xFF</span>, <span class="number">0x68</span>, <span class="number">0xD5</span>, <span class="number">0x67</span>, <span class="number">0xD4</span>, <span class="number">0x06</span>, <span class="number">0xAD</span>, <span class="number">0x0B</span>, <span class="number">0xD8</span>, <span class="number">0x50</span>, <span class="number">0xF9</span>, <span class="number">0x58</span>, <span class="number">0xE0</span>, <span class="number">0x6F</span>, <span class="number">0xC5</span>, <span class="number">0x4A</span>, <span class="number">0xFD</span>, <span class="number">0x2F</span>, <span class="number">0x84</span>, <span class="number">0x36</span>, <span class="number">0x85</span>, <span class="number">0x52</span>, <span class="number">0xFB</span>, <span class="number">0x73</span>, <span class="number">0xD7</span>, <span class="number">0x0D</span>, <span class="number">0xE3</span>]</span><br><span class="line">m=[]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">56</span>,<span class="number">0</span>,-<span class="number">1</span>):</span><br><span class="line">    m.append(enc[i]^enc[i-<span class="number">1</span>]^<span class="number">0xee</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">bytes</span>(m)[::-<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">a=<span class="built_in">bytes</span>(m)[::-<span class="number">1</span>]</span><br><span class="line">s=<span class="string">''</span></span><br><span class="line">key=[<span class="number">0xa</span>,<span class="number">0xb</span>,<span class="number">0xc</span>,<span class="number">0xd</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(a)):</span><br><span class="line">    s+=<span class="built_in">chr</span>(a[i]^key[i%<span class="number">4</span>])</span><br><span class="line"><span class="built_in">print</span>(base64.b64decode(s.encode()))</span><br><span class="line"><span class="comment">#flag{2586dc76-98d5-44e2-ad58-d06e6559d82a}</span></span><br></pre></td></tr></tbody></table></figure><h2 id="babyre">babyre</h2><p>开局多种花指令，简单的跳转直接nop即可，有两种会影响反编译并且比较有趣。</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">00401838</span>                 push    eax</span><br><span class="line">.text:<span class="number">00401839</span>                 mov     eax, <span class="number">7F</span>h</span><br><span class="line">.text:<span class="number">0040183</span>E                 test    eax, eax</span><br><span class="line">.text:<span class="number">00401840</span>                 jz      <span class="keyword">short</span> loc_401847</span><br><span class="line">.text:<span class="number">00401842</span>                 call    near ptr loc_401847+<span class="number">1</span></span><br><span class="line">.text:<span class="number">00401847</span></span><br><span class="line">.text:<span class="number">00401847</span> loc_401847:                             ; CODE XREF: .text:<span class="number">00401840</span>↑j</span><br><span class="line">.text:<span class="number">00401847</span>                                         ; .text:<span class="number">00401842</span>↑p</span><br><span class="line">.text:<span class="number">00401847</span>                 call    fword ptr [eax+<span class="number">58</span>h]</span><br><span class="line"> <span class="comment">//nop一个字节后</span></span><br><span class="line">.text:<span class="number">00401848</span> loc_401848:                             ; CODE XREF: .text:<span class="number">00401842</span>↑p</span><br><span class="line">.text:<span class="number">00401848</span>                 pop     eax</span><br><span class="line">.text:<span class="number">00401849</span>                 pop     eax</span><br></pre></td></tr></tbody></table></figure><p>第一种分析知eax被赋0x7f后jz跳转恒不成立，故通过call来跳转，会压入地址进栈，nop下面call的第一个字节后出现pop，其实是恢复eax值，所以从push eax 到pop eax全nop掉即可。</p><p>第二种更复杂一点，不过也有push和pop恢复现场，全nop掉即可。</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">00401</span>A28                 push    eax</span><br><span class="line">.text:<span class="number">00401</span>A29                 push    ecx</span><br><span class="line">.text:<span class="number">00401</span>A2A                 call    sub_4010A0</span><br><span class="line">.text:<span class="number">00401</span>A2F                 add     eax, <span class="number">15</span>h</span><br><span class="line">.text:<span class="number">00401</span>A32                 push    eax</span><br><span class="line">.text:<span class="number">00401</span>A33                 pop     eax</span><br><span class="line">.text:<span class="number">00401</span>A34                 mov     ecx, <span class="number">0F</span>FFFFFFFh</span><br><span class="line">.text:<span class="number">00401</span>A39                 <span class="keyword">xor</span>     eax, ecx</span><br><span class="line">.text:<span class="number">00401</span>A3B                 push    eax</span><br><span class="line">.text:<span class="number">00401</span>A3C                 pop     ecx</span><br><span class="line">.text:<span class="number">00401</span>A3D                 <span class="keyword">not</span>     ecx</span><br><span class="line">.text:<span class="number">00401</span>A3F                 push    ecx</span><br><span class="line">.text:<span class="number">00401</span>A40                 retn</span><br><span class="line">.text:<span class="number">00401</span>A40 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">00401</span>A41                 db <span class="number">7</span>Eh, <span class="number">0F</span>Fh, <span class="number">15</span>h</span><br><span class="line">.text:<span class="number">00401</span>A44 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">00401</span>A44                 pop     ecx</span><br><span class="line">.text:<span class="number">00401</span>A45                 pop     eax</span><br></pre></td></tr></tbody></table></figure><p>简易版IPYTHON脚本手动去除，生成patch文件。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">adr1=<span class="number">0x00401A28</span></span><br><span class="line">adr2=<span class="number">0x00401A46</span></span><br><span class="line"><span class="keyword">for</span> ad <span class="keyword">in</span> <span class="built_in">range</span>(adr1,adr2):</span><br><span class="line">    PatchByte(ad,<span class="number">0x90</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">'yes'</span>)</span><br></pre></td></tr></tbody></table></figure><p>之后查看控制流，发现ollvm混淆的特征，起初想找个自动化的脚本，可惜没找到!</p><p><a href="https://www.52pojie.cn/thread-1488350-1-1.html">https://www.52pojie.cn/thread-1488350-1-1.html</a></p><p>基本思路是，每个真实块的首地址下断点，运行并记录来还原，因为我们主要关注输入的变化所以，在所有输入的地方下断点，之后调试，多次尝试后执行如下。</p><p><strong>第一块</strong></p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v31的初值为0</span></span><br><span class="line">v31 = ~*(_DWORD *)&amp;input_str[<span class="number">4</span> * v30] &amp; v31 | ~v31 &amp; *(_DWORD *)&amp;input_str[<span class="number">4</span> * v30];</span><br><span class="line">v32 = ~*(_DWORD *)&amp;input_str[<span class="number">4</span> * v30];  <span class="comment">// v30表示下标</span></span><br></pre></td></tr></tbody></table></figure><p>该块为与或非来实现异或，v31依次与所有输入异或(4byte一组)。</p><p><strong>第二块</strong></p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">*(_DWORD *)&amp;input_str[<span class="number">4</span> * v29] = ~*(_DWORD *)&amp;input_str[<span class="number">4</span> * v29] &amp; v31 | ~v31 &amp; *(_DWORD *)&amp;input_str[<span class="number">4</span> * v29];</span><br><span class="line">v32 = v29;<span class="comment">//下标</span></span><br></pre></td></tr></tbody></table></figure><p>该块为输入4byte一组依次与v31异或。</p><p><strong>第三块</strong></p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">input_str[32] = (input_str[v28] &amp; 0x98 | ~input_str[v28] &amp; 0x67) ^ (input_str[32] &amp; 0x98 | ~input_str[32] &amp; 0x67);</span><br></pre></td></tr></tbody></table></figure><p>把进过异或后的所有字节异或到一起填充为33位，用于接下来的base64运算。</p><p><strong>第四块</strong></p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">v15 = v24 &amp; <span class="number">0xF4</span> | ~v24 &amp; <span class="number">0xF0C4020B</span>;</span><br><span class="line">input_str[v20] = v15 ^ (input_str[v20] &amp; <span class="number">0xF4</span> | ~input_str[v20] &amp; <span class="number">0xB</span>);</span><br><span class="line">input_str[v20 + <span class="number">1</span>] = ~v23 &amp; input_str[v20 + <span class="number">1</span>] | ~input_str[v20 + <span class="number">1</span>] &amp; v23;</span><br><span class="line">LOBYTE(v15) = ~v22 &amp; *(_BYTE *)(v20 + <span class="number">10825322</span>) | ~*(_BYTE *)(v20 + <span class="number">10825322</span>) &amp; v22;</span><br><span class="line">*(_BYTE *)(v20 + <span class="number">10825322</span>) = v15;</span><br><span class="line"> v32 = v15;</span><br></pre></td></tr></tbody></table></figure><p>这一块比较复杂，结合动态调试，观察输入的变化，发现是3个一组与3个数异或，而异或的三个数是前一个数据base64加密时转化为的前3个下标。</p><p>在执行时这个异或是从当前开始，之后所有三个一组与该组转化的key异或，第一组不做处理。</p><p><strong>第五块</strong></p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">v24 = (<span class="keyword">int</span>)input_str[v25] &gt;&gt; <span class="number">2</span>;         <span class="comment">// a[0]&gt;&gt;2</span></span><br><span class="line">v10 = ~(<span class="number">16</span> * ~(~input_str[v25] | <span class="number">0xFC</span>));<span class="comment">// (a[0]&amp;0x3 &lt;&lt; 4)</span></span><br><span class="line">v11 = ~((<span class="keyword">int</span>)input_str[v25 + <span class="number">1</span>] &gt;&gt; <span class="number">4</span>);  <span class="comment">// a[1]&gt;&gt;4</span></span><br><span class="line">v23 = ~(v11 | v10) | (((<span class="keyword">int</span>)input_str[v25 + <span class="number">1</span>] &gt;&gt; <span class="number">4</span>) &amp; <span class="number">0x24</span> | v11 &amp; <span class="number">0xDB</span>) ^ ((<span class="number">16</span> * ~(~input_str[v25] | <span class="number">0xFC</span>)) &amp; <span class="number">0x24</span> | v10 &amp; <span class="number">0xDB</span>);</span><br><span class="line">LOBYTE(v11) = ~(<span class="number">4</span> * (input_str[v25 + <span class="number">1</span>] &amp; (input_str[v25 + <span class="number">1</span>] ^ <span class="number">0xF0</span>)));</span><br><span class="line">v12 = ~((<span class="keyword">int</span>)input_str[v25 + <span class="number">2</span>] &gt;&gt; <span class="number">6</span>);</span><br><span class="line">v22 = ~(v12 | v11) | (((<span class="keyword">int</span>)input_str[v25 + <span class="number">2</span>] &gt;&gt; <span class="number">6</span>) &amp; <span class="number">0x11</span> | v12 &amp; <span class="number">0xEE</span>) ^ ((<span class="number">4</span>* (input_str[v25 + <span class="number">1</span>] &amp; (input_str[v25 + <span class="number">1</span>] ^ <span class="number">0xF0</span>))) &amp; <span class="number">0x11</span> | v11 &amp; <span class="number">0xEE</span>);</span><br><span class="line">v21 = input_str[v25 + <span class="number">2</span>] &amp; (input_str[v25 + <span class="number">2</span>] ^ <span class="number">0xC0</span>);</span><br><span class="line">v32 = <span class="number">0x7F</span>;</span><br><span class="line">Str1[v26] = *(_BYTE *)sub_A22210(&amp;off_A52E38, v24);</span><br><span class="line">Str1[v26 + <span class="number">1</span>] = *(_BYTE *)sub_A22210(&amp;off_A52E38, v23);</span><br><span class="line">Str1[v26 + <span class="number">2</span>] = *(_BYTE *)sub_A22210(&amp;off_A52E38, v22);</span><br><span class="line">v13 = v26 + <span class="number">3</span>;</span><br><span class="line">v26 += <span class="number">4</span>;</span><br><span class="line">Str1[v13] = *(_BYTE *)sub_A22210(&amp;off_A52E38, v21);</span><br><span class="line">v20 = v25 + <span class="number">3</span>;</span><br><span class="line">v19 = <span class="number">0xC90DC21D</span>;</span><br></pre></td></tr></tbody></table></figure><p>base64加密，动调测试得知3byte变为4byte的每组6bit的顺序没有变，只不过用与或非实现起来比较难读，这一步和第四块是交替进行的，每进行一次第五块再进行第四块，base64的表需要动调获得。</p><p>通过&amp;off_A52E38间接寻址获得。</p><p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20220124231204350.png" alt="image-20220124231204350"></p><p>耐心调试，了解块的执行顺序后梳理解密逻辑，先是base64换表，之后逆第四块的异或，再之后需要拿到v31，假设我们的base解密后的为 c d 即 a^v31 b^v31 而 v31是由a^b得到所以 c^d == a^d  其中异或的v31抵消了，因此异或的4byte的key可由密文4个一组异或得到，之后再进行解密。</p><p>完整exp如下:</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">s=<span class="string">'Fi9X/fxX6Q6JBfUfBM1V/y6V6PcPjMaQLl9IuttFuH68'</span></span><br><span class="line">t1=<span class="string">'QVEJAfHmUYjBac+u8Ph5n9Od16FrICL/X0GvtM4qk7T2z3wNSsyoebilxWKgZpRD'</span></span><br><span class="line">t2=<span class="string">'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/'</span></span><br><span class="line">c=<span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(s)):</span><br><span class="line">    c+=t2[t1.index(s[i])]</span><br><span class="line">cc=<span class="built_in">list</span>(base64.b64decode(c.encode()))  <span class="comment">#base换表</span></span><br><span class="line"></span><br><span class="line">t=[]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="built_in">len</span>(cc),<span class="number">3</span>): <span class="comment">#分成3个一组</span></span><br><span class="line">    t.append(cc[i:i+<span class="number">3</span>])</span><br><span class="line"><span class="built_in">print</span>(t)</span><br><span class="line">new=[t[<span class="number">0</span>]]</span><br><span class="line"></span><br><span class="line">key=[]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="built_in">len</span>(t)):</span><br><span class="line">    tmp=[<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>]</span><br><span class="line">    a=base64.b64encode(<span class="built_in">bytes</span>(t[i-<span class="number">1</span>])).decode()</span><br><span class="line">    k=[]</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">        k.append(t2.find(a[j]))</span><br><span class="line">    key.append(k)</span><br><span class="line"></span><br><span class="line"><span class="comment">#print(key) 还原base64所用key</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(t)):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(i):</span><br><span class="line">        k=key[j]</span><br><span class="line">        <span class="keyword">for</span> p <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">            t[i][p]^=k[p]</span><br><span class="line"><span class="built_in">print</span>(t) <span class="comment">#你迭代的base</span></span><br><span class="line"></span><br><span class="line">m=[]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> t:</span><br><span class="line">    m.extend(i)</span><br><span class="line"><span class="comment">#print(m)            #base逆向后的明文</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">bytes</span>(m))</span><br><span class="line">mm=[<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>]</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">xor</span>(<span class="params">a,b</span>):</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(a)):</span><br><span class="line">        a[i]^=b[i]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="built_in">len</span>(m)-<span class="number">1</span>,<span class="number">4</span>): <span class="comment">#需要异或v31 而 v31是由 明文4个一组异或而来</span></span><br><span class="line">   xor(mm,m[i:i+<span class="number">4</span>])</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(m)):</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">chr</span>(mm[i%<span class="number">4</span>]^m[i]),end=<span class="string">''</span>)</span><br><span class="line"><span class="comment">#fce5e3dfc6db4f808ccaa6fcffecf583P</span></span><br></pre></td></tr></tbody></table></figure><hr><blockquote><p>re1理解错了，之前也没有编写解释器的经验，后续会复现补上。</p><p>同时赛中花大量时间去搞Android了，可惜最终没能调动起so文件，可能是模拟器有点问题把，一直attach目标程序不上，但最终收获也是蛮大的。</p><p>这次写解密脚本失误有点大，差点re3就废了，看m师傅用z3解的，确实又快又准，自己还要好好加油哦<img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/0BE18A75.png" alt="img" style="zoom: 33%;"></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> CTF-WP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Wp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PinTool-CPU侧信道</title>
      <link href="/2021/12/31/PinTool-CPU%E4%BE%A7%E4%BF%A1%E9%81%93/"/>
      <url>/2021/12/31/PinTool-CPU%E4%BE%A7%E4%BF%A1%E9%81%93/</url>
      
        <content type="html"><![CDATA[<blockquote><p>以2021SCTF的Low-RE为主，初探pintool技术，也对RE手段有了新的认识</p></blockquote><h1>IntelPin的安装</h1><blockquote><p>Pin 是 Intel 公司研发的一个动态二进制插桩框架，可以在二进制程序运行过程中插入各种函数，以监控程序每一步的执行。</p></blockquote><h2 id="条件准备">条件准备</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、Visual Studio Community <span class="number">2019</span> Edition</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>、Cygwin<span class="number">'</span>s <span class="number">64</span>-bit</span><br><span class="line"><span class="comment">//https://cygwin.com/install.html</span></span><br><span class="line"><span class="comment">//需要再安装时选择make gcc-g++的包，非默认</span></span><br><span class="line">    </span><br><span class="line"><span class="number">3</span>、Intel Pin</span><br><span class="line"><span class="comment">//https://www.intel.com/content/www/us/en/developer/articles/tool/pin-a-binary-instrumentation-tool-downloads.html</span></span><br><span class="line"><span class="comment">//版本可以在3.18 - 3.20 或 3.11-3.13 有些对应版本的工具已经被编译为dll在git上</span></span><br></pre></td></tr></tbody></table></figure><h3 id="VS">VS</h3><p>不过要记录VS的vcvars32/64.bat的存放路径，找到VS存放的位置，例如。</p><blockquote><p>“F:\visual studio2019\VC\Auxiliary\Build”<br>build文件夹下有这两个bat文件</p></blockquote><h3 id="Cygwin">Cygwin</h3><p>Cygwin是能在windows环境下执行linux的指令，不过make，gcc，g++等指令要自己下载。</p><p><img src="https://i.imgur.com/5fpdYVd.png" alt=""></p><p>view 选择FULL 搜索要安装的gcc-g++ 和 make 即可，小箭头选着版本，skip即跳过。</p><p><strong>下载完成后，将’D:\Cygwin\bin’添加到环境变量。</strong></p><p><strong>cygwin安装新包</strong></p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、重新运行安装程序</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>、类似apt-get</span><br><span class="line"></span><br><span class="line"> apt-cyg install yourPackage</span><br></pre></td></tr></tbody></table></figure><h3 id="Intel-Pin">Intel Pin</h3><p><a href="https://www.intel.com/content/www/us/en/developer/articles/tool/pin-a-binary-instrumentation-tool-downloads.html">Intel pin官网下载</a></p><p><strong>版本可以选择3.18-3.20 / 3.10-3.13 有现成的工具</strong>。</p><p>完成下载后，将pin.exe所在的目录添加到环境变量。</p><blockquote><p>例如: “D:\pindir\pin”</p></blockquote><p>完成以上操作后，需要对pin\source\tools\ManualExamples的文件进行编译</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">x64</span><br><span class="line"></span><br><span class="line">pushd D:\pindir\pin\source\tools\ManualExamples</span><br><span class="line"><span class="comment">//选择对应位的bat文件</span></span><br><span class="line"></span><br><span class="line"><span class="string">"F:\visual studio2019\VC\Auxiliary\Build\vcvars64.bat"</span></span><br><span class="line"></span><br><span class="line">make all 或 make TARGET=intel64 <span class="comment">//等待即可</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">x86</span><br><span class="line"></span><br><span class="line">pushd D:\pindir\pin\source\tools\ManualExamples</span><br><span class="line"><span class="comment">//选择对应位的bat文件</span></span><br><span class="line"></span><br><span class="line"><span class="string">"F:\visual studio2019\VC\Auxiliary\Build\vcvars64.bat"</span></span><br><span class="line"></span><br><span class="line">make all 或 make TARGET=ia32 <span class="comment">//等待即可</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p><strong>编译成功后，会在ManualExamples目录下生成两个目录，里面的dll 文件即用到的pintools。</strong></p><blockquote><p>使用语法<br>pin -t inscount0.dll – test.exe</p></blockquote><p>单独把pintool的dll文件放到与目标PE文件同目录下，打开cmd输入指令即可。</p><p><strong>完成上述操作后，Intel Pin的一些常用pindll即可自由使用。</strong></p><p>有关pin的更多知识详见:<a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/5.2.1_pin.html#pin-%E5%9C%A8-ctf-%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8">https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/5.2.1_pin.html#pin-在-ctf-中的应用</a></p><h1>Pin在CTF中的使用</h1><blockquote><p>根据做题经验，往往加密后flag的check是逐个比对，也就是较接近明文的输入执行的指令数目越多，或用比较次数来反映，根据这一特性，有了pin的inscount的辅助，我们便能通过反馈的指令执行数目来爆破flag。</p></blockquote><h2 id="low-re">low_re</h2><blockquote><p>题目附件在文末。</p></blockquote><p><img src="https://res.cloudinary.com/lu1u/image/upload/v1640960133/blog_img/%E6%AF%94%E8%B5%9B%E5%A4%8D%E7%8E%B0/sctf-lowre_etmaja.png" alt=""></p><p>VM保护壳，64位程序，脱起壳来就比较麻烦，不过x64dbg能直接定位入口点dump出，但脱壳后的程序拖入IDA的逻辑也看不出如何执行。</p><p>strings窗口有线索，有些hash和flag的提示输入，也难猜出加密算法如何，起初尝试动调，虽然了解到是在调用py文件执行加密，并且找到了几个关键函数，但是还是发现不了加密过程。</p><blockquote><p>由此引入一种新的RE方式，静态和动态都无感，就尝试pintool来暴破一下。</p></blockquote><h3 id="爆破输入长度">爆破输入长度</h3><p>为了让输出效果更直观一些，修改inscount0.cpp编译出mycount64.dll,(自带的是写入到文件)。</p><blockquote><p>inscount1(BB级插桩) 与 inscount0(ins级插桩) 效果相同，但 inscount1 速度更快，实际解题时可以用 inscount1 代替 inscount0</p></blockquote><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">VOID <span class="title">Fini</span><span class="params">(INT32 code, VOID *v)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="comment">// Write to a file since cout and cerr maybe closed by the application</span></span><br><span class="line">    OutFile.setf(ios::showbase);</span><br><span class="line">    OutFile &lt;&lt; <span class="string">"Count "</span> &lt;&lt; icount &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">cout</span>&lt;&lt;<span class="string">"Count "</span> &lt;&lt; icount &lt;&lt; <span class="built_in">endl</span>;<span class="comment">//this 结果输出</span></span><br><span class="line">    OutFile.close();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>根据hash的条数来看输入的位数不会太多，先用mycount爆破一下不同输入位数，因为程序一般都会检测一下输入的长度，如果长度正确反馈的指令数也会更多。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> subprocess <span class="keyword">import</span> Popen,PIPE</span><br><span class="line"><span class="keyword">from</span> sys <span class="keyword">import</span> argv</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line">pinInit = <span class="keyword">lambda</span> tool,pe: Popen([<span class="string">'pin'</span>,<span class="string">'-t'</span>,tool,<span class="string">'--'</span>,pe],stdin=PIPE,stdout=PIPE)</span><br><span class="line">pinWrite = <span class="keyword">lambda</span>  cont : pin.stdin.write(cont)</span><br><span class="line">pinRead = <span class="keyword">lambda</span> : pin.communicate()[<span class="number">0</span>]</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    last_count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">30</span>):</span><br><span class="line">        pin = pinInit(<span class="string">"mycount64"</span>,<span class="string">"low_re.exe"</span>)</span><br><span class="line">        pinWrite(<span class="string">b"a"</span>*i+<span class="string">b'\n'</span>)  <span class="comment">#  换行前即输入内容</span></span><br><span class="line">        _count = <span class="built_in">int</span>(pinRead().split(<span class="string">b"Count "</span>)[<span class="number">1</span>])</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"inputlen({:2d}) -&gt; cout({}) -&gt; delta({})"</span>.<span class="built_in">format</span>(i,_count,_count-last_count))</span><br><span class="line">        last_count=_count</span><br></pre></td></tr></tbody></table></figure><p><img src="https://res.cloudinary.com/lu1u/image/upload/v1640960688/blog_img/%E6%AF%94%E8%B5%9B%E5%A4%8D%E7%8E%B0/lowre1_cqg80x.png" alt=""></p><p>可见在输入长度为17时返回的指令数目明显多于其他长度，故flag大致长为17。</p><h3 id="爆破输入内容">爆破输入内容</h3><p>也是根据反馈指令数目最多来估计为正确字符。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> subprocess <span class="keyword">import</span> Popen,PIPE</span><br><span class="line"><span class="keyword">from</span> sys <span class="keyword">import</span> argv</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line">pinInit = <span class="keyword">lambda</span> tool,pe: Popen([<span class="string">'pin'</span>,<span class="string">'-t'</span>,tool,<span class="string">'--'</span>,pe],stdin=PIPE,stdout=PIPE)</span><br><span class="line">pinWrite = <span class="keyword">lambda</span>  cont : pin.stdin.write(cont)</span><br><span class="line">pinRead = <span class="keyword">lambda</span> : pin.communicate()[<span class="number">0</span>]</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    last_count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> string.printable: <span class="comment">#从可打印字符中爆破</span></span><br><span class="line">        pin = pinInit(<span class="string">"mycount64"</span>,<span class="string">"low_re.exe"</span>)</span><br><span class="line">        pinWrite(i.encode()+<span class="string">b'*'</span>*<span class="number">16</span>+<span class="string">b'\n'</span>)  <span class="comment">#  换行前即输入内容</span></span><br><span class="line">        _count = <span class="built_in">int</span>(pinRead().split(<span class="string">b"Count "</span>)[<span class="number">1</span>])</span><br><span class="line">        <span class="comment">#print("inputlen({:2d}) -&gt; cout({}) -&gt; delta({})".format(i,_count,_count-last_count))</span></span><br><span class="line">        <span class="comment">#last_count=_count</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">'Count(%s) : %d'</span>%(i,_count))</span><br><span class="line"><span class="comment"># ***************** -&gt;624221257</span></span><br><span class="line"><span class="comment"># S**************** -&gt;659084533</span></span><br><span class="line"><span class="comment"># S1*************** -&gt;699517166</span></span><br></pre></td></tr></tbody></table></figure><p>如下图，第一个字符为S时指令数目最多，按照如下思路爆破。</p><p><img src="https://res.cloudinary.com/lu1u/image/upload/v1640960965/blog_img/%E6%AF%94%E8%B5%9B%E5%A4%8D%E7%8E%B0/lowre2_eygakr.png" alt=""></p><p>单由主线程爆破会比较慢，初涉时跑了1个多小时，了解多线程后，用python实现多线程的爆破。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> subprocess <span class="keyword">import</span> Popen,PIPE</span><br><span class="line"><span class="keyword">from</span> sys <span class="keyword">import</span> argv</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> queue</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line">pinInit = <span class="keyword">lambda</span> tool,pe: Popen([<span class="string">'pin'</span>,<span class="string">'-t'</span>,tool,<span class="string">'--'</span>,pe],stdin=PIPE,stdout=PIPE)</span><br><span class="line">last_count=<span class="number">695980376</span> <span class="comment">#当前字符对应的指令数</span></span><br><span class="line">flag=<span class="string">'S1'</span> <span class="comment">#测试的字符</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pintool</span>(<span class="params">s</span>):</span></span><br><span class="line">    pin = pinInit(<span class="string">"mycount64"</span>, <span class="string">"low_re.exe"</span>)</span><br><span class="line">    pin.stdin.write(s.encode())</span><br><span class="line">    _count = <span class="built_in">int</span>(pin.communicate()[<span class="number">0</span>].split(<span class="string">b"Count "</span>)[<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">return</span> _count</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">boom</span>():</span></span><br><span class="line">        <span class="keyword">global</span> flag,last_count,Tcount</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">not</span> q.empty():</span><br><span class="line">            nows=q.get()</span><br><span class="line">            s=(flag+nows).ljust(<span class="number">17</span>,<span class="string">'*'</span>)+<span class="string">'\n'</span> <span class="comment">#换行代表输入</span></span><br><span class="line">            cout=pintool(s)</span><br><span class="line">            <span class="keyword">if</span> cout - last_count &gt; <span class="number">30000000</span>:<span class="comment">#设定值来判定输入是否正确</span></span><br><span class="line">                flag += nows</span><br><span class="line">                last_count = cout</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">'now_str({}) -&gt; count({})'</span>.<span class="built_in">format</span>(flag, cout))</span><br><span class="line">                q.queue.clear()</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            <span class="comment">#    q.queue.clear() 清除队列再赋值</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">setque</span>(<span class="params">q</span>):</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> string.printable[:-<span class="number">2</span>]:<span class="comment">#</span></span><br><span class="line">        q.put(i)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    q = queue.Queue(<span class="number">100</span>)</span><br><span class="line">    setque(q)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="built_in">len</span>(flag)!=<span class="number">17</span>:</span><br><span class="line">        <span class="keyword">if</span> q.empty():</span><br><span class="line">            setque(q)</span><br><span class="line">        <span class="keyword">while</span> threading.active_count()&lt;<span class="number">5</span>: <span class="comment">#维持活跃的多线程</span></span><br><span class="line">             t=threading.Thread(target=boom)</span><br><span class="line">             <span class="comment">#print(threading.active_count())</span></span><br><span class="line">             t.start()</span><br></pre></td></tr></tbody></table></figure><p>运行结果:</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">now_str(S1) -&gt; count(<span class="number">695980376</span>)</span><br><span class="line">now_str(S1d) -&gt; count(<span class="number">735896918</span>)</span><br><span class="line">now_str(S1de) -&gt; count(<span class="number">773007592</span>)</span><br><span class="line">now_str(S1deC) -&gt; count(<span class="number">811103179</span>)</span><br><span class="line">now_str(S1deCh) -&gt; count(<span class="number">852675272</span>)</span><br><span class="line">now_str(S1deCh4) -&gt; count(<span class="number">885489938</span>)</span><br><span class="line">now_str(S1deCh4n) -&gt; count(<span class="number">927208181</span>)</span><br><span class="line">now_str(S1deCh4nn) -&gt; count(<span class="number">965470416</span>)</span><br><span class="line">now_str(S1deCh4nne) -&gt; count(<span class="number">1002501465</span>)</span><br><span class="line">now_str(S1deCh4nnel) -&gt; count(<span class="number">1035433103</span>)</span><br><span class="line">now_str(S1deCh4nnelA) -&gt; count(<span class="number">1074349914</span>)</span><br><span class="line">now_str(S1deCh4nnelAt) -&gt; count(<span class="number">1112107131</span>)</span><br><span class="line">now_str(S1deCh4nnelAtt) -&gt; count(<span class="number">1149152834</span>)</span><br><span class="line">now_str(S1deCh4nnelAtt@) -&gt; count(<span class="number">1192837040</span>)</span><br><span class="line">now_str(S1deCh4nnelAtt@c) -&gt; count(<span class="number">1231986313</span>)</span><br><span class="line"><span class="comment">//SCTF{S1deCh4nnelAtt@ck}</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">hello challanger</span></span><br><span class="line"><span class="comment">please input your flag:</span></span><br><span class="line"><span class="comment">S1deCh4nnelAtt@ck</span></span><br><span class="line"><span class="comment">you are right</span></span><br><span class="line"><span class="comment">Count 1227060385*/</span></span><br></pre></td></tr></tbody></table></figure><p>在跑到最后一个字符时会有些反常，可以单独再爆破或者根据大意猜出为attack。</p><blockquote><p>反思:本题有着VM壳，或者如果遇到大量的混淆，在flag长度较短的情况下，pintool无疑是一大利器。</p></blockquote><p>有些程序判断flag正误会有congra或wrong!等提示，返回值在pin.communicate()元组中，也可以用于爆破。</p><h2 id="check判断计数">check判断计数</h2><blockquote><p>有时正确或者错误的输入在执行指令数上没有较大差别，那么第一种方式就不太适用了，但是程序如果是对输入逐个check的话，并且我们IDA中已知判断代码的地址，我们也能通过改写pintool来计数。</p></blockquote><p>例如:</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;length(provided_flag); i++)</span><br><span class="line">{</span><br><span class="line"><span class="keyword">if</span> (main_mapanic(provided_flag[i]) != constant_binary_blob[i])</span><br><span class="line">{</span><br><span class="line">bad_boy();</span><br><span class="line"><span class="built_in">exit</span>();</span><br><span class="line">}</span><br><span class="line">goodboy();</span><br><span class="line">}</span><br><span class="line"><span class="comment">//节选自前辈博客</span></span><br></pre></td></tr></tbody></table></figure><p>可见是逐个对flag进行比较的，即cmp处，我们可以以此为参考，每当程序执行到cmp一次计数加一，因为如果比对错误程序就会退出，由此可以由count的大小来判断输入的正确性。</p><p>同样，对inscount0进行修改并编译成新的pintool。</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">更改前：</span><br><span class="line"><span class="function">VOID <span class="title">docount</span><span class="params">()</span> </span>{ icount++; }</span><br><span class="line">更改后：</span><br><span class="line"><span class="function">VOID <span class="title">docount</span><span class="params">(<span class="keyword">void</span> *ip)</span> </span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  <span class="comment">// .text:000000000047B96E  cmp al, cl; #代码比较处</span></span><br><span class="line"><span class="keyword">if</span> ((<span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span>)ip == <span class="number">0x000000000047B96E</span>)</span><br><span class="line"> icount++; </span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>编写py脚本对程序进行pintool攻击即可。</p><blockquote><p>最近初涉二进制插桩技术和pintool的简单使用，某些地方可能有错误理解，同时多线程的脚本可能写的有点拉跨，还望师傅们指正。</p></blockquote><hr><p>参考:</p><p>[pin install]起初配置参考: <a href="https://www.cnblogs.com/mgdzy/p/13644475.html">https://www.cnblogs.com/mgdzy/p/13644475.html</a></p><p>[pin in ctf]<a href="https://m4x.fun/post/pin-in-ctf/">https://m4x.fun/post/pin-in-ctf/</a></p><p>[cpu侧信道]<a href="https://www.istt.org.cn/NewsDetail/2672118.html">https://www.istt.org.cn/NewsDetail/2672118.html</a></p><p>[多线程脚本编写]<a href="https://www.cnblogs.com/franknihao/p/6627857.html">https://www.cnblogs.com/franknihao/p/6627857.html</a></p><p>low_re链接：<a href="https://pan.baidu.com/s/17-1WMhu9g5scBQ-RO6MO9Q">https://pan.baidu.com/s/17-1WMhu9g5scBQ-RO6MO9Q</a><br>提取码：uuuu</p>]]></content>
      
      
      <categories>
          
          <category> RE </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RSA dp和dq泄露</title>
      <link href="/2021/12/18/dp%E5%92%8Cdq%E6%B3%84%E9%9C%B2/"/>
      <url>/2021/12/18/dp%E5%92%8Cdq%E6%B3%84%E9%9C%B2/</url>
      
        <content type="html"><![CDATA[<blockquote><p>从一个[羊城杯 2020]Power密码题，引发的关于dp 和 dq泄露等有趣的问题。</p></blockquote><p><strong>题目本身就出的有漏洞，并且对dp泄露的危害有了更深的理解。</strong></p><blockquote><p><strong>其中的数学基础主要基于费马定理和简单的数论推导,成立以m小于p为前提</strong></p></blockquote><h3 id="1、-羊城杯-2020-Power">1、[羊城杯 2020]Power</h3><p>题目如下</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line"><span class="keyword">from</span> secret <span class="keyword">import</span> flag</span><br><span class="line"></span><br><span class="line">p = getPrime(<span class="number">512</span>)</span><br><span class="line">q = getPrime(<span class="number">512</span>)</span><br><span class="line">n = p**<span class="number">4</span>*q</span><br><span class="line"></span><br><span class="line">e = <span class="number">65537</span></span><br><span class="line">phi = gmpy2.lcm(p - <span class="number">1</span>, q - <span class="number">1</span>)</span><br><span class="line">d = gmpy2.invert(e, phi)</span><br><span class="line">dp = d % (p - <span class="number">1</span>)</span><br><span class="line">m = bytes_to_long(flag)</span><br><span class="line">c = <span class="built_in">pow</span>(m, e, n)</span><br><span class="line"><span class="built_in">print</span> (<span class="string">"dp = "</span> + <span class="built_in">str</span>(dp))</span><br><span class="line"><span class="built_in">print</span> (<span class="string">"c = "</span> + <span class="built_in">str</span>(c))</span><br><span class="line"></span><br><span class="line">y = <span class="number">449703347709287328982446812318870158230369688625894307953604074502413258045265502496365998383562119915565080518077360839705004058211784369656486678307007348691991136610142919372779782779111507129101110674559235388392082113417306002050124215904803026894400155194275424834577942500150410440057660679460918645357376095613079720172148302097893734034788458122333816759162605888879531594217661921547293164281934920669935417080156833072528358511807757748554348615957977663784762124746554638152693469580761002437793837094101338408017407251986116589240523625340964025531357446706263871843489143068620501020284421781243879675292060268876353250854369189182926055204229002568224846436918153245720514450234433170717311083868591477186061896282790880850797471658321324127334704438430354844770131980049668516350774939625369909869906362174015628078258039638111064842324979997867746404806457329528690722757322373158670827203350590809390932986616805533168714686834174965211242863201076482127152571774960580915318022303418111346406295217571564155573765371519749325922145875128395909112254242027512400564855444101325427710643212690768272048881411988830011985059218048684311349415764441760364762942692722834850287985399559042457470942580456516395188637916303814055777357738894264037988945951468416861647204658893837753361851667573185920779272635885127149348845064478121843462789367112698673780005436144393573832498203659056909233757206537514290993810628872250841862059672570704733990716282248839</span></span><br><span class="line"></span><br><span class="line">g = <span class="number">2</span></span><br><span class="line">x = <span class="number">2019</span>*p**<span class="number">2</span> + <span class="number">2020</span>*p**<span class="number">3</span> + <span class="number">2021</span>*p**<span class="number">4</span></span><br><span class="line">c1 = <span class="built_in">pow</span>(g, x, y)</span><br><span class="line"><span class="built_in">print</span>( <span class="string">"c1 = "</span> + <span class="built_in">str</span>(c1))</span><br><span class="line"></span><br><span class="line"><span class="comment"># dp = 379476973158146550831004952747643994439940435656483772269013081580532539640189020020958796514224150837680366977747272291881285391919167077726836326564473</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># c = 57248258945927387673579467348106118747034381190703777861409527336272914559699490353325906672956273559867941402281438670652710909532261303394045079629146156340801932254839021574139943933451924062888426726353230757284582863993227592703323133265180414382062132580526658205716218046366247653881764658891315592607194355733209493239611216193118424602510964102026998674323685134796018596817393268106583737153516632969041693280725297929277751136040546830230533898514659714717213371619853137272515967067008805521051613107141555788516894223654851277785393355178114230929014037436770678131148140398384394716456450269539065009396311996040422853740049508500540281488171285233445744799680022307180452210793913614131646875949698079917313572873073033804639877699884489290120302696697425</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># c1 = 78100131461872285613426244322737502147219485108799130975202429638042859488136933783498210914335741940761656137516033926418975363734194661031678516857040723532055448695928820624094400481464950181126638456234669814982411270985650209245687765595483738876975572521276963149542659187680075917322308512163904423297381635532771690434016589132876171283596320435623376283425228536157726781524870348614983116408815088257609788517986810622505961538812889953185684256469540369809863103948326444090715161351198229163190130903661874631020304481842715086104243998808382859633753938512915886223513449238733721777977175430329717970940440862059204518224126792822912141479260791232312544748301412636222498841676742208390622353022668320809201312724936862167350709823581870722831329406359010293121019764160016316259432749291142448874259446854582307626758650151607770478334719317941727680935243820313144829826081955539778570565232935463201135110049861204432285060029237229518297291679114165265808862862827211193711159152992427133176177796045981572758903474465179346029811563765283254777813433339892058322013228964103304946743888213068397672540863260883314665492088793554775674610994639537263588276076992907735153702002001005383321442974097626786699895993544581572457476437853778794888945238622869401634353220344790419326516836146140706852577748364903349138246106379954647002557091131475669295997196484548199507335421499556985949139162639560622973283109342746186994609598854386966520638338999059</span></span><br></pre></td></tr></tbody></table></figure><p>我们已知c，c1，dp，e 没有n，可能我们注意力比较容易被c1的约束所吸引。</p><p><strong>c1是由2^x mod y 生成的，其中x和p相关，y是一个非常大的数，如果没有模运算，一个简单log就能求出n， 在模运算下，这就上升为离散对数问题。</strong></p><p>我们可以通过sympy库的<code>discrete_log</code> 函数来求解，可p是一个512bit的数，X是非常大的，在5min左右python跑出，或许sagemath 会更快一点，这也要求之后要掌握一些有关离散对数的求解算法。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(sympy.discrete_log(y,c1,<span class="number">2</span>))</span><br></pre></td></tr></tbody></table></figure><p>参考用法:        <a href="https://www.pythonf.cn/read/109392">https://www.pythonf.cn/read/109392</a></p><p>离散对数算法: <a href="http://www.zbc53.top/archives/124/">http://www.zbc53.top/archives/124/</a></p><p><strong>假设 我们求出了X 之后X就是p的一个多次方程，可以用z3进行求解。</strong></p><p>求出p之后呢，我们还是没有n 并且没有q的相关信息，这时就要用到dp这一个条件。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">dp= d mod p-<span class="number">1</span></span><br><span class="line"><span class="comment">#两遍同乘e</span></span><br><span class="line">e*dp = e*d mod p -<span class="number">1</span> </span><br><span class="line"><span class="comment">#等价</span></span><br><span class="line">e*dp = e*d + k*(p-<span class="number">1</span>)    (<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">根据我们钟爱的e*d = 1 mod phi n</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">n= (p^4) *q</span></span><br><span class="line"><span class="string">phi(n) = (p^3)*(p-1)*q</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">有了这些前提,不妨让式(1) mod phin</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line">e*d + k*(p-<span class="number">1</span>) mod phin = e*dp </span><br><span class="line"><span class="comment">#等价</span></span><br><span class="line"><span class="number">1</span> + k*(p-<span class="number">1</span>) = e*dp +  k*phin    phin=(p^<span class="number">3</span>)*(p-<span class="number">1</span>)*q  也是k<span class="string">'*(p-1)</span></span><br><span class="line"><span class="string">#整理 也就是</span></span><br><span class="line"><span class="string">e*dp = 1 + k1*(p-1)     (2)    #感觉出其中的倍数关系即可</span></span><br><span class="line"><span class="string">#此处标位式(2) 我们之后会重点用到</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">既然</span></span><br><span class="line"><span class="string">m ^ e = c mod n</span></span><br><span class="line"><span class="string">c^d mod n = m</span></span><br><span class="line"><span class="string">用到了欧拉定理</span></span><br><span class="line"><span class="string">a^(phin) mod n = 1 </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">那么我们可以类似</span></span><br><span class="line"><span class="string">c ^ (dp) = m ^ (e*dp) = m ^ (1 + k1*(p-1))</span></span><br><span class="line"><span class="string">根据费马定理 a ^ (p-1) mod p = 1</span></span><br><span class="line"><span class="string">那么 c ^ dp  mod p = m</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">c ^ dp  mod p = m</span></span><br></pre></td></tr></tbody></table></figure><p>根据上述推导，拿到p，游戏就结束了。</p><ul><li><p>上述  c ^ dp  mod p = m 必须要满足 m &lt; p 或者近似接近 否则近乎不能求解</p><p>即 m = (c^dp mod p) + k*p</p></li></ul><p><strong>回顾一下解题思路，我们执着于解离散对数和高次方程不就是为了求p么，但总结一下上面无论是dp还是 c1 都是有关p的，两个方程求一个未知量，是不是有点奢侈了呢?</strong></p><p><strong>注意推导中的这个式子e<em>dp = 1 + k1</em>(p-1)！！！ e和dp已知，k未知但是 e<em>dp - 1 一定是 (p-1)的整数倍，并且e</em>dp-1为525个bit 是十分接近的，这完全可以爆破。</strong></p><p>脚本如下</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span>  gmpy2</span><br><span class="line"><span class="keyword">import</span> cmath</span><br><span class="line"><span class="keyword">import</span> sympy</span><br><span class="line"><span class="keyword">from</span>  Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line">e = <span class="number">65537</span></span><br><span class="line">dp=<span class="number">379476973158146550831004952747643994439940435656483772269013081580532539640189020020958796514224150837680366977747272291881285391919167077726836326564473</span></span><br><span class="line">c=<span class="number">57248258945927387673579467348106118747034381190703777861409527336272914559699490353325906672956273559867941402281438670652710909532261303394045079629146156340801932254839021574139943933451924062888426726353230757284582863993227592703323133265180414382062132580526658205716218046366247653881764658891315592607194355733209493239611216193118424602510964102026998674323685134796018596817393268106583737153516632969041693280725297929277751136040546830230533898514659714717213371619853137272515967067008805521051613107141555788516894223654851277785393355178114230929014037436770678131148140398384394716456450269539065009396311996040422853740049508500540281488171285233445744799680022307180452210793913614131646875949698079917313572873073033804639877699884489290120302696697425</span></span><br><span class="line">ep=e*dp-<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>,<span class="number">1000000</span>):</span><br><span class="line">    <span class="keyword">if</span> ep % k ==<span class="number">0</span>:</span><br><span class="line">        p = (ep//k) +<span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> isPrime(p):</span><br><span class="line">            <span class="built_in">print</span>(k)</span><br><span class="line"></span><br><span class="line">p=<span class="number">12131601165788024635030034921084070470053842112984866821070395281728468805072716002494427632757418621194662541766157553264889658892783635499016425528807741</span></span><br><span class="line"><span class="built_in">print</span>(long_to_bytes(<span class="built_in">pow</span>(c,dp,p)))</span><br></pre></td></tr></tbody></table></figure><p><strong>这样也能达到解出p的目的，并且直接用 pow(c,dp,p),求解，用到了两个二级推导结论。</strong></p><p><strong>这也能透露出当m&lt;p时e*dp泄露的危害，如果能通过dp爆破出p，或者直接拿到p ，则直接用dp 和 p，作为私钥和公钥解密即可。</strong></p><p><strong>dp，dq本身就是为了快速解密服务的，也就决定了，大多情况下的p和q是非常大的，往往m会比p要小很多，如果出题人在dp泄露时忽视了这一点，那么可能会出现非预期。</strong></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在m&gt;&gt;p 的dp泄露就需要给出e和n，以便我们借助p来分解n</span></span><br><span class="line"><span class="comment">#以网上的一个题目为例</span></span><br><span class="line">(<span class="string">'dp='</span>, <span class="string">'0x7f1344a0b8d2858492aaf88d692b32c23ef0d2745595bc5fe68de384b61c03e8fd054232f2986f8b279a0105b7bee85f74378c7f5f35c3fd505e214c0738e1d9'</span>)</span><br><span class="line">(<span class="string">'n='</span>, <span class="string">'0x5eee1b4b4f17912274b7427d8dc0c274dc96baa72e43da36ff39d452ff6f2ef0dc6bf7eb9bdab899a6bb718c070687feff517fcf5377435c56c248ad88caddad6a9cefa0ca9182daffcc6e48451d481f37e6520be384bedb221465ec7c95e2434bf76568ef81e988039829a2db43572e2fe57e5be0dc5d94d45361e96e14bd65L'</span>)</span><br><span class="line">(<span class="string">'e='</span>, <span class="string">'0x10001'</span>)</span><br><span class="line">(<span class="string">'c='</span>, <span class="string">'0x510fd8c3f6e21dfc0764a352a2c7ff1e604e1681a3867480a070a480f722e2f4a63ca3d7a92b862955ab4be76cde43b51576a128fba49348af7a6e34b335cfdbda8e882925b20503762edf530d6cd765bfa951886e192b1e9aeed61c0ce50d55d11e343c78bb617d8a0adb7b4cf3b913ee85437191f1136e35b94078e68bee8dL'</span>)</span><br></pre></td></tr></tbody></table></figure><h4 id="1、p-m-Quic-Crack">1、p&lt;m Quic Crack</h4><p><strong>p的位数可以直接观察dp得出，接近512bit，64字节，一般flag在30-50左右甚至更短，即m&lt;p</strong></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span>  gmpy2</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line">dp=<span class="number">0x7f1344a0b8d2858492aaf88d692b32c23ef0d2745595bc5fe68de384b61c03e8fd054232f2986f8b279a0105b7bee85f74378c7f5f35c3fd505e214c0738e1d9</span></span><br><span class="line"></span><br><span class="line">n=<span class="number">0x5eee1b4b4f17912274b7427d8dc0c274dc96baa72e43da36ff39d452ff6f2ef0dc6bf7eb9bdab899a6bb718c070687feff517fcf5377435c56c248ad88caddad6a9cefa0ca9182daffcc6e48451d481f37e6520be384bedb221465ec7c95e2434bf76568ef81e988039829a2db43572e2fe57e5be0dc5d94d45361e96e14bd65</span></span><br><span class="line">e=<span class="number">0x10001</span></span><br><span class="line">c=<span class="number">0x510fd8c3f6e21dfc0764a352a2c7ff1e604e1681a3867480a070a480f722e2f4a63ca3d7a92b862955ab4be76cde43b51576a128fba49348af7a6e34b335cfdbda8e882925b20503762edf530d6cd765bfa951886e192b1e9aeed61c0ce50d55d11e343c78bb617d8a0adb7b4cf3b913ee85437191f1136e35b94078e68bee8d</span></span><br><span class="line">edp=e*dp - <span class="number">1</span></span><br><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>,<span class="number">10000000</span>):</span><br><span class="line">    <span class="keyword">if</span> edp%k==<span class="number">0</span>:</span><br><span class="line">        p= edp//k + <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> isPrime(p):</span><br><span class="line">            <span class="built_in">print</span>(long_to_bytes(<span class="built_in">pow</span>(c,dp,p)))</span><br></pre></td></tr></tbody></table></figure><p>当然这只是一种特殊情况，但是网上大多数关于dp泄露题目貌似都存在这个问题。</p><h4 id="2、通用解法">2、通用解法</h4><p><strong>通解，当然rsa加密对密文本身就限制了m是要比n小的</strong></p><p>所以分解n直接解就得了，既然上脚本我们已经测试出了p ，那么q = n//p 即可。</p><p>综上，综合两种脚本</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span>  gmpy2</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line">dp=<span class="number">0x7f1344a0b8d2858492aaf88d692b32c23ef0d2745595bc5fe68de384b61c03e8fd054232f2986f8b279a0105b7bee85f74378c7f5f35c3fd505e214c0738e1d9</span></span><br><span class="line"></span><br><span class="line">n=<span class="number">0x5eee1b4b4f17912274b7427d8dc0c274dc96baa72e43da36ff39d452ff6f2ef0dc6bf7eb9bdab899a6bb718c070687feff517fcf5377435c56c248ad88caddad6a9cefa0ca9182daffcc6e48451d481f37e6520be384bedb221465ec7c95e2434bf76568ef81e988039829a2db43572e2fe57e5be0dc5d94d45361e96e14bd65</span></span><br><span class="line">e=<span class="number">0x10001</span></span><br><span class="line">c=<span class="number">0x510fd8c3f6e21dfc0764a352a2c7ff1e604e1681a3867480a070a480f722e2f4a63ca3d7a92b862955ab4be76cde43b51576a128fba49348af7a6e34b335cfdbda8e882925b20503762edf530d6cd765bfa951886e192b1e9aeed61c0ce50d55d11e343c78bb617d8a0adb7b4cf3b913ee85437191f1136e35b94078e68bee8d</span></span><br><span class="line">edp=e*dp - <span class="number">1</span></span><br><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>,<span class="number">10000000</span>):</span><br><span class="line">    <span class="keyword">if</span> edp%k==<span class="number">0</span>:</span><br><span class="line">        p= edp//k + <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> isPrime(p):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="built_in">print</span>(long_to_bytes(<span class="built_in">pow</span>(c,dp,p)).decode(<span class="string">'utf-8'</span>)) <span class="comment">#flag肯定是可见字符</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">'Quick Crack Suc!'</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                q=n//p</span><br><span class="line">                phi=(p-<span class="number">1</span>)*(q-<span class="number">1</span>)</span><br><span class="line">                d=gmpy2.invert(e,phi)</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    <span class="built_in">print</span>(long_to_bytes(<span class="built_in">pow</span>(c,d,n)).decode(<span class="string">'utf-8'</span>))</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">'yes!'</span>)</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">except</span>:</span><br><span class="line">                    <span class="keyword">pass</span></span><br></pre></td></tr></tbody></table></figure><p><strong>测试，用如下式例来测试 m &gt; p的情况</strong></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dp = <span class="number">14423533367739841601650555272663543354837347609362352488761411482549189398193</span></span><br><span class="line">p =  <span class="number">69901287164206610888661720099426949703910023683707793762919220907478091073681</span></span><br><span class="line">c=  <span class="number">2262919207276468849681578487794992281448594044416435512543882157738828978766101685798623343531305619235784170849036103143665025760464116190980363198608567</span></span><br><span class="line">e=<span class="number">65537</span></span><br><span class="line">n=<span class="number">5965322435025945026021165385608956120433036321627501574655956870755806607342365635361310529607383516087208412532082338428923031616470920911896483167491881</span></span><br></pre></td></tr></tbody></table></figure><h3 id="2、dp-dq泄露">2、dp dq泄露</h3><p><strong>dp 和 dq泄露 和dp泄露有着异曲同工之妙，不过忽略了m &lt; p / q 就成了纸老虎。</strong></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">c: <span class="number">95272795986475189505518980251137003509292621140166383887854853863720692420204142448424074834657149326853553097626486371206617513769930277580823116437975487148956107509247564965652417450550680181691869432067892028368985007229633943149091684419834136214793476910417359537696632874045272326665036717324623992885</span></span><br><span class="line">p: <span class="number">11387480584909854985125335848240384226653929942757756384489381242206157197986555243995335158328781970310603060671486688856263776452654268043936036556215243</span></span><br><span class="line">q: <span class="number">12972222875218086547425818961477257915105515705982283726851833508079600460542479267972050216838604649742870515200462359007315431848784163790312424462439629</span></span><br><span class="line">dp: <span class="number">8191957726161111880866028229950166742224147653136894248088678244548815086744810656765529876284622829884409590596114090872889522887052772791407131880103961</span></span><br><span class="line">dq: <span class="number">3570695757580148093370242608506191464756425954703930236924583065811730548932270595568088372441809535917032142349986828862994856575730078580414026791444659</span></span><br></pre></td></tr></tbody></table></figure><p>按之前的算法 是要用中国剩余定理求d的</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dp = d mod p-<span class="number">1</span></span><br><span class="line">dq = d mod q-<span class="number">1</span></span><br></pre></td></tr></tbody></table></figure><h4 id="1、解密思路-Crt">1、解密思路 + Crt</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">m1 = c^dp mod p</span><br><span class="line">m2 = c^dq mod q</span><br><span class="line">dp = d mod p-<span class="number">1</span>   -&gt; dp = d + k*(p-<span class="number">1</span>)</span><br><span class="line">dq = q mod q-<span class="number">1</span></span><br><span class="line"><span class="comment">#根据 费马可得 c^dp mod p = c^d mod p</span></span><br><span class="line"><span class="comment">#同理 c^dq mod q = c^d mod q </span></span><br><span class="line">c^d mod p = m1</span><br><span class="line">c^d mod q = m2</span><br><span class="line"></span><br><span class="line">构造 x = k1*m1 + k2*m2</span><br><span class="line"></span><br><span class="line">(<span class="number">1</span>)k1 mod p =<span class="number">1</span></span><br><span class="line">(<span class="number">2</span>)k1 mod q =<span class="number">0</span></span><br><span class="line"></span><br><span class="line">k1 = k*q 带入(<span class="number">1</span>)</span><br><span class="line">k = q^(-<span class="number">1</span>) mod p </span><br><span class="line">即 k1 = (q ^(-<span class="number">1</span>) mod p) *q</span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">推广到一般 如果 在剩余定理中</span></span><br><span class="line"><span class="string">x mod a1 = b1 </span></span><br><span class="line"><span class="string">x mod a2 = b2</span></span><br><span class="line"><span class="string">x mod a3 = b3</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">那么构造的数 m = k1*b1 + k2*b2 + ... kn * bn</span></span><br><span class="line"><span class="string">k1 = ((a2 *a3 *..an)^(-1) mod a1) * (a2 *a3 *..an)</span></span><br><span class="line"><span class="string">k2 = ((a1 *a3 *..an)^(-1) mod a1) * (a2 *a3 *..an)</span></span><br><span class="line"><span class="string"><span class="meta">... </span>如此规律</span></span><br><span class="line"><span class="string">M=a1*a2*..an</span></span><br><span class="line"><span class="string">Mi = M / ai</span></span><br><span class="line"><span class="string">Mi' = gmpy2.invert(Mi,ai)</span></span><br><span class="line"><span class="string">Mi * Mi' * bi 每一项</span></span><br><span class="line"><span class="string">综合要%M  一下</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>即</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span>  gmpy2</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">dp= <span class="number">90494486973243104756298311175705002887155440121025946664275790548694955799661434870163629541771658812502682012435200659355928618529521731475360236486362525996535354732687624609637012830178545914960485330748345108757203508531117591067570383564779625954776907685968592668868046507450242047759226407026094726359</span></span><br><span class="line">dq= <span class="number">92386717102324384872139253931247976320472847834037799716676564640678692924258053130751618730959510913784801723023536527134208843358920592320351399005428347188639433875570867152865970587272904695272790831679276818402117343413503376057524788386479263579869430615501089905630519162146030369086836183772975252551</span></span><br><span class="line">p= <span class="number">121869669684596731118740111360803257498670698122183387353481580136405322481841982461820301261370579505460038281590785837096967719889404913176714663774999789266522508163678949469953184327222227297952119212490499582581953510522212981687122483764873187827531047946130999532741388680549345732675732040579796067001</span></span><br><span class="line">q= <span class="number">128363031923139297392077349407719417788135630403499671848196425800900870531452570499668481104884553795224784931947824885511134525485570129640119439950191944938407656926280993408854767711557863016197167505998324659906146937423415404059310560359693643987781862684489401368519777953281060013045590132161625607377</span></span><br><span class="line">c= <span class="number">4176193749773450562408160796325873473193702511560805285554329767573726211097194419198463203488792792756598428753745425419950423161673497255820731183746106463781291156892140581651301528184812357534808298071893380519977926677138246941946185699346532140641376461516107672722425971178865758049759985915001009787241295292157744353554548314911531918044654676691927347018033509499136103964942830581407087547565204232556314726045307279963709599952745342811947421707024572981812906869557834491207590418553244020621858083633564878305733114484857827620268881100166090837841224767358579366482347136224695333980041913268394994302</span></span><br><span class="line">m1 = <span class="built_in">pow</span>(c,dp,p)</span><br><span class="line">m2 = <span class="built_in">pow</span>(c,dq,q)</span><br><span class="line">d = gmpy2.invert(q,p)*(q)*m1 + gmpy2.invert(p,q)*(p)*m2</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(long_to_bytes(d%(p*q)))</span><br></pre></td></tr></tbody></table></figure><p>用python的库sympy来实现crt</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sympy.ntheory.modular <span class="keyword">import</span> * <span class="comment">#从sympy数论库中导入函数</span></span><br><span class="line">crt([p,q],[m1,m2])</span><br><span class="line"><span class="comment"># 第一个参数是模数组，第二个参数是余数组</span></span><br><span class="line"><span class="comment"># 返回值是一个元组 第一个数是求解的m值，第二个数是所有模数的乘积</span></span><br><span class="line"></span><br><span class="line">m=crt([p,q],[m1,m2])[<span class="number">0</span>] <span class="comment">#得到解即可</span></span><br><span class="line"><span class="built_in">print</span>(long_to_bytes(m%n))</span><br></pre></td></tr></tbody></table></figure><p>sympy库中有很多方便的函数，有大致印象百度即可。</p><h4 id="2、测试用例">2、测试用例</h4><p>反例当messaege&gt;q</p><p>注意m要小于n</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span>  gmpy2</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line">p=getPrime(<span class="number">256</span>)</span><br><span class="line">q=getPrime(<span class="number">256</span>)</span><br><span class="line">n=p*q</span><br><span class="line">phi=(p-<span class="number">1</span>)*(q-<span class="number">1</span>)</span><br><span class="line">e=<span class="number">65537</span></span><br><span class="line">d=gmpy2.invert(e,phi)</span><br><span class="line">dp=d%(p-<span class="number">1</span>)</span><br><span class="line">dq=d%(q-<span class="number">1</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">'dp = '</span>,dp)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">'p = '</span>,p)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">'dq = '</span>,dq)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">'q= '</span>,q)</span><br><span class="line">m=<span class="string">b'flag{If_the message_is_larger_than_prime_end!!!}'</span></span><br><span class="line">c=bytes_to_long(m)</span><br><span class="line">c= <span class="built_in">pow</span>(c,e,n)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">'c= '</span>,c)</span><br></pre></td></tr></tbody></table></figure><p>如果继续解密,则是乱码</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line">dp = <span class="number">14423533367739841601650555272663543354837347609362352488761411482549189398193</span></span><br><span class="line">p =  <span class="number">69901287164206610888661720099426949703910023683707793762919220907478091073681</span></span><br><span class="line">c=  <span class="number">2262919207276468849681578487794992281448594044416435512543882157738828978766101685798623343531305619235784170849036103143665025760464116190980363198608567</span></span><br><span class="line"><span class="built_in">print</span>(long_to_bytes(<span class="built_in">pow</span>(c,dp,p)))</span><br><span class="line"><span class="comment"># b'Y\x83^\xa4\xf2\xbaC\xbfY\xa0\x9a!\x07^\xb0\x12\xaa-\xa0\x10\xf8;\x9b\xb1\xaaF5\x9f\xb2\x952\xc0'</span></span><br></pre></td></tr></tbody></table></figure><p>中国剩余定理,成功解决</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span>  gmpy2</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line">dp =  <span class="number">14423533367739841601650555272663543354837347609362352488761411482549189398193</span></span><br><span class="line">p =  <span class="number">69901287164206610888661720099426949703910023683707793762919220907478091073681</span></span><br><span class="line">dq =  <span class="number">32437946587531699347725552012753985094383131578752766354933176932787801620073</span></span><br><span class="line">q=  <span class="number">85339235900086908600694050911639754370783480963298143334400691126173744722201</span></span><br><span class="line">c=  <span class="number">2262919207276468849681578487794992281448594044416435512543882157738828978766101685798623343531305619235784170849036103143665025760464116190980363198608567</span></span><br><span class="line">m1 = <span class="built_in">pow</span>(c,dp,p)</span><br><span class="line">m2 = <span class="built_in">pow</span>(c,dq,q)</span><br><span class="line">d = gmpy2.invert(q,p)*(q)*m1 + gmpy2.invert(p,q)*(p)*m2</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(long_to_bytes(d%(p*q)))</span><br><span class="line"><span class="comment">#b'flag{If_the message_is_larger_than_prime_end!!!}'</span></span><br></pre></td></tr></tbody></table></figure><hr><blockquote><p>推导过程中的中间结论也能对解密有巨大贡献，在进行加密时，还要考虑密文和素因数以及模数的大小，防止出现非预期的漏洞。</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Crypto </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Crypto </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2021NCTF-Re</title>
      <link href="/2021/12/01/2021NCTF-RE/"/>
      <url>/2021/12/01/2021NCTF-RE/</url>
      
        <content type="html"><![CDATA[<h1>NCTF-RE</h1><h2 id="签到">签到</h2><p><strong>送IDA又送flag</strong></p><p><strong>欢迎来到NCTF-逆向工程(Reverse Engineering)</strong><br><strong>这里可能有你需要的工具:</strong><br><strong>ida pro 7.6 :</strong></p><p><strong>链接：<a href="https://pan.baidu.com/s/1bV2HjBBX0bwwtzORqhErOg">https://pan.baidu.com/s/1bV2HjBBX0bwwtzORqhErOg</a></strong></p><p><strong>提取码：o49x</strong></p><h2 id="Shadowbringer">Shadowbringer</h2><p>c++64位程序，ida载入</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">std</span>::<span class="built_in">string</span>::<span class="built_in">string</span>(v4, <span class="string">"U&gt;F2UsQXN`5sXMELT=:7M_2&lt;X]^1ThaWF0=KM?9IUhAsTM5:T==_Ns&amp;&lt;Vhb!"</span>, &amp;v6);</span><br><span class="line">  <span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;::~allocator(&amp;v6);</span><br><span class="line">  <span class="built_in">std</span>::<span class="keyword">operator</span>&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(refptr__ZSt4cout, <span class="string">"Welcome.Please input your flag:\n"</span>);</span><br><span class="line">  <span class="built_in">std</span>::<span class="keyword">operator</span>&gt;&gt;&lt;<span class="keyword">char</span>&gt;(refptr__ZSt3cin, (<span class="built_in">std</span>::<span class="built_in">string</span> *)input);</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span>::<span class="built_in">string</span>((<span class="built_in">std</span>::<span class="built_in">string</span> *)v8, (<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> *)input);<span class="comment">// strcpy</span></span><br><span class="line">  base64encode1((<span class="built_in">std</span>::<span class="built_in">string</span> *)v7, (<span class="built_in">std</span>::<span class="built_in">string</span> *)v8);<span class="comment">// 换表的base64</span></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span>::<span class="keyword">operator</span>=((<span class="built_in">std</span>::<span class="built_in">string</span> *)input, (<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> *)v7);<span class="comment">// 赋值 第一层密文</span></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span>::~<span class="built_in">string</span>((<span class="built_in">std</span>::<span class="built_in">string</span> *)v7);</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span>::~<span class="built_in">string</span>((<span class="built_in">std</span>::<span class="built_in">string</span> *)v8);</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span>::<span class="built_in">string</span>((<span class="built_in">std</span>::<span class="built_in">string</span> *)v10, (<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> *)input);<span class="comment">// 复制一个对象v10</span></span><br><span class="line">  base64encode2((<span class="built_in">std</span>::<span class="built_in">string</span> *)v9, (<span class="built_in">std</span>::<span class="built_in">string</span> *)v10); <span class="comment">// base64换表 两次 不同的表</span></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span>::<span class="keyword">operator</span>=((<span class="built_in">std</span>::<span class="built_in">string</span> *)input, (<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> *)v9);</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span>::~<span class="built_in">string</span>((<span class="built_in">std</span>::<span class="built_in">string</span> *)v9);</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span>::~<span class="built_in">string</span>((<span class="built_in">std</span>::<span class="built_in">string</span> *)v10);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int8)<span class="built_in">std</span>::<span class="keyword">operator</span>==&lt;<span class="keyword">char</span>&gt;(input, v4) )</span><br><span class="line">    <span class="built_in">std</span>::<span class="keyword">operator</span>&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(refptr__ZSt4cout, <span class="string">"Right."</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="keyword">operator</span>&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(refptr__ZSt4cout, <span class="string">"Wrong."</span>);</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span>::~<span class="built_in">string</span>((<span class="built_in">std</span>::<span class="built_in">string</span> *)v4);</span><br></pre></td></tr></tbody></table></figure><p>主要用到了c++ string类来进行处理，结合动调，大致经过了两次base64变表加密，在和v4进行比较。<br><strong>第一组表，</strong><br><strong>‘#$%&amp;’,27h,‘()*+,-.s0123456789:;&lt;=&gt;?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[h]’+‘^_`ab’</strong></p><p><strong>第二组表</strong><br><strong>‘ba`_^]h[ZYXWVUTSRQPONMLKJIHGFEDCBA@?&gt;=&lt;;:9876543210s.-,+*)(’,27h,‘&amp;’‘+’%$#’</strong></p><p>两次加密的代码大致相同，主要通过表的长度和每次处理的二进制长度判断为base64.</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">std</span>::<span class="built_in">bitset</span>&lt;8ull&gt;::to_string(v13, v14);     <span class="comment">// 转为2进制</span></span><br><span class="line"><span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; (<span class="keyword">unsigned</span> __int64)<span class="built_in">std</span>::<span class="built_in">string</span>::size((<span class="built_in">std</span>::<span class="built_in">string</span> *)&amp;v9); j += <span class="number">6</span> )<span class="comment">// 6个二进制一组</span></span><br><span class="line">v7 = (<span class="keyword">char</span> *)<span class="built_in">std</span>::<span class="built_in">string</span>::<span class="keyword">operator</span>[](&amp;hisoralce, v6);<span class="comment">//表索引</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> ( (<span class="built_in">std</span>::<span class="built_in">string</span>::size(a1) &amp; <span class="number">3</span>) != <span class="number">0</span> )</span><br><span class="line">  {</span><br><span class="line">    <span class="built_in">std</span>::<span class="keyword">operator</span>+&lt;<span class="keyword">char</span>&gt;(v19, a1, <span class="string">'!'</span>);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span>::<span class="keyword">operator</span>=(a1, (<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> *)v19);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span>::~<span class="built_in">string</span>((<span class="built_in">std</span>::<span class="built_in">string</span> *)v19);</span><br><span class="line">  }</span><br><span class="line"><span class="comment">//不为4的倍数就不断+!</span></span><br></pre></td></tr></tbody></table></figure><p>了解流程后写解密脚本即可</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">table1=<span class="string">'#$%&amp;'</span>+<span class="string">'\x27'</span>+<span class="string">'()*+,-.s0123456789:;&lt;=&gt;?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[h]'</span>+<span class="string">'^_`ab'</span></span><br><span class="line">table2=<span class="string">'ba`_^]h[ZYXWVUTSRQPONMLKJIHGFEDCBA@?&gt;=&lt;;:9876543210s.-,+*)('</span>+<span class="string">'\x27'</span>+<span class="string">'&amp;%$#'</span></span><br><span class="line">base=<span class="string">'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/'</span></span><br><span class="line">enc=<span class="string">'U&gt;F2UsQXN`5sXMELT=:7M_2&lt;X]^1ThaWF0=KM?9IUhAsTM5:T==_Ns&amp;&lt;Vhb!'</span></span><br><span class="line"><span class="comment">#enc='FsJ7M?b&lt;U-&gt;2M&gt;U:'#123456789测试</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">newbase</span>(<span class="params">enc,table</span>):</span></span><br><span class="line">    m=<span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(enc)):</span><br><span class="line">        <span class="keyword">if</span> enc[i] <span class="keyword">in</span> table:</span><br><span class="line">            m+=base[table.index(enc[i])]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            m+=<span class="string">'='</span></span><br><span class="line">    <span class="built_in">print</span>(base64.b64decode(m))</span><br><span class="line">    <span class="keyword">return</span> base64.b64decode(m)</span><br><span class="line">c1=newbase(enc,table2).decode()</span><br><span class="line">newbase(c1,table1)</span><br><span class="line"><span class="comment">#NCTF{H0m3_r1d1n9_h0m3_dy1n9_h0p3}</span></span><br></pre></td></tr></tbody></table></figure><h2 id="鲨鲨的秘密">鲨鲨的秘密</h2><p>32位程序,ida载入</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">IpAdress = <span class="built_in">malloc</span>(<span class="number">0x20</span>u);</span><br><span class="line"> VirtualProtect(IpAdress, <span class="number">0x20</span>u, <span class="number">0x40</span>u, &amp;flOldProtect);</span><br><span class="line"> dword_404E48 = (<span class="keyword">int</span>)IpAdress;</span><br><span class="line"> *(_BYTE *)IpAdress = <span class="number">0xC3</span>;                    <span class="comment">// ret的机器码</span></span><br><span class="line"> ((<span class="keyword">void</span> (*)(<span class="keyword">void</span>))IpAdress)</span><br></pre></td></tr></tbody></table></figure><p><strong>刚载入就有种莫名其妙的熟悉感，和西湖论剑的一道逆向题思路差不多，又是体力活。</strong><br>是一种修改代码的操作数并单语句执行的SMC，通过一个数组来确定赋值代码长度的大小，和选定相应的操作数和修改的位置。</p><p>挖出汇编代码，结合动调分析语句还原算法。</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">mov     ds:dword_403474, <span class="number">0F</span>FFFFFFFh            <span class="comment">// mov output ,0xffffffff</span></span><br><span class="line">mov     ecx, ds:dword_403464                         <span class="comment">// mov ecx,index(0) </span></span><br><span class="line">mov     dl, byte ptr ds:VirtualProtect[ecx]        <span class="comment">// mov dl,input[0]</span></span><br><span class="line">mov     byte ptr ds:dword_403470, dl             <span class="comment">// mov temp,dl</span></span><br><span class="line">movzx   eax, byte ptr ds:dword_403470         <span class="comment">//  mov eax, temp  输入传给eax</span></span><br><span class="line"><span class="keyword">xor</span>     eax, ds:dword_403474                          <span class="comment">//  xor   eax,output 取反类似</span></span><br><span class="line">mov     byte ptr ds:dword_403470, al            <span class="comment">//   mov temp , al  保存取反的值</span></span><br><span class="line">movzx   ecx, byte ptr ds:dword_403470        <span class="comment">//   mov ecx,temp </span></span><br><span class="line"><span class="keyword">and</span>     ecx, <span class="number">0F</span>Fh                                             <span class="comment">//   and  ecx,0xff</span></span><br><span class="line">mov     byte ptr ds:dword_403470, cl            <span class="comment">//   mov temp,cl</span></span><br><span class="line">mov     edx, ds:dword_403474                      <span class="comment">//    mov edx,output </span></span><br><span class="line">shr     edx,   <span class="number">8</span>                                                 <span class="comment">//    shr   edx,8</span></span><br><span class="line">mov     ds:dword_403474, edx                      <span class="comment">//    mov output,edx</span></span><br><span class="line">movzx   eax, byte ptr ds:dword_403470       <span class="comment">//    mov eax,temp</span></span><br><span class="line">mov     ecx, ds:dword_403474                         <span class="comment">//    mov ecx,output</span></span><br><span class="line"><span class="keyword">xor</span>     ecx, dword ptr ds:byte_403058[eax*<span class="number">4</span>]     <span class="comment">//  xor ecx, sbox[4*eax]   //174841BC  xor sbox[4*0x9e] 结果保存到output</span></span><br><span class="line">mov     ds:dword_403474, ecx                              </span><br><span class="line">mov     edx, ds:dword_403464                            ....</span><br><span class="line">mov     al, [edx+<span class="number">403005</span>h]</span><br><span class="line">mov     byte ptr ds:dword_403470, al</span><br><span class="line">movzx   ecx, byte ptr ds:dword_403470</span><br><span class="line"><span class="keyword">xor</span>     ecx, ds:dword_403474</span><br><span class="line">mov     byte ptr ds:dword_403470, cl</span><br><span class="line">mov     edx, ds:dword_403474</span><br><span class="line">shr     edx, <span class="number">8</span></span><br><span class="line">mov     ds:dword_403474, edx</span><br><span class="line">movzx   eax, byte ptr ds:dword_403470</span><br><span class="line">mov     ecx, ds:dword_403474</span><br><span class="line"><span class="keyword">xor</span>     ecx, dword ptr ds:byte_403058[eax*<span class="number">4</span>]     <span class="comment">//xor ecx,sbox[4*eax]  //eax 0xdd</span></span><br><span class="line">mov     ds:dword_403474, ecx            <span class="comment">//mov output,ecx</span></span><br><span class="line">mov     edx, ds:dword_403474                            <span class="comment">//mov edx,output</span></span><br><span class="line"><span class="keyword">xor</span>     edx, <span class="number">0F</span>FFFFFFFh           <span class="comment">//xor     edx, 0FFFFFFFFh</span></span><br><span class="line">mov     ds:dword_403474, edx                          <span class="comment">//mov    output edx</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>python代码如下</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">input</span>=<span class="string">'a'</span>*<span class="number">40</span></span><br><span class="line">output=<span class="number">0xffffffff</span></span><br><span class="line"><span class="keyword">for</span> index <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">40</span>,<span class="number">2</span>):</span><br><span class="line">        tmp=(<span class="built_in">ord</span>(<span class="built_in">input</span>[index])^output)&amp;<span class="number">0xff</span></span><br><span class="line">        output=output&gt;&gt;<span class="number">8</span></span><br><span class="line">        output=output^somebox[tmp]</span><br><span class="line">        <span class="comment">#print("%x %x"%(tmp,output))</span></span><br><span class="line">        tmp = (<span class="built_in">ord</span>(<span class="built_in">input</span>[index+<span class="number">1</span>]) ^ output) &amp; <span class="number">0xff</span></span><br><span class="line">        output = output &gt;&gt; <span class="number">8</span></span><br><span class="line">        output = output ^ somebox[tmp]</span><br><span class="line">        output=output^<span class="number">0xffffffff</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"%x %x"</span> % (tmp, output))</span><br></pre></td></tr></tbody></table></figure><p><strong>可知是两个字节为一组进行的处理，z3解因为涉及下标问题不好下手，z3所得中间方程REF的参数不能转换为其他类型的变量，所以直接爆破。</strong></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">somebox=[<span class="number">0x00000000</span>, <span class="number">0x77073096</span>, <span class="number">0xEE0E612C</span>, <span class="number">0x990951BA</span>, <span class="number">0x076DC419</span>, <span class="number">0x706AF48F</span>, <span class="number">0xE963A535</span>, <span class="number">0x9E6495A3</span>, <span class="number">0x0EDB8832</span>, <span class="number">0x79DCB8A4</span>, <span class="number">0xE0D5E91E</span>, <span class="number">0x97D2D988</span>, <span class="number">0x09B64C2B</span>, <span class="number">0x7EB17CBD</span>, <span class="number">0xE7B82D07</span>, <span class="number">0x90BF1D91</span>, <span class="number">0x1DB71064</span>, <span class="number">0x6AB020F2</span>, <span class="number">0xF3B97148</span>, <span class="number">0x84BE41DE</span>, <span class="number">0x1ADAD47D</span>, <span class="number">0x6DDDE4EB</span>, <span class="number">0xF4D4B551</span>, <span class="number">0x83D385C7</span>, <span class="number">0x136C9856</span>, <span class="number">0x646BA8C0</span>, <span class="number">0xFD62F97A</span>, <span class="number">0x8A65C9EC</span>, <span class="number">0x14015C4F</span>, <span class="number">0x63066CD9</span>, <span class="number">0xFA0F3D63</span>, <span class="number">0x8D080DF5</span>, <span class="number">0x3B6E20C8</span>, <span class="number">0x4C69105E</span>, <span class="number">0xD56041E4</span>, <span class="number">0xA2677172</span>, <span class="number">0x3C03E4D1</span>, <span class="number">0x4B04D447</span>, <span class="number">0xD20D85FD</span>, <span class="number">0xA50AB56B</span>, <span class="number">0x35B5A8FA</span>, <span class="number">0x42B2986C</span>, <span class="number">0xDBBBC9D6</span>, <span class="number">0xACBCF940</span>, <span class="number">0x32D86CE3</span>, <span class="number">0x45DF5C75</span>, <span class="number">0xDCD60DCF</span>, <span class="number">0xABD13D59</span>, <span class="number">0x26D930AC</span>, <span class="number">0x51DE003A</span>, <span class="number">0xC8D75180</span>, <span class="number">0xBFD06116</span>, <span class="number">0x21B4F4B5</span>, <span class="number">0x56B3C423</span>, <span class="number">0xCFBA9599</span>, <span class="number">0xB8BDA50F</span>, <span class="number">0x2802B89E</span>, <span class="number">0x5F058808</span>, <span class="number">0xC60CD9B2</span>, <span class="number">0xB10BE924</span>, <span class="number">0x2F6F7C87</span>, <span class="number">0x58684C11</span>, <span class="number">0xC1611DAB</span>, <span class="number">0xB6662D3D</span>, <span class="number">0x76DC4190</span>, <span class="number">0x01DB7106</span>, <span class="number">0x98D220BC</span>, <span class="number">0xEFD5102A</span>, <span class="number">0x71B18589</span>, <span class="number">0x06B6B51F</span>, <span class="number">0x9FBFE4A5</span>, <span class="number">0xE8B8D433</span>, <span class="number">0x7807C9A2</span>, <span class="number">0x0F00F934</span>, <span class="number">0x9609A88E</span>, <span class="number">0xE10E9818</span>, <span class="number">0x7F6A0DBB</span>, <span class="number">0x086D3D2D</span>, <span class="number">0x91646C97</span>, <span class="number">0xE6635C01</span>, <span class="number">0x6B6B51F4</span>, <span class="number">0x1C6C6162</span>, <span class="number">0x856530D8</span>, <span class="number">0xF262004E</span>, <span class="number">0x6C0695ED</span>, <span class="number">0x1B01A57B</span>, <span class="number">0x8208F4C1</span>, <span class="number">0xF50FC457</span>, <span class="number">0x65B0D9C6</span>, <span class="number">0x12B7E950</span>, <span class="number">0x8BBEB8EA</span>, <span class="number">0xFCB9887C</span>, <span class="number">0x62DD1DDF</span>, <span class="number">0x15DA2D49</span>, <span class="number">0x8CD37CF3</span>, <span class="number">0xFBD44C65</span>, <span class="number">0x4DB26158</span>, <span class="number">0x3AB551CE</span>, <span class="number">0xA3BC0074</span>, <span class="number">0xD4BB30E2</span>, <span class="number">0x4ADFA541</span>, <span class="number">0x3DD895D7</span>, <span class="number">0xA4D1C46D</span>, <span class="number">0xD3D6F4FB</span>, <span class="number">0x4369E96A</span>, <span class="number">0x346ED9FC</span>, <span class="number">0xAD678846</span>, <span class="number">0xDA60B8D0</span>, <span class="number">0x44042D73</span>, <span class="number">0x33031DE5</span>, <span class="number">0xAA0A4C5F</span>, <span class="number">0xDD0D7CC9</span>, <span class="number">0x5005713C</span>, <span class="number">0x270241AA</span>, <span class="number">0xBE0B1010</span>, <span class="number">0xC90C2086</span>, <span class="number">0x5768B525</span>, <span class="number">0x206F85B3</span>, <span class="number">0xB966D409</span>, <span class="number">0xCE61E49F</span>, <span class="number">0x5EDEF90E</span>, <span class="number">0x29D9C998</span>, <span class="number">0xB0D09822</span>, <span class="number">0xC7D7A8B4</span>, <span class="number">0x59B33D17</span>, <span class="number">0x2EB40D81</span>, <span class="number">0xB7BD5C3B</span>, <span class="number">0xC0BA6CAD</span>, <span class="number">0xEDB88320</span>, <span class="number">0x9ABFB3B6</span>, <span class="number">0x03B6E20C</span>, <span class="number">0x74B1D29A</span>, <span class="number">0xEAD54739</span>, <span class="number">0x9DD277AF</span>, <span class="number">0x04DB2615</span>, <span class="number">0x73DC1683</span>, <span class="number">0xE3630B12</span>, <span class="number">0x94643B84</span>, <span class="number">0x0D6D6A3E</span>, <span class="number">0x7A6A5AA8</span>, <span class="number">0xE40ECF0B</span>, <span class="number">0x9309FF9D</span>, <span class="number">0x0A00AE27</span>, <span class="number">0x7D079EB1</span>, <span class="number">0xF00F9344</span>, <span class="number">0x8708A3D2</span>, <span class="number">0x1E01F268</span>, <span class="number">0x6906C2FE</span>, <span class="number">0xF762575D</span>, <span class="number">0x806567CB</span>, <span class="number">0x196C3671</span>, <span class="number">0x6E6B06E7</span>, <span class="number">0xFED41B76</span>, <span class="number">0x89D32BE0</span>, <span class="number">0x10DA7A5A</span>, <span class="number">0x67DD4ACC</span>, <span class="number">0xF9B9DF6F</span>, <span class="number">0x8EBEEFF9</span>, <span class="number">0x17B7BE43</span>, <span class="number">0x60B08ED5</span>, <span class="number">0xD6D6A3E8</span>, <span class="number">0xA1D1937E</span>, <span class="number">0x38D8C2C4</span>, <span class="number">0x4FDFF252</span>, <span class="number">0xD1BB67F1</span>, <span class="number">0xA6BC5767</span>, <span class="number">0x3FB506DD</span>, <span class="number">0x48B2364B</span>, <span class="number">0xD80D2BDA</span>, <span class="number">0xAF0A1B4C</span>, <span class="number">0x36034AF6</span>, <span class="number">0x41047A60</span>, <span class="number">0xDF60EFC3</span>, <span class="number">0xA867DF55</span>, <span class="number">0x316E8EEF</span>, <span class="number">0x4669BE79</span>, <span class="number">0xCB61B38C</span>, <span class="number">0xBC66831A</span>, <span class="number">0x256FD2A0</span>, <span class="number">0x5268E236</span>, <span class="number">0xCC0C7795</span>, <span class="number">0xBB0B4703</span>, <span class="number">0x220216B9</span>, <span class="number">0x5505262F</span>, <span class="number">0xC5BA3BBE</span>, <span class="number">0xB2BD0B28</span>, <span class="number">0x2BB45A92</span>, <span class="number">0x5CB36A04</span>, <span class="number">0xC2D7FFA7</span>, <span class="number">0xB5D0CF31</span>, <span class="number">0x2CD99E8B</span>, <span class="number">0x5BDEAE1D</span>, <span class="number">0x9B64C2B0</span>, <span class="number">0xEC63F226</span>, <span class="number">0x756AA39C</span>, <span class="number">0x026D930A</span>, <span class="number">0x9C0906A9</span>, <span class="number">0xEB0E363F</span>, <span class="number">0x72076785</span>, <span class="number">0x05005713</span>, <span class="number">0x95BF4A82</span>, <span class="number">0xE2B87A14</span>, <span class="number">0x7BB12BAE</span>, <span class="number">0x0CB61B38</span>, <span class="number">0x92D28E9B</span>, <span class="number">0xE5D5BE0D</span>, <span class="number">0x7CDCEFB7</span>, <span class="number">0x0BDBDF21</span>, <span class="number">0x86D3D2D4</span>, <span class="number">0xF1D4E242</span>, <span class="number">0x68DDB3F8</span>, <span class="number">0x1FDA836E</span>, <span class="number">0x81BE16CD</span>, <span class="number">0xF6B9265B</span>, <span class="number">0x6FB077E1</span>, <span class="number">0x18B74777</span>, <span class="number">0x88085AE6</span>, <span class="number">0xFF0F6A70</span>, <span class="number">0x66063BCA</span>, <span class="number">0x11010B5C</span>, <span class="number">0x8F659EFF</span>, <span class="number">0xF862AE69</span>, <span class="number">0x616BFFD3</span>, <span class="number">0x166CCF45</span>, <span class="number">0xA00AE278</span>, <span class="number">0xD70DD2EE</span>, <span class="number">0x4E048354</span>, <span class="number">0x3903B3C2</span>, <span class="number">0xA7672661</span>, <span class="number">0xD06016F7</span>, <span class="number">0x4969474D</span>, <span class="number">0x3E6E77DB</span>, <span class="number">0xAED16A4A</span>, <span class="number">0xD9D65ADC</span>, <span class="number">0x40DF0B66</span>, <span class="number">0x37D83BF0</span>, <span class="number">0xA9BCAE53</span>, <span class="number">0xDEBB9EC5</span>, <span class="number">0x47B2CF7F</span>, <span class="number">0x30B5FFE9</span>, <span class="number">0xBDBDF21C</span>, <span class="number">0xCABAC28A</span>, <span class="number">0x53B39330</span>, <span class="number">0x24B4A3A6</span>, <span class="number">0xBAD03605</span>, <span class="number">0xCDD70693</span>, <span class="number">0x54DE5729</span>, <span class="number">0x23D967BF</span>, <span class="number">0xB3667A2E</span>, <span class="number">0xC4614AB8</span>, <span class="number">0x5D681B02</span>, <span class="number">0x2A6F2B94</span>, <span class="number">0xB40BBE37</span>, <span class="number">0xC30C8EA1</span>, <span class="number">0x5A05DF1B</span>, <span class="number">0x2D02EF8D</span>]</span><br><span class="line">enc=[<span class="number">0xC0F6605E</span>, <span class="number">0x00B16E0A</span>, <span class="number">0x3319A2D2</span>, <span class="number">0x57CAB7B7</span>, <span class="number">0x9A646D9C</span>, <span class="number">0xBDD82726</span>, <span class="number">0xD838FB91</span>, <span class="number">0x8DE10BB3</span>, <span class="number">0x176B0DAD</span>, <span class="number">0x685FDEEF</span>, <span class="number">0x2C1FF7B1</span>, <span class="number">0x6C444296</span>, <span class="number">0xA15CFE90</span>, <span class="number">0x20CD8721</span>, <span class="number">0x62967CE8</span>, <span class="number">0x2C1641FD</span>, <span class="number">0x572D0F9A</span>, <span class="number">0xAE52DC2C</span>, <span class="number">0x50497DCF</span>, <span class="number">0xFF6ABF4A</span>]</span><br><span class="line">s=<span class="string">''</span></span><br><span class="line">enc=[<span class="number">0xC0F6605E</span>, <span class="number">0x00B16E0A</span>, <span class="number">0x3319A2D2</span>, <span class="number">0x57CAB7B7</span>, <span class="number">0x9A646D9C</span>, <span class="number">0xBDD82726</span>, <span class="number">0xD838FB91</span>, <span class="number">0x8DE10BB3</span>, <span class="number">0x176B0DAD</span>, <span class="number">0x685FDEEF</span>, <span class="number">0x2C1FF7B1</span>, <span class="number">0x6C444296</span>, <span class="number">0xA15CFE90</span>, <span class="number">0x20CD8721</span>, <span class="number">0x62967CE8</span>, <span class="number">0x2C1641FD</span>, <span class="number">0x572D0F9A</span>, <span class="number">0xAE52DC2C</span>, <span class="number">0x50497DCF</span>, <span class="number">0xFF6ABF4A</span>]</span><br><span class="line"><span class="keyword">for</span> i  <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>):</span><br><span class="line">    <span class="keyword">for</span>  m <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>,<span class="number">128</span>):</span><br><span class="line">        <span class="keyword">for</span> n <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>,<span class="number">128</span>):</span><br><span class="line">            output = <span class="number">0xffffffff</span></span><br><span class="line">            tmp=(m^output)&amp;<span class="number">0xff</span></span><br><span class="line">            output=output&gt;&gt;<span class="number">8</span></span><br><span class="line">            output=output^somebox[tmp]</span><br><span class="line">            <span class="comment">#print("%x %x"%(tmp,output))</span></span><br><span class="line">            tmp = (n ^ output) &amp; <span class="number">0xff</span></span><br><span class="line">            output = output &gt;&gt; <span class="number">8</span></span><br><span class="line">            output = output ^ somebox[tmp]</span><br><span class="line">            output=output^<span class="number">0xffffffff</span></span><br><span class="line">            <span class="keyword">if</span> output==enc[i]:</span><br><span class="line">                s+=<span class="built_in">chr</span>(m)+<span class="built_in">chr</span>(n)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(s)</span><br><span class="line"><span class="comment">#NCTF{rLdE57TG0iHA39qUnFZp6LeJyYEBcxMNL7}</span></span><br></pre></td></tr></tbody></table></figure><h2 id="狗狗的秘密">狗狗的秘密</h2><p><strong>挺不错的，解完想暴打出题人。</strong><br>32位程序，ida载入获得假flag一枚<br><img src="https://bu.dusays.com/2021/12/01/811a7364f1bd8.png" alt=""><br>不过main之前有个TlsCallback函数，直接下个断点，动态分析。</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( !v9 &amp;&amp; !IsDebuggerPresent() )</span><br><span class="line">   {</span><br><span class="line">     off_825014 = (<span class="keyword">int</span> (__cdecl *)(_DWORD))sub_823000;</span><br><span class="line">     v8 = (<span class="keyword">unsigned</span> <span class="keyword">int</span> *)((<span class="keyword">char</span> *)sub_823000 + <span class="number">256</span>);</span><br><span class="line">     <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="number">24</span>; ++i )</span><br><span class="line">       v8 += <span class="number">2</span>;</span><br><span class="line">     <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; <span class="number">24</span>; ++j )</span><br><span class="line">     {</span><br><span class="line">       v8 -= <span class="number">2</span>;</span><br><span class="line">       sub_8211F0(v8);</span><br><span class="line">     }</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure><p>反调试，off_825014在主函数出现过，但是个假逻辑，所以这部分内容是SMC修改技术。</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> __cdecl <span class="title">sub_8211F0</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> *a1)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [esp+0h] [ebp-Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v3; <span class="comment">// [esp+4h] [ebp-8h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v4; <span class="comment">// [esp+8h] [ebp-4h]</span></span><br><span class="line"></span><br><span class="line">  v4 = *a1;</span><br><span class="line">  v3 = a1[<span class="number">1</span>];</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="number">64</span>; ++i )</span><br><span class="line">  {</span><br><span class="line">    v3 -= (dword_825004[(*(_DWORD *)delta &gt;&gt; <span class="number">11</span>) &amp; <span class="number">3</span>] + *(_DWORD *)delta) ^ (v4 + ((v4 &gt;&gt; <span class="number">5</span>) ^ (<span class="number">16</span> * v4)));</span><br><span class="line">    *(_DWORD *)delta += dword_825000;</span><br><span class="line">    v4 -= (dword_825004[delta[<span class="number">0</span>] &amp; <span class="number">3</span>] + *(_DWORD *)delta) ^ (v3 + ((v3 &gt;&gt; <span class="number">5</span>) ^ (<span class="number">16</span> * v3)));</span><br><span class="line">  }</span><br><span class="line">  *a1 = v4;</span><br><span class="line">  result = v3;</span><br><span class="line">  a1[<span class="number">1</span>] = v3;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><strong>直接改eip绕过这个反调试即可，同时修改代码用的xTea，不过delta的值有个小坑，main函数中有个创建线程的函数，将delta赋值为0xDA76C600，patch进行修改，后面下个断F9。</strong></p><blockquote><p>线程的执行顺序不是太清楚，不过TLSCALLBACK在main之前执行，而delta在main函数中被改掉，为什么会应用到smc中呢，有待解决。</p></blockquote><p><strong>修复函数后拿到真正处理逻辑。</strong></p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">sub_823000</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *a1)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v2; <span class="comment">// [esp+0h] [ebp-98h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v3; <span class="comment">// [esp+10h] [ebp-88h]</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v4; <span class="comment">// [esp+1Ch] [ebp-7Ch]</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// [esp+2Ch] [ebp-6Ch]</span></span><br><span class="line">  <span class="keyword">int</span> v6; <span class="comment">// [esp+2Ch] [ebp-6Ch]</span></span><br><span class="line">  <span class="keyword">char</span> v7; <span class="comment">// [esp+32h] [ebp-66h]</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> Size; <span class="comment">// [esp+34h] [ebp-64h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v9; <span class="comment">// [esp+38h] [ebp-60h]</span></span><br><span class="line">  <span class="keyword">int</span> k; <span class="comment">// [esp+38h] [ebp-60h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int8 *v11; <span class="comment">// [esp+3Ch] [ebp-5Ch]</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [esp+40h] [ebp-58h]</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> j; <span class="comment">// [esp+40h] [ebp-58h]</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> m; <span class="comment">// [esp+40h] [ebp-58h]</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> n; <span class="comment">// [esp+40h] [ebp-58h]</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> ii; <span class="comment">// [esp+40h] [ebp-58h]</span></span><br><span class="line">  <span class="keyword">char</span> v17[<span class="number">62</span>]; <span class="comment">// [esp+44h] [ebp-54h]</span></span><br><span class="line">  <span class="keyword">int</span> v18; <span class="comment">// [esp+82h] [ebp-16h]</span></span><br><span class="line">  <span class="keyword">int</span> v19; <span class="comment">// [esp+86h] [ebp-12h]</span></span><br><span class="line">  <span class="keyword">int</span> v20; <span class="comment">// [esp+8Ah] [ebp-Eh]</span></span><br><span class="line">  <span class="keyword">int</span> v21; <span class="comment">// [esp+8Eh] [ebp-Ah]</span></span><br><span class="line">  __int16 v22; <span class="comment">// [esp+92h] [ebp-6h]</span></span><br><span class="line"></span><br><span class="line">  v3 = <span class="built_in">strlen</span>(a1);</span><br><span class="line">  Size = <span class="number">146</span> * v3 / <span class="number">0x64</span> + <span class="number">1</span>;</span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  v11 = (<span class="keyword">unsigned</span> __int8 *)<span class="built_in">malloc</span>(Size);</span><br><span class="line">  v17[<span class="number">0</span>] = <span class="number">82</span>;</span><br><span class="line">  v17[<span class="number">1</span>] = <span class="number">-61</span>;</span><br><span class="line">  v17[<span class="number">2</span>] = <span class="number">26</span>;</span><br><span class="line">  v17[<span class="number">3</span>] = <span class="number">-32</span>;</span><br><span class="line">  v17[<span class="number">4</span>] = <span class="number">22</span>;</span><br><span class="line">  v17[<span class="number">5</span>] = <span class="number">93</span>;</span><br><span class="line">  v17[<span class="number">6</span>] = <span class="number">94</span>;</span><br><span class="line">  v17[<span class="number">7</span>] = <span class="number">-30</span>;</span><br><span class="line">  v17[<span class="number">8</span>] = <span class="number">103</span>;</span><br><span class="line">  v17[<span class="number">9</span>] = <span class="number">31</span>;</span><br><span class="line">  v17[<span class="number">10</span>] = <span class="number">31</span>;</span><br><span class="line">  v17[<span class="number">11</span>] = <span class="number">6</span>;</span><br><span class="line">  v17[<span class="number">12</span>] = <span class="number">6</span>;</span><br><span class="line">  v17[<span class="number">13</span>] = <span class="number">31</span>;</span><br><span class="line">  v17[<span class="number">14</span>] = <span class="number">23</span>;</span><br><span class="line">  v17[<span class="number">15</span>] = <span class="number">6</span>;</span><br><span class="line">  v17[<span class="number">16</span>] = <span class="number">15</span>;</span><br><span class="line">  v17[<span class="number">17</span>] = <span class="number">-7</span>;</span><br><span class="line">  v17[<span class="number">18</span>] = <span class="number">6</span>;</span><br><span class="line">  v17[<span class="number">19</span>] = <span class="number">103</span>;</span><br><span class="line">  v17[<span class="number">20</span>] = <span class="number">88</span>;</span><br><span class="line">  v17[<span class="number">21</span>] = <span class="number">-78</span>;</span><br><span class="line">  v17[<span class="number">22</span>] = <span class="number">-30</span>;</span><br><span class="line">  v17[<span class="number">23</span>] = <span class="number">-116</span>;</span><br><span class="line">  v17[<span class="number">24</span>] = <span class="number">15</span>;</span><br><span class="line">  v17[<span class="number">25</span>] = <span class="number">42</span>;</span><br><span class="line">  v17[<span class="number">26</span>] = <span class="number">6</span>;</span><br><span class="line">  v17[<span class="number">27</span>] = <span class="number">-119</span>;</span><br><span class="line">  v17[<span class="number">28</span>] = <span class="number">-49</span>;</span><br><span class="line">  v17[<span class="number">29</span>] = <span class="number">42</span>;</span><br><span class="line">  v17[<span class="number">30</span>] = <span class="number">6</span>;</span><br><span class="line">  v17[<span class="number">31</span>] = <span class="number">31</span>;</span><br><span class="line">  v17[<span class="number">32</span>] = <span class="number">-104</span>;</span><br><span class="line">  v17[<span class="number">33</span>] = <span class="number">26</span>;</span><br><span class="line">  v17[<span class="number">34</span>] = <span class="number">62</span>;</span><br><span class="line">  v17[<span class="number">35</span>] = <span class="number">23</span>;</span><br><span class="line">  v17[<span class="number">36</span>] = <span class="number">103</span>;</span><br><span class="line">  v17[<span class="number">37</span>] = <span class="number">31</span>;</span><br><span class="line">  v17[<span class="number">38</span>] = <span class="number">-9</span>;</span><br><span class="line">  v17[<span class="number">39</span>] = <span class="number">58</span>;</span><br><span class="line">  v17[<span class="number">40</span>] = <span class="number">68</span>;</span><br><span class="line">  v17[<span class="number">41</span>] = <span class="number">-61</span>;</span><br><span class="line">  v17[<span class="number">42</span>] = <span class="number">22</span>;</span><br><span class="line">  v17[<span class="number">43</span>] = <span class="number">51</span>;</span><br><span class="line">  v17[<span class="number">44</span>] = <span class="number">105</span>;</span><br><span class="line">  v17[<span class="number">45</span>] = <span class="number">26</span>;</span><br><span class="line">  v17[<span class="number">46</span>] = <span class="number">117</span>;</span><br><span class="line">  v17[<span class="number">47</span>] = <span class="number">22</span>;</span><br><span class="line">  v17[<span class="number">48</span>] = <span class="number">62</span>;</span><br><span class="line">  v17[<span class="number">49</span>] = <span class="number">23</span>;</span><br><span class="line">  v17[<span class="number">50</span>] = <span class="number">-43</span>;</span><br><span class="line">  v17[<span class="number">51</span>] = <span class="number">105</span>;</span><br><span class="line">  v17[<span class="number">52</span>] = <span class="number">122</span>;</span><br><span class="line">  v17[<span class="number">53</span>] = <span class="number">27</span>;</span><br><span class="line">  v17[<span class="number">54</span>] = <span class="number">68</span>;</span><br><span class="line">  v17[<span class="number">55</span>] = <span class="number">68</span>;</span><br><span class="line">  v17[<span class="number">56</span>] = <span class="number">62</span>;</span><br><span class="line">  v17[<span class="number">57</span>] = <span class="number">103</span>;</span><br><span class="line">  v17[<span class="number">58</span>] = <span class="number">-9</span>;</span><br><span class="line">  v17[<span class="number">59</span>] = <span class="number">-119</span>;</span><br><span class="line">  v17[<span class="number">60</span>] = <span class="number">103</span>;</span><br><span class="line">  v17[<span class="number">61</span>] = <span class="number">-61</span>;</span><br><span class="line">  v18 = <span class="number">0</span>;</span><br><span class="line">  v19 = <span class="number">0</span>;</span><br><span class="line">  v20 = <span class="number">0</span>;</span><br><span class="line">  v21 = <span class="number">0</span>;</span><br><span class="line">  v22 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(v11, <span class="number">0</span>, Size);</span><br><span class="line">  v9 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="number">256</span>; ++i )</span><br><span class="line">  {</span><br><span class="line">    v7 = byte_825018[i];</span><br><span class="line">    byte_825018[i] = byte_825018[(i + *((<span class="keyword">unsigned</span> __int8 *)&amp;delta + i % <span class="number">4</span>)) % <span class="number">256</span>];<span class="comment">// delta变为0了</span></span><br><span class="line">    byte_825018[(i + *((<span class="keyword">unsigned</span> __int8 *)&amp;delta + i % <span class="number">4</span>)) % <span class="number">256</span>] = v7;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">while</span> ( v9 &lt; <span class="built_in">strlen</span>(a1) )</span><br><span class="line">  {</span><br><span class="line">    v5 = a1[v9];</span><br><span class="line">    <span class="keyword">for</span> ( j = <span class="number">146</span> * v3 / <span class="number">0x64</span>; ; --j )</span><br><span class="line">    {</span><br><span class="line">      v6 = v5 + (v11[j] &lt;&lt; <span class="number">8</span>);</span><br><span class="line">      v11[j] = v6 % <span class="number">47</span>;</span><br><span class="line">      v5 = v6 / <span class="number">47</span>;</span><br><span class="line">      <span class="keyword">if</span> ( j &lt; v4 )</span><br><span class="line">        v4 = j;</span><br><span class="line">      <span class="keyword">if</span> ( !v5 &amp;&amp; j &lt;= v4 )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    }</span><br><span class="line">    ++v9;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">for</span> ( k = <span class="number">0</span>; !v11[k]; ++k )</span><br><span class="line">    ;</span><br><span class="line">  <span class="keyword">for</span> ( m = <span class="number">0</span>; m &lt; Size; ++m )</span><br><span class="line">    v11[m] = byte_825118[v11[k++]];             <span class="comment">// 单表替换</span></span><br><span class="line">  <span class="keyword">while</span> ( m &lt; Size )</span><br><span class="line">    v11[m++] = <span class="number">0</span>;</span><br><span class="line">  v2 = <span class="built_in">strlen</span>((<span class="keyword">const</span> <span class="keyword">char</span> *)v11);</span><br><span class="line">  <span class="keyword">for</span> ( n = <span class="number">0</span>; n &lt; v2; ++n )</span><br><span class="line">    v11[n] ^= byte_825018[v11[n]];              <span class="comment">// 异或处理</span></span><br><span class="line">  <span class="keyword">for</span> ( ii = <span class="number">0</span>; ii &lt; v2; ++ii )</span><br><span class="line">  {</span><br><span class="line">    <span class="keyword">if</span> ( v11[ii] != (<span class="keyword">unsigned</span> __int8)v17[ii] )</span><br><span class="line">    {</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"Wrong!\n"</span>, v2);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Right!\n"</span>, v2);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><strong>delta的值是0，需要注意一下，接着就是写脚本逆向，z3不好直接求解，加密流程是先将输入转为47进制下每位的值存在数组v11中，找到第一个非0值的下标k，接着进行单表替换和异或。</strong></p><blockquote><p>又是一个z3直接出，却被ban了的题，类型转换有点坑</p></blockquote><p><strong>因为涉及到表索引和本身异或不好逆向还原，所以想着先爆破v11数组。</strong></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">enc=[<span class="number">0x52</span>, <span class="number">0xC3</span>, <span class="number">0x1A</span>, <span class="number">0xE0</span>, <span class="number">0x16</span>, <span class="number">0x5D</span>, <span class="number">0x5E</span>, <span class="number">0xE2</span>, <span class="number">0x67</span>, <span class="number">0x1F</span>, <span class="number">0x1F</span>, <span class="number">0x06</span>, <span class="number">0x06</span>, <span class="number">0x1F</span>, <span class="number">0x17</span>, <span class="number">0x06</span>, <span class="number">0x0F</span>, <span class="number">0xF9</span>, <span class="number">0x06</span>, <span class="number">0x67</span>, <span class="number">0x58</span>, <span class="number">0xB2</span>, <span class="number">0xE2</span>, <span class="number">0x8C</span>, <span class="number">0x0F</span>, <span class="number">0x2A</span>, <span class="number">0x06</span>, <span class="number">0x89</span>, <span class="number">0xCF</span>, <span class="number">0x2A</span>, <span class="number">0x06</span>, <span class="number">0x1F</span>, <span class="number">0x98</span>, <span class="number">0x1A</span>, <span class="number">0x3E</span>, <span class="number">0x17</span>, <span class="number">0x67</span>, <span class="number">0x1F</span>, <span class="number">0xF7</span>, <span class="number">0x3A</span>, <span class="number">0x44</span>, <span class="number">0xC3</span>, <span class="number">0x16</span>, <span class="number">0x33</span>, <span class="number">0x69</span>, <span class="number">0x1A</span>, <span class="number">0x75</span>, <span class="number">0x16</span>, <span class="number">0x3E</span>, <span class="number">0x17</span>, <span class="number">0xD5</span>, <span class="number">0x69</span>, <span class="number">0x7A</span>, <span class="number">0x1B</span>, <span class="number">0x44</span>, <span class="number">0x44</span>, <span class="number">0x3E</span>, <span class="number">0x67</span>, <span class="number">0xF7</span>, <span class="number">0x89</span>, <span class="number">0x67</span>, <span class="number">0xC3</span>]</span><br><span class="line">c=[]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">61</span>):</span><br><span class="line">    temp=[]</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">47</span>):</span><br><span class="line">        tmp=tb2[j]</span><br><span class="line">        tmp=tmp^table[tmp]</span><br><span class="line">        <span class="keyword">if</span> tmp==enc[i]:</span><br><span class="line">            temp.append(j)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(temp)==<span class="number">1</span>:</span><br><span class="line">        c.append(temp[<span class="number">0</span>])</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        c.append(temp)</span><br><span class="line">c.insert(<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#[0, 2, 0, [33, 45], 44, 30, 40, 8, 23, [7, 11, 22], [34, 37], [34, 37], [19, 20, 43], [19, 20, 43], [34, 37], 24, [19, 20, 43], [4, 31], 29, [19, 20, 43], [7, 11, 22], 13, 5, 23, 41, [4, 31], 35, [19, 20, 43], 9, 14, 35, [19, 20, 43], [34, 37], 3, [33, 45], 10, 24, [7, 11, 22], [34, 37], 38, 1, 25, 0, 30, 6, 42, [33, 45], 36, 30, 10, 24, 21, 42, 26, 28, 25, 25, 10, [7, 11, 22], 38, 9, [7, 11, 22]]</span></span><br></pre></td></tr></tbody></table></figure><p><strong>v11第一位是0，根据加密的最后一位是0xc3，或者多次测试都可知，不过这解有点多，下面就是对c进行排列组合，之后47进制转，long_to_bytes下即可，不过这…tmd，dfs不太会写，直接硬爆破了，大概跑了半小时,直接整emo了。</strong></p><blockquote><p>跑起来才意识到从高位开始爆破会比较快，高位对转字符的影响较大，傻了</p></blockquote><p>完整如下</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dododo</span>(<span class="params">c</span>):</span></span><br><span class="line">    <span class="built_in">sum</span> = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">62</span>):</span><br><span class="line">        <span class="built_in">sum</span> += c[i] * <span class="built_in">pow</span>(<span class="number">47</span>, <span class="number">61</span> - i)</span><br><span class="line">    m=long_to_bytes(<span class="built_in">sum</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        flag=m.decode()</span><br><span class="line">        <span class="built_in">print</span>(flag)</span><br><span class="line">        exit(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">enc=[<span class="number">0x52</span>, <span class="number">0xC3</span>, <span class="number">0x1A</span>, <span class="number">0xE0</span>, <span class="number">0x16</span>, <span class="number">0x5D</span>, <span class="number">0x5E</span>, <span class="number">0xE2</span>, <span class="number">0x67</span>, <span class="number">0x1F</span>, <span class="number">0x1F</span>, <span class="number">0x06</span>, <span class="number">0x06</span>, <span class="number">0x1F</span>, <span class="number">0x17</span>, <span class="number">0x06</span>, <span class="number">0x0F</span>, <span class="number">0xF9</span>, <span class="number">0x06</span>, <span class="number">0x67</span>, <span class="number">0x58</span>, <span class="number">0xB2</span>, <span class="number">0xE2</span>, <span class="number">0x8C</span>, <span class="number">0x0F</span>, <span class="number">0x2A</span>, <span class="number">0x06</span>, <span class="number">0x89</span>, <span class="number">0xCF</span>, <span class="number">0x2A</span>, <span class="number">0x06</span>, <span class="number">0x1F</span>, <span class="number">0x98</span>, <span class="number">0x1A</span>, <span class="number">0x3E</span>, <span class="number">0x17</span>, <span class="number">0x67</span>, <span class="number">0x1F</span>, <span class="number">0xF7</span>, <span class="number">0x3A</span>, <span class="number">0x44</span>, <span class="number">0xC3</span>, <span class="number">0x16</span>, <span class="number">0x33</span>, <span class="number">0x69</span>, <span class="number">0x1A</span>, <span class="number">0x75</span>, <span class="number">0x16</span>, <span class="number">0x3E</span>, <span class="number">0x17</span>, <span class="number">0xD5</span>, <span class="number">0x69</span>, <span class="number">0x7A</span>, <span class="number">0x1B</span>, <span class="number">0x44</span>, <span class="number">0x44</span>, <span class="number">0x3E</span>, <span class="number">0x67</span>, <span class="number">0xF7</span>, <span class="number">0x89</span>, <span class="number">0x67</span>, <span class="number">0xC3</span>]</span><br><span class="line">table=[<span class="number">0x21</span>, <span class="number">0x43</span>, <span class="number">0x65</span>, <span class="number">0x87</span>, <span class="number">0x09</span>, <span class="number">0x21</span>, <span class="number">0x43</span>, <span class="number">0x65</span>, <span class="number">0xA2</span>, <span class="number">0x9B</span>, <span class="number">0xF4</span>, <span class="number">0xDF</span>, <span class="number">0xAC</span>, <span class="number">0x7C</span>, <span class="number">0xA1</span>, <span class="number">0xC6</span>, <span class="number">0x16</span>, <span class="number">0xD0</span>, <span class="number">0x0F</span>, <span class="number">0xDD</span>, <span class="number">0xDC</span>, <span class="number">0x73</span>, <span class="number">0xC5</span>, <span class="number">0x6B</span>, <span class="number">0xD1</span>, <span class="number">0x96</span>, <span class="number">0x47</span>, <span class="number">0xC2</span>, <span class="number">0x26</span>, <span class="number">0x67</span>, <span class="number">0x4E</span>, <span class="number">0x41</span>, <span class="number">0x82</span>, <span class="number">0x20</span>, <span class="number">0x56</span>, <span class="number">0x9A</span>, <span class="number">0x6E</span>, <span class="number">0x33</span>, <span class="number">0x92</span>, <span class="number">0x88</span>, <span class="number">0x29</span>, <span class="number">0xB5</span>, <span class="number">0xB4</span>, <span class="number">0x71</span>, <span class="number">0xA9</span>, <span class="number">0xCE</span>, <span class="number">0xC3</span>, <span class="number">0x34</span>, <span class="number">0x50</span>, <span class="number">0x59</span>, <span class="number">0xBF</span>, <span class="number">0x2D</span>, <span class="number">0x57</span>, <span class="number">0x22</span>, <span class="number">0xA6</span>, <span class="number">0x30</span>, <span class="number">0x04</span>, <span class="number">0xB2</span>, <span class="number">0xCD</span>, <span class="number">0x36</span>, <span class="number">0xD5</span>, <span class="number">0x68</span>, <span class="number">0x4D</span>, <span class="number">0x5B</span>, <span class="number">0x45</span>, <span class="number">0x9E</span>, <span class="number">0x85</span>, <span class="number">0xCF</span>, <span class="number">0x9D</span>, <span class="number">0xCC</span>, <span class="number">0x61</span>, <span class="number">0x78</span>, <span class="number">0x32</span>, <span class="number">0x76</span>, <span class="number">0x31</span>, <span class="number">0xE3</span>, <span class="number">0x80</span>, <span class="number">0xAD</span>, <span class="number">0x39</span>, <span class="number">0x4F</span>, <span class="number">0xFA</span>, <span class="number">0x72</span>, <span class="number">0x83</span>, <span class="number">0x4C</span>, <span class="number">0x86</span>, <span class="number">0x60</span>, <span class="number">0xB7</span>, <span class="number">0xD7</span>, <span class="number">0x63</span>, <span class="number">0x0C</span>, <span class="number">0x44</span>, <span class="number">0x35</span>, <span class="number">0xB3</span>, <span class="number">0x7B</span>, <span class="number">0x19</span>, <span class="number">0xD4</span>, <span class="number">0x69</span>, <span class="number">0x08</span>, <span class="number">0x0B</span>, <span class="number">0x1F</span>, <span class="number">0x3D</span>, <span class="number">0x11</span>, <span class="number">0x79</span>, <span class="number">0xD3</span>, <span class="number">0xEE</span>, <span class="number">0x93</span>, <span class="number">0x42</span>, <span class="number">0xDE</span>, <span class="number">0x23</span>, <span class="number">0x3B</span>, <span class="number">0x5D</span>, <span class="number">0x8D</span>, <span class="number">0xA5</span>, <span class="number">0x77</span>, <span class="number">0x5F</span>, <span class="number">0x58</span>, <span class="number">0xDB</span>, <span class="number">0x97</span>, <span class="number">0xF6</span>, <span class="number">0x7A</span>, <span class="number">0x18</span>, <span class="number">0x52</span>, <span class="number">0x15</span>, <span class="number">0x74</span>, <span class="number">0x25</span>, <span class="number">0x62</span>, <span class="number">0x2C</span>, <span class="number">0x05</span>, <span class="number">0xE8</span>, <span class="number">0x0D</span>, <span class="number">0x98</span>, <span class="number">0x2A</span>, <span class="number">0x43</span>, <span class="number">0xE2</span>, <span class="number">0xEF</span>, <span class="number">0x48</span>, <span class="number">0x87</span>, <span class="number">0x49</span>, <span class="number">0x1C</span>, <span class="number">0xCA</span>, <span class="number">0x2B</span>, <span class="number">0xA7</span>, <span class="number">0x8A</span>, <span class="number">0x09</span>, <span class="number">0x81</span>, <span class="number">0xE7</span>, <span class="number">0x53</span>, <span class="number">0xAA</span>, <span class="number">0xFF</span>, <span class="number">0x6F</span>, <span class="number">0x8E</span>, <span class="number">0x91</span>, <span class="number">0xF1</span>, <span class="number">0xF0</span>, <span class="number">0xA4</span>, <span class="number">0x46</span>, <span class="number">0x3A</span>, <span class="number">0x7D</span>, <span class="number">0x54</span>, <span class="number">0xEB</span>, <span class="number">0x2F</span>, <span class="number">0xC1</span>, <span class="number">0xC0</span>, <span class="number">0x0E</span>, <span class="number">0xBD</span>, <span class="number">0xE1</span>, <span class="number">0x6C</span>, <span class="number">0x64</span>, <span class="number">0xBE</span>, <span class="number">0xE4</span>, <span class="number">0x02</span>, <span class="number">0x3C</span>, <span class="number">0x5A</span>, <span class="number">0xA8</span>, <span class="number">0x9F</span>, <span class="number">0x37</span>, <span class="number">0xAF</span>, <span class="number">0xA0</span>, <span class="number">0x13</span>, <span class="number">0xED</span>, <span class="number">0x1B</span>, <span class="number">0xEC</span>, <span class="number">0x8B</span>, <span class="number">0x3E</span>, <span class="number">0x7E</span>, <span class="number">0x27</span>, <span class="number">0x99</span>, <span class="number">0x75</span>, <span class="number">0xAB</span>, <span class="number">0xFE</span>, <span class="number">0xD9</span>, <span class="number">0x3F</span>, <span class="number">0xF3</span>, <span class="number">0xEA</span>, <span class="number">0x70</span>, <span class="number">0xF7</span>, <span class="number">0x95</span>, <span class="number">0xBA</span>, <span class="number">0x1D</span>, <span class="number">0x40</span>, <span class="number">0xB0</span>, <span class="number">0xF9</span>, <span class="number">0xE5</span>, <span class="number">0xF8</span>, <span class="number">0x06</span>, <span class="number">0xBC</span>, <span class="number">0xB6</span>, <span class="number">0x03</span>, <span class="number">0xC9</span>, <span class="number">0x10</span>, <span class="number">0x9C</span>, <span class="number">0x2E</span>, <span class="number">0x89</span>, <span class="number">0x5C</span>, <span class="number">0x7F</span>, <span class="number">0xB1</span>, <span class="number">0x1A</span>, <span class="number">0xD6</span>, <span class="number">0x90</span>, <span class="number">0xAE</span>, <span class="number">0xDA</span>, <span class="number">0xE6</span>, <span class="number">0x5E</span>, <span class="number">0xB9</span>, <span class="number">0x84</span>, <span class="number">0xE9</span>, <span class="number">0x55</span>, <span class="number">0xBB</span>, <span class="number">0xC7</span>, <span class="number">0x0A</span>, <span class="number">0xE0</span>, <span class="number">0x66</span>, <span class="number">0xF2</span>, <span class="number">0xD8</span>, <span class="number">0xCB</span>, <span class="number">0x00</span>, <span class="number">0x12</span>, <span class="number">0xB8</span>, <span class="number">0x17</span>, <span class="number">0x94</span>, <span class="number">0x6A</span>, <span class="number">0x4A</span>, <span class="number">0x01</span>, <span class="number">0x24</span>, <span class="number">0x14</span>, <span class="number">0x51</span>, <span class="number">0x07</span>, <span class="number">0x65</span>, <span class="number">0x21</span>, <span class="number">0xC8</span>, <span class="number">0x38</span>, <span class="number">0xFD</span>, <span class="number">0x8F</span>, <span class="number">0xC4</span>, <span class="number">0xF5</span>, <span class="number">0xFC</span>]</span><br><span class="line"><span class="comment">#delta=[0,0xc6,0x76,0xda]</span></span><br><span class="line">tb2=[<span class="number">0xA7</span>, <span class="number">0x1C</span>, <span class="number">0x7E</span>, <span class="number">0xAF</span>, <span class="number">0xD9</span>, <span class="number">0xC2</span>, <span class="number">0xC0</span>, <span class="number">0xBE</span>, <span class="number">0x1F</span>, <span class="number">0x45</span>, <span class="number">0x9A</span>, <span class="number">0x85</span>, <span class="number">0x26</span>, <span class="number">0xE3</span>, <span class="number">0x87</span>, <span class="number">0xC3</span>, <span class="number">0x21</span>, <span class="number">0xE0</span>, <span class="number">0x95</span>, <span class="number">0x10</span>, <span class="number">0x71</span>, <span class="number">0x70</span>, <span class="number">0x02</span>, <span class="number">0x75</span>, <span class="number">0x35</span>, <span class="number">0xA5</span>, <span class="number">0x1D</span>, <span class="number">0x0D</span>, <span class="number">0x2F</span>, <span class="number">0xEE</span>, <span class="number">0x25</span>, <span class="number">0x7B</span>, <span class="number">0xB5</span>, <span class="number">0x82</span>, <span class="number">0x66</span>, <span class="number">0x8D</span>, <span class="number">0xDB</span>, <span class="number">0x53</span>, <span class="number">0x3A</span>, <span class="number">0x29</span>, <span class="number">0xD4</span>, <span class="number">0x43</span>, <span class="number">0x99</span>, <span class="number">0x97</span>, <span class="number">0x9D</span>, <span class="number">0xE8</span>, <span class="number">0x49</span>, <span class="number">0x00</span>]</span><br><span class="line"></span><br><span class="line">c=[]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">61</span>):</span><br><span class="line">    temp=[]</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">47</span>):</span><br><span class="line">        tmp=tb2[j]</span><br><span class="line">        tmp=tmp^table[tmp]</span><br><span class="line">        <span class="keyword">if</span> tmp==enc[i]:</span><br><span class="line">            temp.append(j)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(temp)==<span class="number">1</span>:</span><br><span class="line">        c.append(temp[<span class="number">0</span>])</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        c.append(temp)</span><br><span class="line">c.insert(<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line"><span class="built_in">print</span>(c)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> c:</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(i,<span class="built_in">int</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(i)</span><br><span class="line">c[<span class="number">3</span>]=<span class="number">45</span></span><br><span class="line">tblen=[]</span><br><span class="line">l=<span class="number">1</span></span><br><span class="line">index=[]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(c)):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        tblen.append(<span class="built_in">len</span>(c[i]))</span><br><span class="line">        l*=<span class="built_in">len</span>(c[i])</span><br><span class="line">        index.append(i)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        tblen.append(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(tblen)</span><br><span class="line"><span class="built_in">print</span>(index)</span><br><span class="line"></span><br><span class="line"><span class="built_in">sum</span>=<span class="number">0</span></span><br><span class="line">t1=[<span class="number">7</span>, <span class="number">11</span>, <span class="number">22</span>]</span><br><span class="line">t2=[<span class="number">34</span>, <span class="number">37</span>]</span><br><span class="line">t3=[<span class="number">19</span>, <span class="number">20</span>, <span class="number">43</span>]</span><br><span class="line">t4=[<span class="number">4</span>, <span class="number">31</span>]</span><br><span class="line">t5=[<span class="number">33</span>, <span class="number">45</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>  a1 <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    c[<span class="number">9</span>]=t1[a1]</span><br><span class="line">    <span class="keyword">for</span> a2 <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">        c[<span class="number">10</span>]=t2[a2]</span><br><span class="line">        <span class="keyword">for</span> a3 <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">            c[<span class="number">11</span>]=t2[a3]</span><br><span class="line">            <span class="keyword">for</span> a4 <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">                c[<span class="number">12</span>]=t3[a4]</span><br><span class="line">                <span class="keyword">for</span> a5 <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">                    c[<span class="number">13</span>]=t3[a5]</span><br><span class="line">                    <span class="keyword">for</span> a6 <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">                        c[<span class="number">14</span>]=t2[a6]</span><br><span class="line">                        <span class="keyword">for</span> a7 <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">                            c[<span class="number">16</span>]=t3[a7]</span><br><span class="line">                            <span class="keyword">for</span> a8 <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">                                c[<span class="number">17</span>]=t4[a8]</span><br><span class="line">                                <span class="keyword">for</span> a9 <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">                                    c[<span class="number">19</span>]=t3[a9]</span><br><span class="line">                                    <span class="keyword">for</span> a10 <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">                                        c[<span class="number">20</span>]=t1[a10]</span><br><span class="line">                                        <span class="keyword">for</span> a11 <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">                                            c[<span class="number">25</span>]=t4[a11]</span><br><span class="line">                                            <span class="keyword">for</span> a12 <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">                                                c[<span class="number">27</span>]=t3[a12]</span><br><span class="line">                                                <span class="keyword">for</span> a13 <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">                                                    c[<span class="number">31</span>]=t3[a13]</span><br><span class="line">                                                    <span class="keyword">for</span> a14 <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">                                                        c[<span class="number">32</span>]=t2[a14]</span><br><span class="line">                                                        <span class="keyword">for</span> a15 <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">                                                            c[<span class="number">34</span>]=t5[a15]</span><br><span class="line">                                                            <span class="keyword">for</span> a16 <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">                                                                c[<span class="number">37</span>]=t1[a16]</span><br><span class="line">                                                                <span class="keyword">for</span> a17 <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">                                                                    c[<span class="number">38</span>]=t2[a17]</span><br><span class="line">                                                                    <span class="keyword">for</span> a18 <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">                                                                        c[<span class="number">46</span>]=t5[a18]</span><br><span class="line">                                                                        <span class="keyword">for</span> a19 <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">                                                                            c[<span class="number">58</span>]=t1[a19]</span><br><span class="line">                                                                            <span class="keyword">for</span> a20 <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">                                                                                c[<span class="number">61</span>]=t1[a20]</span><br><span class="line">                                                                                dododo(c)</span><br><span class="line"></span><br><span class="line"><span class="comment">#NCTF{ADF0E239-D911-3781-7E40-A575A19E5835}</span></span><br></pre></td></tr></tbody></table></figure><p>题感觉都挺好玩的，就是把z3 ban掉太不够意思了，自己的算法能力不是太给力。</p><hr><p><strong>总结:C++或者再复杂一点的语言还得是动调，线程的调用关系要梳理清晰还有常见算法，同时巩固了一下西湖的SMC思路。</strong></p><blockquote><p>NCTF还是差一道Android就能AK了，native层的代码看的头皮发麻，有时间要及时复现和反思，另:航哥TQQQLLL，直接给秒了</p></blockquote><p><strong>加上安洵杯，上周小比赛还是蛮多的，能学到很多东西，但还没完全复现。最近临近考试周，实验和考试比较多，要去冲刺了，估计是最近两周不会再摸了。</strong></p><blockquote><p>别贪心，我们不会什么都有，别灰心，我们也不会什么都没有。让我们像个英勇的蒙古骑士一样，拿起手中锋利的马刀，去与更强大的敌人拼杀吧！</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> CTF Memory </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>西湖论剑2021-Re</title>
      <link href="/2021/11/21/%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%912021/"/>
      <url>/2021/11/21/%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%912021/</url>
      
        <content type="html"><![CDATA[<p><strong>感悟: 收获挺大的，同时意识到自己的做题思路和方法还有所欠缺，还是要做好应对体力活的准备。</strong></p><hr><h3 id="1、ROR">1、ROR</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">  __CheckForDebuggerJustMyCode(&amp;unk_406029);</span><br><span class="line">  v6[<span class="number">0</span>] = <span class="number">128</span>;</span><br><span class="line">  v6[<span class="number">1</span>] = <span class="number">64</span>;</span><br><span class="line">  v6[<span class="number">2</span>] = <span class="number">32</span>;</span><br><span class="line">  v6[<span class="number">3</span>] = <span class="number">16</span>;</span><br><span class="line">  v6[<span class="number">4</span>] = <span class="number">8</span>;</span><br><span class="line">  v6[<span class="number">5</span>] = <span class="number">4</span>;</span><br><span class="line">  v6[<span class="number">6</span>] = <span class="number">2</span>;</span><br><span class="line">  v6[<span class="number">7</span>] = <span class="number">1</span>;</span><br><span class="line">  <span class="built_in">memset</span>(input, <span class="number">0</span>, <span class="keyword">sizeof</span>(input));</span><br><span class="line">  <span class="built_in">memset</span>(Buf2, <span class="number">0</span>, <span class="keyword">sizeof</span>(Buf2));</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Input:"</span>, v4);</span><br><span class="line">  <span class="built_in">scanf</span>(<span class="string">"%40s"</span>, (<span class="keyword">char</span>)input);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strlen</span>(input) != <span class="number">40</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="number">40</span>; i += <span class="number">8</span> )</span><br><span class="line">  {</span><br><span class="line">    <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; <span class="number">8</span>; ++j )</span><br><span class="line">    {</span><br><span class="line">      v5 = ((v6[j] &amp; input[i + <span class="number">3</span>]) &lt;&lt; (<span class="number">8</span> - (<span class="number">3</span> - j) % <span class="number">8u</span>)) | ((v6[j] &amp; (<span class="keyword">unsigned</span> <span class="keyword">int</span>)input[i + <span class="number">3</span>]) &gt;&gt; ((<span class="number">3</span> - j) % <span class="number">8u</span>)) | ((v6[j] &amp; input[i + <span class="number">2</span>]) &lt;&lt; (<span class="number">8</span> - (<span class="number">2</span> - j) % <span class="number">8u</span>)) | ((v6[j] &amp; (<span class="keyword">unsigned</span> <span class="keyword">int</span>)input[i + <span class="number">2</span>]) &gt;&gt; ((<span class="number">2</span> - j) % <span class="number">8u</span>)) | ((v6[j] &amp; input[i + <span class="number">1</span>]) &lt;&lt; (<span class="number">8</span> - (<span class="number">1</span> - j) % <span class="number">8u</span>)) | ((v6[j] &amp; (<span class="keyword">unsigned</span> <span class="keyword">int</span>)input[i + <span class="number">1</span>]) &gt;&gt; ((<span class="number">1</span> - j) % <span class="number">8u</span>)) | ((v6[j] &amp; (<span class="keyword">unsigned</span> __int8)input[i]) &lt;&lt; (<span class="number">8</span> - -j % <span class="number">8u</span>)) | ((v6[j] &amp; (<span class="keyword">unsigned</span> <span class="keyword">int</span>)input[i]) &gt;&gt; (-j % <span class="number">8u</span>));</span><br><span class="line">      Buf2[j + i] = byte_405000[(<span class="keyword">unsigned</span> __int8)(((v6[j] &amp; (<span class="keyword">unsigned</span> __int8)input[i + <span class="number">7</span>]) &lt;&lt; (<span class="number">8</span> - (<span class="number">7</span> - j) % <span class="number">8u</span>)) | ((v6[j] &amp; (<span class="keyword">unsigned</span> <span class="keyword">int</span>)input[i + <span class="number">7</span>]) &gt;&gt; ((<span class="number">7</span> - j) % <span class="number">8u</span>)) | ((v6[j] &amp; input[i + <span class="number">6</span>]) &lt;&lt; (<span class="number">8</span> - (<span class="number">6</span> - j) % <span class="number">8u</span>)) | ((v6[j] &amp; (<span class="keyword">unsigned</span> <span class="keyword">int</span>)input[i + <span class="number">6</span>]) &gt;&gt; ((<span class="number">6</span> - j) % <span class="number">8u</span>)) | ((v6[j] &amp; input[i + <span class="number">5</span>]) &lt;&lt; (<span class="number">8</span> - (<span class="number">5</span> - j) % <span class="number">8u</span>)) | ((v6[j] &amp; (<span class="keyword">unsigned</span> <span class="keyword">int</span>)input[i + <span class="number">5</span>]) &gt;&gt; ((<span class="number">5</span> - j) % <span class="number">8u</span>)) | ((v6[j] &amp; input[i + <span class="number">4</span>]) &lt;&lt; (<span class="number">8</span> - (<span class="number">4</span> - j) % <span class="number">8u</span>)) | ((v6[j] &amp; (<span class="keyword">unsigned</span> <span class="keyword">int</span>)input[i + <span class="number">4</span>]) &gt;&gt; ((<span class="number">4</span> - j) % <span class="number">8u</span>)) | v5)];</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">memcmp</span>(&amp;unk_405100, Buf2, <span class="number">0x28</span>u) )</span><br><span class="line">  {</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Wrong"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  }</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Congratulations"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"flag is DASCTF{your input}"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>主要就是对输入8个一组进行位运算，之后再进行表byte_405000的索引，看到立马想到z3，修改代码z3解密。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line">v6=[<span class="number">128</span>,<span class="number">64</span>,<span class="number">32</span>,<span class="number">16</span>,<span class="number">8</span>,<span class="number">4</span>,<span class="number">2</span>,<span class="number">1</span>]</span><br><span class="line"><span class="built_in">input</span>=[BitVec(<span class="string">'s%d'</span>%i,<span class="number">8</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">40</span>)]</span><br><span class="line">Buf2=[<span class="number">0</span>]*<span class="number">40</span></span><br><span class="line">byte_405000=[<span class="number">0x65</span>, <span class="number">0x08</span>, <span class="number">0xF7</span>, <span class="number">0x12</span>, <span class="number">0xBC</span>, <span class="number">0xC3</span>, <span class="number">0xCF</span>, <span class="number">0xB8</span>, <span class="number">0x83</span>, <span class="number">0x7B</span>, <span class="number">0x02</span>, <span class="number">0xD5</span>, <span class="number">0x34</span>, <span class="number">0xBD</span>, <span class="number">0x9F</span>, <span class="number">0x33</span>, <span class="number">0x77</span>, <span class="number">0x76</span>, <span class="number">0xD4</span>, <span class="number">0xD7</span>, <span class="number">0xEB</span>, <span class="number">0x90</span>, <span class="number">0x89</span>, <span class="number">0x5E</span>, <span class="number">0x54</span>, <span class="number">0x01</span>, <span class="number">0x7D</span>, <span class="number">0xF4</span>, <span class="number">0x11</span>, <span class="number">0xFF</span>, <span class="number">0x99</span>, <span class="number">0x49</span>, <span class="number">0xAD</span>, <span class="number">0x57</span>, <span class="number">0x46</span>, <span class="number">0x67</span>, <span class="number">0x2A</span>, <span class="number">0x9D</span>, <span class="number">0x7F</span>, <span class="number">0xD2</span>, <span class="number">0xE1</span>, <span class="number">0x21</span>, <span class="number">0x8B</span>, <span class="number">0x1D</span>, <span class="number">0x5A</span>, <span class="number">0x91</span>, <span class="number">0x38</span>, <span class="number">0x94</span>, <span class="number">0xF9</span>, <span class="number">0x0C</span>, <span class="number">0x00</span>, <span class="number">0xCA</span>, <span class="number">0xE8</span>, <span class="number">0xCB</span>, <span class="number">0x5F</span>, <span class="number">0x19</span>, <span class="number">0xF6</span>, <span class="number">0xF0</span>, <span class="number">0x3C</span>, <span class="number">0xDE</span>, <span class="number">0xDA</span>, <span class="number">0xEA</span>, <span class="number">0x9C</span>, <span class="number">0x14</span>, <span class="number">0x75</span>, <span class="number">0xA4</span>, <span class="number">0x0D</span>, <span class="number">0x25</span>, <span class="number">0x58</span>, <span class="number">0xFC</span>, <span class="number">0x44</span>, <span class="number">0x86</span>, <span class="number">0x05</span>, <span class="number">0x6B</span>, <span class="number">0x43</span>, <span class="number">0x9A</span>, <span class="number">0x6D</span>, <span class="number">0xD1</span>, <span class="number">0x63</span>, <span class="number">0x98</span>, <span class="number">0x68</span>, <span class="number">0x2D</span>, <span class="number">0x52</span>, <span class="number">0x3D</span>, <span class="number">0xDD</span>, <span class="number">0x88</span>, <span class="number">0xD6</span>, <span class="number">0xD0</span>, <span class="number">0xA2</span>, <span class="number">0xED</span>, <span class="number">0xA5</span>, <span class="number">0x3B</span>, <span class="number">0x45</span>, <span class="number">0x3E</span>, <span class="number">0xF2</span>, <span class="number">0x22</span>, <span class="number">0x06</span>, <span class="number">0xF3</span>, <span class="number">0x1A</span>, <span class="number">0xA8</span>, <span class="number">0x09</span>, <span class="number">0xDC</span>, <span class="number">0x7C</span>, <span class="number">0x4B</span>, <span class="number">0x5C</span>, <span class="number">0x1E</span>, <span class="number">0xA1</span>, <span class="number">0xB0</span>, <span class="number">0x71</span>, <span class="number">0x04</span>, <span class="number">0xE2</span>, <span class="number">0x9B</span>, <span class="number">0xB7</span>, <span class="number">0x10</span>, <span class="number">0x4E</span>, <span class="number">0x16</span>, <span class="number">0x23</span>, <span class="number">0x82</span>, <span class="number">0x56</span>, <span class="number">0xD8</span>, <span class="number">0x61</span>, <span class="number">0xB4</span>, <span class="number">0x24</span>, <span class="number">0x7E</span>, <span class="number">0x87</span>, <span class="number">0xF8</span>, <span class="number">0x0A</span>, <span class="number">0x13</span>, <span class="number">0xE3</span>, <span class="number">0xE4</span>, <span class="number">0xE6</span>, <span class="number">0x1C</span>, <span class="number">0x35</span>, <span class="number">0x2C</span>, <span class="number">0xB1</span>, <span class="number">0xEC</span>, <span class="number">0x93</span>, <span class="number">0x66</span>, <span class="number">0x03</span>, <span class="number">0xA9</span>, <span class="number">0x95</span>, <span class="number">0xBB</span>, <span class="number">0xD3</span>, <span class="number">0x51</span>, <span class="number">0x39</span>, <span class="number">0xE7</span>, <span class="number">0xC9</span>, <span class="number">0xCE</span>, <span class="number">0x29</span>, <span class="number">0x72</span>, <span class="number">0x47</span>, <span class="number">0x6C</span>, <span class="number">0x70</span>, <span class="number">0x15</span>, <span class="number">0xDF</span>, <span class="number">0xD9</span>, <span class="number">0x17</span>, <span class="number">0x74</span>, <span class="number">0x3F</span>, <span class="number">0x62</span>, <span class="number">0xCD</span>, <span class="number">0x41</span>, <span class="number">0x07</span>, <span class="number">0x73</span>, <span class="number">0x53</span>, <span class="number">0x85</span>, <span class="number">0x31</span>, <span class="number">0x8A</span>, <span class="number">0x30</span>, <span class="number">0xAA</span>, <span class="number">0xAC</span>, <span class="number">0x2E</span>, <span class="number">0xA3</span>, <span class="number">0x50</span>, <span class="number">0x7A</span>, <span class="number">0xB5</span>, <span class="number">0x8E</span>, <span class="number">0x69</span>, <span class="number">0x1F</span>, <span class="number">0x6A</span>, <span class="number">0x97</span>, <span class="number">0x55</span>, <span class="number">0x3A</span>, <span class="number">0xB2</span>, <span class="number">0x59</span>, <span class="number">0xAB</span>, <span class="number">0xE0</span>, <span class="number">0x28</span>, <span class="number">0xC0</span>, <span class="number">0xB3</span>, <span class="number">0xBE</span>, <span class="number">0xCC</span>, <span class="number">0xC6</span>, <span class="number">0x2B</span>, <span class="number">0x5B</span>, <span class="number">0x92</span>, <span class="number">0xEE</span>, <span class="number">0x60</span>, <span class="number">0x20</span>, <span class="number">0x84</span>, <span class="number">0x4D</span>, <span class="number">0x0F</span>, <span class="number">0x26</span>, <span class="number">0x4A</span>, <span class="number">0x48</span>, <span class="number">0x0B</span>, <span class="number">0x36</span>, <span class="number">0x80</span>, <span class="number">0x5D</span>, <span class="number">0x6F</span>, <span class="number">0x4C</span>, <span class="number">0xB9</span>, <span class="number">0x81</span>, <span class="number">0x96</span>, <span class="number">0x32</span>, <span class="number">0xFD</span>, <span class="number">0x40</span>, <span class="number">0x8D</span>, <span class="number">0x27</span>, <span class="number">0xC1</span>, <span class="number">0x78</span>, <span class="number">0x4F</span>, <span class="number">0x79</span>, <span class="number">0xC8</span>, <span class="number">0x0E</span>, <span class="number">0x8C</span>, <span class="number">0xE5</span>, <span class="number">0x9E</span>, <span class="number">0xAE</span>, <span class="number">0xBF</span>, <span class="number">0xEF</span>, <span class="number">0x42</span>, <span class="number">0xC5</span>, <span class="number">0xAF</span>, <span class="number">0xA0</span>, <span class="number">0xC2</span>, <span class="number">0xFA</span>, <span class="number">0xC7</span>, <span class="number">0xB6</span>, <span class="number">0xDB</span>, <span class="number">0x18</span>, <span class="number">0xC4</span>, <span class="number">0xA6</span>, <span class="number">0xFE</span>, <span class="number">0xE9</span>, <span class="number">0xF5</span>, <span class="number">0x6E</span>, <span class="number">0x64</span>, <span class="number">0x2F</span>, <span class="number">0xF1</span>, <span class="number">0x1B</span>, <span class="number">0xFB</span>, <span class="number">0xBA</span>, <span class="number">0xA7</span>, <span class="number">0x37</span>, <span class="number">0x8F</span>]</span><br><span class="line">enc=[<span class="number">0x65</span>, <span class="number">0x55</span>, <span class="number">0x24</span>, <span class="number">0x36</span>, <span class="number">0x9D</span>, <span class="number">0x71</span>, <span class="number">0xB8</span>, <span class="number">0xC8</span>, <span class="number">0x65</span>, <span class="number">0xFB</span>, <span class="number">0x87</span>, <span class="number">0x7F</span>, <span class="number">0x9A</span>, <span class="number">0x9C</span>, <span class="number">0xB1</span>, <span class="number">0xDF</span>, <span class="number">0x65</span>, <span class="number">0x8F</span>, <span class="number">0x9D</span>, <span class="number">0x39</span>, <span class="number">0x8F</span>, <span class="number">0x11</span>, <span class="number">0xF6</span>, <span class="number">0x8E</span>, <span class="number">0x65</span>, <span class="number">0x42</span>, <span class="number">0xDA</span>, <span class="number">0xB4</span>, <span class="number">0x8C</span>, <span class="number">0x39</span>, <span class="number">0xFB</span>, <span class="number">0x99</span>, <span class="number">0x65</span>, <span class="number">0x48</span>, <span class="number">0x6A</span>, <span class="number">0xCA</span>, <span class="number">0x63</span>, <span class="number">0xE7</span>, <span class="number">0xA4</span>, <span class="number">0x79</span>]</span><br><span class="line">tmp=[]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(enc)):</span><br><span class="line">    tmp.append(byte_405000.index(enc[i]))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">40</span>,<span class="number">8</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        v5 = ((v6[j] &amp; <span class="built_in">input</span>[i + <span class="number">3</span>]) &lt;&lt; (<span class="number">8</span> - (<span class="number">3</span> - j) % <span class="number">8</span>)) | ((v6[j] &amp; <span class="built_in">input</span>[i + <span class="number">3</span>]) &gt;&gt; ((<span class="number">3</span> - j) % <span class="number">8</span>)) | ((v6[j] &amp; <span class="built_in">input</span>[i + <span class="number">2</span>]) &lt;&lt; (<span class="number">8</span> - (<span class="number">2</span> - j) % <span class="number">8</span>)) | ((v6[j] &amp; <span class="built_in">input</span>[i + <span class="number">2</span>]) &gt;&gt; ((<span class="number">2</span> - j) % <span class="number">8</span>)) | ((v6[j] &amp; <span class="built_in">input</span>[i + <span class="number">1</span>]) &lt;&lt; (<span class="number">8</span> - (<span class="number">1</span> - j) % <span class="number">8</span>)) | ((v6[j] &amp; <span class="built_in">input</span>[i + <span class="number">1</span>]) &gt;&gt; ((<span class="number">1</span> - j) % <span class="number">8</span>)) | ((v6[j] &amp; <span class="built_in">input</span>[i]) &lt;&lt; (<span class="number">8</span> - -j % <span class="number">8</span>)) | ((v6[j] &amp; <span class="built_in">input</span>[i]) &gt;&gt; (-j % <span class="number">8</span>))</span><br><span class="line">        Buf2[j + i]=((((v6[j] &amp; <span class="built_in">input</span>[i + <span class="number">7</span>]) &lt;&lt; (<span class="number">8</span> - (<span class="number">7</span> - j) % <span class="number">8</span>)) | ((v6[j] &amp; <span class="built_in">input</span>[i + <span class="number">7</span>]) &gt;&gt; ((<span class="number">7</span> - j) % <span class="number">8</span>)) | ((v6[j] &amp; <span class="built_in">input</span>[i + <span class="number">6</span>]) &lt;&lt; (<span class="number">8</span> - (<span class="number">6</span> - j) % <span class="number">8</span>)) | ((v6[j] &amp; <span class="built_in">input</span>[i + <span class="number">6</span>]) &gt;&gt; ((<span class="number">6</span> - j) % <span class="number">8</span>)) | ((v6[j] &amp; <span class="built_in">input</span>[i + <span class="number">5</span>]) &lt;&lt; (<span class="number">8</span> - (<span class="number">5</span> - j) % <span class="number">8</span>)) | ((v6[j] &amp; <span class="built_in">input</span>[i + <span class="number">5</span>]) &gt;&gt; ((<span class="number">5</span> - j) % <span class="number">8</span>)) | ((v6[j] &amp; <span class="built_in">input</span>[i + <span class="number">4</span>]) &lt;&lt; (<span class="number">8</span> - (<span class="number">4</span> - j) % <span class="number">8</span>)) | ((v6[j] &amp; <span class="built_in">input</span>[i + <span class="number">4</span>]) &gt;&gt; ((<span class="number">4</span> - j) % <span class="number">8</span>)) | v5))&amp;<span class="number">0xff</span></span><br><span class="line">s=Solver()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">40</span>):</span><br><span class="line">    s.add(Buf2[i]==tmp[i])</span><br><span class="line">s.check()</span><br><span class="line"><span class="keyword">if</span> s.check():</span><br><span class="line">    m=s.model()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">40</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">chr</span>(m[<span class="built_in">input</span>[i]].as_long()),end=<span class="string">''</span>)</span><br></pre></td></tr></tbody></table></figure><p>赛后整理的时候copy一遍就过了，比赛的时候出了点问题，卡了段时间。</p><p>另一种解法就是了解程序的位运算在干什么，v6数组对应的8位二进制每一位,单拿一小段分析。</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">i=<span class="number">0</span></span><br><span class="line">j=<span class="number">0</span>~<span class="number">8</span></span><br><span class="line">v6[<span class="number">0</span>]=<span class="number">128</span>-&gt;<span class="number">0x10000000</span></span><br><span class="line">((v6[j] &amp; input[i + <span class="number">3</span>]) &lt;&lt; (<span class="number">8</span> - (<span class="number">3</span> - j) % <span class="number">8u</span>)) | ((v6[j] &amp; (<span class="keyword">unsigned</span> <span class="keyword">int</span>)input[i + <span class="number">3</span>]) &gt;&gt; ((<span class="number">3</span> - j) % <span class="number">8u</span>)) | ((v6[j] &amp; input[i + <span class="number">2</span>]) &lt;&lt; (<span class="number">8</span> - (<span class="number">2</span> - j) % <span class="number">8u</span>)) | ((v6[j] &amp; (<span class="keyword">unsigned</span> <span class="keyword">int</span>)input[i + <span class="number">2</span>]) &gt;&gt; ((<span class="number">2</span> - j) % <span class="number">8u</span>)) | ((v6[j] &amp; input[i + <span class="number">1</span>]) &lt;&lt; (<span class="number">8</span> - (<span class="number">1</span> - j) % <span class="number">8u</span>)) | ((v6[j] &amp; (<span class="keyword">unsigned</span> <span class="keyword">int</span>)input[i + <span class="number">1</span>]) &gt;&gt; ((<span class="number">1</span> - j) % <span class="number">8u</span>)) | ((v6[j] &amp; (<span class="keyword">unsigned</span> __int8)input[i]) &lt;&lt; (<span class="number">8</span> - -j % <span class="number">8u</span>)) | ((v6[j] &amp; (<span class="keyword">unsigned</span> <span class="keyword">int</span>)input[i]) &gt;&gt; (-j % <span class="number">8u</span>))</span><br><span class="line">    </span><br><span class="line"><span class="comment">/*上为char input[0~3]  分别与上v6[j]取出最高位，因为第二步限定(unsigned __int8)类型，所以只看右移，左移都舍去了</span></span><br><span class="line"><span class="comment">input 0   intput 1  input2  input3</span></span><br><span class="line"><span class="comment">高位  a0000000  b0000000  c0000000  d0000000</span></span><br><span class="line"><span class="comment">input3 右移3  input2 右移2  input 1 右移1 ..</span></span><br><span class="line"><span class="comment">变成 abcd0000</span></span><br><span class="line"><span class="comment">后半段也类似 加上input4~7 假设7为x0000000则 最后变为abcd...x</span></span><br><span class="line"><span class="comment">也就是8个一组 对应位的二进制重新组合按照顺序做到右放0-7的对应位</span></span><br><span class="line"><span class="comment">逆过程，通过enc在table中的索引转换为8个二进制，之后8个一组，重组即可。</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></tbody></table></figure><p>exp:</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line">v6=[<span class="number">128</span>,<span class="number">64</span>,<span class="number">32</span>,<span class="number">16</span>,<span class="number">8</span>,<span class="number">4</span>,<span class="number">2</span>,<span class="number">1</span>]</span><br><span class="line">Buf2=[<span class="number">0</span>]*<span class="number">40</span></span><br><span class="line">byte_405000=[<span class="number">0x65</span>, <span class="number">0x08</span>, <span class="number">0xF7</span>, <span class="number">0x12</span>, <span class="number">0xBC</span>, <span class="number">0xC3</span>, <span class="number">0xCF</span>, <span class="number">0xB8</span>, <span class="number">0x83</span>, <span class="number">0x7B</span>, <span class="number">0x02</span>, <span class="number">0xD5</span>, <span class="number">0x34</span>, <span class="number">0xBD</span>, <span class="number">0x9F</span>, <span class="number">0x33</span>, <span class="number">0x77</span>, <span class="number">0x76</span>, <span class="number">0xD4</span>, <span class="number">0xD7</span>, <span class="number">0xEB</span>, <span class="number">0x90</span>, <span class="number">0x89</span>, <span class="number">0x5E</span>, <span class="number">0x54</span>, <span class="number">0x01</span>, <span class="number">0x7D</span>, <span class="number">0xF4</span>, <span class="number">0x11</span>, <span class="number">0xFF</span>, <span class="number">0x99</span>, <span class="number">0x49</span>, <span class="number">0xAD</span>, <span class="number">0x57</span>, <span class="number">0x46</span>, <span class="number">0x67</span>, <span class="number">0x2A</span>, <span class="number">0x9D</span>, <span class="number">0x7F</span>, <span class="number">0xD2</span>, <span class="number">0xE1</span>, <span class="number">0x21</span>, <span class="number">0x8B</span>, <span class="number">0x1D</span>, <span class="number">0x5A</span>, <span class="number">0x91</span>, <span class="number">0x38</span>, <span class="number">0x94</span>, <span class="number">0xF9</span>, <span class="number">0x0C</span>, <span class="number">0x00</span>, <span class="number">0xCA</span>, <span class="number">0xE8</span>, <span class="number">0xCB</span>, <span class="number">0x5F</span>, <span class="number">0x19</span>, <span class="number">0xF6</span>, <span class="number">0xF0</span>, <span class="number">0x3C</span>, <span class="number">0xDE</span>, <span class="number">0xDA</span>, <span class="number">0xEA</span>, <span class="number">0x9C</span>, <span class="number">0x14</span>, <span class="number">0x75</span>, <span class="number">0xA4</span>, <span class="number">0x0D</span>, <span class="number">0x25</span>, <span class="number">0x58</span>, <span class="number">0xFC</span>, <span class="number">0x44</span>, <span class="number">0x86</span>, <span class="number">0x05</span>, <span class="number">0x6B</span>, <span class="number">0x43</span>, <span class="number">0x9A</span>, <span class="number">0x6D</span>, <span class="number">0xD1</span>, <span class="number">0x63</span>, <span class="number">0x98</span>, <span class="number">0x68</span>, <span class="number">0x2D</span>, <span class="number">0x52</span>, <span class="number">0x3D</span>, <span class="number">0xDD</span>, <span class="number">0x88</span>, <span class="number">0xD6</span>, <span class="number">0xD0</span>, <span class="number">0xA2</span>, <span class="number">0xED</span>, <span class="number">0xA5</span>, <span class="number">0x3B</span>, <span class="number">0x45</span>, <span class="number">0x3E</span>, <span class="number">0xF2</span>, <span class="number">0x22</span>, <span class="number">0x06</span>, <span class="number">0xF3</span>, <span class="number">0x1A</span>, <span class="number">0xA8</span>, <span class="number">0x09</span>, <span class="number">0xDC</span>, <span class="number">0x7C</span>, <span class="number">0x4B</span>, <span class="number">0x5C</span>, <span class="number">0x1E</span>, <span class="number">0xA1</span>, <span class="number">0xB0</span>, <span class="number">0x71</span>, <span class="number">0x04</span>, <span class="number">0xE2</span>, <span class="number">0x9B</span>, <span class="number">0xB7</span>, <span class="number">0x10</span>, <span class="number">0x4E</span>, <span class="number">0x16</span>, <span class="number">0x23</span>, <span class="number">0x82</span>, <span class="number">0x56</span>, <span class="number">0xD8</span>, <span class="number">0x61</span>, <span class="number">0xB4</span>, <span class="number">0x24</span>, <span class="number">0x7E</span>, <span class="number">0x87</span>, <span class="number">0xF8</span>, <span class="number">0x0A</span>, <span class="number">0x13</span>, <span class="number">0xE3</span>, <span class="number">0xE4</span>, <span class="number">0xE6</span>, <span class="number">0x1C</span>, <span class="number">0x35</span>, <span class="number">0x2C</span>, <span class="number">0xB1</span>, <span class="number">0xEC</span>, <span class="number">0x93</span>, <span class="number">0x66</span>, <span class="number">0x03</span>, <span class="number">0xA9</span>, <span class="number">0x95</span>, <span class="number">0xBB</span>, <span class="number">0xD3</span>, <span class="number">0x51</span>, <span class="number">0x39</span>, <span class="number">0xE7</span>, <span class="number">0xC9</span>, <span class="number">0xCE</span>, <span class="number">0x29</span>, <span class="number">0x72</span>, <span class="number">0x47</span>, <span class="number">0x6C</span>, <span class="number">0x70</span>, <span class="number">0x15</span>, <span class="number">0xDF</span>, <span class="number">0xD9</span>, <span class="number">0x17</span>, <span class="number">0x74</span>, <span class="number">0x3F</span>, <span class="number">0x62</span>, <span class="number">0xCD</span>, <span class="number">0x41</span>, <span class="number">0x07</span>, <span class="number">0x73</span>, <span class="number">0x53</span>, <span class="number">0x85</span>, <span class="number">0x31</span>, <span class="number">0x8A</span>, <span class="number">0x30</span>, <span class="number">0xAA</span>, <span class="number">0xAC</span>, <span class="number">0x2E</span>, <span class="number">0xA3</span>, <span class="number">0x50</span>, <span class="number">0x7A</span>, <span class="number">0xB5</span>, <span class="number">0x8E</span>, <span class="number">0x69</span>, <span class="number">0x1F</span>, <span class="number">0x6A</span>, <span class="number">0x97</span>, <span class="number">0x55</span>, <span class="number">0x3A</span>, <span class="number">0xB2</span>, <span class="number">0x59</span>, <span class="number">0xAB</span>, <span class="number">0xE0</span>, <span class="number">0x28</span>, <span class="number">0xC0</span>, <span class="number">0xB3</span>, <span class="number">0xBE</span>, <span class="number">0xCC</span>, <span class="number">0xC6</span>, <span class="number">0x2B</span>, <span class="number">0x5B</span>, <span class="number">0x92</span>, <span class="number">0xEE</span>, <span class="number">0x60</span>, <span class="number">0x20</span>, <span class="number">0x84</span>, <span class="number">0x4D</span>, <span class="number">0x0F</span>, <span class="number">0x26</span>, <span class="number">0x4A</span>, <span class="number">0x48</span>, <span class="number">0x0B</span>, <span class="number">0x36</span>, <span class="number">0x80</span>, <span class="number">0x5D</span>, <span class="number">0x6F</span>, <span class="number">0x4C</span>, <span class="number">0xB9</span>, <span class="number">0x81</span>, <span class="number">0x96</span>, <span class="number">0x32</span>, <span class="number">0xFD</span>, <span class="number">0x40</span>, <span class="number">0x8D</span>, <span class="number">0x27</span>, <span class="number">0xC1</span>, <span class="number">0x78</span>, <span class="number">0x4F</span>, <span class="number">0x79</span>, <span class="number">0xC8</span>, <span class="number">0x0E</span>, <span class="number">0x8C</span>, <span class="number">0xE5</span>, <span class="number">0x9E</span>, <span class="number">0xAE</span>, <span class="number">0xBF</span>, <span class="number">0xEF</span>, <span class="number">0x42</span>, <span class="number">0xC5</span>, <span class="number">0xAF</span>, <span class="number">0xA0</span>, <span class="number">0xC2</span>, <span class="number">0xFA</span>, <span class="number">0xC7</span>, <span class="number">0xB6</span>, <span class="number">0xDB</span>, <span class="number">0x18</span>, <span class="number">0xC4</span>, <span class="number">0xA6</span>, <span class="number">0xFE</span>, <span class="number">0xE9</span>, <span class="number">0xF5</span>, <span class="number">0x6E</span>, <span class="number">0x64</span>, <span class="number">0x2F</span>, <span class="number">0xF1</span>, <span class="number">0x1B</span>, <span class="number">0xFB</span>, <span class="number">0xBA</span>, <span class="number">0xA7</span>, <span class="number">0x37</span>, <span class="number">0x8F</span>]</span><br><span class="line">enc=[<span class="number">0x65</span>, <span class="number">0x55</span>, <span class="number">0x24</span>, <span class="number">0x36</span>, <span class="number">0x9D</span>, <span class="number">0x71</span>, <span class="number">0xB8</span>, <span class="number">0xC8</span>, <span class="number">0x65</span>, <span class="number">0xFB</span>, <span class="number">0x87</span>, <span class="number">0x7F</span>, <span class="number">0x9A</span>, <span class="number">0x9C</span>, <span class="number">0xB1</span>, <span class="number">0xDF</span>, <span class="number">0x65</span>, <span class="number">0x8F</span>, <span class="number">0x9D</span>, <span class="number">0x39</span>, <span class="number">0x8F</span>, <span class="number">0x11</span>, <span class="number">0xF6</span>, <span class="number">0x8E</span>, <span class="number">0x65</span>, <span class="number">0x42</span>, <span class="number">0xDA</span>, <span class="number">0xB4</span>, <span class="number">0x8C</span>, <span class="number">0x39</span>, <span class="number">0xFB</span>, <span class="number">0x99</span>, <span class="number">0x65</span>, <span class="number">0x48</span>, <span class="number">0x6A</span>, <span class="number">0xCA</span>, <span class="number">0x63</span>, <span class="number">0xE7</span>, <span class="number">0xA4</span>, <span class="number">0x79</span>]</span><br><span class="line">tmp=[]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(enc)):</span><br><span class="line">    tmp.append(<span class="built_in">bin</span>(byte_405000.index(enc[i]))[<span class="number">2</span>:].zfill(<span class="number">8</span>))</span><br><span class="line"><span class="built_in">print</span>(tmp)</span><br><span class="line">m=[<span class="string">''</span>]*<span class="number">40</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">40</span>,<span class="number">8</span>):</span><br><span class="line">    <span class="keyword">for</span> p <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):<span class="comment">#控制tmp的索引</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">            m[i+j]+=tmp[i+p][j]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> m:</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">chr</span>(<span class="built_in">int</span>(i,<span class="number">2</span>)),end=<span class="string">''</span>)</span><br><span class="line"><span class="comment">#Q5la5_3KChtem6_HYHk_NlHhNZz73aCZeK05II96</span></span><br></pre></td></tr></tbody></table></figure><p>上述两种方法都可以求逆，不过擅长使用z3来解这道题是非常迅速的，减少了代码分析量。</p><h3 id="2、TacticalArmed">2、TacticalArmed</h3><p>赛后复现，学到很多东西，基础还是⑧顶，尤其是对执行流程有修改的代码。</p><p>win逆向，有Tlscallback函数，开了一个进程，跟进进程处理函数。</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">004010</span>D6 ;   __try { <span class="comment">// __except at loc_4010F1</span></span><br><span class="line">.text:<span class="number">004010</span>D6                 mov     [ebp+ms_exc.registration.TryLevel], <span class="number">0</span></span><br><span class="line">.text:<span class="number">004010</span>DD                 <span class="keyword">int</span>     <span class="number">2</span>Dh             ; Windows NT - debugging services: eax = type</span><br><span class="line">.text:<span class="number">004010</span>DF                 nop</span><br><span class="line">.text:<span class="number">004010E0</span>                 jmp     <span class="keyword">short</span> loc_401142</span><br><span class="line">.text:<span class="number">004010E0</span> ;   } <span class="comment">// starts at 4010D6</span></span><br></pre></td></tr></tbody></table></figure><p>存在Int 2d反调试，即正常运行会引发异常而检测到调试器则继续执行，所以真正代码逻辑在异常处理中。</p><p>分析代码知是对dword_405000这个内存中赋值了4个int，一般是修改key或某个解密需要的参数。</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dword_405000 -&gt;<span class="number">7</span>CE45630h  <span class="number">58334908</span>h  <span class="number">66398867</span>h  <span class="number">0</span>C35195B1h</span><br><span class="line"><span class="comment">//retn 指令</span></span><br><span class="line">retn <span class="number">4</span> -&gt; pop eip  add esp,<span class="number">4</span></span><br></pre></td></tr></tbody></table></figure><p>之后主函数内用到了一个函数指针v21,来表示lpadress的函数。</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">  lpAdress = <span class="built_in">malloc</span>(<span class="number">0x10</span>u);</span><br><span class="line">  VirtualProtect(lpAdress, <span class="number">0x10</span>u, <span class="number">0x40</span>u, &amp;flOldProtect);</span><br><span class="line">  v21 = (__int64 (__fastcall *)(<span class="keyword">int</span>, _DWORD))lpAdress;</span><br><span class="line"></span><br><span class="line"><span class="comment">//函数指针</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">Func</span><span class="params">(<span class="keyword">int</span> x)</span></span>;   <span class="comment">/*声明一个函数*/</span></span><br><span class="line">    <span class="keyword">int</span> (*p) (<span class="keyword">int</span>);  <span class="comment">/*定义一个函数指针*/</span></span><br><span class="line">    p = Func;          <span class="comment">/*将Func函数的首地址赋给指针变量p*/</span></span><br><span class="line">p(<span class="number">1</span>) 等价 Func(<span class="number">1</span>)  </span><br></pre></td></tr></tbody></table></figure><p>整体main函数如下</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">lpAdress = <span class="built_in">malloc</span>(<span class="number">0x10</span>u);</span><br><span class="line">VirtualProtect(lpAdress, <span class="number">0x10</span>u, <span class="number">0x40</span>u, &amp;flOldProtect);</span><br><span class="line">v21 = (__int64 (__fastcall *)(<span class="keyword">int</span>, _DWORD))lpAdress;</span><br><span class="line">Src = (<span class="keyword">char</span> *)&amp;loc_405010;                    <span class="comment">// 指向一个神秘的数串 类似opcode</span></span><br><span class="line">Size = <span class="number">0</span>;</span><br><span class="line">v18 = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Input flag here:"</span>, v13);</span><br><span class="line"><span class="built_in">scanf</span>(<span class="string">"%255s"</span>, (<span class="keyword">char</span>)Str);</span><br><span class="line">v17 = <span class="built_in">strlen</span>(Str) &gt;&gt; <span class="number">3</span>;                       <span class="comment">// size_t是unsigned int 的一个宏定义 主要用来计数</span></span><br><span class="line">a3 = <span class="number">0</span>;</span><br><span class="line">v15 = <span class="number">0</span>;</span><br><span class="line">a2 = <span class="number">0</span>;</span><br><span class="line">v12 = v4;</span><br><span class="line">HIDWORD(v11) = v3;</span><br><span class="line">v5 = __readeflags();</span><br><span class="line">v10 = v5;</span><br><span class="line"><span class="keyword">while</span> ( <span class="number">1</span> )                                   <span class="comment">// v15循环33次 分清</span></span><br><span class="line">{</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )                                 </span><br><span class="line">  {</span><br><span class="line">    <span class="keyword">while</span> ( Size )</span><br><span class="line">    {</span><br><span class="line">      <span class="built_in">memset</span>(lpAdress, <span class="number">0</span>, <span class="number">0x10</span>u);             <span class="comment">// 清0</span></span><br><span class="line">      <span class="built_in">memcpy</span>(lpAdress, Src, Size);            <span class="comment">// 把src处指向的代码 赋值过去</span></span><br><span class="line">      dispatch((<span class="keyword">int</span>)lpAdress, a2, a3);</span><br><span class="line">      *((_BYTE *)lpAdress + Size) = <span class="number">0xC3</span>;     <span class="comment">// ret的机器码是0xc3</span></span><br><span class="line">      __writeeflags(v10);</span><br><span class="line">      v6 = v21(v12, HIDWORD(v11));</span><br><span class="line">      v12 = v7;</span><br><span class="line">      v11 = v6;</span><br><span class="line">      v8 = __readeflags();</span><br><span class="line">      v10 = v8;</span><br><span class="line">      ++a2;</span><br><span class="line">      Src += <span class="number">16</span>;</span><br><span class="line">      Size = unk_405220[v18++];               <span class="comment">// 读取opcode的大小 控制里面的代码执行</span></span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> ( v15 == <span class="number">33</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    ++v15;</span><br><span class="line">    a2 = <span class="number">0</span>;</span><br><span class="line">    Src = (<span class="keyword">char</span> *)&amp;loc_405010;</span><br><span class="line">    Size = unk_405220[<span class="number">0</span>];                     <span class="comment">// 6</span></span><br><span class="line">    v18 = <span class="number">1</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">if</span> ( ++a3 == v17 )                          <span class="comment">// v17是输入长度//8  输入8个一组</span></span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  v15 = <span class="number">0</span>;</span><br><span class="line">  Size = <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"><span class="keyword">if</span> ( <span class="built_in">memcmp</span>(Str, dword_40532C, <span class="number">40u</span>) )</span><br><span class="line">{</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Wrong"</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">}</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"Congratulations"</span>);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"flag is DASCTF{your input}"</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br></pre></td></tr></tbody></table></figure><p>主要步骤是是while(size)里的循环，主要是代码的执行。</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">*((_BYTE *)lpAdress + Size) = <span class="number">0xC3</span>;</span><br><span class="line">是对每个语句末写上ret语句，用于返回。</span><br><span class="line">之后通过v21来调用，在调用前还有一个针对opcode的smc</span><br></pre></td></tr></tbody></table></figure><p>用switch case语句来进行不同变量的分发，比较新颖。</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __cdecl <span class="title">dispatch</span><span class="params">(<span class="keyword">int</span> a1, <span class="keyword">int</span> a2, <span class="keyword">int</span> a3)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v3; <span class="comment">// [esp+Ch] [ebp-50h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v4; <span class="comment">// [esp+50h] [ebp-Ch]</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [esp+58h] [ebp-4h]</span></span><br><span class="line"></span><br><span class="line">  __CheckForDebuggerJustMyCode(&amp;unk_406015);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; *(_BYTE *)(i + a1); ++i )        <span class="comment">// 一直找opcode为0的地方停</span></span><br><span class="line">    ;</span><br><span class="line">  v4 = dword_4052A8[a2] % <span class="number">0x10</span>u;</span><br><span class="line">  v3 = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)dword_4052A8[a2] &gt;&gt; <span class="number">4</span>;     <span class="comment">// 16进制数的高位和低位 16进制模式</span></span><br><span class="line">  <span class="keyword">switch</span> ( v3 )</span><br><span class="line">  {</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1u</span>:</span><br><span class="line">      *(_DWORD *)(i + a1) = <span class="number">4</span> * (v4 + <span class="number">2</span> * a3) + <span class="number">0x405648</span>;<span class="comment">// input a3是8个一组 依次越过8个字节</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2u</span>:</span><br><span class="line">      *(_DWORD *)(i + a1) = <span class="number">4</span> * v4 + <span class="number">0x405000</span>;  <span class="comment">// key</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">3u</span>:</span><br><span class="line">      *(_DWORD *)(i + a1) = &amp;unk_405748;        <span class="comment">// sum 看汇编得出 </span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>case语句的左侧是一个int的指针，所以右侧是一个地址，可以跳转到0x405648和0x405000，发现一个是输入的首地址，一个这是在Tlscallback中被修改过的int数据组的地址，还有一个&amp;unk_405748，没有其他的交叉引用所以初始默认为0，(全局变量)。</p><p>而switch 和 case中用到的索引在dword_4052A8这个数组中，16进制高位为case索引，低位为寻址的下标。</p><p><strong>综上，流程就是把src处的代码依次cpy到lpadress中，通过dispatch来修改操作数的值(操作数也是写入机器码中的)，之后依次执行。这片代码通过v15控制一共执行33次，同时根据输入进行8个一组分组再循环上述操作。</strong></p><p>Src = (char *)&amp;loc_405010;    src每次+16执行</p><p><img src="https://res.cloudinary.com/lu1u/image/upload/v1637546895/blog_img/%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91/x_wxkqn4.png" alt=""></p><p>mov操作后面都是00，所以需要dispatch来赋值。</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">8B</span> <span class="number">0</span>D <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>                 mov     ecx, large ds:<span class="number">0</span></span><br><span class="line"><span class="number">81</span> E9 D2 <span class="number">96</span> <span class="number">5</span>A <span class="number">7</span>E                 sub     ecx, <span class="number">7E5</span>A96D2h  </span><br><span class="line"><span class="number">89</span> <span class="number">0</span>D <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>                 mov     large ds:<span class="number">0</span>, ecx</span><br><span class="line"><span class="number">8B</span> <span class="number">15</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>                 mov     edx, large ds:<span class="number">0</span></span><br><span class="line">C1 EA <span class="number">05</span>                          shr     edx, <span class="number">5</span></span><br><span class="line">A1 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>                    mov     eax, large ds:<span class="number">0</span></span><br><span class="line"><span class="number">03</span> C2                             add     eax, edx</span><br><span class="line"><span class="number">8B</span> <span class="number">0</span>D <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>                 mov     ecx, large ds:<span class="number">0</span></span><br><span class="line"><span class="number">03</span> <span class="number">0</span>D <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>                 add     ecx, large ds:<span class="number">0</span></span><br><span class="line"><span class="number">33</span> C1                             <span class="keyword">xor</span>     eax, ecx</span><br><span class="line"><span class="number">8B</span> <span class="number">15</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>                 mov     edx, large ds:<span class="number">0</span></span><br><span class="line">C1 E2 <span class="number">04</span>                          shl     edx, <span class="number">4</span></span><br><span class="line"><span class="number">8B</span> <span class="number">0</span>D <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>                 mov     ecx, large ds:<span class="number">0</span></span><br><span class="line"><span class="number">03</span> CA                             add     ecx, edx</span><br><span class="line"><span class="number">33</span> C1                             <span class="keyword">xor</span>     eax, ecx</span><br><span class="line"><span class="number">8B</span> <span class="number">15</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>                 mov     edx, large ds:<span class="number">0</span></span><br><span class="line"><span class="number">03</span> D0                             add     edx, eax</span><br><span class="line"><span class="number">89</span> <span class="number">15</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>                 mov     large ds:<span class="number">0</span>, edx</span><br><span class="line">A1 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>                    mov     eax, large ds:<span class="number">0</span></span><br><span class="line">C1 E8 <span class="number">05</span>                          shr     eax, <span class="number">5</span>    </span><br><span class="line"><span class="number">8B</span> <span class="number">0</span>D <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>                 mov     ecx, large ds:<span class="number">0</span>  </span><br><span class="line"><span class="number">03</span> C8                             add     ecx, eax</span><br><span class="line"><span class="number">8B</span> <span class="number">15</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>                 mov     edx, large ds:<span class="number">0</span></span><br><span class="line"><span class="number">03</span> <span class="number">15</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>                 add     edx, large ds:<span class="number">0</span>   <span class="number">33</span> CA                             <span class="keyword">xor</span>     ecx, edx</span><br><span class="line">A1 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>                    mov     eax, large ds:<span class="number">0</span></span><br><span class="line">C1 E0 <span class="number">04</span>                          shl     eax, <span class="number">4</span></span><br><span class="line"><span class="number">8B</span> <span class="number">15</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>                 mov     edx, large ds:<span class="number">0</span></span><br><span class="line"><span class="number">03</span> D0                             add     edx, eax</span><br><span class="line"><span class="number">33</span> CA                             <span class="keyword">xor</span>     ecx, edx</span><br><span class="line">A1 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>                    mov     eax, large ds:<span class="number">0</span></span><br><span class="line"><span class="number">03</span> C1                             add     eax, ecx</span><br><span class="line">A3 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>                    mov     large ds:<span class="number">0</span>, eax</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>脚本对4025A8数组处理，拿到修改操作数的流程。</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; *(_BYTE *)(i + a1); ++i )；        <span class="comment">// 一直找opcode为0的地方停</span></span><br><span class="line"></span><br><span class="line"><span class="number">3</span> <span class="number">0</span> <span class="number">3</span> <span class="number">1</span> <span class="number">0</span> <span class="number">2</span> <span class="number">0</span> <span class="number">3</span> <span class="number">1</span> <span class="number">0</span> <span class="number">1</span> <span class="number">0</span> <span class="number">2</span> <span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">0</span> <span class="number">1</span> <span class="number">1</span> <span class="number">0</span> <span class="number">2</span> <span class="number">0</span> <span class="number">3</span> <span class="number">1</span> <span class="number">0</span> <span class="number">1</span> <span class="number">0</span> <span class="number">2</span> <span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">0</span> </span><br><span class="line"><span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">0</span> <span class="number">1</span> <span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">0</span> <span class="number">1</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">3</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">2</span> <span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">0</span> </span><br><span class="line"><span class="comment">//举例</span></span><br><span class="line"> <span class="number">3</span> <span class="number">0</span> -&gt; <span class="keyword">switch</span>(<span class="number">3</span>) 也就是 把<span class="number">8</span>D <span class="number">0</span>D <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> 后<span class="number">4</span>个改成unk_405748的地址并取内容赋值给ecx</span><br><span class="line"> <span class="number">0</span> <span class="number">0</span> 无操做</span><br><span class="line"> <span class="number">1</span> <span class="number">1</span> 是取出input[<span class="number">1</span>] 右边是v4=<span class="number">1</span>   <span class="number">4</span> * (v4 + <span class="number">2</span> * a3) + <span class="number">0x405648</span></span><br><span class="line"> <span class="number">2</span> <span class="number">1</span> 是取出key[<span class="number">1</span>] <span class="comment">//大致分析后确定  </span></span><br><span class="line"> ...依次补全汇编并翻译</span><br></pre></td></tr></tbody></table></figure><p>如下:</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">mov ecx,&amp;unk_405748</span><br><span class="line"></span><br><span class="line">sum=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">sub     ecx, <span class="number">7E5</span>A96D2h</span><br><span class="line">mov &amp;unk_405748,ecx</span><br><span class="line"></span><br><span class="line">sum-=<span class="number">0x7E5A96D2</span></span><br><span class="line"></span><br><span class="line">mov  edx,input[<span class="number">1</span>]</span><br><span class="line">shr edx,<span class="number">5</span></span><br><span class="line"></span><br><span class="line">mov eax,key[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">add eax,edx <span class="comment">//2 1  0 0</span></span><br><span class="line"></span><br><span class="line">mov ecx,sum</span><br><span class="line">add ecx,input[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">xor</span> eax,ecx   <span class="comment">//(input[1]+sum)^(input[1]&gt;&gt;5 + key[1])</span></span><br><span class="line"></span><br><span class="line">mov edx, input[<span class="number">1</span>]</span><br><span class="line">shl edx,<span class="number">4</span></span><br><span class="line">mov ecx,key[<span class="number">0</span>]</span><br><span class="line">add ecx,edx</span><br><span class="line"><span class="keyword">xor</span> eax,ecx</span><br><span class="line"><span class="comment">// (input[1]&lt;&lt;4 + key[0])^(input[1]+sum)^(input[1]&gt;&gt;5 + key[1])</span></span><br><span class="line"></span><br><span class="line">mov edx ,input[<span class="number">0</span>]</span><br><span class="line">add edx,eax</span><br><span class="line"></span><br><span class="line">mov edx,input[<span class="number">0</span>] </span><br><span class="line"></span><br><span class="line"><span class="comment">//以上实现的就是 v0+=(v1&lt;&lt;4 + k0)^(v1 + sum)(v1 &gt;&gt;5 + k1)</span></span><br><span class="line">.....</span><br><span class="line"></span><br><span class="line"><span class="comment">//不过汇编中没有 mov  xxx,0 并且 对 sum 那边地址内容unk_405748 也没有别的交叉引用  也就是每组</span></span><br></pre></td></tr></tbody></table></figure><p>分析到一半就能推出是Tea加密，轮数为33 ，default为0x7E5A96D2，既然分析出&amp;unk_405748为sum，并且对他没有别的引用，所以再对密文多次加密时sum是在上一轮基础上使用的。</p><p>解密脚本:</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">tea_decode</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span>* s, <span class="keyword">unsigned</span> <span class="keyword">int</span>* key,<span class="keyword">int</span> count)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line"><span class="keyword">int</span> a = <span class="number">0xE98651DC67185A11</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> enc[] = { <span class="number">0x422F1DED</span>,<span class="number">0x1485E472</span>,<span class="number">0x35578D5</span>,<span class="number">0x0BF6B80A2</span>,<span class="number">0x97D77245</span>,<span class="number">0x2DAE75D1</span>,<span class="number">0x665FA963</span>,<span class="number">0x292E6D74</span>,<span class="number">0x9795FCC1</span>,<span class="number">0x0BB5C8E9</span>};</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> key[<span class="number">4</span>] = { <span class="number">0x7CE45630</span>,<span class="number">0x58334908</span>,<span class="number">0x66398867</span>,<span class="number">0x0C35195B1</span> };</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i+=<span class="number">2</span>)</span><br><span class="line">tea_decode(enc+i, key,i/<span class="number">2</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">tea_decode</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span>* s, <span class="keyword">unsigned</span> <span class="keyword">int</span>* key,<span class="keyword">int</span> count)</span> </span>{</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> v0 = s[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> v1 = s[<span class="number">1</span>];</span><br><span class="line"><span class="keyword">uint32_t</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> defalt = <span class="number">0x7E5A96D2</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> k0 = key[<span class="number">0</span>], k1 = key[<span class="number">1</span>], k2 = key[<span class="number">2</span>], k3 = key[<span class="number">3</span>];</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; (<span class="number">33</span>*count+<span class="number">33</span>); i++)<span class="comment">// sum状态保存到下一组</span></span><br><span class="line">sum -= defalt;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">33</span>; i++) {  </span><br><span class="line">v1 -= ((v0 &lt;&lt; <span class="number">4</span>) + k2) ^ (v0 + sum) ^ ((v0 &gt;&gt; <span class="number">5</span>) + k3);</span><br><span class="line">v0 -= ((v1 &lt;&lt; <span class="number">4</span>) + k0) ^ (v1 + sum) ^ ((v1 &gt;&gt; <span class="number">5</span>) + k1);</span><br><span class="line">sum += defalt;</span><br><span class="line">}</span><br><span class="line">s[<span class="number">0</span>] = v0;</span><br><span class="line">s[<span class="number">1</span>] = v1;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%d,%d,"</span>, v0,v1);</span><br><span class="line">}</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">a=[826566507,843212655,845236089,1097428850,1198086245,1902206776,1132088430,1181900618,1917866824,1261778286]</span></span><br><span class="line"><span class="comment">for i in a:</span></span><br><span class="line"><span class="comment">    print(int.to_bytes(i,4,'little').decode(),end='')</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></tbody></table></figure><h3 id="3、虚假的粉丝">3、虚假的粉丝</h3><p>dos界面的代码动画，有点震撼，不过题目没设计到什么算法，主要还是读流程。</p><p>首先就是找到3个key，查看strings窗口，发现第一字符串很可疑,对其交叉引用发现了一个未被调用的函数，需要重新定义一下。</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//#j#M_OEE!jmhih,=555"xtx</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sub_401379</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  <span class="keyword">char</span> Buffer[<span class="number">100</span>]; <span class="comment">// [esp+16h] [ebp-92h] BYREF</span></span><br><span class="line">  <span class="keyword">char</span> FileName[<span class="number">30</span>]; <span class="comment">// [esp+7Ah] [ebp-2Eh] BYREF</span></span><br><span class="line">  FILE *Stream; <span class="comment">// [esp+98h] [ebp-10h]</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [esp+9Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">23</span>; ++i )</span><br><span class="line">    FileName[i] = aJMOeeJmhih555X[i] ^ <span class="number">0xC</span>;</span><br><span class="line">  Stream = fopen(FileName, <span class="string">"r"</span>);</span><br><span class="line">  fread(Buffer, <span class="number">0x57</span>u, <span class="number">1u</span>, Stream);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">"%s\n"</span>, Buffer);</span><br><span class="line">}    </span><br></pre></td></tr></tbody></table></figure><p>拉出去异或一下，是在读<strong>P./f/ASCII-faded 1999P.txt</strong>这个文件，打开查看，发现key。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">K3y1: (<span class="built_in">hex</span>(<span class="built_in">ord</span>(<span class="string">'A'</span>)) + <span class="built_in">hex</span>(<span class="built_in">ord</span>(<span class="string">'W'</span>))).replace(<span class="string">"0x"</span>, <span class="string">""</span>)</span><br><span class="line">K3y2: <span class="built_in">ord</span>(<span class="string">'F'</span>) + <span class="built_in">ord</span>(<span class="string">'a'</span>) + <span class="built_in">ord</span>(<span class="string">'d'</span>) + <span class="built_in">ord</span>(<span class="string">'e'</span>) + <span class="built_in">ord</span>(<span class="string">'d'</span>) + <span class="built_in">ord</span>(<span class="string">'i'</span>) + <span class="built_in">ord</span>(<span class="string">'s'</span>) + <span class="built_in">ord</span>(<span class="string">'b'</span>) + <span class="built_in">ord</span>(<span class="string">'e'</span>) + <span class="built_in">ord</span>(<span class="string">'s'</span>) + <span class="built_in">ord</span>(<span class="string">'t'</span>)</span><br><span class="line"><span class="comment">#key3是文件读取的字节大小，根据if判断知是40</span></span><br><span class="line"><span class="keyword">if</span> ( Buffer[<span class="number">0</span>] != <span class="string">'U'</span> || Buffer[<span class="number">39</span>] != <span class="string">'S'</span> )</span><br></pre></td></tr></tbody></table></figure><p>之后它通过上述的key计算了一个新的文件，之后从中读取内容。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"UzNDcmU3X0szeSUyMCUzRCUyMEFsNE5fd0FsSzNS"</span></span><br><span class="line">base64 -&gt; url解码 -&gt; S3Cre7_K3y = Al4N_wAlK3R</span><br></pre></td></tr></tbody></table></figure><p>之后观察一个用到key的check结果的处理。</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( v24 == <span class="number">1</span> )</span><br><span class="line"> {</span><br><span class="line">   v25 = <span class="number">5317</span>;</span><br><span class="line">   Stream = fopen(<span class="string">"./f/ASCII-faded 5315.txt"</span>, <span class="string">"rb"</span>);</span><br><span class="line">   <span class="keyword">if</span> ( !Stream )</span><br><span class="line">   {</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">"ERROR!\n"</span>);</span><br><span class="line">     <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">   }</span><br><span class="line">   fread(v6, <span class="number">0x4EDE</span>u, <span class="number">1u</span>, Stream);</span><br><span class="line">   fclose(Stream);</span><br><span class="line">   v22 = <span class="number">0</span>;</span><br><span class="line">   <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">0x84E</span>; ++i )</span><br><span class="line">   {</span><br><span class="line">     <span class="keyword">if</span> ( v22 &gt; <span class="number">10</span> )</span><br><span class="line">       v22 = <span class="number">0</span>;</span><br><span class="line">     v6[i] ^= key[v22++];</span><br><span class="line">   }</span><br><span class="line">   Stream = fopen(<span class="string">"./f/ASCII-faded 5315.txt"</span>, <span class="string">"w"</span>);</span><br><span class="line">   fwrite(v6, <span class="number">0x84F</span>u, <span class="number">1u</span>, Stream);</span><br><span class="line">   fclose(Stream);</span><br><span class="line"> }</span><br></pre></td></tr></tbody></table></figure><p>对5317进行异或之后再写入，再异或一次观察内容,后面就没什么内容了，就是接着奏乐接着舞了。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">key=<span class="string">'Al4N_wAlK3R'</span></span><br><span class="line">f=<span class="built_in">open</span>(<span class="string">'ASCII-faded 5315.txt'</span>,<span class="string">'r+'</span>)</span><br><span class="line">s=f.read()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(s)):</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">chr</span>(<span class="built_in">ord</span>(s[i])^<span class="built_in">ord</span>(key[i%<span class="built_in">len</span>(key)])),end=<span class="string">''</span>)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>输入key跑起来还是挺不错的，摘掉眼镜.jpg。</p><p><img src="https://res.cloudinary.com/lu1u/image/upload/v1637550797/blog_img/%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91/1_dhb3xj.png" alt=""></p><p>A_TrUe_AW_f4ns</p><p>不过这题，静态的话就最后一个key有用，还是在文件中，并且U和S已知，直接文件搜索，也能拿到key，然后直接异或就可以了。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">5317</span>):</span><br><span class="line">    f=<span class="built_in">open</span>(<span class="string">'ASCII-faded %s.txt'</span>%<span class="built_in">str</span>(i).zfill(<span class="number">4</span>),<span class="string">'r+'</span>)</span><br><span class="line">    s=f.read()</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'U'</span><span class="keyword">in</span> s <span class="keyword">and</span> <span class="string">'S'</span> <span class="keyword">in</span> s:</span><br><span class="line">        <span class="built_in">print</span>(i)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        f.close()</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">4157 -&gt;key的文件</span></span><br><span class="line"><span class="string">5315</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></tbody></table></figure><hr><p><strong>比赛时候挺麻的，比赛快要截止才有点感觉，还有一个硬件描述语言有待复现，计组实验课用的verilog神似，关键是不会啊! 人不行别怪路不平，还得补！。</strong></p>]]></content>
      
      
      <categories>
          
          <category> CTF Memory </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CUMT-RE专项</title>
      <link href="/2021/11/11/CUMT-RE/"/>
      <url>/2021/11/11/CUMT-RE/</url>
      
        <content type="html"><![CDATA[<h1>CUMT-2021RE专项赛</h1><h3 id="1、签到">1、签到</h3><p><strong>循环左移</strong>，逆序即可</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">*((_BYTE *)Buf2 + v3) = __ROL1__(*((_BYTE *)Buf2 + v3), <span class="number">1</span>);</span><br><span class="line">++v3;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line">Buf1=[<span class="number">0</span>]*<span class="number">12</span></span><br><span class="line">Buf1[<span class="number">0</span>] = <span class="number">0xE8DAEAC6</span>;</span><br><span class="line">Buf1[<span class="number">1</span>] = <span class="number">0xF6CCE8C6</span>;</span><br><span class="line">Buf1[<span class="number">2</span>] = <span class="number">0xCA9680DA</span>;</span><br><span class="line">Buf1[<span class="number">3</span>] = <span class="number">0xECCAA4BE</span>;</span><br><span class="line">Buf1[<span class="number">4</span>] = <span class="number">0x66E6A4CA</span>;</span><br><span class="line">Buf1[<span class="number">5</span>] = <span class="number">0x72DCCABE</span>;</span><br><span class="line">Buf1[<span class="number">6</span>] = <span class="number">0x8ACA9C62</span>;</span><br><span class="line">Buf1[<span class="number">7</span>] = <span class="number">0xCEDC62A4</span>;</span><br><span class="line">Buf1[<span class="number">8</span>] = <span class="number">0x66A48EBE</span>;</span><br><span class="line">Buf1[<span class="number">9</span>] = <span class="number">0x80BE6EC2</span>;</span><br><span class="line">Buf1[<span class="number">10</span>] = <span class="number">0xDC6282CE</span>;</span><br><span class="line">Buf1[<span class="number">11</span>] = <span class="number">0xFA</span>;</span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(Buf1)):</span><br><span class="line">    a=<span class="built_in">int</span>.to_bytes(Buf1[j],<span class="number">4</span>,<span class="string">'little'</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> a:</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">chr</span>((i&gt;&gt;<span class="number">1</span>)|((i&amp;<span class="number">1</span>)&lt;&lt;<span class="number">7</span>)),end=<span class="string">''</span>)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h3 id="2、来自字节码的鼓励">2、来自字节码的鼓励</h3><p><strong>python字节码</strong>，比较短，对照官方文档很容易便能翻译出源码。</p><p><a href="https://docs.python.org/3/library/dis.html">dis — Disassembler for Python bytecode — Python 3.10.0 documentation</a></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line">n=[-<span class="number">83</span>,-<span class="number">96</span>,-<span class="number">78</span>,-<span class="number">21</span>,-<span class="number">3</span>,-<span class="number">17</span>,<span class="number">58</span>,<span class="number">31</span>,<span class="number">58</span>]</span><br><span class="line"><span class="comment">#ff=input</span></span><br><span class="line">c=<span class="string">''</span></span><br><span class="line">f=<span class="built_in">open</span>(<span class="string">'1'</span>,<span class="string">'r'</span>)</span><br><span class="line">s=f.read()</span><br><span class="line">f.close()</span><br><span class="line">f=<span class="built_in">open</span>(<span class="string">'2'</span>,<span class="string">'rb'</span>)</span><br><span class="line">b=f.read(<span class="number">9</span>)</span><br><span class="line">f.close()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(s)):</span><br><span class="line">    tmp=<span class="built_in">ord</span>(s[i])^b[i]</span><br><span class="line">    tmp=tmp+n[i]</span><br><span class="line">    c+=<span class="built_in">chr</span>(tmp)</span><br><span class="line"><span class="keyword">if</span> c==ff:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'Right! Please add cumtctf{}'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'try again'</span>)</span><br></pre></td></tr></tbody></table></figure><p>ff是输入，只在最后用到，故翻译出的字节码前部分便是flag的生成代码。</p><h3 id="3、my-cloth">3、my cloth</h3><p><strong>经典upx壳，后加三段魔改default和轮数的Tea加密。</strong></p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">  v23[<span class="number">0</span>] = <span class="number">222</span>;</span><br><span class="line">  v23[<span class="number">1</span>] = <span class="number">173</span>;</span><br><span class="line">  v23[<span class="number">2</span>] = <span class="number">190</span>;</span><br><span class="line">  v23[<span class="number">3</span>] = <span class="number">239</span>;</span><br><span class="line">  </span><br><span class="line"> v5 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">3</span>; ++i )</span><br><span class="line">    v5 = (v5 &lt;&lt; <span class="number">8</span>) + (<span class="keyword">unsigned</span> __int8)v24[i];</span><br><span class="line">  v7 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> ( j = <span class="number">4</span>; j &lt;= <span class="number">7</span>; ++j )</span><br><span class="line">    v7 = (v7 &lt;&lt; <span class="number">8</span>) + (<span class="keyword">unsigned</span> __int8)v24[j]; <span class="comment">//输入转大端</span></span><br><span class="line">  v17 = v5;</span><br><span class="line">  v18 = v7;</span><br><span class="line">  encrypt(&amp;v17, v23);</span><br><span class="line">  </span><br><span class="line"> <span class="comment">//明文相邻两四个字节进行加密，并转成大端的int型，key是固定的</span></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> *__fastcall <span class="title">encrypt</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> *result, _DWORD *a2)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v2; <span class="comment">// [sp+Ch] [bp+Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v3; <span class="comment">// [sp+10h] [bp+10h]</span></span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// [sp+14h] [bp+14h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> i; <span class="comment">// [sp+18h] [bp+18h]</span></span><br><span class="line"></span><br><span class="line">  v2 = *result;</span><br><span class="line">  v3 = result[<span class="number">1</span>];</span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">0x3F</span>; ++i )</span><br><span class="line">  {</span><br><span class="line">    v4 -= <span class="number">559038737</span>;</span><br><span class="line">    v2 += (a2[<span class="number">1</span>] + (v3 &gt;&gt; <span class="number">5</span>)) ^ (<span class="number">16</span> * v3 + *a2) ^ (v4 + v3);</span><br><span class="line">    v3 += (a2[<span class="number">3</span>] + (v2 &gt;&gt; <span class="number">5</span>)) ^ (<span class="number">16</span> * v2 + a2[<span class="number">2</span>]) ^ (v4 + v2);</span><br><span class="line">  }</span><br><span class="line">  *result = v2;</span><br><span class="line">  result[<span class="number">1</span>] = v3;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>exp:</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">tea_decode</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span>* s, <span class="keyword">unsigned</span> <span class="keyword">int</span>* key)</span> </span>{</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> v0 = s[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> v1 = s[<span class="number">1</span>];</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> defalt = <span class="number">0x21524111</span>;</span><br><span class="line"><span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= <span class="number">0x3F</span>; i++)</span><br><span class="line">sum -= defalt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> k0 = key[<span class="number">0</span>], k1 = key[<span class="number">1</span>], k2 = key[<span class="number">2</span>], k3 = key[<span class="number">3</span>];</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= <span class="number">0x3f</span>; i++) {</span><br><span class="line">v1 -= (k3 + (v0 &gt;&gt; <span class="number">5</span>)) ^ ((v0 &lt;&lt; <span class="number">4</span>) + k2) ^ (sum + v0);</span><br><span class="line">v0 -= (k1 + (v1 &gt;&gt; <span class="number">5</span>)) ^ ((v1 &lt;&lt; <span class="number">4</span>) + k0) ^ (sum + v1);</span><br><span class="line">sum += defalt;</span><br><span class="line">}</span><br><span class="line">s[<span class="number">0</span>] = v0;</span><br><span class="line">s[<span class="number">1</span>] = v1;</span><br><span class="line">cout &lt;&lt; s[<span class="number">0</span>] &lt;&lt; <span class="string">","</span> &lt;&lt; s[<span class="number">1</span>] &lt;&lt; <span class="string">","</span>;</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> key[<span class="number">4</span>] = { <span class="number">222</span>,<span class="number">173</span>,<span class="number">190</span>,<span class="number">239</span> };</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> enc[<span class="number">6</span>] = { <span class="number">0xD5AF0608</span>,<span class="number">0x361EF340</span>,<span class="number">0xB55D7042</span>,<span class="number">0xB460532B</span>,<span class="number">0xC53FB95B</span>,<span class="number">0xCC5F1002</span> };</span><br><span class="line"><span class="built_in">tea_decode</span>(enc, key);</span><br><span class="line"><span class="built_in">tea_decode</span>(enc + <span class="number">2</span>, key);</span><br><span class="line"><span class="built_in">tea_decode</span>(enc + <span class="number">4</span>, key);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"><span class="comment">/* python</span></span><br><span class="line"><span class="comment">a=[1668640116,1668572795,1382381157,1920165215,829644646,1970167677,]</span></span><br><span class="line"><span class="comment">for i in a:</span></span><br><span class="line"><span class="comment">    print(int.to_bytes(i,4,'big').decode(),end='')</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h3 id="4、weak">4、weak</h3><p><strong>花指令+数独</strong></p><p>花指令单独写了一个函数，通过修改EIP来越过垃圾代码。</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">00000000000013</span>EA junk            proc near               ; CODE XREF: .text:<span class="number">000000000000123</span>A↑p</span><br><span class="line">.text:<span class="number">00000000000013</span>EA                 pop     rax</span><br><span class="line">.text:<span class="number">00000000000013</span>EB                 add     rax, <span class="number">5</span></span><br><span class="line">.text:<span class="number">00000000000013</span>EF                 push    rax</span><br><span class="line">.text:<span class="number">00000000000013F</span>0                 retn</span><br><span class="line">.text:<span class="number">00000000000013F</span>0 junk            endp</span><br></pre></td></tr></tbody></table></figure><p>call 会push下一条指令的IP，之后对IP+5，并retn，对IP的值完成+5的操作。<br>nop掉call junk下一条指令开始的5个字节即可。</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v6; <span class="comment">// [rsp+4h] [rbp-7Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 i; <span class="comment">// [rsp+8h] [rbp-78h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 j; <span class="comment">// [rsp+10h] [rbp-70h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 k; <span class="comment">// [rsp+18h] [rbp-68h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 m; <span class="comment">// [rsp+20h] [rbp-60h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 n; <span class="comment">// [rsp+28h] [rbp-58h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 ii; <span class="comment">// [rsp+30h] [rbp-50h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 jj; <span class="comment">// [rsp+38h] [rbp-48h]</span></span><br><span class="line">  __int64 v14; <span class="comment">// [rsp+40h] [rbp-40h]</span></span><br><span class="line">  __int64 v15; <span class="comment">// [rsp+48h] [rbp-38h]</span></span><br><span class="line">  __int64 v16; <span class="comment">// [rsp+50h] [rbp-30h]</span></span><br><span class="line">  __int64 v17[<span class="number">4</span>]; <span class="comment">// [rsp+60h] [rbp-20h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v17[<span class="number">3</span>] = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v17[<span class="number">0</span>] = <span class="number">0LL</span>;</span><br><span class="line">  v17[<span class="number">1</span>] = <span class="number">0LL</span>;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"your flag?"</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">"%s"</span>, v17);</span><br><span class="line">  v6 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0LL</span>; i &lt;= <span class="number">0x23</span>; ++i )</span><br><span class="line">  {</span><br><span class="line">    <span class="keyword">if</span> ( !numbers[i] )</span><br><span class="line">      numbers[i] = *((_BYTE *)v17 + v6++) - <span class="number">48</span>;</span><br><span class="line">  }</span><br><span class="line">  junk();</span><br><span class="line">  <span class="keyword">for</span> ( j = <span class="number">0LL</span>; j &lt;= <span class="number">5</span>; ++j )</span><br><span class="line">  {</span><br><span class="line">    v14 = <span class="number">0LL</span>;</span><br><span class="line">    v15 = <span class="number">0LL</span>;</span><br><span class="line">    v16 = <span class="number">0LL</span>;</span><br><span class="line">    <span class="keyword">for</span> ( k = <span class="number">0LL</span>; k &lt;= <span class="number">5</span>; ++k )</span><br><span class="line">    {</span><br><span class="line">      v3 = numbers[<span class="number">6</span> * j + k] - <span class="number">1</span>;</span><br><span class="line">      ++*((_DWORD *)&amp;v14 + v3);<span class="comment">//要求v3 0-5 即数组每行为1-6</span></span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">for</span> ( m = <span class="number">0LL</span>; m &lt;= <span class="number">5</span>; ++m )</span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">if</span> ( *((_DWORD *)&amp;v14 + m) != <span class="number">1</span> )</span><br><span class="line">      {</span><br><span class="line">LABEL_12:</span><br><span class="line">        fail();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  junk();</span><br><span class="line">  <span class="keyword">for</span> ( n = <span class="number">0LL</span>; n &lt;= <span class="number">5</span>; ++n )</span><br><span class="line">  {</span><br><span class="line">    v14 = <span class="number">0LL</span>;</span><br><span class="line">    v15 = <span class="number">0LL</span>;</span><br><span class="line">    v16 = <span class="number">0LL</span>;</span><br><span class="line">    <span class="keyword">for</span> ( ii = <span class="number">0LL</span>; ii &lt;= <span class="number">5</span>; ++ii )</span><br><span class="line">    {</span><br><span class="line">      v5 = numbers[<span class="number">6</span> * ii + n] - <span class="number">1</span>; <span class="comment">//要求每列1-6</span></span><br><span class="line">      ++*((_DWORD *)&amp;v14 + v5);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">for</span> ( jj = <span class="number">0LL</span>; jj &lt;= <span class="number">5</span>; ++jj )</span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">if</span> ( *((_DWORD *)&amp;v14 + jj) != <span class="number">1</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_12;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  succ();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>6阶数独，数独并不难，手撸即可。</p><h3 id="5、gogogo">5、gogogo</h3><p><strong>go 语言+迷宫问题 10x10阶</strong><br>不过IDA7.6也存在一些反编译的问题</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">v12 = fmt_Fscanln(v5, v8, v10);</span><br><span class="line"> <span class="keyword">if</span> ( !v2 )</span><br><span class="line"> {</span><br><span class="line">   <span class="keyword">for</span> ( i = <span class="number">0LL</span>; v15[<span class="number">1</span>] &gt; i; i = v14 + <span class="number">1</span> )</span><br><span class="line">   {</span><br><span class="line">     v14 = i;</span><br><span class="line">     <span class="keyword">if</span> ( !(<span class="keyword">unsigned</span> __int8)main___ptr_Maze__advance() )</span><br><span class="line">     {</span><br><span class="line">       v16[<span class="number">0</span>] = &amp;off_4D6200;</span><br><span class="line">       v14 = fmt_Fprintln(v6, v9, v11, v12, v13);</span><br><span class="line">     }</span><br><span class="line">   }</span><br><span class="line">   <span class="keyword">if</span> ( a11111111111010[<span class="number">11</span>] == <span class="string">'#'</span> )</span><br></pre></td></tr></tbody></table></figure><p>​ 比如将最后的check终点的位置，识别成了一个常量位置，查看汇编和动调能解决这个错误。</p><p>​迷宫路径，从下标11(0xB)开始，扫到’#'，眼过即可。但还是准备好一套熟悉的自动化迷宫脚本，一旦量大起来，手撸就不现实了。</p><h3 id="6、SimpleSMC">6、SimpleSMC</h3><p><strong>花指令+反调试+SMC+Blowfish</strong></p><p>​首先观察main函数，第一句汇编便是iretq的返回指令，显然经过了修改，对main交叉引用可以定位到一句lea rcx, main，并发现上方有花指令。</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0000000140003001</span> ; __unwind { <span class="comment">// __C_specific_handler</span></span><br><span class="line">.text:<span class="number">0000000140003001</span>                 jz      <span class="keyword">short</span> near ptr loc_140003005+<span class="number">1</span></span><br><span class="line">.text:<span class="number">0000000140003003</span>                 jnz     <span class="keyword">short</span> near ptr loc_140003005+<span class="number">1</span></span><br><span class="line">.text:<span class="number">0000000140003005</span></span><br><span class="line">.text:<span class="number">0000000140003005</span> loc_140003005:                          ; CODE XREF: sub_140002FF0:loc_140003001↑j</span><br><span class="line">.text:<span class="number">0000000140003005</span>                                         ; sub_140002FF0+<span class="number">13</span>↑j</span><br><span class="line">.text:<span class="number">0000000140003005</span>                 call    near ptr <span class="number">0</span>C9493074h</span><br><span class="line">.text:<span class="number">000000014000300</span>A                 loope   near ptr loc_140003053+<span class="number">1</span></span><br></pre></td></tr></tbody></table></figure><p>通过jz 和 jnz 连用实现跳转，nop掉loc_140003005处的第一个字节即可。</p><p><img src="https://res.cloudinary.com/lu1u/image/upload/v1637039417/blog_img/1_ukikcx.png" alt=""></p><p>通过与NT有关的API调用，类似一种反调试手段，不过此处也没发现对main函数有关的处理，跟进140003110函数。</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0000000140003110</span> sub_140003110   proc near               ; CODE XREF: sub_140002FF0:loc_140003073↑p</span><br><span class="line">.text:<span class="number">0000000140003110</span>                                         ; DATA XREF: .pdata:<span class="number">000000014000</span>D054↓o</span><br><span class="line">.text:<span class="number">0000000140003110</span></span><br><span class="line">.text:<span class="number">0000000140003110</span> var_8           = qword ptr <span class="number">-8</span></span><br><span class="line">.text:<span class="number">0000000140003110</span></span><br><span class="line">.text:<span class="number">0000000140003110</span>                 pushfq</span><br><span class="line">.text:<span class="number">0000000140003111</span>                 <span class="keyword">or</span>      [rsp+<span class="number">8</span>+var_8], <span class="number">100</span>h</span><br><span class="line">.text:<span class="number">0000000140003119</span>                 popfq</span><br><span class="line">.text:<span class="number">000000014000311</span>A                 retn</span><br><span class="line">.text:<span class="number">000000014000311</span>A sub_140003110   endp</span><br></pre></td></tr></tbody></table></figure><p>pushfq是将标志寄存器的值入栈，之后or 0x100进行修改，将TF标志位置1，涉及到一个反调试。</p><p>​<strong>通过将陷阱标志位TF置1导致触发单步执行异常（触发后会置0），而我们事先设置好的异常处理函数会修改eip跳到正确的代码处，调试时则不会。</strong></p><p>参考:<a href="https://www.cnblogs.com/glodears/p/12842101.html">反调试技术–WIndows篇 - 深海之炎 - 博客园 (cnblogs.com)</a></p><p>在汇编窗口能看到try 和 except，并且在except 的代码中看到了对main函数处的内存进行了smc自修改。</p><p><img src="https://res.cloudinary.com/lu1u/image/upload/v1637040466/blog_img/re_ks9zzr.png" alt=""></p><p>汇编看出，修改代码为单字节循环左移三异或0x3F恢复，idapy脚本恢复即可。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> idautils</span><br><span class="line">target=<span class="number">0x0000000140001000</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x1F50</span>):</span><br><span class="line">    a=Byte(target+i)</span><br><span class="line">    result=((a&lt;&lt;<span class="number">3</span>)|(a&gt;&gt;<span class="number">5</span>))^<span class="number">0x3f</span></span><br><span class="line">    PatchByte(target+i,result&amp;<span class="number">0xff</span>)</span><br><span class="line">    </span><br><span class="line"><span class="built_in">print</span>(<span class="string">'yes'</span>)</span><br></pre></td></tr></tbody></table></figure><p>修复后可见ida在反编译时定义了4个256的int数组，并且内存中有连续的18个int。</p><p><img src="https://res.cloudinary.com/lu1u/image/upload/v1637041060/blog_img/re1_bwtple.png" alt=""></p><p>hint提示为blowfish加密，不过优化让代码面目全非，一步一步分析是个体力活。</p><p>blowfish参考:<a href="https://cloud.tencent.com/developer/article/1836650">https://cloud.tencent.com/developer/article/1836650</a></p><p>不过是魔改掉了p盒和s盒，初始化的代码是没有变的，可能经过优化有些难读。</p><p>例如:</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; ++i)</span><br><span class="line">{</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">256</span>; j+=<span class="number">2</span>)</span><br><span class="line">{</span><br><span class="line">BlowfishEncryption(ptr, &amp;leftSide, &amp;rightSide);</span><br><span class="line">ptr-&gt;s[i][j] = leftSide;</span><br><span class="line">ptr-&gt;s[i][j+<span class="number">1</span>] = rightSide;</span><br><span class="line">}</span><br><span class="line">}</span><br><span class="line"><span class="comment">//而IDA直接识别为</span></span><br><span class="line"> <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="number">0x200</span>; ++i )</span><br><span class="line">     <span class="comment">//xxxxxxx</span></span><br></pre></td></tr></tbody></table></figure><p>整体加密流程就是先秘钥初始化，此部分与输入无关，之后进行加密，加密流程类似festil轮，左边等于左边异或p[i]，右边等与F(左)^右，最后再左右交换。一共循环16轮，最后一轮取消交换，左右与p[17]和p[16]异或即可。解密即逆过程。</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">blowfish_decrypt</span><span class="params">(<span class="keyword">uint32_t</span>* L, <span class="keyword">uint32_t</span>* R)</span> </span>{</span><br><span class="line">*L ^= P[<span class="number">17</span>];</span><br><span class="line">*R ^= P[<span class="number">16</span>];</span><br><span class="line">swap(L, R);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">short</span> r = <span class="number">15</span>; r &gt;=<span class="number">0</span>; r--) {</span><br><span class="line">*L = *L ^ f(*R);</span><br><span class="line">*R^=P[r];</span><br><span class="line">swap(L, R);</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>按照内存中的数据修改头文件中的pbox和sbox，解密的主体代码如下。</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">"blowfish.h"</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">uint32_t</span> <span class="title">f</span><span class="params">(<span class="keyword">uint32_t</span> x)</span> </span>{</span><br><span class="line"><span class="keyword">uint32_t</span> h = S[<span class="number">0</span>][x &gt;&gt; <span class="number">24</span>] + S[<span class="number">1</span>][x &gt;&gt; <span class="number">16</span> &amp; <span class="number">0xff</span>];</span><br><span class="line"><span class="keyword">return</span> (h ^ S[<span class="number">2</span>][x &gt;&gt; <span class="number">8</span> &amp; <span class="number">0xff</span>]) + S[<span class="number">3</span>][x &amp; <span class="number">0xff</span>];</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">blowfish_encrypt</span><span class="params">(<span class="keyword">uint32_t</span>* L, <span class="keyword">uint32_t</span>* R)</span> </span>{</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">short</span> r = <span class="number">0</span>; r &lt; <span class="number">16</span>; r++) {</span><br><span class="line"></span><br><span class="line">*L = *L ^ P[r];</span><br><span class="line">*R = f(*L) ^ *R;</span><br><span class="line">swap(L, R);</span><br><span class="line">}</span><br><span class="line">swap(L, R);</span><br><span class="line">*R = *R ^ P[<span class="number">16</span>];</span><br><span class="line">*L = *L ^ P[<span class="number">17</span>];</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">//void blowfish_decrypt(uint32_t* L, uint32_t* R) { // 网上一般采用的解密方法  感觉有点别扭</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//for (short r = 17; r &gt; 1; r--) {</span></span><br><span class="line"><span class="comment">//*L = *L ^ P[r];</span></span><br><span class="line"><span class="comment">//*R = f(*L) ^ *R;</span></span><br><span class="line"><span class="comment">//swap(L, R);</span></span><br><span class="line"><span class="comment">//}</span></span><br><span class="line"><span class="comment">//swap(L, R); </span></span><br><span class="line"><span class="comment">//*R = *R ^ P[1];</span></span><br><span class="line"><span class="comment">//*L = *L ^ P[0];</span></span><br><span class="line"><span class="comment">//}</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">blowfish_decrypt</span><span class="params">(<span class="keyword">uint32_t</span>* L, <span class="keyword">uint32_t</span>* R)</span> </span>{</span><br><span class="line">*L ^= P[<span class="number">17</span>];</span><br><span class="line">*R ^= P[<span class="number">16</span>];</span><br><span class="line">swap(L, R);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">short</span> r = <span class="number">15</span>; r &gt;= <span class="number">0</span>; r--) {</span><br><span class="line">*L = *L ^ f(*R);</span><br><span class="line">*R ^= P[r];</span><br><span class="line">swap(L, R);</span><br><span class="line">}</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">blowfish_init</span><span class="params">(<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">int</span>* key, <span class="keyword">int</span> key_len)</span> </span>{</span><br><span class="line"><span class="comment">/* initialize P box w/ key*/</span></span><br><span class="line"><span class="keyword">uint32_t</span> k;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">short</span> i = <span class="number">0</span>, p = <span class="number">0</span>; i &lt; <span class="number">18</span>; i++)</span><br><span class="line">{</span><br><span class="line">k = key[i % key_len];</span><br><span class="line">P[i] ^= k;</span><br><span class="line">}</span><br><span class="line"><span class="comment">/* blowfish key expansion (521 iterations) */</span></span><br><span class="line"><span class="keyword">uint32_t</span> l = <span class="number">0x00</span>, r = <span class="number">0x00</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">short</span> i = <span class="number">0</span>; i &lt; <span class="number">18</span>; i += <span class="number">2</span>)</span><br><span class="line">{</span><br><span class="line">blowfish_encrypt(&amp;l, &amp;r);</span><br><span class="line">P[i] = l;</span><br><span class="line">P[i + <span class="number">1</span>] = r;</span><br><span class="line">}</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">short</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) <span class="comment">//512次</span></span><br><span class="line">{</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">short</span> j = <span class="number">0</span>; j &lt; <span class="number">256</span>; j += <span class="number">2</span>)</span><br><span class="line">{</span><br><span class="line">blowfish_encrypt(&amp;l, &amp;r); S[i][j] = l;</span><br><span class="line">S[i][j + <span class="number">1</span>] = r;</span><br><span class="line">}</span><br><span class="line">}</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> key[<span class="number">4</span>] = { <span class="number">0x12233445</span>,<span class="number">0xDEADBEEF</span>,<span class="number">0x90223344</span>,<span class="number">0x88112243</span> };</span><br><span class="line">blowfish_init(key, <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint32_t</span> enc[<span class="number">8</span>] = { <span class="number">0x7187C938</span>, <span class="number">0xCDE138C1</span>, <span class="number">0x3DBA6F8C</span>, <span class="number">0x4E68D12A</span>, <span class="number">0xA7FB22EE</span>, <span class="number">0x52E73F49</span>, <span class="number">0x81E16485</span>, <span class="number">0x753D87D7</span> };</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i += <span class="number">1</span>)</span><br><span class="line">blowfish_decrypt(enc + <span class="number">7</span> - i, enc + i);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%s"</span>, (<span class="keyword">char</span>*)enc);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>当然秘钥初始化是与输入无关的，通过动调来拿到初始化后的扩展盒和秘钥解密可能会更快。</p><hr><p>最后，某些人现在终于有自己的博客啦，用re专项来纪念一下，也是最近鸽了老久的比赛，现在终于完结撒花咯，还有一堆比赛有待复现，路途尚远，还要继续前行！</p>]]></content>
      
      
      <categories>
          
          <category> RE </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RE </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
