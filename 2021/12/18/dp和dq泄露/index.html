<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>RSA dp和dq泄露 | Lu1u</title><meta name="author" content="Lu1u"><meta name="copyright" content="Lu1u"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="从一个[羊城杯 2020]Power密码题，引发的关于dp 和 dq泄露等有趣的问题。  题目本身就出的有漏洞，并且对dp泄露的危害有了更深的理解。  其中的数学基础主要基于费马定理和简单的数论推导,成立以m小于p为前提  1、[羊城杯 2020]Power题目如下 1234567891011121314151617181920212223242526272829from Crypto.Util">
<meta property="og:type" content="article">
<meta property="og:title" content="RSA dp和dq泄露">
<meta property="og:url" content="http://example.com/2021/12/18/dp%E5%92%8Cdq%E6%B3%84%E9%9C%B2/index.html">
<meta property="og:site_name" content="Lu1u">
<meta property="og:description" content="从一个[羊城杯 2020]Power密码题，引发的关于dp 和 dq泄露等有趣的问题。  题目本身就出的有漏洞，并且对dp泄露的危害有了更深的理解。  其中的数学基础主要基于费马定理和简单的数论推导,成立以m小于p为前提  1、[羊城杯 2020]Power题目如下 1234567891011121314151617181920212223242526272829from Crypto.Util">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://res.cloudinary.com/lu1u/image/upload/v1639802724/blog_img/CTF_cover/wallhaven-j3lqlw_u0iivg.jpg">
<meta property="article:published_time" content="2021-12-18T04:40:38.000Z">
<meta property="article:modified_time" content="2021-12-18T05:03:47.722Z">
<meta property="article:author" content="Lu1u">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://res.cloudinary.com/lu1u/image/upload/v1639802724/blog_img/CTF_cover/wallhaven-j3lqlw_u0iivg.jpg"><link rel="shortcut icon" href="/img/lu1u.png"><link rel="canonical" href="http://example.com/2021/12/18/dp%E5%92%8Cdq%E6%B3%84%E9%9C%B2/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'RSA dp和dq泄露',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-12-18 13:03:47'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/lu1u.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">6</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">1</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">3</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://res.cloudinary.com/lu1u/image/upload/v1639802724/blog_img/CTF_cover/wallhaven-j3lqlw_u0iivg.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Lu1u</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">RSA dp和dq泄露</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-12-18T04:40:38.000Z" title="发表于 2021-12-18 12:40:38">2021-12-18</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-12-18T05:03:47.722Z" title="更新于 2021-12-18 13:03:47">2021-12-18</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Crypto/">Crypto</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">1.9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>8分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="RSA dp和dq泄露"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><blockquote>
<p>从一个[羊城杯 2020]Power密码题，引发的关于dp 和 dq泄露等有趣的问题。</p>
</blockquote>
<p><strong>题目本身就出的有漏洞，并且对dp泄露的危害有了更深的理解。</strong></p>
<blockquote>
<p><strong>其中的数学基础主要基于费马定理和简单的数论推导,成立以m小于p为前提</strong></p>
</blockquote>
<h3 id="1、-羊城杯-2020-Power"><a href="#1、-羊城杯-2020-Power" class="headerlink" title="1、[羊城杯 2020]Power"></a>1、[羊城杯 2020]Power</h3><p>题目如下</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line"><span class="keyword">from</span> secret <span class="keyword">import</span> flag</span><br><span class="line"></span><br><span class="line">p = getPrime(<span class="number">512</span>)</span><br><span class="line">q = getPrime(<span class="number">512</span>)</span><br><span class="line">n = p**<span class="number">4</span>*q</span><br><span class="line"></span><br><span class="line">e = <span class="number">65537</span></span><br><span class="line">phi = gmpy2.lcm(p - <span class="number">1</span>, q - <span class="number">1</span>)</span><br><span class="line">d = gmpy2.invert(e, phi)</span><br><span class="line">dp = d % (p - <span class="number">1</span>)</span><br><span class="line">m = bytes_to_long(flag)</span><br><span class="line">c = <span class="built_in">pow</span>(m, e, n)</span><br><span class="line"><span class="built_in">print</span> (<span class="string">"dp = "</span> + <span class="built_in">str</span>(dp))</span><br><span class="line"><span class="built_in">print</span> (<span class="string">"c = "</span> + <span class="built_in">str</span>(c))</span><br><span class="line"></span><br><span class="line">y = <span class="number">449703347709287328982446812318870158230369688625894307953604074502413258045265502496365998383562119915565080518077360839705004058211784369656486678307007348691991136610142919372779782779111507129101110674559235388392082113417306002050124215904803026894400155194275424834577942500150410440057660679460918645357376095613079720172148302097893734034788458122333816759162605888879531594217661921547293164281934920669935417080156833072528358511807757748554348615957977663784762124746554638152693469580761002437793837094101338408017407251986116589240523625340964025531357446706263871843489143068620501020284421781243879675292060268876353250854369189182926055204229002568224846436918153245720514450234433170717311083868591477186061896282790880850797471658321324127334704438430354844770131980049668516350774939625369909869906362174015628078258039638111064842324979997867746404806457329528690722757322373158670827203350590809390932986616805533168714686834174965211242863201076482127152571774960580915318022303418111346406295217571564155573765371519749325922145875128395909112254242027512400564855444101325427710643212690768272048881411988830011985059218048684311349415764441760364762942692722834850287985399559042457470942580456516395188637916303814055777357738894264037988945951468416861647204658893837753361851667573185920779272635885127149348845064478121843462789367112698673780005436144393573832498203659056909233757206537514290993810628872250841862059672570704733990716282248839</span></span><br><span class="line"></span><br><span class="line">g = <span class="number">2</span></span><br><span class="line">x = <span class="number">2019</span>*p**<span class="number">2</span> + <span class="number">2020</span>*p**<span class="number">3</span> + <span class="number">2021</span>*p**<span class="number">4</span></span><br><span class="line">c1 = <span class="built_in">pow</span>(g, x, y)</span><br><span class="line"><span class="built_in">print</span>( <span class="string">"c1 = "</span> + <span class="built_in">str</span>(c1))</span><br><span class="line"></span><br><span class="line"><span class="comment"># dp = 379476973158146550831004952747643994439940435656483772269013081580532539640189020020958796514224150837680366977747272291881285391919167077726836326564473</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># c = 57248258945927387673579467348106118747034381190703777861409527336272914559699490353325906672956273559867941402281438670652710909532261303394045079629146156340801932254839021574139943933451924062888426726353230757284582863993227592703323133265180414382062132580526658205716218046366247653881764658891315592607194355733209493239611216193118424602510964102026998674323685134796018596817393268106583737153516632969041693280725297929277751136040546830230533898514659714717213371619853137272515967067008805521051613107141555788516894223654851277785393355178114230929014037436770678131148140398384394716456450269539065009396311996040422853740049508500540281488171285233445744799680022307180452210793913614131646875949698079917313572873073033804639877699884489290120302696697425</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># c1 = 78100131461872285613426244322737502147219485108799130975202429638042859488136933783498210914335741940761656137516033926418975363734194661031678516857040723532055448695928820624094400481464950181126638456234669814982411270985650209245687765595483738876975572521276963149542659187680075917322308512163904423297381635532771690434016589132876171283596320435623376283425228536157726781524870348614983116408815088257609788517986810622505961538812889953185684256469540369809863103948326444090715161351198229163190130903661874631020304481842715086104243998808382859633753938512915886223513449238733721777977175430329717970940440862059204518224126792822912141479260791232312544748301412636222498841676742208390622353022668320809201312724936862167350709823581870722831329406359010293121019764160016316259432749291142448874259446854582307626758650151607770478334719317941727680935243820313144829826081955539778570565232935463201135110049861204432285060029237229518297291679114165265808862862827211193711159152992427133176177796045981572758903474465179346029811563765283254777813433339892058322013228964103304946743888213068397672540863260883314665492088793554775674610994639537263588276076992907735153702002001005383321442974097626786699895993544581572457476437853778794888945238622869401634353220344790419326516836146140706852577748364903349138246106379954647002557091131475669295997196484548199507335421499556985949139162639560622973283109342746186994609598854386966520638338999059</span></span><br></pre></td></tr></tbody></table></figure>

<p>我们已知c，c1，dp，e 没有n，可能我们注意力比较容易被c1的约束所吸引。</p>
<p><strong>c1是由2^x mod y 生成的，其中x和p相关，y是一个非常大的数，如果没有模运算，一个简单log就能求出n， 在模运算下，这就上升为离散对数问题。</strong></p>
<p>我们可以通过sympy库的<code>discrete_log</code> 函数来求解，可p是一个512bit的数，X是非常大的，在5min左右python跑出，或许sagemath 会更快一点，这也要求之后要掌握一些有关离散对数的求解算法。</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(sympy.discrete_log(y,c1,<span class="number">2</span>))</span><br></pre></td></tr></tbody></table></figure>

<p>参考用法:        <a target="_blank" rel="noopener" href="https://www.pythonf.cn/read/109392">https://www.pythonf.cn/read/109392</a></p>
<p>离散对数算法: <a target="_blank" rel="noopener" href="http://www.zbc53.top/archives/124/">http://www.zbc53.top/archives/124/</a></p>
<p><strong>假设 我们求出了X 之后X就是p的一个多次方程，可以用z3进行求解。</strong></p>
<p>求出p之后呢，我们还是没有n 并且没有q的相关信息，这时就要用到dp这一个条件。</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">dp= d mod p-<span class="number">1</span></span><br><span class="line"><span class="comment">#两遍同乘e</span></span><br><span class="line">e*dp = e*d mod p -<span class="number">1</span> </span><br><span class="line"><span class="comment">#等价</span></span><br><span class="line">e*dp = e*d + k*(p-<span class="number">1</span>)    (<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">根据我们钟爱的e*d = 1 mod phi n</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">n= (p^4) *q</span></span><br><span class="line"><span class="string">phi(n) = (p^3)*(p-1)*q</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">有了这些前提,不妨让式(1) mod phin</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line">e*d + k*(p-<span class="number">1</span>) mod phin = e*dp </span><br><span class="line"><span class="comment">#等价</span></span><br><span class="line"><span class="number">1</span> + k*(p-<span class="number">1</span>) = e*dp +  k*phin    phin=(p^<span class="number">3</span>)*(p-<span class="number">1</span>)*q  也是k<span class="string">'*(p-1)</span></span><br><span class="line"><span class="string">#整理 也就是</span></span><br><span class="line"><span class="string">e*dp = 1 + k1*(p-1)     (2)    #感觉出其中的倍数关系即可</span></span><br><span class="line"><span class="string">#此处标位式(2) 我们之后会重点用到</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">既然</span></span><br><span class="line"><span class="string">m ^ e = c mod n</span></span><br><span class="line"><span class="string">c^d mod n = m</span></span><br><span class="line"><span class="string">用到了欧拉定理</span></span><br><span class="line"><span class="string">a^(phin) mod n = 1 </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">那么我们可以类似</span></span><br><span class="line"><span class="string">c ^ (dp) = m ^ (e*dp) = m ^ (1 + k1*(p-1))</span></span><br><span class="line"><span class="string">根据费马定理 a ^ (p-1) mod p = 1</span></span><br><span class="line"><span class="string">那么 c ^ dp  mod p = m</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">c ^ dp  mod p = m</span></span><br></pre></td></tr></tbody></table></figure>

<p>根据上述推导，拿到p，游戏就结束了。</p>
<ul>
<li>上述  c ^ dp  mod p = m 必须要满足 m &lt; p 或者近似接近 否则近乎不能求解  即 m = (c^dp mod p) + k*p</li>
</ul>
<p><strong>回顾一下解题思路，我们执着于解离散对数和高次方程不就是为了求p么，但总结一下上面无论是dp还是 c1 都是有关p的，两个方程求一个未知量，是不是有点奢侈了呢?</strong></p>
<p><strong>注意推导中的这个式子e<em>dp = 1 + k1</em>(p-1)！！！ e和dp已知，k未知但是 e<em>dp - 1 一定是 (p-1)的整数倍，并且e</em>dp-1为525个bit 是十分接近的，这完全可以爆破。</strong></p>
<p>脚本如下</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span>  gmpy2</span><br><span class="line"><span class="keyword">import</span> cmath</span><br><span class="line"><span class="keyword">import</span> sympy</span><br><span class="line"><span class="keyword">from</span>  Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line">e = <span class="number">65537</span></span><br><span class="line">dp=<span class="number">379476973158146550831004952747643994439940435656483772269013081580532539640189020020958796514224150837680366977747272291881285391919167077726836326564473</span></span><br><span class="line">c=<span class="number">57248258945927387673579467348106118747034381190703777861409527336272914559699490353325906672956273559867941402281438670652710909532261303394045079629146156340801932254839021574139943933451924062888426726353230757284582863993227592703323133265180414382062132580526658205716218046366247653881764658891315592607194355733209493239611216193118424602510964102026998674323685134796018596817393268106583737153516632969041693280725297929277751136040546830230533898514659714717213371619853137272515967067008805521051613107141555788516894223654851277785393355178114230929014037436770678131148140398384394716456450269539065009396311996040422853740049508500540281488171285233445744799680022307180452210793913614131646875949698079917313572873073033804639877699884489290120302696697425</span></span><br><span class="line">ep=e*dp-<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>,<span class="number">1000000</span>):</span><br><span class="line">    <span class="keyword">if</span> ep % k ==<span class="number">0</span>:</span><br><span class="line">        p = (ep//k) +<span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> isPrime(p):</span><br><span class="line">            <span class="built_in">print</span>(k)</span><br><span class="line"></span><br><span class="line">p=<span class="number">12131601165788024635030034921084070470053842112984866821070395281728468805072716002494427632757418621194662541766157553264889658892783635499016425528807741</span></span><br><span class="line"><span class="built_in">print</span>(long_to_bytes(<span class="built_in">pow</span>(c,dp,p)))</span><br></pre></td></tr></tbody></table></figure>

<p><strong>这样也能达到解出p的目的，并且直接用 pow(c,dp,p),求解，用到了两个二级推导结论。</strong></p>
<p><strong>这也能透露出当m&lt;p时e*dp泄露的危害，如果能通过dp爆破出p，或者直接拿到p ，则直接用dp 和 p，作为私钥和公钥解密即可。</strong></p>
<p><strong>dp，dq本身就是为了快速解密服务的，也就决定了，大多情况下的p和q是非常大的，往往m会比p要小很多，如果出题人在dp泄露时忽视了这一点，那么可能会出现非预期。</strong></p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在m&gt;&gt;p 的dp泄露就需要给出e和n，以便我们借助p来分解n</span></span><br><span class="line"><span class="comment">#以网上的一个题目为例</span></span><br><span class="line">(<span class="string">'dp='</span>, <span class="string">'0x7f1344a0b8d2858492aaf88d692b32c23ef0d2745595bc5fe68de384b61c03e8fd054232f2986f8b279a0105b7bee85f74378c7f5f35c3fd505e214c0738e1d9'</span>)</span><br><span class="line">(<span class="string">'n='</span>, <span class="string">'0x5eee1b4b4f17912274b7427d8dc0c274dc96baa72e43da36ff39d452ff6f2ef0dc6bf7eb9bdab899a6bb718c070687feff517fcf5377435c56c248ad88caddad6a9cefa0ca9182daffcc6e48451d481f37e6520be384bedb221465ec7c95e2434bf76568ef81e988039829a2db43572e2fe57e5be0dc5d94d45361e96e14bd65L'</span>)</span><br><span class="line">(<span class="string">'e='</span>, <span class="string">'0x10001'</span>)</span><br><span class="line">(<span class="string">'c='</span>, <span class="string">'0x510fd8c3f6e21dfc0764a352a2c7ff1e604e1681a3867480a070a480f722e2f4a63ca3d7a92b862955ab4be76cde43b51576a128fba49348af7a6e34b335cfdbda8e882925b20503762edf530d6cd765bfa951886e192b1e9aeed61c0ce50d55d11e343c78bb617d8a0adb7b4cf3b913ee85437191f1136e35b94078e68bee8dL'</span>)</span><br></pre></td></tr></tbody></table></figure>

<h4 id="1、p-lt-m-Quic-Crack"><a href="#1、p-lt-m-Quic-Crack" class="headerlink" title="1、p<m Quic Crack"></a>1、p&lt;m Quic Crack</h4><p><strong>p的位数可以直接观察dp得出，接近512bit，64字节，一般flag在30-50左右甚至更短，即m&lt;p</strong></p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span>  gmpy2</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line">dp=<span class="number">0x7f1344a0b8d2858492aaf88d692b32c23ef0d2745595bc5fe68de384b61c03e8fd054232f2986f8b279a0105b7bee85f74378c7f5f35c3fd505e214c0738e1d9</span></span><br><span class="line"></span><br><span class="line">n=<span class="number">0x5eee1b4b4f17912274b7427d8dc0c274dc96baa72e43da36ff39d452ff6f2ef0dc6bf7eb9bdab899a6bb718c070687feff517fcf5377435c56c248ad88caddad6a9cefa0ca9182daffcc6e48451d481f37e6520be384bedb221465ec7c95e2434bf76568ef81e988039829a2db43572e2fe57e5be0dc5d94d45361e96e14bd65</span></span><br><span class="line">e=<span class="number">0x10001</span></span><br><span class="line">c=<span class="number">0x510fd8c3f6e21dfc0764a352a2c7ff1e604e1681a3867480a070a480f722e2f4a63ca3d7a92b862955ab4be76cde43b51576a128fba49348af7a6e34b335cfdbda8e882925b20503762edf530d6cd765bfa951886e192b1e9aeed61c0ce50d55d11e343c78bb617d8a0adb7b4cf3b913ee85437191f1136e35b94078e68bee8d</span></span><br><span class="line">edp=e*dp - <span class="number">1</span></span><br><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>,<span class="number">10000000</span>):</span><br><span class="line">    <span class="keyword">if</span> edp%k==<span class="number">0</span>:</span><br><span class="line">        p= edp//k + <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> isPrime(p):</span><br><span class="line">            <span class="built_in">print</span>(long_to_bytes(<span class="built_in">pow</span>(c,dp,p)))</span><br></pre></td></tr></tbody></table></figure>

<p>当然这只是一种特殊情况，但是网上大多数关于dp泄露题目貌似都存在这个问题。</p>
<h4 id="2、通用解法"><a href="#2、通用解法" class="headerlink" title="2、通用解法"></a>2、通用解法</h4><p><strong>通解，当然rsa加密对密文本身就限制了m是要比n小的</strong></p>
<p>所以分解n直接解就得了，既然上脚本我们已经测试出了p ，那么q = n//p 即可。</p>
<p>综上，综合两种脚本</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span>  gmpy2</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line">dp=<span class="number">0x7f1344a0b8d2858492aaf88d692b32c23ef0d2745595bc5fe68de384b61c03e8fd054232f2986f8b279a0105b7bee85f74378c7f5f35c3fd505e214c0738e1d9</span></span><br><span class="line"></span><br><span class="line">n=<span class="number">0x5eee1b4b4f17912274b7427d8dc0c274dc96baa72e43da36ff39d452ff6f2ef0dc6bf7eb9bdab899a6bb718c070687feff517fcf5377435c56c248ad88caddad6a9cefa0ca9182daffcc6e48451d481f37e6520be384bedb221465ec7c95e2434bf76568ef81e988039829a2db43572e2fe57e5be0dc5d94d45361e96e14bd65</span></span><br><span class="line">e=<span class="number">0x10001</span></span><br><span class="line">c=<span class="number">0x510fd8c3f6e21dfc0764a352a2c7ff1e604e1681a3867480a070a480f722e2f4a63ca3d7a92b862955ab4be76cde43b51576a128fba49348af7a6e34b335cfdbda8e882925b20503762edf530d6cd765bfa951886e192b1e9aeed61c0ce50d55d11e343c78bb617d8a0adb7b4cf3b913ee85437191f1136e35b94078e68bee8d</span></span><br><span class="line">edp=e*dp - <span class="number">1</span></span><br><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>,<span class="number">10000000</span>):</span><br><span class="line">    <span class="keyword">if</span> edp%k==<span class="number">0</span>:</span><br><span class="line">        p= edp//k + <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> isPrime(p):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="built_in">print</span>(long_to_bytes(<span class="built_in">pow</span>(c,dp,p)).decode(<span class="string">'utf-8'</span>)) <span class="comment">#flag肯定是可见字符</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">'Quick Crack Suc!'</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                q=n//p</span><br><span class="line">                phi=(p-<span class="number">1</span>)*(q-<span class="number">1</span>)</span><br><span class="line">                d=gmpy2.invert(e,phi)</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    <span class="built_in">print</span>(long_to_bytes(<span class="built_in">pow</span>(c,d,n)).decode(<span class="string">'utf-8'</span>))</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">'yes!'</span>)</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">except</span>:</span><br><span class="line">                    <span class="keyword">pass</span></span><br></pre></td></tr></tbody></table></figure>

<p><strong>测试，用如下式例来测试 m &gt; p的情况</strong></p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dp = <span class="number">14423533367739841601650555272663543354837347609362352488761411482549189398193</span></span><br><span class="line">p =  <span class="number">69901287164206610888661720099426949703910023683707793762919220907478091073681</span></span><br><span class="line">c=  <span class="number">2262919207276468849681578487794992281448594044416435512543882157738828978766101685798623343531305619235784170849036103143665025760464116190980363198608567</span></span><br><span class="line">e=<span class="number">65537</span></span><br><span class="line">n=<span class="number">5965322435025945026021165385608956120433036321627501574655956870755806607342365635361310529607383516087208412532082338428923031616470920911896483167491881</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="2、dp-dq泄露"><a href="#2、dp-dq泄露" class="headerlink" title="2、dp dq泄露"></a>2、dp dq泄露</h3><p><strong>dp 和 dq泄露 和dp泄露有着异曲同工之妙，不过忽略了m &lt; p / q 就成了纸老虎。</strong></p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">c: <span class="number">95272795986475189505518980251137003509292621140166383887854853863720692420204142448424074834657149326853553097626486371206617513769930277580823116437975487148956107509247564965652417450550680181691869432067892028368985007229633943149091684419834136214793476910417359537696632874045272326665036717324623992885</span></span><br><span class="line">p: <span class="number">11387480584909854985125335848240384226653929942757756384489381242206157197986555243995335158328781970310603060671486688856263776452654268043936036556215243</span></span><br><span class="line">q: <span class="number">12972222875218086547425818961477257915105515705982283726851833508079600460542479267972050216838604649742870515200462359007315431848784163790312424462439629</span></span><br><span class="line">dp: <span class="number">8191957726161111880866028229950166742224147653136894248088678244548815086744810656765529876284622829884409590596114090872889522887052772791407131880103961</span></span><br><span class="line">dq: <span class="number">3570695757580148093370242608506191464756425954703930236924583065811730548932270595568088372441809535917032142349986828862994856575730078580414026791444659</span></span><br></pre></td></tr></tbody></table></figure>

<p>按之前的算法 是要用中国剩余定理求d的</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dp = d mod p-<span class="number">1</span></span><br><span class="line">dq = d mod q-<span class="number">1</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="1、解密思路-Crt"><a href="#1、解密思路-Crt" class="headerlink" title="1、解密思路 + Crt"></a>1、解密思路 + Crt</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">m1 = c^dp mod p</span><br><span class="line">m2 = c^dq mod q</span><br><span class="line">dp = d mod p-<span class="number">1</span>   -&gt; dp = d + k*(p-<span class="number">1</span>)</span><br><span class="line">dq = q mod q-<span class="number">1</span></span><br><span class="line"><span class="comment">#根据 费马可得 c^dp mod p = c^d mod p</span></span><br><span class="line"><span class="comment">#同理 c^dq mod q = c^d mod q </span></span><br><span class="line">c^d mod p = m1</span><br><span class="line">c^d mod q = m2</span><br><span class="line"></span><br><span class="line">构造 x = k1*m1 + k2*m2</span><br><span class="line"></span><br><span class="line">(<span class="number">1</span>)k1 mod p =<span class="number">1</span></span><br><span class="line">(<span class="number">2</span>)k1 mod q =<span class="number">0</span></span><br><span class="line"></span><br><span class="line">k1 = k*q 带入(<span class="number">1</span>)</span><br><span class="line">k = q^(-<span class="number">1</span>) mod p </span><br><span class="line">即 k1 = (q ^(-<span class="number">1</span>) mod p) *q</span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">推广到一般 如果 在剩余定理中</span></span><br><span class="line"><span class="string">x mod a1 = b1 </span></span><br><span class="line"><span class="string">x mod a2 = b2</span></span><br><span class="line"><span class="string">x mod a3 = b3</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">那么构造的数 m = k1*b1 + k2*b2 + ... kn * bn</span></span><br><span class="line"><span class="string">k1 = ((a2 *a3 *..an)^(-1) mod a1) * (a2 *a3 *..an)</span></span><br><span class="line"><span class="string">k2 = ((a1 *a3 *..an)^(-1) mod a1) * (a2 *a3 *..an)</span></span><br><span class="line"><span class="string"><span class="meta">... </span>如此规律</span></span><br><span class="line"><span class="string">M=a1*a2*..an</span></span><br><span class="line"><span class="string">Mi = M / ai</span></span><br><span class="line"><span class="string">Mi' = gmpy2.invert(Mi,ai)</span></span><br><span class="line"><span class="string">Mi * Mi' * bi 每一项</span></span><br><span class="line"><span class="string">综合要%M  一下</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>即</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span>  gmpy2</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">dp= <span class="number">90494486973243104756298311175705002887155440121025946664275790548694955799661434870163629541771658812502682012435200659355928618529521731475360236486362525996535354732687624609637012830178545914960485330748345108757203508531117591067570383564779625954776907685968592668868046507450242047759226407026094726359</span></span><br><span class="line">dq= <span class="number">92386717102324384872139253931247976320472847834037799716676564640678692924258053130751618730959510913784801723023536527134208843358920592320351399005428347188639433875570867152865970587272904695272790831679276818402117343413503376057524788386479263579869430615501089905630519162146030369086836183772975252551</span></span><br><span class="line">p= <span class="number">121869669684596731118740111360803257498670698122183387353481580136405322481841982461820301261370579505460038281590785837096967719889404913176714663774999789266522508163678949469953184327222227297952119212490499582581953510522212981687122483764873187827531047946130999532741388680549345732675732040579796067001</span></span><br><span class="line">q= <span class="number">128363031923139297392077349407719417788135630403499671848196425800900870531452570499668481104884553795224784931947824885511134525485570129640119439950191944938407656926280993408854767711557863016197167505998324659906146937423415404059310560359693643987781862684489401368519777953281060013045590132161625607377</span></span><br><span class="line">c= <span class="number">4176193749773450562408160796325873473193702511560805285554329767573726211097194419198463203488792792756598428753745425419950423161673497255820731183746106463781291156892140581651301528184812357534808298071893380519977926677138246941946185699346532140641376461516107672722425971178865758049759985915001009787241295292157744353554548314911531918044654676691927347018033509499136103964942830581407087547565204232556314726045307279963709599952745342811947421707024572981812906869557834491207590418553244020621858083633564878305733114484857827620268881100166090837841224767358579366482347136224695333980041913268394994302</span></span><br><span class="line">m1 = <span class="built_in">pow</span>(c,dp,p)</span><br><span class="line">m2 = <span class="built_in">pow</span>(c,dq,q)</span><br><span class="line">d = gmpy2.invert(q,p)*(q)*m1 + gmpy2.invert(p,q)*(p)*m2</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(long_to_bytes(d%(p*q)))</span><br></pre></td></tr></tbody></table></figure>

<p>用python的库sympy来实现crt</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sympy.ntheory.modular <span class="keyword">import</span> * <span class="comment">#从sympy数论库中导入函数</span></span><br><span class="line">crt([p,q],[m1,m2])</span><br><span class="line"><span class="comment"># 第一个参数是模数组，第二个参数是余数组</span></span><br><span class="line"><span class="comment"># 返回值是一个元组 第一个数是求解的m值，第二个数是所有模数的乘积</span></span><br><span class="line"></span><br><span class="line">m=crt([p,q],[m1,m2])[<span class="number">0</span>] <span class="comment">#得到解即可</span></span><br><span class="line"><span class="built_in">print</span>(long_to_bytes(m%n))</span><br></pre></td></tr></tbody></table></figure>

<p>sympy库中有很多方便的函数，有大致印象百度即可。</p>
<h4 id="2、测试用例"><a href="#2、测试用例" class="headerlink" title="2、测试用例"></a>2、测试用例</h4><p>反例当messaege&gt;q</p>
<p>注意m要小于n</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span>  gmpy2</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line">p=getPrime(<span class="number">256</span>)</span><br><span class="line">q=getPrime(<span class="number">256</span>)</span><br><span class="line">n=p*q</span><br><span class="line">phi=(p-<span class="number">1</span>)*(q-<span class="number">1</span>)</span><br><span class="line">e=<span class="number">65537</span></span><br><span class="line">d=gmpy2.invert(e,phi)</span><br><span class="line">dp=d%(p-<span class="number">1</span>)</span><br><span class="line">dq=d%(q-<span class="number">1</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">'dp = '</span>,dp)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">'p = '</span>,p)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">'dq = '</span>,dq)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">'q= '</span>,q)</span><br><span class="line">m=<span class="string">b'flag{If_the message_is_larger_than_prime_end!!!}'</span></span><br><span class="line">c=bytes_to_long(m)</span><br><span class="line">c= <span class="built_in">pow</span>(c,e,n)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">'c= '</span>,c)</span><br></pre></td></tr></tbody></table></figure>

<p>如果继续解密,则是乱码</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line">dp = <span class="number">14423533367739841601650555272663543354837347609362352488761411482549189398193</span></span><br><span class="line">p =  <span class="number">69901287164206610888661720099426949703910023683707793762919220907478091073681</span></span><br><span class="line">c=  <span class="number">2262919207276468849681578487794992281448594044416435512543882157738828978766101685798623343531305619235784170849036103143665025760464116190980363198608567</span></span><br><span class="line"><span class="built_in">print</span>(long_to_bytes(<span class="built_in">pow</span>(c,dp,p)))</span><br><span class="line"><span class="comment"># b'Y\x83^\xa4\xf2\xbaC\xbfY\xa0\x9a!\x07^\xb0\x12\xaa-\xa0\x10\xf8;\x9b\xb1\xaaF5\x9f\xb2\x952\xc0'</span></span><br></pre></td></tr></tbody></table></figure>

<p>中国剩余定理,成功解决</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span>  gmpy2</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line">dp =  <span class="number">14423533367739841601650555272663543354837347609362352488761411482549189398193</span></span><br><span class="line">p =  <span class="number">69901287164206610888661720099426949703910023683707793762919220907478091073681</span></span><br><span class="line">dq =  <span class="number">32437946587531699347725552012753985094383131578752766354933176932787801620073</span></span><br><span class="line">q=  <span class="number">85339235900086908600694050911639754370783480963298143334400691126173744722201</span></span><br><span class="line">c=  <span class="number">2262919207276468849681578487794992281448594044416435512543882157738828978766101685798623343531305619235784170849036103143665025760464116190980363198608567</span></span><br><span class="line">m1 = <span class="built_in">pow</span>(c,dp,p)</span><br><span class="line">m2 = <span class="built_in">pow</span>(c,dq,q)</span><br><span class="line">d = gmpy2.invert(q,p)*(q)*m1 + gmpy2.invert(p,q)*(p)*m2</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(long_to_bytes(d%(p*q)))</span><br><span class="line"><span class="comment">#b'flag{If_the message_is_larger_than_prime_end!!!}'</span></span><br></pre></td></tr></tbody></table></figure>

<hr>
<blockquote>
<p>推导过程中的中间结论也能对解密有巨大贡献，在进行加密时，还要考虑密文和素因数以及模数的大小，防止出现非预期的漏洞。</p>
</blockquote>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Lu1u</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2021/12/18/dp%E5%92%8Cdq%E6%B3%84%E9%9C%B2/">http://example.com/2021/12/18/dp%E5%92%8Cdq%E6%B3%84%E9%9C%B2/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">Lu1u</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://res.cloudinary.com/lu1u/image/upload/v1639802724/blog_img/CTF_cover/wallhaven-j3lqlw_u0iivg.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/12/31/PinTool-CPU%E4%BE%A7%E4%BF%A1%E9%81%93/"><img class="prev-cover" src="https://cdn.shi1011.cn/2021/12/cbe91a9658490131c13ef122dafbf8d3.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">PinTool-CPU侧信道</div></div></a></div><div class="next-post pull-right"><a href="/2021/12/01/2021NCTF-RE/"><img class="next-cover" src="https://bu.dusays.com/2021/12/01/88ccec55e64a1.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">2021NCTF-Re</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/lu1u.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Lu1u</div><div class="author-info__description">Never back</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">6</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">1</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">3</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/smallboyZ"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/smallboyZ" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:3194679102@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">沿途风景正好!</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81-%E7%BE%8A%E5%9F%8E%E6%9D%AF-2020-Power"><span class="toc-number">1.</span> <span class="toc-text">1、[羊城杯 2020]Power</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81p-lt-m-Quic-Crack"><span class="toc-number">1.1.</span> <span class="toc-text">1、p&lt;m Quic Crack</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81%E9%80%9A%E7%94%A8%E8%A7%A3%E6%B3%95"><span class="toc-number">1.2.</span> <span class="toc-text">2、通用解法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81dp-dq%E6%B3%84%E9%9C%B2"><span class="toc-number">2.</span> <span class="toc-text">2、dp dq泄露</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81%E8%A7%A3%E5%AF%86%E6%80%9D%E8%B7%AF-Crt"><span class="toc-number">2.1.</span> <span class="toc-text">1、解密思路 + Crt</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81%E6%B5%8B%E8%AF%95%E7%94%A8%E4%BE%8B"><span class="toc-number">2.2.</span> <span class="toc-text">2、测试用例</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2021/12/31/PinTool-CPU%E4%BE%A7%E4%BF%A1%E9%81%93/" title="PinTool-CPU侧信道"><img src="https://cdn.shi1011.cn/2021/12/cbe91a9658490131c13ef122dafbf8d3.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="PinTool-CPU侧信道"/></a><div class="content"><a class="title" href="/2021/12/31/PinTool-CPU%E4%BE%A7%E4%BF%A1%E9%81%93/" title="PinTool-CPU侧信道">PinTool-CPU侧信道</a><time datetime="2021-12-31T13:53:37.000Z" title="发表于 2021-12-31 21:53:37">2021-12-31</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/12/18/dp%E5%92%8Cdq%E6%B3%84%E9%9C%B2/" title="RSA dp和dq泄露"><img src="https://res.cloudinary.com/lu1u/image/upload/v1639802724/blog_img/CTF_cover/wallhaven-j3lqlw_u0iivg.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="RSA dp和dq泄露"/></a><div class="content"><a class="title" href="/2021/12/18/dp%E5%92%8Cdq%E6%B3%84%E9%9C%B2/" title="RSA dp和dq泄露">RSA dp和dq泄露</a><time datetime="2021-12-18T04:40:38.000Z" title="发表于 2021-12-18 12:40:38">2021-12-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/12/01/2021NCTF-RE/" title="2021NCTF-Re"><img src="https://bu.dusays.com/2021/12/01/88ccec55e64a1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="2021NCTF-Re"/></a><div class="content"><a class="title" href="/2021/12/01/2021NCTF-RE/" title="2021NCTF-Re">2021NCTF-Re</a><time datetime="2021-12-01T02:27:36.000Z" title="发表于 2021-12-01 10:27:36">2021-12-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/12/01/GFCTF2021-RE/" title="GFCTF2021-RE"><img src="https://bu.dusays.com/2021/12/01/6819e6a909b53.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="GFCTF2021-RE"/></a><div class="content"><a class="title" href="/2021/12/01/GFCTF2021-RE/" title="GFCTF2021-RE">GFCTF2021-RE</a><time datetime="2021-12-01T01:55:26.000Z" title="发表于 2021-12-01 09:55:26">2021-12-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/11/21/%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%912021/" title="西湖论剑2021-Re"><img src="https://mediabluk.cnr.cn/img/cnr/CNRCDP/2021/1101/f280e289735c1163573267423187913910.jpg?auth=3a6b80b01faf9b287a0684f1825e6f7c" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="西湖论剑2021-Re"/></a><div class="content"><a class="title" href="/2021/11/21/%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%912021/" title="西湖论剑2021-Re">西湖论剑2021-Re</a><time datetime="2021-11-21T15:33:43.000Z" title="发表于 2021-11-21 23:33:43">2021-11-21</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://res.cloudinary.com/lu1u/image/upload/v1639802724/blog_img/CTF_cover/wallhaven-j3lqlw_u0iivg.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2021 - 2022 By Lu1u</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function addGitalkSource () {
  const ele = document.createElement('link')
  ele.rel = 'stylesheet'
  ele.href= 'https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css'
  document.getElementsByTagName('head')[0].appendChild(ele)
}

function loadGitalk () {
  function initGitalk () {
    var gitalk = new Gitalk(Object.assign({
      clientID: '1309fd935c8171290758',
      clientSecret: '6a4b26253863498a69d7d5d9690aedd1d58e68d7',
      repo: 'smallboyZ.github.io',
      owner: 'smallboyZ',
      admin: ['smallboyZ'],
      id: 'c050430b7902c3fcdb1892066fc0d6b6',
      language: 'en',
      perPage: 10,
      distractionFreeMode: false,
      pagerDirection: 'last',
      createIssueManually: false,
      updateCountCallback: commentCount
    },null))

    gitalk.render('gitalk-container')
  }

  if (typeof Gitalk === 'function') initGitalk()
  else {
    addGitalkSource()
    getScript('https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js').then(initGitalk)
  }
}

function commentCount(n){
  let isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
  if (isCommentCount) {
    isCommentCount.innerHTML= n
  }
}

if ('Gitalk' === 'Gitalk' || !false) {
  if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
  else loadGitalk()
} else {
  function loadOtherComment () {
    loadGitalk()
  }
}</script></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/fireworks.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>