

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/QQå›¾ç‰‡20211218184601.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Lu1u&#39;s Blog">
  <meta name="keywords" content="">
  
    <meta name="description" content="re-wpã€å…³äºbabysysçš„è¯¦ç»†ä»‹ç»ã€‚">
<meta property="og:type" content="article">
<meta property="og:title" content="2022-10æœˆDASCTF X GFCTF">
<meta property="og:url" content="http://example.com/2022/10/26/2022-10%E6%9C%88DASCTF%20X%20GFCTF/index.html">
<meta property="og:site_name" content="Lu1u">
<meta property="og:description" content="re-wpã€å…³äºbabysysçš„è¯¦ç»†ä»‹ç»ã€‚">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20221026174407573.png">
<meta property="article:published_time" content="2022-10-26T09:59:45.327Z">
<meta property="article:modified_time" content="2022-10-26T10:02:16.231Z">
<meta property="article:author" content="Lu1u&#39;s Blog">
<meta property="article:tag" content="RE">
<meta property="article:tag" content="Wp">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20221026174407573.png">
  
  
  <title>2022-10æœˆDASCTF X GFCTF - Lu1u</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />
  


<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- è‡ªå®šä¹‰æ ·å¼ä¿æŒåœ¨æœ€åº•éƒ¨ -->

  
<link rel="stylesheet" href="/css/mac.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.14","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0,"placement":"right"},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"follow_dnt":true},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Lightu&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                é¦–é¡µ
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                å½’æ¡£
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                åˆ†ç±»
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                æ ‡ç­¾
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                å…³äº
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                å‹é“¾
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/wallhaven-l3v7pr.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="2022-10æœˆDASCTF X GFCTF">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2022-10-26 17:59" pubdate>
        2022å¹´10æœˆ26æ—¥ ä¸‹åˆ
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      12k å­—
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      99 åˆ†é’Ÿ
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">2022-10æœˆDASCTF X GFCTF</h1>
            
            <div class="markdown-body">
              <h1>2022-10æœˆDASCTF X GFCTF</h1>
<blockquote>
<p>è€ƒç‚¹: å­—èŠ‚ç ã€ollvmæ··æ·†ã€duilibç¨‹åºé€†å‘ã€sysé©±åŠ¨ã€å¼‚å¸¸å¤„ç†</p>
</blockquote>
<p>ç®—æ³•æµ“åº¦ä¸æ˜¯å¾ˆé«˜ï¼ŒğŸ¹ğŸ¹æ¯”è¾ƒå–œæ¬¢ï¼Œbabysysä¸ªäººæ„Ÿè§‰é¢˜ç›®ä¸é”™ï¼Œæœ¬æ–‡ä¹Ÿä¸»è¦ä»‹ç»äº†è¯¥é¢˜çš„åšé¢˜æ€è·¯ã€‚</p>
<h3 id="PYCODE">PYCODE</h3>
<p>version3.9ï¼Œdisæ‹¿å­—èŠ‚ç ï¼Œç›´æ¥ç¿»è¯‘å³å¯ã€‚</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></div></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br>cc=<span class="hljs-string">'8b2e4e858126bc8478d6a6a485215f03'</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">extract_number</span>(<span class="hljs-params">x</span>):</span><br>    x = x ^ (x &gt;&gt; <span class="hljs-number">11</span>)<br>    x=x&amp;<span class="hljs-number">0xffffffff</span><br>    x = x ^ ((x &lt;&lt; <span class="hljs-number">7</span>) &amp; <span class="hljs-number">2022072721</span>)<br>    x = x &amp; <span class="hljs-number">0xffffffff</span><br>    x = x ^ ((x &lt;&lt; <span class="hljs-number">15</span>) &amp; <span class="hljs-number">2323163360</span>)<br>    x = x &amp; <span class="hljs-number">0xffffffff</span><br>    x = x ^ (x &gt;&gt; <span class="hljs-number">18</span>)<br>    x = x &amp; <span class="hljs-number">0xffffffff</span><br>    <span class="hljs-keyword">return</span> x<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">transform</span>(<span class="hljs-params">m</span>):</span><br>    new_message = <span class="hljs-string">''</span><br>    l = <span class="hljs-built_in">len</span>(m)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(l//<span class="hljs-number">4</span>):<br>        enc = m[<span class="hljs-number">4</span> * i:<span class="hljs-number">4</span> * i + <span class="hljs-number">4</span>]<br>        enc = bytes_to_long(enc)<br>        enc = extract_number(enc)<br>        new_message += long_to_bytes(enc, <span class="hljs-number">4</span>)<br>    <span class="hljs-keyword">return</span>  new_message<br>cc=<span class="hljs-built_in">bytes</span>.fromhex(cc)<br>c=[]<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(cc)//<span class="hljs-number">4</span>):<br>    c.append(bytes_to_long(cc[<span class="hljs-number">4</span>*i:<span class="hljs-number">4</span>*i+<span class="hljs-number">4</span>]))<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">re</span>(<span class="hljs-params">x</span>):</span><br>    x=x^(x&gt;&gt;<span class="hljs-number">18</span>)<br>    t=(x^((x&lt;&lt;<span class="hljs-number">15</span>)&amp;<span class="hljs-number">2323163360</span>))&amp;<span class="hljs-number">0xffffffff</span><br>    x=x^((t&lt;&lt;<span class="hljs-number">15</span>)&amp;<span class="hljs-number">2323163360</span>)<br>    x = x &amp; <span class="hljs-number">0xffffffff</span><br>    t1=(x ^ ((x &lt;&lt; <span class="hljs-number">7</span>) &amp; <span class="hljs-number">2022072721</span>))&amp;<span class="hljs-number">0xffffffff</span> <span class="hljs-comment">#14</span><br>    t2=(x ^ ((t1 &lt;&lt; <span class="hljs-number">7</span>) &amp; <span class="hljs-number">2022072721</span>))&amp;<span class="hljs-number">0xffffffff</span><span class="hljs-comment">#21</span><br>    t3=(x ^ ((t2 &lt;&lt; <span class="hljs-number">7</span>) &amp; <span class="hljs-number">2022072721</span>))&amp;<span class="hljs-number">0xffffffff</span> <span class="hljs-comment">#28</span><br>    x=x ^ ((t3 &lt;&lt; <span class="hljs-number">7</span>) &amp; <span class="hljs-number">2022072721</span>)<br>    x = x &amp; <span class="hljs-number">0xffffffff</span><br>    t = x ^ (x &gt;&gt; <span class="hljs-number">11</span>) <span class="hljs-comment">#22</span><br>    x=x ^ (t &gt;&gt; <span class="hljs-number">11</span>)<br>    <span class="hljs-keyword">return</span> x<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(c)):<br>    <span class="hljs-built_in">print</span>(long_to_bytes(re(c[i])).<span class="hljs-built_in">hex</span>(),end=<span class="hljs-string">''</span>)<br><span class="hljs-comment">#DASCTF{89196e63ab5556e7389d2bb44f8e6e06}</span><br></code></pre></td></tr></tbody></table></figure>
<h3 id="è´ªç©CTF">è´ªç©CTF</h3>
<p>ä¸»è¦é€»è¾‘åœ¨<code>sub_7FF6A72619C0</code>,TLSå‡½æ•°åˆåè°ƒè¯•ï¼Œnopæ‰å³å¯ï¼Œå¯ä»¥é€šè¿‡è®¾ç½®æ¡ä»¶æ–­ç‚¹ä¾¿äºè°ƒè¯•ã€‚</p>
<p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20221023180526090.png" srcset="/img/loading.gif" lazyload alt="image-20221023180526090"></p>
<p>å¯¹è´¦å·åŠ å¯†å•çº¯å¼‚æˆ–æœ€åä¸€ä½ï¼Œå¯¹å¯†ç åŠ å¯†åˆ™æ˜¯AESï¼Œé¦–å…ˆä¼šåŠ¨æ€æ¢å¤sboxã€‚</p>
<p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20221023180723914.png" srcset="/img/loading.gif" lazyload alt="image-20221023180723914"></p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python">s=[ <span class="hljs-number">0x04</span>, <span class="hljs-number">0x1F</span>, <span class="hljs-number">0x1F</span>, <span class="hljs-number">0x1E</span>, <span class="hljs-number">0x43</span>, <span class="hljs-number">0x4B</span>, <span class="hljs-number">0x43</span>, <span class="hljs-number">0x45</span>, <span class="hljs-number">0x44</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x16</span>, <span class="hljs-number">0x10</span>, <span class="hljs-number">0x55</span>, <span class="hljs-number">0x17</span>, <span class="hljs-number">0x12</span>, <span class="hljs-number">0x73</span>]<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">15</span>):<br>    s[i]^=s[<span class="hljs-number">15</span>]<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">bytes</span>(s))<br>k=<span class="hljs-built_in">bytes</span>(s)<br><span class="hljs-comment">#wllm08067sec&amp;das</span><br><span class="hljs-keyword">from</span> Crypto.Cipher.AES <span class="hljs-keyword">import</span> *<br>aes=new(k,MODE_ECB)<br>c=<span class="hljs-built_in">bytes</span>([<span class="hljs-number">0x3C</span>, <span class="hljs-number">0x97</span>, <span class="hljs-number">0x72</span>, <span class="hljs-number">0x96</span>, <span class="hljs-number">0x5A</span>, <span class="hljs-number">0x33</span>, <span class="hljs-number">0x63</span>, <span class="hljs-number">0x9C</span>, <span class="hljs-number">0x97</span>, <span class="hljs-number">0x30</span>, <span class="hljs-number">0x4D</span>, <span class="hljs-number">0x90</span>, <span class="hljs-number">0x84</span>, <span class="hljs-number">0xE8</span>, <span class="hljs-number">0x5F</span>, <span class="hljs-number">0x56</span>])<br><span class="hljs-built_in">print</span>(aes.decrypt(c))<br><span class="hljs-comment">#DASCTF{wllm08067sec&amp;dase4deb7a6510a10f7}</span><br></code></pre></td></tr></tbody></table></figure>
<h3 id="cutere">cutere</h3>
<p>é€šè¿‡ä¸€åœºå¤„ç†ä¿®æ”¹äº†rc4çš„ç§˜é’¥å’Œbase64è¡¨ï¼ŒåŠ å¯†ä¸»ä½“éƒ¨åˆ†é‡‡ç”¨ollvmæ··æ·†è¿‡äº†ï¼Œä¸è¿‡åŠ å¯†é€»è¾‘æ²¡å˜ï¼Œè°ƒè¯•å‡ºå…³é”®å€¼ç›´æ¥è§£å¯†å³å¯ã€‚</p>
<p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20221023181006551.png" srcset="/img/loading.gif" lazyload alt="image-20221023181006551"></p>
<p>ç›´æ¥cyberchefä¸€æŠŠæ¢­</p>
<p>rc4</p>
<p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20221023181117914.png" srcset="/img/loading.gif" lazyload alt="image-20221023181117914"></p>
<p>æ¢è¡¨base64</p>
<p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20221023181223173.png" srcset="/img/loading.gif" lazyload alt="image-20221023181223173"></p>
<p>æœ€åäº¤æ›¿æ‹¼æ¥å³å¯</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-built_in">print</span>(<span class="hljs-string">'a'</span>*<span class="hljs-number">32</span>)<br>rc4=<span class="hljs-string">'szv~'</span><br>buf0=<span class="hljs-string">'DST{Wo7Xj5Ad8Nx8'</span><br>buf1=<span class="hljs-string">'ACFg0Gw1Jo5Ix9C}'</span><br>nbase=<span class="hljs-string">'ghijklmnopqrstuvwxyz0123456789+/ABCDEFGHIJKLMNOPQRSTUVWXYZabcdef'</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(buf1)):<br>    <span class="hljs-built_in">print</span>(buf0[i]+buf1[i],end=<span class="hljs-string">''</span>)<br></code></pre></td></tr></tbody></table></figure>
<h2 id="babysys">babysys</h2>
<blockquote>
<p>æ— åŒå‡»è°ƒè¯•ç»éªŒï¼Œåªèƒ½ç¡¬åŠ¨æ€åˆ†æã€‚æœ¬é¢˜å†…æ ¸æˆåˆ†ä¸å¤šï¼Œä¸»è¦æ˜¯å¼‚å¸¸å¤„ç†ï¼Œæ„Ÿè°¢Retardçˆ·çš„ç‚¹æ’­ï¼ŒğŸ¹ğŸ¹æˆ‘å•Š~ ï¼Œæ‰ç†æ¸…ç¨‹åºé€»è¾‘ã€‚</p>
</blockquote>
<h3 id="å¼‚å¸¸è¡¥å……">å¼‚å¸¸è¡¥å……</h3>
<blockquote>
<p>å…³äºx64SEHç›¸å…³è¡¥å……ï¼Œä¿®å¤æ§åˆ¶æµçš„ç›¸å…³ç»“æ„ä½“</p>
</blockquote>
<h4 id="å¼‚å¸¸æ³¨å†Œ">å¼‚å¸¸æ³¨å†Œ</h4>
<p>æ¯ä¸ªéå¶å‡½æ•°åªè¦å¯¹åº”ä¸€ä¸ª<code>RUNTIME_FUNCTION</code>ç»“æ„ä½“ï¼Œå¦‚æœå¶å‡½æ•°ä½¿ç”¨äº†SEHï¼Œä¹Ÿä¼šæœ‰å¯¹åº”çš„ç»“æ„ä½“ã€‚</p>
<blockquote>
<p>ä¸è°ƒç”¨å‡½æ•°ã€åˆæ²¡æœ‰ä¿®æ”¹æ ˆæŒ‡é’ˆï¼Œä¹Ÿæ²¡æœ‰ä½¿ç”¨ SEH çš„å‡½æ•°å°±å«åšâ€œå¶å‡½æ•°â€ï¼Œæ ‘çš„å¶å­èŠ‚ç‚¹ã€‚</p>
</blockquote>
<p>x64 windowsä¸­å¼‚å¸¸æ³¨å†Œä¿¡æ¯å‘ç”Ÿäº†å·¨å¤§çš„æ”¹å˜ï¼Œå¼‚å¸¸æ³¨å†Œä¿¡æ¯åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­ç”Ÿæˆï¼Œé“¾æ¥æ—¶å†™å…¥ PE+ å¤´ä¸­çš„ <code>ExceptionDirectory</code> ï¼Œå…¶ä¸­å‡ ä¹åŒ…å«æ‰€æœ‰å‡½æ•°çš„æ ˆæ“ä½œã€å¼‚å¸¸å¤„ç†ç­‰ä¿¡æ¯ã€‚</p>
<p>ç¨‹åºå‡ºç°å¼‚å¸¸-&gt;æŸ¥æ‰¾å‡½æ•°çš„<code>runtime_function</code>ç»“æ„ä½“-&gt;æ‰¾åˆ°<code>unwind_info</code>,åˆ¤æ–­flagsï¼Œå¦‚æœæ²¡æœ‰å¼‚å¸¸å¤„ç†ç¨‹åºï¼Œé‚£ä¹ˆæ ¹æ®å¼‚å¸¸çš„ä½ç½®å‚ç…§<code>unwind_code</code>è¿›è¡Œå›æ»šï¼Œè¿”å›åˆ°ä¸Šå±‚å‡½æ•°ï¼Œç»§ç»­æŸ¥<code>runtime_function</code>ç»“æ„ä½“ï¼ŒæŸ¥çœ‹æœ‰æ— å¤„ç†å‡½æ•°ï¼Œå¦‚æœæœ‰åˆ™è¿›è¡Œå¼‚å¸¸å¤„ç†ï¼Œå¦‚æœæ— åˆ™ç»§ç»­å›æ»šé‡å¤æŸ¥<code>runtime_function</code>ã€‚</p>
<blockquote>
<p>è‡³äºfindallyå—çš„æ‰§è¡Œï¼Œæ»¡è¶³å…¨å±€å±•å¼€ï¼Œä¼šå…ˆæ‰¾ä¸€ä¸ªå¼‚å¸¸è¿‡æ»¤ç¨‹åºæ‰§è¡Œï¼Œå¦‚æœè¿”å›1</p>
</blockquote>
<p><code>ExceptionDir</code></p>
<p>å…¶ä¸­åŒ…å«å¤šæ¡å­—æ®µ<code>RUNTIME_FUNCTION</code>,ä¸€å…±12å­—èŠ‚ã€‚</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IMAGE_RUNTIME_FUNCTION_ENTRY</span> {</span><br>  DWORD BeginAddress;					<span class="hljs-comment">//å‡½æ•°é¦–åœ°å€</span><br>  DWORD EndAddress;						<span class="hljs-comment">//å‡½æ•°ç»“æŸåœ°å€</span><br>  <span class="hljs-class"><span class="hljs-keyword">union</span> {</span>								<span class="hljs-comment">//å‡½æ•°unwindç›¸å…³ä¿¡æ¯</span><br>    DWORD UnwindInfoAddress;<br>    DWORD UnwindData;<br>  } DUMMYUNIONNAME;<br>} RUNTIME_FUNCTION, *PRUNTIME_FUNCTION, _IMAGE_RUNTIME_FUNCTION_ENTRY, *_PIMAGE_RUNTIME_FUNCTION_ENTRY;<br></code></pre></td></tr></tbody></table></figure>
<p>unwindç»“æ„ä½“è®°å½•æœ‰å…³å¼‚å¸¸å¤„ç†å’Œå‡½æ•°æ“ä½œçš„ä¿¡æ¯ï¼Œç”¨äºå›æ»šã€‚</p>
<blockquote>
<p>æ˜“å¤±å¯„å­˜å™¨rcxã€rdxã€r8ã€r9ã€r10ã€r11</p>
</blockquote>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">UNWIND_INFO_HDR</span></span><br><span class="hljs-class">{</span><br>  <span class="hljs-keyword">char</span> Ver3_Flags;	<span class="hljs-comment">//ä½3ä½æ˜¯version é«˜5ä½æ˜¯flags</span><br>  <span class="hljs-keyword">char</span> PrologSize;	<span class="hljs-comment">//å‡½æ•°å¤´å¤§å°ï¼Œå‡½æ•°å¤´ä¸€èˆ¬æ˜¯å¯¹æ ˆè¿›è¡Œå¯†é›†æ“ä½œçš„ä¸€éƒ¨åˆ†</span><br>  <span class="hljs-keyword">char</span> CntUnwindCodes;<span class="hljs-comment">//UWIND_CODEçš„æ•°é‡</span><br>  <span class="hljs-keyword">char</span> FrReg_FrRegOff;<span class="hljs-comment">// FrRegç”¨ä½œfpçš„å¯„å­˜å™¨ç¼–å·  fpä¸­å­˜æ”¾ rsp+16*FrRegOff</span><br>};<br><span class="hljs-comment">/*flagså€¼ - å…³é”®</span><br><span class="hljs-comment">UNW_FLAG_NHANDLER 0x0 ä¸å¯¹å¼‚å¸¸è¿›è¡Œå¤„ç†</span><br><span class="hljs-comment">UNW_FLAG_EHANDLER 0x01 ä½¿ç”¨Exceptå‡½æ•°è¿›è¡Œå¤„ç†ã€‚</span><br><span class="hljs-comment">UNW_FLAG_UHANDLER 0x02 ä½¿ç”¨finallyå‡½æ•°å¤„ç†ã€‚</span><br><span class="hljs-comment">UNW_FLAG_CHAININFO 0x04 ä½¿ç”¨è°ƒç”¨é“¾ï¼ŒæŸäº›å‡½æ•°è¢«å…¶ä»–å‡½æ•°è°ƒç”¨ï¼Œåœ¨å¼‚å¸¸ä¼šæ»šæ—¶ä¹Ÿéœ€è¦åšè°ƒç”¨ä»–å‡½æ•°çš„å›æ»šå·¥ä½œï¼Œå¯ä»¥ç›´æ¥ç”¨å…¶ä¸Šå±‚å‡½æ•°çš„runtime_funcå³å¯ã€‚</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></tbody></table></figure>
<p>å½“unwind_infoâ€”ä¸­çš„flagå­—æ®µä¸ºåä¸‰ç§æƒ…å†µæ—¶ï¼Œåç»­ä¸å®šé•¿æ•°ç»„<code>unwind_code</code>çš„ç»“æ„å¦‚ä¸‹ã€‚</p>
<p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20221024202124917.png" srcset="/img/loading.gif" lazyload alt="image-20221024202124917"></p>
<p>UWIND_CODEç”¨äºè®°å½•å‡½æ•°å¤´ä¸­æœ‰å…³éæ˜“å¤±æ€§å¯„å­˜å™¨å’ŒRSPçš„æ“ä½œã€‚</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">UNWIND_CODE</span></span><br><span class="hljs-class">{</span><br>  <span class="hljs-keyword">char</span> PrologOff;     <span class="hljs-comment">// æ‰§è¡Œæ­¤æ“ä½œçš„æŒ‡ä»¤æœ«å°¾çš„åç§»é‡</span><br>  <span class="hljs-keyword">char</span> OpCode_OpInfo;<br>  <span class="hljs-comment">//Unwind operation code  low  4bit</span><br>  <span class="hljs-comment">//Operation info		   high 4bit</span><br>};<br></code></pre></td></tr></tbody></table></figure>
<p><code>PrologOff</code>è·ç¦»å¤´éƒ¨åç§»çš„åç§»é‡ï¼Œä¾‹å¦‚å€¼ä¸ºxï¼Œé‚£ä¹ˆåœ¨mainå‡½æ•°xå­—èŠ‚ä¹‹å¤–å‘ç”Ÿå¼‚å¸¸ï¼Œåˆ™éœ€è¦æ­¤æ¬¡å›æ»šï¼Œå¦åˆ™ä¸è¿›è¡Œå›æ»šï¼Œ<code>info</code>åˆ™æ˜¯æ ¹æ®opçš„ç±»å‹æ‰€éœ€çš„ç›¸å…³å‚æ•°ã€‚</p>
<p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20221024185740395.png" srcset="/img/loading.gif" lazyload alt="image-20221024185740395"></p>
<p>ä¾‹å¦‚<code>47a0</code>å‡½æ•°çš„ä¸€æ¡<code>unwind_code</code>å¦‚ä¸‹ï¼Œç¬¬ä¸€ä¸ªå€¼æ˜¯4ï¼Œç»“åˆå‡½æ•°å¤„çš„æ±‡ç¼–ä¸º<code>sub rsp,0x38</code>è¡¨ç¤ºçš„è¯¥4å­—èŠ‚çš„æ ˆæ“ä½œï¼Œè€Œ0x62ï¼Œä½4ä½ä¸º2å³<code>UWOP_ALLOC_SMALL</code>,å¯¹äº<code>info</code>çš„å€¼ä¸º6ï¼ŒæŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ã€‚</p>
<p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20221024190207532.png" srcset="/img/loading.gif" lazyload alt="image-20221024190207532"></p>
<p>åœ¨æ ˆä¸Šå¼€è¾Ÿäº†ä¸€ä¸ª8*<code>info</code>+8å¤§å°çš„ç©ºé—´ï¼Œå³6*8+8 = 0x38, ä¹Ÿå°±è¯¥æ¡<code>unwind_code</code>è®°å½•ç€è¯¥å‡½æ•°å‰4å­—èŠ‚åšçš„æ“ä½œåœ¨æ ˆä¸Šå¼€è¾Ÿäº†0x38çš„ç©ºé—´ï¼Œå¦‚æœåœ¨ä¹‹åå‡ºç°å¼‚å¸¸ï¼Œåˆ™å›æ»šæ—¶åˆ™éœ€è¦è¿›è¡Œç›¸åº”çš„æ ˆå¤„ç†ã€‚</p>
<blockquote>
<p>unwind_codeçš„å¤„ç†é¡ºåºå’Œå‡½æ•°ä¸­å¯¹æ ˆæ“ä½œçš„æŒ‡ä»¤ç›¸åã€‚</p>
</blockquote>
<p>å¯¹äºflagsä¸º1æˆ–2æ—¶ï¼Œå³å‡½æ•°å­˜åœ¨å¼‚å¸¸å¤„ç†/ç»ˆæ­¢å¤„ç†çš„ç¨‹åºã€‚</p>
<p><code>unwind_info </code>ä¸­ä¼šå¡å…¥<code>__C_specific_handler</code>å‡½æ•°ï¼Œä»–æ ¹æ®<code>SCOPE_TABLE</code>è¿›è¡Œå¼‚å¸¸å¤„ç†æˆ–ç»ˆæ­¢å¤„ç†ï¼Œè¯¥å‡½æ•°åè·Ÿ<code>SCOPE_TABLE</code>çš„æ•°é‡ï¼Œä¹‹åä¾¿æ˜¯ï¼Œç›¸å…³çš„scopeç»“æ„ä½“æ•°ç»„ã€‚</p>
<p><code>C_SCOPE_TABLE</code>ç»“æ„ä½“è®°å½•äº†å¼‚å¸¸å¤„ç†çš„ç»“æ„,å¤§å°16å­—èŠ‚ï¼Œ4ä¸ª<code>RVA</code>ã€‚</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">C_SCOPE_TABLE</span></span><br><span class="hljs-class">{</span><br>  <span class="hljs-keyword">void</span> *__ptr32 Begin;     <span class="hljs-comment">//tryå—å¼€å§‹çš„é¦–åœ°å€</span><br>  <span class="hljs-keyword">void</span> *__ptr32 End;	   <span class="hljs-comment">// tryå—ç»“æŸçš„åœ°å€</span><br>  <span class="hljs-keyword">void</span> *__ptr32 Handler;<br>  <span class="hljs-keyword">void</span> *__ptr32 Target;<br>};<br><span class="hljs-comment">/*å¯¹äºhandlerå’Œtarget</span><br><span class="hljs-comment">å¦‚æœUNWIND_INFO_HDRä¸­Flagsä¸ºUNW_FLAG_EHANDLER(1),åˆ™ä»¥æ­¤ä¸ºfilterç¨‹åºå’Œexceptç¨‹åºã€‚</span><br><span class="hljs-comment">å¦‚æœFlagsä¸ºUNW_FLAG_UHANDLER(2),åˆ™ä¸ºfinallyç¨‹åºå’Œ0ã€‚</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></tbody></table></figure>
<p>ç»¼ä¸Šï¼Œ<code>RUNTIME_FUNCTION</code>æœ€åä¼šæŒ‡å‘ä¸€ç³»åˆ—çš„<code>unwind_code</code>ç”¨äºå›æ»šã€‚</p>
<p>ç»“æ„ä½“æ±‡æ€»</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">RUNTIME_FUNCTION</span> {</span><br>        ULONG BeginAddress;<br>        ULONG EndAddress;<br>        ULONG UnwindData;<br>    } RUNTIME_FUNCTION, *PRUNTIME_FUNCTION;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">enum</span> _<span class="hljs-title">UNWIND_OP_CODES</span> {</span><br>        UWOP_PUSH_NONVOL = <span class="hljs-number">0</span>,<br>        UWOP_ALLOC_LARGE,       <span class="hljs-comment">// 1</span><br>        UWOP_ALLOC_SMALL,       <span class="hljs-comment">// 2</span><br>        UWOP_SET_FPREG,         <span class="hljs-comment">// 3</span><br>        UWOP_SAVE_NONVOL,       <span class="hljs-comment">// 4</span><br>        UWOP_SAVE_NONVOL_FAR,   <span class="hljs-comment">// 5</span><br>        UWOP_SPARE_CODE1,       <span class="hljs-comment">// 6</span><br>        UWOP_SPARE_CODE2,       <span class="hljs-comment">// 7</span><br>        UWOP_SAVE_XMM128,       <span class="hljs-comment">// 8</span><br>        UWOP_SAVE_XMM128_FAR,   <span class="hljs-comment">// 9</span><br>        UWOP_PUSH_MACHFRAME     <span class="hljs-comment">// 10</span><br>    } UNWIND_OP_CODES, *PUNWIND_OP_CODES;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">union</span> _<span class="hljs-title">UNWIND_CODE</span> {</span><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> {</span><br>            UCHAR CodeOffset;<br>            UCHAR UnwindOp : <span class="hljs-number">4</span>;<br>            UCHAR OpInfo : <span class="hljs-number">4</span>;<br>        };<br>    <br>        USHORT FrameOffset;<br>    } UNWIND_CODE, *PUNWIND_CODE;<br>    <br>    <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> UNW_FLAG_NHANDLER 0x0   <span class="hljs-comment">//no </span></span><br>    <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> UNW_FLAG_EHANDLER 0x1	<span class="hljs-comment">//exception</span></span><br>    <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> UNW_FLAG_UHANDLER 0x2	<span class="hljs-comment">//unwind(finally)</span></span><br>    <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> UNW_FLAG_CHAININFO 0x4  <span class="hljs-comment">//chain</span></span><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">UNWIND_INFO</span> {</span><br>        UCHAR Version : <span class="hljs-number">3</span>;     <span class="hljs-comment">//å‰éƒ¨åˆ†ä¸€å…±4å­—èŠ‚ï¼ŒIDAä¸­å®šä¹‰ä¸ºUNWIND_INFO_HDR</span><br>        UCHAR Flags : <span class="hljs-number">5</span>;	   <br>        UCHAR SizeOfProlog;    <span class="hljs-comment">//å‡½æ•°å¤´éƒ¨å¤§å°</span><br>        UCHAR CountOfCodes;    <span class="hljs-comment">//ä¸å®šé•¿ç»“æ„ä½“å¤§å°ï¼Œä¸è¿‡æ›´å‡†ç¡®åº”è¯¥æ˜¯åŒ…å«çš„dwæ•°æ®çš„ä¸ªæ•°  </span><br>        UCHAR FrameRegister : <span class="hljs-number">4</span>;<br>        UCHAR FrameOffset : <span class="hljs-number">4</span>;<br>        UNWIND_CODE UnwindCode[<span class="hljs-number">1</span>]; <span class="hljs-comment">//ä¸å®šé•¿æ•°ç»„</span><br>    <br>    <span class="hljs-comment">//</span><br>    <span class="hljs-comment">// The unwind codes are followed by an optional DWORD aligned field that</span><br>    <span class="hljs-comment">// contains the exception handler address or a function table entry if</span><br>    <span class="hljs-comment">// chained unwind information is specified. If an exception handler address</span><br>    <span class="hljs-comment">// is specified, then it is followed by the language specified exception</span><br>    <span class="hljs-comment">// handler data.</span><br>    <span class="hljs-comment">//</span><br>    <span class="hljs-comment">//  union {</span><br>    <span class="hljs-comment">//      struct {</span><br>    <span class="hljs-comment">//          ULONG ExceptionHandler;</span><br>    <span class="hljs-comment">//          ULONG ExceptionData[];</span><br>    <span class="hljs-comment">//      };</span><br>    <span class="hljs-comment">//</span><br>    <span class="hljs-comment">//      RUNTIME_FUNCTION FunctionEntry;</span><br>    <span class="hljs-comment">//  };</span><br>    <span class="hljs-comment">//</span><br>    <br>    } UNWIND_INFO, *PUNWIND_INFO;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">SCOPE_TABLE</span> {</span><br>        ULONG Count;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">        {</span><br>            ULONG BeginAddress;<br>            ULONG EndAddress;<br>            ULONG HandlerAddress;<br>            ULONG JumpTarget;<br>        } ScopeRecord[<span class="hljs-number">1</span>];<br>    } SCOPE_TABLE, *PSCOPE_TABLE;<br></code></pre></td></tr></tbody></table></figure>
<p>è¯¦è§å®˜æ–¹: <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/cpp/build/exception-handling-x64?view=msvc-170">https://learn.microsoft.com/en-us/cpp/build/exception-handling-x64?view=msvc-170</a></p>
<h4 id="å¼‚å¸¸ä¿¡æ¯">å¼‚å¸¸ä¿¡æ¯</h4>
<p><code>__finally</code>ä»£ç å—ä¸ºç»ˆæ­¢ç¨‹åºï¼Œ<code>__except(filter())</code>ä¸ºå¼‚å¸¸å¤„ç†ç¨‹åº,<code>filter</code>ä¸ºå¼‚å¸¸è¿‡æ»¤ç¨‹åºï¼Œè¿”å›å€¼æœ‰ä¸‰ç§æƒ…å†µã€‚</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">EXCEPTION_CONTINUE_EXECUTION(<span class="hljs-number">-1</span>)  <span class="hljs-comment">//åœ¨å‘ç”Ÿå¼‚å¸¸çš„åœ°æ–¹ç»§ç»­æ‰§è¡Œ</span><br>EXCEPTION_EXECUTE_HANDLER(<span class="hljs-number">1</span>)    <span class="hljs-comment">//æ‰§è¡Œå¼‚å¸¸å¤„ç†ç¨‹åº</span><br>EXCEPTION_CONTINUE_SEARCH(<span class="hljs-number">0</span>)    <span class="hljs-comment">//ç»§ç»­å‘ä¸Šå¯»æ‰¾å¼‚å¸¸è¿‡æ»¤ç¨‹åºï¼Œç›´åˆ°èƒ½å¤„ç†    </span><br></code></pre></td></tr></tbody></table></figure>
<p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20221024221213623.png" srcset="/img/loading.gif" lazyload alt="image-20221024221213623"></p>
<blockquote>
<p>ç³Š~</p>
</blockquote>
<p>å¼‚å¸¸å¤„ç†ä¸­ä¸å¼‚å¸¸ä¿¡æ¯ç›¸å…³ç»“æ„ä½“ï¼Œå¯ç”±GetExceptionInformationå‡½æ•°è·å–ï¼Œè¿”å›<code>EXCEPTION_POINTERS</code>ç±»å‹çš„æŒ‡é’ˆã€‚</p>
<p><code>EXCEPTION_POINTERS</code></p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">EXCEPTION_POINTERS</span> {</span><br>  PEXCEPTION_RECORD ExceptionRecord; <span class="hljs-comment">//ä¸CPUæ— å…³çš„ä¿¡æ¯</span><br>  PCONTEXT          ContextRecord;	 <span class="hljs-comment">//CPUç›¸å…³çš„å¼‚å¸¸ä¿¡æ¯ï¼Œå¯„å­˜å™¨ç­‰ã€‚</span><br>} EXCEPTION_POINTERS, *PEXCEPTION_POINTERS;<br></code></pre></td></tr></tbody></table></figure>
<p><code>PEXCEPTION_RECORD</code></p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">EXCEPTION_RECORD</span> {</span><br>  DWORD                    ExceptionCode;<br>  DWORD                    ExceptionFlags;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">EXCEPTION_RECORD</span> *<span class="hljs-title">ExceptionRecord</span>;</span><br>  PVOID                    ExceptionAddress;<br>  DWORD                    NumberParameters;<br>  ULONG_PTR                ExceptionInformation[EXCEPTION_MAXIMUM_PARAMETERS];<br>} EXCEPTION_RECORD;<br></code></pre></td></tr></tbody></table></figure>
<h3 id="é¢˜è§£">é¢˜è§£</h3>
<p>ç”¨æˆ·ç¨‹åºè®¿é—®é©±åŠ¨ï¼Œé€šè¿‡<code>CreateFile</code>è®¿é—®è®¾å¤‡ã€‚</p>
<p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20221024222100867.png" srcset="/img/loading.gif" lazyload alt="image-20221024222100867"></p>
<p>åŒæ—¶ä½¿ç”¨<code>DeviceIoControl</code>å‡½æ•°å‘é©±åŠ¨å‘é€ä¿¡æ¯ï¼Œæ§åˆ¶è®¾å¤‡æ‰§è¡Œç›¸å…³æ“ä½œï¼Œæ“ä½œæ§åˆ¶ä»£ç ä¸º0x222000ã€‚</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-function">BOOL <span class="hljs-title">DeviceIoControl</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">  (HANDLE) hDevice,                 <span class="hljs-comment">// handle to device</span></span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-literal">NULL</span>,                             <span class="hljs-comment">// lpInBuffer</span></span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-number">0</span>,                                <span class="hljs-comment">// nInBufferSize</span></span></span><br><span class="hljs-params"><span class="hljs-function">  (LPVOID) lpOutBuffer,             <span class="hljs-comment">// output buffer</span></span></span><br><span class="hljs-params"><span class="hljs-function">  (DWORD) nOutBufferSize,           <span class="hljs-comment">// size of output buffer</span></span></span><br><span class="hljs-params"><span class="hljs-function">  (LPDWORD) lpBytesReturned,        <span class="hljs-comment">// number of bytes returned</span></span></span><br><span class="hljs-params"><span class="hljs-function">  (LPOVERLAPPED) lpOverlapped       <span class="hljs-comment">// OVERLAPPED structure</span></span></span><br><span class="hljs-params"><span class="hljs-function">)</span></span>;<br></code></pre></td></tr></tbody></table></figure>
<p>é©±åŠ¨ç¨‹åºé€šè¿‡<code>IoCreateDevice</code>åˆ›å»ºè®¾å¤‡åç§°ï¼Œå¹¶ä½¿ç”¨<code>IoCreateSymbolicLink</code>åˆ›å»ºç¬¦å·é“¾æ¥ã€‚</p>
<p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20221024222622619.png" srcset="/img/loading.gif" lazyload alt="image-20221024222622619"></p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">DRIVER_OBJECT</span> {</span><br>  CSHORT             Type;<br>  CSHORT             Size;<br>  PDEVICE_OBJECT     DeviceObject;<br>  ULONG              Flags;<br>  PVOID              DriverStart;<br>  ULONG              DriverSize;<br>  PVOID              DriverSection;<br>  PDRIVER_EXTENSION  DriverExtension;<br>  UNICODE_STRING     DriverName;<br>  PUNICODE_STRING    HardwareDatabase;<br>  PFAST_IO_DISPATCH  FastIoDispatch;<br>  PDRIVER_INITIALIZE DriverInit;<br>  PDRIVER_STARTIO    DriverStartIo;<br>  PDRIVER_UNLOAD     DriverUnload;<br>  PDRIVER_DISPATCH   MajorFunction[IRP_MJ_MAXIMUM_FUNCTION + <span class="hljs-number">1</span>];<br>} DRIVER_OBJECT, *PDRIVER_OBJECT;<br></code></pre></td></tr></tbody></table></figure>
<p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20221023233226231.png" srcset="/img/loading.gif" lazyload alt="image-20221023233226231"></p>
<p>å¹¶ä¸”é©±åŠ¨ç¨‹åºæ³¨å†Œäº†ä¸€ä¸ª<code>DriverObject-&gt;MajorFunction[14]</code>çš„å‡½æ•°ï¼Œ0xeå¯¹åº”ç€<code>IRP_MJ_DEVICE_CONTROL</code>,å³åº”ç”¨ç¨‹åºè°ƒç”¨<code> DeviceIoControl</code>ï¼Œä¼šæŒ‡å‘æ³¨å†Œçš„<code>sub_14000175C</code>å‡½æ•°ã€‚</p>
<p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20221024230024387.png" srcset="/img/loading.gif" lazyload alt="image-20221024230024387"></p>
<p>è¯¥å‡½æ•°ä¼šåŒ¹é…æ“ä½œæ§åˆ¶ç ï¼Œå¹¶ä¸”è·å–åº”ç”¨ç¨‹åºä¼ å…¥çš„è¾“å…¥è®¡ç®—å…¶é•¿åº¦ï¼Œå¹¶ä½¿ç”¨<code>sub_1400018d8</code>å‡½æ•°è¿›è¡Œå¤„ç†ã€‚</p>
<p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20221024230632623.png" srcset="/img/loading.gif" lazyload alt="image-20221024230632623"></p>
<p>åç»­å‡½æ•°å¤šä½¿ç”¨å¼‚æˆ–æ¥åšSMCï¼Œå¹¶ä¸”åœ¨è°ƒç”¨åæ¢å¤ã€‚</p>
<p><code>get_func_len</code>å‡½æ•°æ˜¯é€šè¿‡è®¿é—®<code>runtime_function</code>ç»“æ„ä½“è·å–å‡½æ•°å¼€å§‹å’Œç»“æŸä½ç½®åšå·®è·å–ã€‚</p>
<p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20221024231130224.png" srcset="/img/loading.gif" lazyload alt="image-20221024231130224"></p>
<p>å¦‚æœå¯¹PEæ–‡ä»¶ç†Ÿæ‚‰çš„è¯ï¼Œ<code>0x3c</code>æ˜¯doså¤´æœ€åå››å­—èŠ‚ï¼ŒæŒ‡å‘NTå¤´ï¼Œè€Œ0xA0åˆ™å¯¹åº”<code>ExceptionDir</code>çš„é¦–åœ°å€ï¼Œç›¸å…³ç»“æ„ä½“ä¸Šæ–‡å·²ç»™å‡ºã€‚</p>
<p>ä½¿ç”¨ipyè§£å¯†ä»£ç ï¼Œä½†æ˜¯å‘ç°åæ–‡å¹¶æ²¡æœ‰ç›´æ¥è°ƒç”¨ï¼Œè€Œæ˜¯åœ¨è°ƒç”¨<code>hook_2_func_encrypt</code>åå°±å°†è§£å¯†åçš„ä»£ç è¿˜åŸäº†ã€‚</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> idautils<br>adr=<span class="hljs-number">0x140001288</span><br>end=<span class="hljs-number">0x1400014C1</span><br>size=end-adr<br>code=<span class="hljs-built_in">bytearray</span>(get_bytes(adr,size))<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(code)):<br>    code[i]^=<span class="hljs-number">0xab</span><br>    patch_byte(adr+i,code[i])<br><span class="hljs-built_in">print</span>(<span class="hljs-string">'win'</span>)<br></code></pre></td></tr></tbody></table></figure>
<p>æŸ¥çœ‹<code>hook_2_func_encrypt</code>åœ°å€çš„å‡½æ•°ï¼Œå…¶é€šè¿‡è§¦å‘int3å¼‚å¸¸æ¥æ‰§è¡Œå¼‚å¸¸è¿‡æ»¤ç¨‹åºï¼Œè¿™æ ·ä¾¿èƒ½è°ƒç”¨åˆšåˆšè§£å¯†çš„<code> sub_140001288</code>å‡½æ•°ã€‚</p>
<p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20221024231929089.png" srcset="/img/loading.gif" lazyload alt="image-20221024231929089"></p>
<p><code>sub_140001288</code></p>
<p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20221024232450647.png" srcset="/img/loading.gif" lazyload alt="image-20221024232450647"></p>
<p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20221025083058978.png" srcset="/img/loading.gif" lazyload alt="image-20221025083058978"></p>
<p>é€šè¿‡v3(cnt)ä»0å¼€å§‹è®¡æ•°ï¼Œå¹¶æ¯”å¯¹v3çš„å€¼å®Œæˆä¸åŒæ“ä½œã€‚å¦‚æœv3çš„å€¼å°äº7ï¼Œåˆ™æ‰§è¡Œå¦å¤–ä¸¤ç»„æ“ä½œã€‚å¹¶ä¸”åœ¨æœ€åé€šè¿‡<code>EXCEPTION_POINTERS</code>è·å–å¼‚å¸¸ipï¼Œå¦‚æœå¼‚å¸¸å¤„æŒ‡ä»¤ä¸º0xccå¹¶ä¸”v3ä¸ç­‰äº1å°±å°†ipåŠ 1åè¿”å›ï¼Œè¿”å›å€¼ä¸º-1å³ç»§ç»­åœ¨å¼‚å¸¸å¤„æ‰§è¡Œã€‚</p>
<p>å¦‚æœv3ä¸º1æˆ–3æ—¶ï¼Œä¼šå…ˆå¯¹è¾“å…¥è¿›è¡Œ+içš„å¤„ç†ï¼Œä¹‹åè°ƒç”¨<code>sub_140001AB4</code>å‡½æ•°ã€‚</p>
<p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20221025085825841.png" srcset="/img/loading.gif" lazyload alt="image-20221025085825841"></p>
<p><code>sub_140001AB4</code>å‡½æ•°åŠ å¯†é€»è¾‘å¦‚ä¸‹</p>
<p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20221025090206334.png" srcset="/img/loading.gif" lazyload alt="image-20221025090206334"></p>
<p>é€šè¿‡è®¡ç®—ä¸¤ä¸ªå›ºå®šå‡½æ•°çš„md5ç›¸å¼‚æˆ–ï¼Œå°†å¾—åˆ°çš„32ä¸ªå­—ç¬¦åˆ†ä¸º16ä¸ªå­—èŠ‚ä¸€ç»„ï¼Œç¬¬ä¸€ç»„ç”¨åšteaåŠ å¯†ï¼Œç¬¬äºŒç»„ç”¨ä½œteaè§£å¯†ï¼Œç±»ä¼¼3DESå¤„ç†ã€‚</p>
<p>å½“v3ç­‰äº2/4æ—¶ï¼Œä¼šé¦–å…ˆè°ƒç”¨<code> sub_140001C60</code>,å¹¶ä¸”å¼‚æˆ–0x10ã€‚</p>
<p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20221025090522937.png" srcset="/img/loading.gif" lazyload alt="image-20221025090522937"></p>
<p>ä¸€å…±æœ‰6ä¸ªint3ï¼Œå¹¶ä¸”ç¬¬ä¸€æ¬¡ä¸æ”¹ipæ•…cntä¸€å…±åŠ äº†7æ¬¡ï¼Œç¬¬7æ¬¡è¿›å…¥ifå—å¤„ç†ã€‚</p>
<p>é¦–å…ˆä¼šè°ƒç”¨<code>sub_140001868</code>å‡½æ•°ï¼Œä¿®æ”¹è§¦å‘å¼‚å¸¸å‡½æ•°çš„<code>runtime_function</code>ç»“æ„ä½“ï¼Œä¿®æ”¹å…¶å¼‚å¸¸å¤„ç†ç¨‹åºä¸º<code>0x140001009</code>å¤„çš„<code>func_encrypt</code>å‡½æ•°ã€‚</p>
<p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20221025094325672.png" srcset="/img/loading.gif" lazyload alt="image-20221025094325672"></p>
<p>ä¹‹åä¼šå°†<code>sub_1400014C4</code>å‡½æ•°å¼‚æˆ–0x66ï¼Œå¹¶ä¸”è¿”å›-1ï¼Œä¸‹æ¬¡è§¦å‘å¼‚å¸¸å¯¹åº”çš„cntä¸º8åˆ™è¿”å›1ï¼Œé‚£ä¹ˆå¼‚å¸¸ç”±exceptå—çš„å¼‚å¸¸å¤„ç†ç¨‹åºè¿›è¡Œå¤„ç†ï¼Œå³è°ƒç”¨åˆšåˆšä¿®æ”¹çš„<code>0x140001009 </code>åœ°å€å¤„çš„å‡½æ•°ã€‚</p>
<blockquote>
<p>å¯¹<code>sub_1400014C4</code>å‡½æ•°è¿˜ä¼šå¼‚æˆ–0xccï¼Œè°ƒç”¨ç»“æŸåä¼šå¼‚æˆ–0xaaï¼Œå› ä¸º0x66^0xcc == 0xaa,è¿™é‡Œå¥—äº†ä¸€å±‚ã€‚</p>
</blockquote>
<p>å‡½æ•°çš„smcä¸åœ¨èµ˜è¿°ï¼Œå¤„ç†æµç¨‹ä¸ºå°†å¯†æ–‡å†å¼‚æˆ–0x99å¹¶ä½¿ç”¨<code>sub_140001C60</code>è¿›è¡ŒteaåŠ å¯†ï¼Œç»“æœä¸v11æ¯”å¯¹ã€‚</p>
<p><img src="https://blog-1309321804.cos.ap-nanjing.myqcloud.com/blog/image-20221026172745157.png" srcset="/img/loading.gif" lazyload alt="image-20221026172745157"></p>
<p><code>sub_140001c60</code>å‡½æ•°</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span> __fastcall <span class="hljs-title">sub_140001C60</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> *a1)</span></span><br><span class="hljs-function"></span>{<br>  __int64 v2; <span class="hljs-comment">// r10</span><br>  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> v0; <span class="hljs-comment">// r8d</span><br>  <span class="hljs-keyword">int</span> sum; <span class="hljs-comment">// r11d</span><br>  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> v1; <span class="hljs-comment">// r9d</span><br>  __int64 round; <span class="hljs-comment">// rbx</span><br><br>  v2 = <span class="hljs-number">5</span>i64;<br>  <span class="hljs-keyword">do</span><br>  {<br>    v0 = *a1;<br>    sum = <span class="hljs-number">0</span>;<br>    v1 = a1[<span class="hljs-number">1</span>];<br>    round = <span class="hljs-number">32</span>i64;<br>    <span class="hljs-keyword">do</span><br>    {<br>      sum -= <span class="hljs-number">0x61C88647</span>;<br>      v0 += (<span class="hljs-number">16</span> * v1 + <span class="hljs-number">17</span>) ^ ((v1 &gt;&gt; <span class="hljs-number">5</span>) + <span class="hljs-number">34</span>) ^ (sum + v1);<br>      v1 += (<span class="hljs-number">16</span> * v0 + <span class="hljs-number">51</span>) ^ ((v0 &gt;&gt; <span class="hljs-number">5</span>) + <span class="hljs-number">68</span>) ^ (sum + v0);<br>      --round;<br>    }<br>    <span class="hljs-keyword">while</span> ( round );<br>    *a1 = v0;<br>    a1[<span class="hljs-number">1</span>] = v1;<br>    a1 += <span class="hljs-number">2</span>;<br>    --v2;<br>  }<br>  <span class="hljs-keyword">while</span> ( v2 );<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>æ•´ä½“åŠ å¯†æµç¨‹ç®€åŒ–åå¦‚ä¸‹</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//å¾ªç¯ä¸¤è½®</span><br>ms[i]+=i<br>sub_140001AB4(v2); <span class="hljs-comment">//ä¸¤ä¸ªtea åŠ å¯† è§£å¯†</span><br>sub_140001C60(v2); <span class="hljs-comment">//tea</span><br>ms[i]^=<span class="hljs-number">0x10</span><br>    <br><span class="hljs-comment">//sub_140001638å¼‚å¸¸å¤„ç†å‡½æ•°</span><br>ms[i]^=<span class="hljs-number">0x99</span><br>sub_140001C60(v2) <span class="hljs-comment">//tea</span><br></code></pre></td></tr></tbody></table></figure>
<p>ç®—æ³•æ— é­”æ”¹ï¼Œåªè¦å–åˆ°keyå€¼å³å¯ï¼Œè§£å¯†è„šæœ¬å¦‚ä¸‹ã€‚</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ut32 unsigned int</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> delta 0x9e3779b9</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> __fastcall <span class="hljs-title">sub_140001C60</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>* a1)</span></span><br><span class="hljs-function"></span>{<br>	__int64 v2; <span class="hljs-comment">// r10</span><br>	<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> v0; <span class="hljs-comment">// r8d</span><br>	<span class="hljs-keyword">int</span> sum; <span class="hljs-comment">// r11d</span><br>	<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> v1; <span class="hljs-comment">// r9d</span><br>	__int64 round; <span class="hljs-comment">// rbx</span><br><br>	v2 = <span class="hljs-number">1</span>i64;<br>	<span class="hljs-keyword">do</span><br>	{<br>		v0 = *a1;<br>		sum = <span class="hljs-number">0</span>;<br>		v1 = a1[<span class="hljs-number">1</span>];<br>		round = <span class="hljs-number">32</span>i64;<br>		<span class="hljs-keyword">do</span><br>		{<br>			sum -= <span class="hljs-number">0x61C88647</span>;<br>			v0 += (<span class="hljs-number">16</span> * v1 + <span class="hljs-number">17</span>) ^ ((v1 &gt;&gt; <span class="hljs-number">5</span>) + <span class="hljs-number">34</span>) ^ (sum + v1);<br>			v1 += (<span class="hljs-number">16</span> * v0 + <span class="hljs-number">51</span>) ^ ((v0 &gt;&gt; <span class="hljs-number">5</span>) + <span class="hljs-number">68</span>) ^ (sum + v0);<br>			--round;<br>		}     <span class="hljs-keyword">while</span> (round);<br>		*a1 = v0;<br>		a1[<span class="hljs-number">1</span>] = v1;<br>		a1 += <span class="hljs-number">2</span>;<br>		--v2;<br>	}   <span class="hljs-keyword">while</span> (v2);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"sum: %08x\n"</span>, sum);<br>}<br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Tea_Encrypt</span><span class="hljs-params">(ut32* src, ut32* k)</span> </span>{<br>	ut32 sum = <span class="hljs-number">0</span>;<br>	ut32 v0 = src[<span class="hljs-number">0</span>];<br>	ut32 v1 = src[<span class="hljs-number">1</span>];<br>	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x20</span>; i++) {<br>		sum += delta;<br>		v0 += ((v1 &lt;&lt; <span class="hljs-number">4</span>) + k[<span class="hljs-number">0</span>]) ^ (v1 + sum) ^ ((v1 &gt;&gt; <span class="hljs-number">5</span>) + k[<span class="hljs-number">1</span>]);<br>		v1 += ((v0 &lt;&lt; <span class="hljs-number">4</span>) + k[<span class="hljs-number">2</span>]) ^ (v0 + sum) ^ ((v0 &gt;&gt; <span class="hljs-number">5</span>) + k[<span class="hljs-number">3</span>]);<br>	}<br>	src[<span class="hljs-number">0</span>] = v0;<br>	src[<span class="hljs-number">1</span>] = v1;<br>}<br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Tea_Decrypt</span><span class="hljs-params">(ut32* enc, ut32* k)</span> </span>{<br>	<span class="hljs-keyword">int</span> sum = delta * <span class="hljs-number">0x20</span>;<br>	ut32 v0 = enc[<span class="hljs-number">0</span>];<br>	ut32 v1 = enc[<span class="hljs-number">1</span>];<br>	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x20</span>; i++) {<br>		v1 -= ((v0 &lt;&lt; <span class="hljs-number">4</span>) + k[<span class="hljs-number">2</span>]) ^ (v0 + sum) ^ ((v0 &gt;&gt; <span class="hljs-number">5</span>) + k[<span class="hljs-number">3</span>]);<br>		v0 -= ((v1 &lt;&lt; <span class="hljs-number">4</span>) + k[<span class="hljs-number">0</span>]) ^ (v1 + sum) ^ ((v1 &gt;&gt; <span class="hljs-number">5</span>) + k[<span class="hljs-number">1</span>]);<br>		sum -= delta;<br>	}<br>	enc[<span class="hljs-number">0</span>] = v0;<br>	enc[<span class="hljs-number">1</span>] = v1;<br>}<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">output</span><span class="hljs-params">(ut32* m, ut32 n)</span> </span>{<br>	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; n; i++)<br>		<span class="hljs-built_in">printf</span>(<span class="hljs-string">"0x%08x "</span>, m[i]);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"\n"</span>);<br>}<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{<br>	ut32 m[<span class="hljs-number">10</span>] = { <span class="hljs-number">0xbb929b51</span>,<span class="hljs-number">0x25fed57f</span>,<span class="hljs-number">0x988aa03d</span>,<span class="hljs-number">0xbdc35d79</span>,<span class="hljs-number">0xe60aca2f</span>,<span class="hljs-number">0xf2755515</span>,<span class="hljs-number">0x67aa0fc2</span>,<span class="hljs-number">0xeb1992a8</span>,<span class="hljs-number">0x62759e50</span>,<span class="hljs-number">0x461e460c</span> };<br>	ut32 k1[<span class="hljs-number">4</span>] = { <span class="hljs-number">0x656565e</span>,<span class="hljs-number">0x57575207</span>,<span class="hljs-number">0x5201040a</span>,<span class="hljs-number">0xf045605</span> };<br><br>	ut32 k2[<span class="hljs-number">4</span>] = { <span class="hljs-number">0x7595701</span>,<span class="hljs-number">0x5601560c</span>,<span class="hljs-number">0x5651565a</span>,<span class="hljs-number">0x5525056</span> };<br><br>	ut32 k[<span class="hljs-number">4</span>] = { <span class="hljs-number">17</span>,<span class="hljs-number">34</span>,<span class="hljs-number">51</span>,<span class="hljs-number">68</span> };<br><br>	<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">10</span>;i+=<span class="hljs-number">2</span>)<br>		Tea_Decrypt(m+i, k);<br><br>	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {<br>		m[i] ^= <span class="hljs-number">0x99999999</span>;<br>	}<br>	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">2</span>; j++) {<br>		<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++)<br>			m[i] ^= <span class="hljs-number">0x10101010</span>;<br>		<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i += <span class="hljs-number">2</span>) {<br>			Tea_Decrypt(m + i, k);<br>			Tea_Encrypt(m + i, k2);<br>			Tea_Decrypt(m + i, k1);<br>		}<br>		<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">40</span>; i++) {<br>			*((<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span>*)m + i) -= i;<br>		}<br>	}<br>	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">40</span>; i++) {<br>		<span class="hljs-built_in">putchar</span>(*((<span class="hljs-keyword">char</span>*)m + i));<br>	}<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>}<br></code></pre></td></tr></tbody></table></figure>
<h3 id="å‚è€ƒ">å‚è€ƒ</h3>
<p><a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-190668.htm">(å‘é‡åŒ–å¼‚111å¸¸å¤„ç†)VEH hook</a></p>
<p><a target="_blank" rel="noopener" href="http://yimitumi.com/2020/05/13/VEH-Hook/">åŸºäºå¼‚å¸¸å¤„ç†çš„Hookå‡½æ•°(VEH Hook)</a></p>
<p><a target="_blank" rel="noopener" href="https://voidsec.com/windows-drivers-reverse-engineering-methodology/#windows-driver-101">Windows é©±åŠ¨ç¨‹åºé€†å‘å·¥ç¨‹æ–¹æ³•</a></p>
<p><a target="_blank" rel="noopener" href="https://www.pediy.com/kssd/pediy12/142371.htm">SEHåˆ†æç¬”è®°ï¼ˆX64ç¯‡)</a></p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/CTF-WP/">CTF-WP</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/RE/">RE</a>
                    
                      <a class="hover-with-bg" href="/tags/Wp/">Wp</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 åè®®</a> ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/11/07/2022QW%E6%8B%9F%E6%80%81/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">2022ç¬¬äº”å±Š"å¼ºç½‘"æ‹Ÿæ€</span>
                        <span class="visible-mobile">ä¸Šä¸€ç¯‡</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/10/17/2022ASISCTF/">
                        <span class="hidden-mobile">2022ASISCTF</span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ç›®å½•</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js" ></script>
  
  
    <script  src="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js" ></script>
  
  
    <script defer src="https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js" ></script>
  






  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
        typing(title);
      
    })(window, document);
  </script>















<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ ä¿æŒåœ¨æœ€åº•éƒ¨ -->
<script  src="/js/boot.js" ></script>


</body>
</html>
